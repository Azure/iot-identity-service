#!/bin/sh


toml_kvp() {
	printf "%s = \"%s\"\n" "$1" "$2"
}

toml_new_section() {
	printf "\n\n"
	printf "[%s]\n" "$1"
}

# Work around the fact that there is no consolidated, machine readable
# output of `hostnamectl` in the version included in core20. Core22 will
# be more elegant (i.e. `hostnamectl hostname`)
get_hostname() {
	hostname="$(/usr/bin/hostnamectl --static)"
	if [ -z "$hostname" ] ; then
		hostname="$(/usr/bin/hostnamectl --transient)"
	fi

	printf "$hostname"
}

snapctl get raw-config > /etc/aziot/config.toml

{
	toml_kvp "hostname" "$(get_hostname)"
} | tee /etc/aziot/keyd/config.d/01-snap.toml /etc/aziot/certd/config.d/01-snap.toml /etc/aziot/identityd/config.d/01-snap.toml /etc/aziot/tpmd/config.d/01-snap.toml

$SNAP/bin/aziotctl config apply
