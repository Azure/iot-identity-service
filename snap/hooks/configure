#!/bin/sh


toml_kvp() {
	printf "%s = \"%s\"\n" "$1" "$2"
}

toml_new_section() {
	printf "\n\n"
	printf "[%s]\n" "$1"
}

# Work around the fact that there is no consolidated, machine readable
# output of `hostnamectl` in the version included in core20. Core22 will
# be more elegant (i.e. `hostnamectl hostname`)
get_hostname() {
	hostname="$(/usr/bin/hostnamectl --static)"
	if [ -z "$hostname" ] ; then
		hostname="$(/usr/bin/hostnamectl --transient)"
	fi

	printf "$hostname"
}

{
	toml_kvp "hostname" "$(get_hostname)"

	snapctl get raw-config

	toml_new_section "aziot_keys"
	toml_kvp "homedir_path" "$SNAP_COMMON/libaziot_keys_homedir"

} > /etc/aziot/config.toml

$SNAP/bin/aziotctl config apply
