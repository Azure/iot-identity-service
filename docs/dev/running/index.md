# Running the services locally

1. Follow the steps in [Building the services](../building.md) to build the services.

1. (Optional) If you want to test the `aziot-keyd` with PKCS#11, see [Setting up your PKCS#11 library](pkcs11/index.md)

1. Create an Azure IoT Hub and an Azure IoT Device identity in that IoT Hub. Depending on the auth method you choose for the device identity, the services will be configured accordingly later.

    - If the device identity is set to use the `shared_private_key` auth method, retain one of the SAS keys generated by IoT Hub.

    - If the device identity is set to use the `x509_thumbprint` auth method, create a device ID cert and retain its private key and public X.509 PEM.

    - If the device identity is set to use the `x509_ca` auth method, create a device ID CA cert and retain its private key and public X.509 PEM.

    For `x509_thumbprint` and `x509_ca`, you can use hardware-backed private keys for the certs if you're using PKCS#11.

1. Start `aziot-keyd` in one shell. See [Configuring and running `aziot-keyd`](aziot-keyd.md)

1. Start `aziot-certd` in another shell. See [Configuring and running `aziot-certd`](aziot-certd.md)

1. Start `aziot-identityd` in another shell. See [Configuring and running `aziot-identityd`](aziot-identityd.md)

1. Run `iotedged` in another shell.

    - If the device identity is set to use the `shared_private_key` auth method, run the program with the SAS key:

        ```sh
        cargo run -p iotedged -- \
            --hub-id 'example.azure-devices.net' \
            --device-id 'example-1' \
            --sas-key 'QXp1cmUgSW9UIEVkZ2U='
        ```

    - If the device identity is set to use the `x509_thumbprint` auth method, run the program with the identifier of the device ID cert and private key:

        ```sh
        # The value of `--preloaded-device-id-cert` matches
        # the name of the key preloaded into keyd and
        # the name of the cert preloaded into certd.
        cargo run -p iotedged -- \
            --hub-id 'example.azure-devices.net' \
            --device-id 'example-1' \
            --preloaded-device-id-cert 'device-id'
        ```

    - If the device identity is set to use the `x509_ca` auth method, run the program with the identifier of the device ID CA cert and private key:

        ```sh
        # The value of `--preloaded-device-id-ca-cert` matches
        # the name of the key preloaded into keyd and
        # the name of the cert preloaded into certd.
        cargo run -p iotedged -- \
            --hub-id 'example.azure-devices.net' \
            --device-id 'example-1' \
            --preloaded-device-id-ca-cert 'device-id-ca'
        ```

`iotedged` is a test binary that performs some operations that would be done by the Identity Service or Edge Module Runtime. Specifically, it connects to `aziot-keyd` and `aziot-certd` and does the following:

1. Create a self-signed device CA cert.

1. Create a workload CA cert signed by the device CA cert.

1. Connect to IoT Hub using the device identity, using an auth method based on the parameters given to it:

    - When `--sas-key` is provided:
        1. Import the IoT Hub SAS key into `aziot-keyd`
        1. Connect to the IoT Hub and perform a list modules HTTP request. The SAS token for this request is signed using the SAS key imported into `aziot-keyd`.

    - When `--preloaded-device-id-cert` is provided:
        1. Connect to the IoT Hub and perform a list modules HTTP request. The key and cert preloaded into `aziot-keyd` and `aziot-certd` respectively are used for TLS client authentication.

    - When `--preloaded-device-id-ca-cert` is provided:
        1. Obtain the device ID CA cert whose ID is specified by the parameter.
        1. Create a new device ID certificate using `aziot-certd` that is signed by the device ID CA cert.
        1. Connect to the IoT Hub and perform a list modules HTTP request. The device ID cert created in the previous step is used for TLS client authentication.


## Miscellaneous

### Create IoT Device identity with X.509-CA auth mode

```sh
IOT_HUB_NAME=example
IOT_DEVICE_ID=example-1

# Certs will be stored here
mkdir -p scratch
cd scratch

# Create self-signed root CA
rm -f \
    device-id-root.key.pem \
    device-id-root.pem
openssl req \
    -x509 \
    -newkey rsa:4096 -keyout device-id-root.key.pem -nodes \
    -out device-id-root.pem \
    -subj '/CN=device-id-root' \
    -days 365

# Upload root CA to IoT Hub
az iot hub certificate create \
    --hub-name "$IOT_HUB_NAME" --name device-id-root \
    --path "$PWD/device-id-root.pem"

# Generate first etag for verification code request
etag="$(
    az iot hub certificate show \
    --hub-name "$IOT_HUB_NAME" --name device-id-root \
    --query etag --output tsv
)"

# Generate verification code and also save new etag
cloud_certificate="$(
    az iot hub certificate generate-verification-code \
    --hub-name "$IOT_HUB_NAME" --name device-id-root \
    --etag "$etag"
)"
etag="$(<<< "$cloud_certificate" jq '.etag' -r)"
verification_code="$(
    <<< "$cloud_certificate" jq '.properties.verificationCode' -r
)"

# Print the verification code.
# This becomes the CN of the verification cert.
echo "$verification_code"

# Generate CSR for verification cert and sign it
# with the root CA to get the verification cert.
rm -f \
    device-id-root-verify.key.pem \
    device-id-root-verify.csr \
    device-id-root-verify.pem
openssl req \
    -newkey rsa:2048 -keyout device-id-root-verify.key.pem -nodes \
    -out device-id-root-verify.csr \
    -subj "/CN=$verification_code" \
    -days 1
openssl x509 -req \
    -in device-id-root-verify.csr \
    -CA device-id-root.pem -CAkey device-id-root.key.pem \
    -out device-id-root-verify.pem \
    -days 365 -CAcreateserial

# Upload verification cert to IoT Hub
az iot hub certificate verify \
    --hub-name "$IOT_HUB_NAME" --name device-id-root \
    --path $PWD/device-id-root-verify.pem \
    --etag "$etag"

# Clean up verification cert
rm -f \
    device-id-root-verify.key.pem \
    device-id-root-verify.csr \
    device-id-root-verify.pem

# device-id-root.pem and device-id-root.key.pem are no ready
# to be used to issue device ID certs.

# ---

# To manually issue a device ID cert signed by this CA cert:

# Create device identity with X.509-CA auth mode
az iot hub device-identity create \
    --hub-name "$IOT_HUB_NAME" --device-id "$IOT_DEVICE_ID" \
    --auth-method x509_ca

# Generate CSR for device ID cert and sign it
# with the root CA to get the device ID cert.
rm -f \
    device-id.key.pem \
    device-id.csr \
    device-id.pem
openssl req \
    -newkey rsa:2048 -keyout device-id.key.pem -nodes \
    -out device-id.csr \
    -subj "/CN=$IOT_DEVICE_ID" \
    -days 1
openssl x509 -req \
    -in device-id.csr \
    -CA device-id-root.pem -CAkey device-id-root.key.pem \
    -out device-id.pem \
    -days 365 -CAcreateserial

# Clean up device ID CSR
rm -f device-id.csr
```
