<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="2298px" preserveAspectRatio="none" style="width:2081px;height:2298px;" version="1.1" viewBox="0 0 2081 2298" width="2081px" zoomAndPan="magnify"><defs><filter height="300%" id="fu0bg1xfo7bex" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="167" x="958" y="27.4023">Device Provisioning</text><rect fill="#ADD8E6" height="2247.875" style="stroke: #A80036; stroke-width: 1.0;" width="930" x="634.5" y="39.1992"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="45" x="1075" y="51.7676">Device</text><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="113.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="49.5" y="507.7246"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="113.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="49.5" y="968.7617"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="49.5" y="1294.5566"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="130.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="270.5" y="2051.0332"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="587.5" y="2122.6543"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="401.7266" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="694" y="1814.8594"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1172" y="221.2402"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1172" y="406.793"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1172" y="766.8984"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1172" y="867.8301"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1172" y="1368.1328"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1172" y="1511.375"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1172" y="1849.1699"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="1585.6191" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1482" y="167.6191"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="40.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1487" y="287.8613"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="40.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1487" y="658.9668"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="40.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1487" y="1120.0039"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="40.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1487" y="1434.7539"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="40.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1487" y="1662.6172"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1482" y="1950.1016"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="531.6582" style="stroke: #000000; stroke-width: 2.0;" width="2019" x="23" y="182.6191"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="489.3477" style="stroke: #000000; stroke-width: 2.0;" width="2007" x="23" y="728.2773"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="493.3027" style="stroke: #000000; stroke-width: 2.0;" width="2057" x="13" y="1231.625"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="461.9922" style="stroke: #000000; stroke-width: 2.0;" width="2037" x="23" y="1255.9355"/><rect fill="#FFFFFF" height="386.0605" style="stroke: none; stroke-width: 1.0;" width="2037" x="23" y="1331.8672"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="463.3477" style="stroke: #000000; stroke-width: 2.0;" width="1327" x="243.5" y="1768.2383"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="54" x2="54" y1="93.998" y2="2248.5859"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="275.5" x2="275.5" y1="93.998" y2="2248.5859"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="592.5" x2="592.5" y1="93.998" y2="2248.5859"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="698.5" x2="698.5" y1="93.998" y2="2248.5859"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1176.5" x2="1176.5" y1="93.998" y2="2248.5859"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1486.5" x2="1486.5" y1="93.998" y2="2248.5859"/><rect fill="#FEFECE" filter="url(#fu0bg1xfo7bex)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="39" x="33" y="58.5098"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="25" x="40" y="79.0449">EST</text><rect fill="#FEFECE" filter="url(#fu0bg1xfo7bex)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="39" x="33" y="2247.5859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="25" x="40" y="2268.1211">EST</text><rect fill="#FEFECE" filter="url(#fu0bg1xfo7bex)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="40" x="253.5" y="58.5098"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="26" x="260.5" y="79.0449">DPS</text><rect fill="#FEFECE" filter="url(#fu0bg1xfo7bex)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="40" x="253.5" y="2247.5859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="26" x="260.5" y="2268.1211">DPS</text><rect fill="#FEFECE" filter="url(#fu0bg1xfo7bex)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="68" x="556.5" y="58.5098"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="54" x="563.5" y="79.0449">IoT Hub</text><rect fill="#FEFECE" filter="url(#fu0bg1xfo7bex)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="68" x="556.5" y="2247.5859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="54" x="563.5" y="2268.1211">IoT Hub</text><rect fill="#FEFECE" filter="url(#fu0bg1xfo7bex)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="117" x="638.5" y="58.5098"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="103" x="645.5" y="79.0449">Identity Service</text><rect fill="#FEFECE" filter="url(#fu0bg1xfo7bex)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="117" x="638.5" y="2247.5859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="103" x="645.5" y="2268.1211">Identity Service</text><rect fill="#FEFECE" filter="url(#fu0bg1xfo7bex)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1126.5" y="58.5098"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="1133.5" y="79.0449">Keys Service</text><rect fill="#FEFECE" filter="url(#fu0bg1xfo7bex)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1126.5" y="2247.5859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="1133.5" y="2268.1211">Keys Service</text><rect fill="#FEFECE" filter="url(#fu0bg1xfo7bex)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="143" x="1413.5" y="58.5098"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="129" x="1420.5" y="79.0449">Certificates Service</text><rect fill="#FEFECE" filter="url(#fu0bg1xfo7bex)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="143" x="1413.5" y="2247.5859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="129" x="1420.5" y="2268.1211">Certificates Service</text><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="113.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="49.5" y="507.7246"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="113.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="49.5" y="968.7617"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="49.5" y="1294.5566"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="130.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="270.5" y="2051.0332"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="587.5" y="2122.6543"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="401.7266" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="694" y="1814.8594"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1172" y="221.2402"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1172" y="406.793"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1172" y="766.8984"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1172" y="867.8301"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1172" y="1368.1328"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1172" y="1511.375"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1172" y="1849.1699"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="1585.6191" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1482" y="167.6191"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="40.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1487" y="287.8613"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="40.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1487" y="658.9668"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="40.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1487" y="1120.0039"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="40.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1487" y="1434.7539"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="40.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1487" y="1662.6172"/><rect fill="#FFFFFF" filter="url(#fu0bg1xfo7bex)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1482" y="1950.1016"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1487" x2="1529" y1="125.3086" y2="125.3086"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1529" x2="1529" y1="125.3086" y2="138.3086"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1488" x2="1529" y1="138.3086" y2="138.3086"/><polygon fill="#A80036" points="1498,134.3086,1488,138.3086,1498,142.3086,1494,138.3086" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1494" y="120.5664">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="380" x="1507" y="120.5664">At first, the bootstrap ID cert is used as the EST identity cert</text><polygon fill="#A80036" points="1470,163.6191,1480,167.6191,1470,171.6191,1474,167.6191" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="699" x2="1476" y1="167.6191" y2="167.6191"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="706" y="162.877">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="719" y="162.877">Get current EST identity cert</text><path d="M23,182.6191 L97,182.6191 L97,189.6191 L87,199.6191 L23,199.6191 L23,182.6191 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="531.6582" style="stroke: #000000; stroke-width: 2.0;" width="2019" x="23" y="182.6191"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="38" y="196.1875">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="249" x="112" y="195.2539">[for creating and renewing EST identity cert]</text><polygon fill="#A80036" points="1193,217.2402,1183,221.2402,1193,225.2402,1189,221.2402" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1187" x2="1481" y1="221.2402" y2="221.2402"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1199" y="216.498">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="1212" y="216.498">Get current EST identity cert's private key</text><polygon fill="#A80036" points="1470,246.5508,1480,250.5508,1470,254.5508,1474,250.5508" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1177" x2="1476" y1="250.5508" y2="250.5508"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1184" y="245.8086">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="1197" y="245.8086">Key handle</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1492" x2="1539" y1="274.8613" y2="274.8613"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1539" x2="1539" y1="274.8613" y2="287.8613"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1498" x2="1539" y1="287.8613" y2="287.8613"/><polygon fill="#A80036" points="1508,283.8613,1498,287.8613,1508,291.8613,1504,287.8613" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1504" y="270.1191">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="1517" y="270.1191">Get current EST identity cert</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1497" x2="1539" y1="327.1719" y2="327.1719"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1539" x2="1539" y1="327.1719" y2="340.1719"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1492" x2="1539" y1="340.1719" y2="340.1719"/><polygon fill="#A80036" points="1502,336.1719,1492,340.1719,1502,344.1719,1498,340.1719" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1504" y="322.4297">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="25" x="1517" y="322.4297">PEM</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1492" x2="1534" y1="364.4824" y2="364.4824"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1534" x2="1534" y1="364.4824" y2="377.4824"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1493" x2="1534" y1="377.4824" y2="377.4824"/><polygon fill="#A80036" points="1503,373.4824,1493,377.4824,1503,381.4824,1499,377.4824" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1499" y="359.7402">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="432" x="1512" y="359.7402">Create TLS client using key handle + PEM (using openssl-engine-ks)</text><polygon fill="#A80036" points="1193,402.793,1183,406.793,1193,410.793,1189,406.793" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1187" x2="1481" y1="406.793" y2="406.793"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1199" y="402.0508">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="215" x="1212" y="402.0508">Generate new asymmetric key pair</text><polygon fill="#A80036" points="1470,432.1035,1480,436.1035,1470,440.1035,1474,436.1035" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1177" x2="1476" y1="436.1035" y2="436.1035"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1184" y="431.3613">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="1197" y="431.3613">Key handle</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1492" x2="1534" y1="465.4141" y2="465.4141"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1534" x2="1534" y1="465.4141" y2="478.4141"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1493" x2="1534" y1="478.4141" y2="478.4141"/><polygon fill="#A80036" points="1503,474.4141,1493,478.4141,1503,482.4141,1499,478.4141" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1499" y="460.6719">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="509" x="1521" y="460.6719">Create CSR for new EST identity cert using key handle (using openssl-engine-ks)</text><polygon fill="#A80036" points="70.5,503.7246,60.5,507.7246,70.5,511.7246,66.5,507.7246" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="64.5" x2="1481" y1="507.7246" y2="507.7246"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="76.5" y="502.9824">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="682" x="98.5" y="502.9824">Connect using TLS client and perform EST enrolment to get a new EST identity cert corresponding to the CSR</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="59.5" x2="101.5" y1="537.0352" y2="537.0352"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="101.5" x2="101.5" y1="537.0352" y2="550.0352"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="60.5" x2="101.5" y1="550.0352" y2="550.0352"/><polygon fill="#A80036" points="70.5,546.0352,60.5,550.0352,70.5,554.0352,66.5,550.0352" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="66.5" y="532.293">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="88.5" y="532.293">Verify client cert against CA</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="59.5" x2="101.5" y1="579.3457" y2="579.3457"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="101.5" x2="101.5" y1="579.3457" y2="592.3457"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="60.5" x2="101.5" y1="592.3457" y2="592.3457"/><polygon fill="#A80036" points="70.5,588.3457,60.5,592.3457,70.5,596.3457,66.5,592.3457" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="66.5" y="574.6035">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="55" x="88.5" y="574.6035">Sign CSR</text><polygon fill="#A80036" points="1470,617.6563,1480,621.6563,1470,625.6563,1474,621.6563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="54.5" x2="1476" y1="621.6563" y2="621.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="61.5" y="616.9141">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="83.5" y="616.9141">Signed cert</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1492" x2="1539" y1="645.9668" y2="645.9668"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1539" x2="1539" y1="645.9668" y2="658.9668"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1498" x2="1539" y1="658.9668" y2="658.9668"/><polygon fill="#A80036" points="1508,654.9668,1498,658.9668,1508,662.9668,1504,658.9668" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1504" y="641.2246">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="386" x="1526" y="641.2246">Import signed cert as the EST identity cert for future requests</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1497" x2="1539" y1="698.2773" y2="698.2773"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1539" x2="1539" y1="698.2773" y2="711.2773"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1492" x2="1539" y1="711.2773" y2="711.2773"/><polygon fill="#A80036" points="1502,707.2773,1492,711.2773,1502,715.2773,1498,711.2773" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1504" y="693.5352">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1530" y="693.5352"/><path d="M23,728.2773 L97,728.2773 L97,735.2773 L87,745.2773 L23,745.2773 L23,728.2773 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="489.3477" style="stroke: #000000; stroke-width: 2.0;" width="2007" x="23" y="728.2773"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="38" y="741.8457">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="411" x="112" y="740.9121">[for creating and renewing device CA cert (if needed to mint other certs)]</text><polygon fill="#A80036" points="1193,762.8984,1183,766.8984,1193,770.8984,1189,766.8984" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1187" x2="1481" y1="766.8984" y2="766.8984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1199" y="762.1563">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="1221" y="762.1563">Get current EST identity cert's private key</text><polygon fill="#A80036" points="1470,792.209,1480,796.209,1470,800.209,1474,796.209" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1177" x2="1476" y1="796.209" y2="796.209"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1184" y="791.4668">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="1206" y="791.4668">Key handle</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1492" x2="1534" y1="825.5195" y2="825.5195"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1534" x2="1534" y1="825.5195" y2="838.5195"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1493" x2="1534" y1="838.5195" y2="838.5195"/><polygon fill="#A80036" points="1503,834.5195,1493,838.5195,1503,842.5195,1499,838.5195" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1499" y="820.7773">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="432" x="1521" y="820.7773">Create TLS client using key handle + PEM (using openssl-engine-ks)</text><polygon fill="#A80036" points="1193,863.8301,1183,867.8301,1193,871.8301,1189,867.8301" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1187" x2="1481" y1="867.8301" y2="867.8301"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1199" y="863.0879">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="215" x="1221" y="863.0879">Generate new asymmetric key pair</text><polygon fill="#A80036" points="1470,893.1406,1480,897.1406,1470,901.1406,1474,897.1406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1177" x2="1476" y1="897.1406" y2="897.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1184" y="892.3984">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="1206" y="892.3984">Key handle</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1492" x2="1534" y1="926.4512" y2="926.4512"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1534" x2="1534" y1="926.4512" y2="939.4512"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1493" x2="1534" y1="939.4512" y2="939.4512"/><polygon fill="#A80036" points="1503,935.4512,1493,939.4512,1503,943.4512,1499,939.4512" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1499" y="921.709">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="497" x="1521" y="921.709">Create CSR for new device CA cert using key handle (using openssl-engine-ks)</text><polygon fill="#A80036" points="70.5,964.7617,60.5,968.7617,70.5,972.7617,66.5,968.7617" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="64.5" x2="1481" y1="968.7617" y2="968.7617"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="76.5" y="964.0195">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="577" x="98.5" y="964.0195">Connect using TLS client and send request for new device CA cert corresponding to the CSR</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="59.5" x2="101.5" y1="998.0723" y2="998.0723"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="101.5" x2="101.5" y1="998.0723" y2="1011.0723"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="60.5" x2="101.5" y1="1011.0723" y2="1011.0723"/><polygon fill="#A80036" points="70.5,1007.0723,60.5,1011.0723,70.5,1015.0723,66.5,1011.0723" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="66.5" y="993.3301">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="88.5" y="993.3301">Verify client cert against CA</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="59.5" x2="101.5" y1="1040.3828" y2="1040.3828"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="101.5" x2="101.5" y1="1040.3828" y2="1053.3828"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="60.5" x2="101.5" y1="1053.3828" y2="1053.3828"/><polygon fill="#A80036" points="70.5,1049.3828,60.5,1053.3828,70.5,1057.3828,66.5,1053.3828" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="66.5" y="1035.6406">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="55" x="88.5" y="1035.6406">Sign CSR</text><polygon fill="#A80036" points="1470,1078.6934,1480,1082.6934,1470,1086.6934,1474,1082.6934" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="54.5" x2="1476" y1="1082.6934" y2="1082.6934"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="61.5" y="1077.9512">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="83.5" y="1077.9512">Signed cert</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1492" x2="1539" y1="1107.0039" y2="1107.0039"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1539" x2="1539" y1="1107.0039" y2="1120.0039"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1498" x2="1539" y1="1120.0039" y2="1120.0039"/><polygon fill="#A80036" points="1508,1116.0039,1498,1120.0039,1508,1124.0039,1504,1120.0039" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1504" y="1102.2617">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="252" x="1526" y="1102.2617">Import signed cert as the device CA cert</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1497" x2="1539" y1="1159.3145" y2="1159.3145"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1539" x2="1539" y1="1159.3145" y2="1172.3145"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1492" x2="1539" y1="1172.3145" y2="1172.3145"/><polygon fill="#A80036" points="1502,1168.3145,1492,1172.3145,1502,1176.3145,1498,1172.3145" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1504" y="1154.5723">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1530" y="1154.5723"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1492" x2="1534" y1="1196.625" y2="1196.625"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1534" x2="1534" y1="1196.625" y2="1209.625"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1493" x2="1534" y1="1209.625" y2="1209.625"/><polygon fill="#A80036" points="1503,1205.625,1493,1209.625,1503,1213.625,1499,1209.625" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1499" y="1191.8828">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="363" x="1521" y="1191.8828">Wait for the device CA cert to be near expiry (active timer)</text><path d="M13,1231.625 L87,1231.625 L87,1238.625 L77,1248.625 L13,1248.625 L13,1231.625 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="493.3027" style="stroke: #000000; stroke-width: 2.0;" width="2057" x="13" y="1231.625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="28" y="1245.1934">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="264" x="102" y="1244.2598">[for creating and renewing device identity cert]</text><path d="M23,1255.9355 L85,1255.9355 L85,1262.9355 L75,1272.9355 L23,1272.9355 L23,1255.9355 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="461.9922" style="stroke: #000000; stroke-width: 2.0;" width="2037" x="23" y="1255.9355"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="38" y="1269.5039">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="337" x="100" y="1268.5703">[if user configured device identity to be obtained from EST]</text><polygon fill="#A80036" points="70.5,1290.5566,60.5,1294.5566,70.5,1298.5566,66.5,1294.5566" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="64.5" x2="1481" y1="1294.5566" y2="1294.5566"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="76.5" y="1289.8145">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="271" x="98.5" y="1289.8145">Similar process as for device CA cert above</text><polygon fill="#A80036" points="1470,1319.8672,1480,1323.8672,1470,1327.8672,1474,1323.8672" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="54.5" x2="1476" y1="1323.8672" y2="1323.8672"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="61.5" y="1319.125">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="83.5" y="1319.125">Signed cert</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="23" x2="2060" y1="1332.8672" y2="1332.8672"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="312" x="28" y="1343.502">[if user configured device identity to be minted locally]</text><polygon fill="#A80036" points="1193,1364.1328,1183,1368.1328,1193,1372.1328,1189,1368.1328" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1187" x2="1481" y1="1368.1328" y2="1368.1328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1199" y="1363.3906">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="247" x="1221" y="1363.3906">Get current device CA cert's private key</text><polygon fill="#A80036" points="1470,1393.4434,1480,1397.4434,1470,1401.4434,1474,1397.4434" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1177" x2="1476" y1="1397.4434" y2="1397.4434"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1184" y="1392.7012">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="1206" y="1392.7012">Key handle</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1492" x2="1539" y1="1421.7539" y2="1421.7539"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1539" x2="1539" y1="1421.7539" y2="1434.7539"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1498" x2="1539" y1="1434.7539" y2="1434.7539"/><polygon fill="#A80036" points="1508,1430.7539,1498,1434.7539,1508,1438.7539,1504,1434.7539" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1504" y="1417.0117">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="1526" y="1417.0117">Get current device CA cert</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1497" x2="1539" y1="1474.0645" y2="1474.0645"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1539" x2="1539" y1="1474.0645" y2="1487.0645"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1492" x2="1539" y1="1487.0645" y2="1487.0645"/><polygon fill="#A80036" points="1502,1483.0645,1492,1487.0645,1502,1491.0645,1498,1487.0645" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1504" y="1469.3223">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="25" x="1526" y="1469.3223">PEM</text><polygon fill="#A80036" points="1193,1507.375,1183,1511.375,1193,1515.375,1189,1511.375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1187" x2="1481" y1="1511.375" y2="1511.375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1199" y="1506.6328">36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="215" x="1221" y="1506.6328">Generate new asymmetric key pair</text><polygon fill="#A80036" points="1470,1536.6855,1480,1540.6855,1470,1544.6855,1474,1540.6855" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1177" x2="1476" y1="1540.6855" y2="1540.6855"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1184" y="1535.9434">37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="1206" y="1535.9434">Key handle</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1492" x2="1534" y1="1569.9961" y2="1569.9961"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1534" x2="1534" y1="1569.9961" y2="1582.9961"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1493" x2="1534" y1="1582.9961" y2="1582.9961"/><polygon fill="#A80036" points="1503,1578.9961,1493,1582.9961,1503,1586.9961,1499,1582.9961" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1499" y="1565.2539">38</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="527" x="1521" y="1565.2539">Create CSR for new device identity cert using key handle (using openssl-engine-ks)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1492" x2="1534" y1="1612.3066" y2="1612.3066"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1534" x2="1534" y1="1612.3066" y2="1625.3066"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1493" x2="1534" y1="1625.3066" y2="1625.3066"/><polygon fill="#A80036" points="1503,1621.3066,1493,1625.3066,1503,1629.3066,1499,1625.3066" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1499" y="1607.5645">39</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="188" x="1521" y="1607.5645">Sign CSR using device CA cert</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1492" x2="1539" y1="1649.6172" y2="1649.6172"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1539" x2="1539" y1="1649.6172" y2="1662.6172"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1498" x2="1539" y1="1662.6172" y2="1662.6172"/><polygon fill="#A80036" points="1508,1658.6172,1498,1662.6172,1508,1666.6172,1504,1662.6172" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1504" y="1644.875">40</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="282" x="1526" y="1644.875">Import signed cert as the device identity cert</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1497" x2="1539" y1="1701.9277" y2="1701.9277"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1539" x2="1539" y1="1701.9277" y2="1714.9277"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1492" x2="1539" y1="1714.9277" y2="1714.9277"/><polygon fill="#A80036" points="1502,1710.9277,1492,1714.9277,1502,1718.9277,1498,1714.9277" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1504" y="1697.1855">41</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1530" y="1697.1855"/><polygon fill="#A80036" points="710,1749.2383,700,1753.2383,710,1757.2383,706,1753.2383" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="704" x2="1486" y1="1753.2383" y2="1753.2383"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="716" y="1748.4961">42</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="25" x="738" y="1748.4961">PEM</text><path d="M243.5,1768.2383 L317.5,1768.2383 L317.5,1775.2383 L307.5,1785.2383 L243.5,1785.2383 L243.5,1768.2383 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="463.3477" style="stroke: #000000; stroke-width: 2.0;" width="1327" x="243.5" y="1768.2383"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="258.5" y="1781.8066">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="332.5" y="1780.873">[for (re-)provisioning]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="699" x2="746" y1="1801.8594" y2="1801.8594"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="746" x2="746" y1="1801.8594" y2="1814.8594"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="705" x2="746" y1="1814.8594" y2="1814.8594"/><polygon fill="#A80036" points="715,1810.8594,705,1814.8594,715,1818.8594,711,1814.8594" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="711" y="1797.1172">43</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="733" y="1797.1172">Request provisioning</text><polygon fill="#A80036" points="1160,1845.1699,1170,1849.1699,1160,1853.1699,1164,1849.1699" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="704" x2="1166" y1="1849.1699" y2="1849.1699"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="711" y="1844.4277">44</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="733" y="1844.4277">Get current device identity cert's private key</text><polygon fill="#A80036" points="715,1874.4805,705,1878.4805,715,1882.4805,711,1878.4805" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="709" x2="1176" y1="1878.4805" y2="1878.4805"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="721" y="1873.7383">45</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="743" y="1873.7383">Key handle</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="704" x2="746" y1="1907.791" y2="1907.791"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="746" x2="746" y1="1907.791" y2="1920.791"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="705" x2="746" y1="1920.791" y2="1920.791"/><polygon fill="#A80036" points="715,1916.791,705,1920.791,715,1924.791,711,1920.791" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="711" y="1903.0488">46</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="733" y="1903.0488">Check EST identity cert validity</text><polygon fill="#A80036" points="1470,1946.1016,1480,1950.1016,1470,1954.1016,1474,1950.1016" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="704" x2="1476" y1="1950.1016" y2="1950.1016"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="711" y="1945.3594">47</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="733" y="1945.3594">Get current device identity cert</text><polygon fill="#A80036" points="715,1975.4121,705,1979.4121,715,1983.4121,711,1979.4121" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="709" x2="1486" y1="1979.4121" y2="1979.4121"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="721" y="1974.6699">48</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="25" x="743" y="1974.6699">PEM</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="704" x2="746" y1="2008.7227" y2="2008.7227"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="746" x2="746" y1="2008.7227" y2="2021.7227"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="705" x2="746" y1="2021.7227" y2="2021.7227"/><polygon fill="#A80036" points="715,2017.7227,705,2021.7227,715,2025.7227,711,2021.7227" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="711" y="2003.9805">49</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="432" x="733" y="2003.9805">Create TLS client using key handle + PEM (using openssl-engine-ks)</text><polygon fill="#A80036" points="291.5,2047.0332,281.5,2051.0332,291.5,2055.0332,287.5,2051.0332" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="285.5" x2="693" y1="2051.0332" y2="2051.0332"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="297.5" y="2046.291">50</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="351" x="319.5" y="2046.291">Connect using TLS client and send provisioning request</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="280.5" x2="322.5" y1="2080.3438" y2="2080.3438"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="322.5" x2="322.5" y1="2080.3438" y2="2093.3438"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="281.5" x2="322.5" y1="2093.3438" y2="2093.3438"/><polygon fill="#A80036" points="291.5,2089.3438,281.5,2093.3438,291.5,2097.3438,287.5,2093.3438" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="287.5" y="2075.6016">51</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="271" x="309.5" y="2075.6016">Verify client cert against device identity CA</text><polygon fill="#A80036" points="575.5,2118.6543,585.5,2122.6543,575.5,2126.6543,579.5,2122.6543" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="280.5" x2="581.5" y1="2122.6543" y2="2122.6543"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="287.5" y="2117.9121">52</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="309.5" y="2117.9121">Register device</text><polygon fill="#A80036" points="291.5,2147.9648,281.5,2151.9648,291.5,2155.9648,287.5,2151.9648" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="285.5" x2="591.5" y1="2151.9648" y2="2151.9648"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="297.5" y="2147.2227">53</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="323.5" y="2147.2227"/><polygon fill="#A80036" points="682,2177.2754,692,2181.2754,682,2185.2754,686,2181.2754" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="275.5" x2="688" y1="2181.2754" y2="2181.2754"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="282.5" y="2176.5332">54</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="279" x="304.5" y="2176.5332">Provisioning info (IoT Hub + device identity)</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="704" x2="746" y1="2215.5859" y2="2215.5859"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="746" x2="746" y1="2215.5859" y2="2228.5859"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="699" x2="746" y1="2228.5859" y2="2228.5859"/><polygon fill="#A80036" points="709,2224.5859,699,2228.5859,709,2232.5859,705,2228.5859" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="711" y="2210.8438">55</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="733" y="2210.8438">Ok(ProvisioningDone)</text><!--MD5=[90d8e8637b8b5d9d63f66ecf1211897b]
@startuml

title Device Provisioning

participant "EST" as est
participant "DPS" as dps
participant "IoT Hub" as hub

box Device #LightBlue
	participant "Identity Service" as is
	participant "Keys Service" as ks
	participant "Certificates Service" as cs
end box

autonumber

cs -> cs: At first, the bootstrap ID cert is used as the EST identity cert

is -> cs ++: Get current EST identity cert
loop for creating and renewing EST identity cert
	cs -> ks ++: Get current EST identity cert's private key
	return Key handle
	cs -> cs ++: Get current EST identity cert
	return PEM
	cs -> cs: Create TLS client using key handle + PEM (using openssl-engine-ks)

	cs -> ks ++: Generate new asymmetric key pair
	return Key handle
	cs -> cs: Create CSR for new EST identity cert using key handle (using openssl-engine-ks)

	cs -> est ++: Connect using TLS client and perform EST enrolment to get a new EST identity cert corresponding to the CSR
	est -> est: Verify client cert against CA
	est -> est: Sign CSR
	return Signed cert
	cs -> cs ++: Import signed cert as the EST identity cert for future requests
	return
end

loop for creating and renewing device CA cert (if needed to mint other certs)
	cs -> ks ++: Get current EST identity cert's private key
	return Key handle
	cs -> cs: Create TLS client using key handle + PEM (using openssl-engine-ks)

	cs -> ks ++: Generate new asymmetric key pair
	return Key handle
	cs -> cs: Create CSR for new device CA cert using key handle (using openssl-engine-ks)

	cs -> est ++: Connect using TLS client and send request for new device CA cert corresponding to the CSR
	est -> est: Verify client cert against CA
	est -> est: Sign CSR
	return Signed cert
	cs -> cs ++: Import signed cert as the device CA cert
	return
	cs -> cs: Wait for the device CA cert to be near expiry (active timer)
end

loop for creating and renewing device identity cert
	alt if user configured device identity to be obtained from EST
		cs -> est ++: Similar process as for device CA cert above
		return Signed cert

	else if user configured device identity to be minted locally
		cs -> ks ++: Get current device CA cert's private key
		return Key handle
		cs -> cs ++: Get current device CA cert
		return PEM

		cs -> ks ++: Generate new asymmetric key pair
		return Key handle
		cs -> cs: Create CSR for new device identity cert using key handle (using openssl-engine-ks)
		cs -> cs: Sign CSR using device CA cert

		cs -> cs ++: Import signed cert as the device identity cert
		return
	end
end
return PEM

loop for (re-)provisioning
	is -> is ++: Request provisioning
	is -> ks ++: Get current device identity cert's private key
	return Key handle
	is -> is: Check EST identity cert validity
	is -> cs ++: Get current device identity cert
	return PEM
	is -> is: Create TLS client using key handle + PEM (using openssl-engine-ks)
	is -> dps ++: Connect using TLS client and send provisioning request
	dps -> dps: Verify client cert against device identity CA
	dps -> hub ++: Register device
	return
	return Provisioning info (IoT Hub + device identity)
	return Ok(ProvisioningDone)
end


@enduml

PlantUML version 1.2020.10(Sun May 17 02:35:57 PDT 2020)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 13.0.1+9
Operating System: Mac OS X
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>