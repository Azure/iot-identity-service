<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="6857px" preserveAspectRatio="none" style="width:1993px;height:6857px;" version="1.1" viewBox="0 0 1993 6857" width="1993px" zoomAndPan="magnify"><defs><filter height="300%" id="f1jxt8w6krzj03" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="150" x="919.75" y="30.6855">Runtime Operation</text><rect fill="#ADD8E6" height="6808.625" style="stroke:#A80036;stroke-width:1.0;" width="1440" x="533.5" y="42.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="1230" y="56.1357">Device</text><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="133.4063" style="stroke:#A80036;stroke-width:1.0;" width="10" x="213.5" y="5172.4688"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="70.7031" style="stroke:#A80036;stroke-width:1.0;" width="10" x="399.5" y="938.8125"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="139.1094" style="stroke:#A80036;stroke-width:1.0;" width="10" x="399.5" y="1673.6563"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="399.5" y="2257.4453"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="139.1094" style="stroke:#A80036;stroke-width:1.0;" width="10" x="399.5" y="2913.4922"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="399.5" y="3089.9531"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="399.5" y="3505.2813"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="139.1094" style="stroke:#A80036;stroke-width:1.0;" width="10" x="399.5" y="6615.9375"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="386.625" style="stroke:#A80036;stroke-width:1.0;" width="10" x="592.5" y="2436.8125"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="403.9766" style="stroke:#A80036;stroke-width:1.0;" width="10" x="592.5" y="3192.3594"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="592.5" y="3626.6875"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="193.1094" style="stroke:#A80036;stroke-width:1.0;" width="10" x="592.5" y="4108.4922"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="1308.4375" style="stroke:#A80036;stroke-width:1.0;" width="10" x="592.5" y="4347.7891"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="189.1641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="592.5" y="5903.3906"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="386.625" style="stroke:#A80036;stroke-width:1.0;" width="10" x="592.5" y="6139.2578"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="195.4609" style="stroke:#A80036;stroke-width:1.0;" width="10" x="790.5" y="597.2422"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="233.5156" style="stroke:#A80036;stroke-width:1.0;" width="10" x="790.5" y="1137.2734"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="419.3281" style="stroke:#A80036;stroke-width:1.0;" width="10" x="790.5" y="1898.8203"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="293.2188" style="stroke:#A80036;stroke-width:1.0;" width="10" x="790.5" y="2499.8672"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="326.9219" style="stroke:#A80036;stroke-width:1.0;" width="10" x="790.5" y="3239.0625"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="79.4063" style="stroke:#A80036;stroke-width:1.0;" width="10" x="790.5" y="5933.7422"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="293.2188" style="stroke:#A80036;stroke-width:1.0;" width="10" x="790.5" y="6202.3125"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="992.5" y="276.3203"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="992.5" y="386.0781"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="992.5" y="495.8359"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="992.5" y="648.9453"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="992.5" y="1183.9766"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="992.5" y="1293.7344"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="992.5" y="1460.8438"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="992.5" y="1945.5234"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="992.5" y="2071.6328"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="992.5" y="2546.5703"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="992.5" y="2672.6797"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="992.5" y="3285.7656"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="992.5" y="3411.875"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="992.5" y="4883.6016"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="992.5" y="5368.4141"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="992.5" y="6249.0156"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="992.5" y="6375.125"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1183.5" y="726"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="933.7344" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1183.5" y="4692.1406"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="781.9766" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1188.5" y="4806.5469"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="41.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1193.5" y="4968.6563"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="41.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1193.5" y="5437.1172"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="890.3047" style="stroke:#000000;stroke-width:2.0;" width="927.5" x="351" y="134.2109"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="798.25" style="stroke:#000000;stroke-width:2.0;" width="907.5" x="361" y="219.2656"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="789.25" style="stroke:#000000;stroke-width:2.0;" width="1226.5" x="351" y="1038.5156"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="756.8984" style="stroke:#000000;stroke-width:2.0;" width="1206.5" x="361" y="1063.8672"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="1941.1016" style="stroke:#000000;stroke-width:2.0;" width="1628.5" x="351" y="1841.7656"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="680.8438" style="stroke:#000000;stroke-width:2.0;" width="1386.5" x="361" y="2379.7578"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="529.7344" style="stroke:#000000;stroke-width:2.0;" width="1255.5" x="361" y="3135.3047"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="2980.1797" style="stroke:#000000;stroke-width:2.0;" width="1944.5" x="10" y="3796.8672"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="2001.1172" style="stroke:#000000;stroke-width:2.0;" width="1780.5" x="20" y="3822.2188"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="1748.5469" style="stroke:#000000;stroke-width:2.0;" width="1614.5" x="176" y="4067.7891"/><rect fill="#FFFFFF" height="1506.7344" style="stroke:none;stroke-width:1.0;" width="1614.5" x="176" y="4309.6016"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="223.9453" style="stroke:#000000;stroke-width:2.0;" width="291" x="527.5" y="4362.7891"/><rect fill="#FFFFFF" height="118.8906" style="stroke:none;stroke-width:1.0;" width="291" x="527.5" y="4467.8438"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="726.625" style="stroke:#000000;stroke-width:2.0;" width="1198.5" x="186" y="4826.5469"/><rect fill="#FFFFFF" height="239.2969" style="stroke:none;stroke-width:1.0;" width="1198.5" x="186" y="5313.875"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="932.7109" style="stroke:#000000;stroke-width:2.0;" width="1593.5" x="351" y="5837.3359"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="900.3594" style="stroke:#000000;stroke-width:2.0;" width="1573.5" x="361" y="5862.6875"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="218" x2="218" y1="117.2109" y2="6794.0469"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="404" x2="404" y1="117.2109" y2="6794.0469"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="597.5" x2="597.5" y1="117.2109" y2="6794.0469"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="795.5" x2="795.5" y1="117.2109" y2="6794.0469"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="997.5" x2="997.5" y1="117.2109" y2="6794.0469"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1188.5" x2="1188.5" y1="117.2109" y2="6794.0469"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1382" x2="1382" y1="117.2109" y2="6794.0469"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1562.5" x2="1562.5" y1="2359.4531" y2="6794.0469"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1742.5" x2="1742.5" y1="3705.3438" y2="6794.0469"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1929.5" x2="1929.5" y1="3760.7578" y2="6794.0469"/><rect fill="#FEFECE" filter="url(#f1jxt8w6krzj03)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="41" x="196" y="80.6016"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="27" x="203" y="102.1348">EST</text><rect fill="#FEFECE" filter="url(#f1jxt8w6krzj03)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="41" x="196" y="6793.0469"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="27" x="203" y="6814.5801">EST</text><rect fill="#FEFECE" filter="url(#f1jxt8w6krzj03)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="63" x="371" y="80.6016"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="49" x="378" y="102.1348">IoT Hub</text><rect fill="#FEFECE" filter="url(#f1jxt8w6krzj03)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="63" x="371" y="6793.0469"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="49" x="378" y="6814.5801">IoT Hub</text><rect fill="#FEFECE" filter="url(#f1jxt8w6krzj03)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="116" x="537.5" y="80.6016"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="102" x="544.5" y="102.1348">Module Runtime</text><rect fill="#FEFECE" filter="url(#f1jxt8w6krzj03)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="116" x="537.5" y="6793.0469"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="102" x="544.5" y="6814.5801">Module Runtime</text><rect fill="#FEFECE" filter="url(#f1jxt8w6krzj03)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="110" x="738.5" y="80.6016"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="96" x="745.5" y="102.1348">Identity Service</text><rect fill="#FEFECE" filter="url(#f1jxt8w6krzj03)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="110" x="738.5" y="6793.0469"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="96" x="745.5" y="6814.5801">Identity Service</text><rect fill="#FEFECE" filter="url(#f1jxt8w6krzj03)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="96" x="947.5" y="80.6016"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="954.5" y="102.1348">Keys Service</text><rect fill="#FEFECE" filter="url(#f1jxt8w6krzj03)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="96" x="947.5" y="6793.0469"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="954.5" y="6814.5801">Keys Service</text><rect fill="#FEFECE" filter="url(#f1jxt8w6krzj03)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="136" x="1118.5" y="80.6016"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="122" x="1125.5" y="102.1348">Certificates Service</text><rect fill="#FEFECE" filter="url(#f1jxt8w6krzj03)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="136" x="1118.5" y="6793.0469"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="122" x="1125.5" y="6814.5801">Certificates Service</text><rect fill="#FEFECE" filter="url(#f1jxt8w6krzj03)" height="49.2188" style="stroke:#A80036;stroke-width:1.5;" width="97" x="1332" y="62.9922"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="1339" y="84.5254">Host Process</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="46" x="1357.5" y="102.1348">Module</text><rect fill="#FEFECE" filter="url(#f1jxt8w6krzj03)" height="49.2188" style="stroke:#A80036;stroke-width:1.5;" width="97" x="1332" y="6793.0469"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="1339" y="6814.5801">Host Process</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="46" x="1357.5" y="6832.1895">Module</text><rect fill="#FEFECE" filter="url(#f1jxt8w6krzj03)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="84" x="1518.5" y="6793.0469"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="70" x="1525.5" y="6814.5801">EdgeAgent</text><rect fill="#FEFECE" filter="url(#f1jxt8w6krzj03)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="72" x="1704.5" y="6793.0469"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="58" x="1711.5" y="6814.5801">EdgeHub</text><rect fill="#FEFECE" filter="url(#f1jxt8w6krzj03)" height="49.2188" style="stroke:#A80036;stroke-width:1.5;" width="76" x="1889.5" y="6793.0469"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="62" x="1896.5" y="6814.5801">Container</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="46" x="1904.5" y="6832.1895">Module</text><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="133.4063" style="stroke:#A80036;stroke-width:1.0;" width="10" x="213.5" y="5172.4688"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="70.7031" style="stroke:#A80036;stroke-width:1.0;" width="10" x="399.5" y="938.8125"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="139.1094" style="stroke:#A80036;stroke-width:1.0;" width="10" x="399.5" y="1673.6563"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="399.5" y="2257.4453"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="139.1094" style="stroke:#A80036;stroke-width:1.0;" width="10" x="399.5" y="2913.4922"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="399.5" y="3089.9531"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="399.5" y="3505.2813"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="139.1094" style="stroke:#A80036;stroke-width:1.0;" width="10" x="399.5" y="6615.9375"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="386.625" style="stroke:#A80036;stroke-width:1.0;" width="10" x="592.5" y="2436.8125"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="403.9766" style="stroke:#A80036;stroke-width:1.0;" width="10" x="592.5" y="3192.3594"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="592.5" y="3626.6875"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="193.1094" style="stroke:#A80036;stroke-width:1.0;" width="10" x="592.5" y="4108.4922"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="1308.4375" style="stroke:#A80036;stroke-width:1.0;" width="10" x="592.5" y="4347.7891"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="189.1641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="592.5" y="5903.3906"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="386.625" style="stroke:#A80036;stroke-width:1.0;" width="10" x="592.5" y="6139.2578"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="195.4609" style="stroke:#A80036;stroke-width:1.0;" width="10" x="790.5" y="597.2422"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="233.5156" style="stroke:#A80036;stroke-width:1.0;" width="10" x="790.5" y="1137.2734"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="419.3281" style="stroke:#A80036;stroke-width:1.0;" width="10" x="790.5" y="1898.8203"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="293.2188" style="stroke:#A80036;stroke-width:1.0;" width="10" x="790.5" y="2499.8672"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="326.9219" style="stroke:#A80036;stroke-width:1.0;" width="10" x="790.5" y="3239.0625"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="79.4063" style="stroke:#A80036;stroke-width:1.0;" width="10" x="790.5" y="5933.7422"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="293.2188" style="stroke:#A80036;stroke-width:1.0;" width="10" x="790.5" y="6202.3125"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="992.5" y="276.3203"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="992.5" y="386.0781"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="992.5" y="495.8359"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="992.5" y="648.9453"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="992.5" y="1183.9766"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="992.5" y="1293.7344"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="992.5" y="1460.8438"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="992.5" y="1945.5234"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="992.5" y="2071.6328"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="992.5" y="2546.5703"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="992.5" y="2672.6797"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="992.5" y="3285.7656"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="992.5" y="3411.875"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="992.5" y="4883.6016"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="992.5" y="5368.4141"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="992.5" y="6249.0156"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="992.5" y="6375.125"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1183.5" y="726"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="933.7344" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1183.5" y="4692.1406"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="781.9766" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1188.5" y="4806.5469"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="41.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1193.5" y="4968.6563"/><rect fill="#FFFFFF" filter="url(#f1jxt8w6krzj03)" height="41.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1193.5" y="5437.1172"/><path d="M351,134.2109 L598,134.2109 L598,142.2109 L588,152.2109 L351,152.2109 L351,134.2109 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="890.3047" style="stroke:#000000;stroke-width:2.0;" width="927.5" x="351" y="134.2109"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="202" x="366" y="148.7061">Host-level modules provisioning</text><line style="stroke:#A80036;stroke-width:1.0;" x1="795.5" x2="837.5" y1="191.2656" y2="191.2656"/><line style="stroke:#A80036;stroke-width:1.0;" x1="837.5" x2="837.5" y1="191.2656" y2="204.2656"/><line style="stroke:#A80036;stroke-width:1.0;" x1="796.5" x2="837.5" y1="204.2656" y2="204.2656"/><polygon fill="#A80036" points="806.5,200.2656,796.5,204.2656,806.5,208.2656,802.5,204.2656" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="802.5" y="178.2334">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="813.5" y="170.0576">Read host-level module</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="813.5" y="186.4092">names from configuration</text><path d="M361,219.2656 L434,219.2656 L434,227.2656 L424,237.2656 L361,237.2656 L361,219.2656 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="798.25" style="stroke:#000000;stroke-width:2.0;" width="907.5" x="361" y="219.2656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="376" y="233.7607">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="217" x="449" y="232.6846">[for creating each host-level module M]</text><polygon fill="#A80036" points="980.5,272.3203,990.5,276.3203,980.5,280.3203,984.5,276.3203" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="795.5" x2="986.5" y1="276.3203" y2="276.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="802.5" y="263.2881">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="813.5" y="255.1123">Create/Get master</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="813.5" y="271.4639">identity symmetric key</text><polygon fill="#A80036" points="806.5,302.6719,796.5,306.6719,806.5,310.6719,802.5,306.6719" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="800.5" x2="996.5" y1="306.6719" y2="306.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="812.5" y="301.8154">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="823.5" y="301.8154">Key handle</text><polygon fill="#A80036" points="980.5,382.0781,990.5,386.0781,980.5,390.0781,984.5,386.0781" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="795.5" x2="986.5" y1="386.0781" y2="386.0781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="802.5" y="356.6943">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="813.5" y="332.167">Create module derived</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="813.5" y="348.5186">key object for module M</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="813.5" y="364.8701">(based on master identity</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="67" x="813.5" y="381.2217">key handle)</text><polygon fill="#A80036" points="806.5,412.4297,796.5,416.4297,806.5,420.4297,802.5,416.4297" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="800.5" x2="996.5" y1="416.4297" y2="416.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="812.5" y="411.5732">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="827.5" y="411.5732"/><polygon fill="#A80036" points="980.5,491.8359,990.5,495.8359,980.5,499.8359,984.5,495.8359" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="795.5" x2="986.5" y1="495.8359" y2="495.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="802.5" y="466.4521">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="813.5" y="441.9248">Derive and Sign module</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="813.5" y="458.2764">M's SAS key using name</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="813.5" y="474.6279">+ generation ID (with</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="813.5" y="490.9795">derived key handle)</text><polygon fill="#A80036" points="806.5,522.1875,796.5,526.1875,806.5,530.1875,802.5,526.1875" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="800.5" x2="996.5" y1="526.1875" y2="526.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="812.5" y="521.3311">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="827.5" y="521.3311"/><line style="stroke:#A80036;stroke-width:1.0;" x1="795.5" x2="842.5" y1="584.2422" y2="584.2422"/><line style="stroke:#A80036;stroke-width:1.0;" x1="842.5" x2="842.5" y1="584.2422" y2="597.2422"/><line style="stroke:#A80036;stroke-width:1.0;" x1="801.5" x2="842.5" y1="597.2422" y2="597.2422"/><polygon fill="#A80036" points="811.5,593.2422,801.5,597.2422,811.5,601.2422,807.5,597.2422" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="807.5" y="563.0342">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="818.5" y="546.6826">Get current device</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="818.5" y="563.0342">identity cert and key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="38" x="818.5" y="579.3857">handle</text><polygon fill="#A80036" points="980.5,644.9453,990.5,648.9453,980.5,652.9453,984.5,648.9453" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="800.5" x2="986.5" y1="648.9453" y2="648.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="807.5" y="635.9131">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="818.5" y="627.7373">Get current device</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="818.5" y="644.0889">identity cert's private key</text><polygon fill="#A80036" points="811.5,675.2969,801.5,679.2969,811.5,683.2969,807.5,679.2969" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="805.5" x2="996.5" y1="679.2969" y2="679.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="817.5" y="674.4404">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="835.5" y="674.4404">Key handle</text><polygon fill="#A80036" points="1171.5,722,1181.5,726,1171.5,730,1175.5,726" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="800.5" x2="1177.5" y1="726" y2="726"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="807.5" y="712.9678">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="825.5" y="704.792">Get current device</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="825.5" y="721.1436">identity cert</text><polygon fill="#A80036" points="811.5,752.3516,801.5,756.3516,811.5,760.3516,807.5,756.3516" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="805.5" x2="1187.5" y1="756.3516" y2="756.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="817.5" y="751.4951">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="29" x="835.5" y="751.4951">PEM</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="800.5" x2="842.5" y1="791.7031" y2="791.7031"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="842.5" x2="842.5" y1="791.7031" y2="804.7031"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="795.5" x2="842.5" y1="804.7031" y2="804.7031"/><polygon fill="#A80036" points="805.5,800.7031,795.5,804.7031,805.5,808.7031,801.5,804.7031" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="807.5" y="786.8467">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="829.5" y="786.8467"/><line style="stroke:#A80036;stroke-width:1.0;" x1="795.5" x2="837.5" y1="862.7578" y2="862.7578"/><line style="stroke:#A80036;stroke-width:1.0;" x1="837.5" x2="837.5" y1="862.7578" y2="875.7578"/><line style="stroke:#A80036;stroke-width:1.0;" x1="796.5" x2="837.5" y1="875.7578" y2="875.7578"/><polygon fill="#A80036" points="806.5,871.7578,796.5,875.7578,806.5,879.7578,802.5,875.7578" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="802.5" y="841.5498">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="820.5" y="825.1982">Create TLS client using</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="820.5" y="841.5498">key handle + PEM (using</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="820.5" y="857.9014">openssl-engine-ks)</text><polygon fill="#A80036" points="420.5,934.8125,410.5,938.8125,420.5,942.8125,416.5,938.8125" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="414.5" x2="794.5" y1="938.8125" y2="938.8125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="426.5" y="917.6045">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="444.5" y="901.2529">Create identity for module</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="444.5" y="917.6045">M and register the derived</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="444.5" y="933.9561">SAS keys for it</text><path d="M525,951.8125 L525,977.8125 L1061,977.8125 L1061,961.8125 L1051,951.8125 L525,951.8125 " fill="#FBFB77" filter="url(#f1jxt8w6krzj03)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1051,951.8125 L1051,961.8125 L1061,961.8125 L1051,951.8125 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="515" x="531" y="970.3076">If IoTHub call ever fails with bad credential, IS requests provisioning (with reprovision=true)</text><polygon fill="#A80036" points="783.5,1005.5156,793.5,1009.5156,783.5,1013.5156,787.5,1009.5156" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="404.5" x2="789.5" y1="1009.5156" y2="1009.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="411.5" y="1004.6592">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="433.5" y="1004.6592"/><path d="M351,1038.5156 L639,1038.5156 L639,1046.5156 L629,1056.5156 L351,1056.5156 L351,1038.5156 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="789.25" style="stroke:#000000;stroke-width:2.0;" width="1226.5" x="351" y="1038.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="243" x="366" y="1053.0107">Host-level modules process operations</text><path d="M361,1063.8672 L434,1063.8672 L434,1071.8672 L424,1081.8672 L361,1081.8672 L361,1063.8672 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="756.8984" style="stroke:#000000;stroke-width:2.0;" width="1206.5" x="361" y="1063.8672"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="376" y="1078.3623">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="423" x="449" y="1077.2861">[for host-level module M to create SAS token for authenticating with IoT Hub]</text><polygon fill="#A80036" points="811.5,1133.2734,801.5,1137.2734,811.5,1141.2734,807.5,1137.2734" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="805.5" x2="1381.5" y1="1137.2734" y2="1137.2734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="817.5" y="1116.0654">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="114" x="835.5" y="1099.7139">Get identity for host</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="835.5" y="1116.0654">module M to identify with</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="44" x="835.5" y="1132.417">IoT Hub</text><polygon fill="#A80036" points="980.5,1179.9766,990.5,1183.9766,980.5,1187.9766,984.5,1183.9766" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="800.5" x2="986.5" y1="1183.9766" y2="1183.9766"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="807.5" y="1170.9443">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="825.5" y="1162.7686">Get master identity key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="38" x="825.5" y="1179.1201">handle</text><polygon fill="#A80036" points="811.5,1210.3281,801.5,1214.3281,811.5,1218.3281,807.5,1214.3281" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="805.5" x2="996.5" y1="1214.3281" y2="1214.3281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="817.5" y="1209.4717">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="835.5" y="1209.4717">Key handle</text><polygon fill="#A80036" points="980.5,1289.7344,990.5,1293.7344,980.5,1297.7344,984.5,1293.7344" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="800.5" x2="986.5" y1="1293.7344" y2="1293.7344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="807.5" y="1264.3506">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="825.5" y="1239.8232">Create module derived</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="825.5" y="1256.1748">key object for module M</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="825.5" y="1272.5264">(based on master identity</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="67" x="825.5" y="1288.8779">key handle)</text><polygon fill="#A80036" points="811.5,1320.0859,801.5,1324.0859,811.5,1328.0859,807.5,1324.0859" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="805.5" x2="996.5" y1="1324.0859" y2="1324.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="817.5" y="1319.2295">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="839.5" y="1319.2295"/><polygon fill="#A80036" points="1370.5,1366.7891,1380.5,1370.7891,1370.5,1374.7891,1374.5,1370.7891" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="795.5" x2="1376.5" y1="1370.7891" y2="1370.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="802.5" y="1357.7568">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="115" x="820.5" y="1349.5811">Module identity with</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="820.5" y="1365.9326">derived key handle</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1382.5" x2="1424.5" y1="1401.1406" y2="1401.1406"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1424.5" x2="1424.5" y1="1401.1406" y2="1414.1406"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1383.5" x2="1424.5" y1="1414.1406" y2="1414.1406"/><polygon fill="#A80036" points="1393.5,1410.1406,1383.5,1414.1406,1393.5,1418.1406,1389.5,1414.1406" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1389.5" y="1396.2842">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="1407.5" y="1396.2842">Generate SAS token</text><polygon fill="#A80036" points="1013.5,1456.8438,1003.5,1460.8438,1013.5,1464.8438,1009.5,1460.8438" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1007.5" x2="1381.5" y1="1460.8438" y2="1460.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1019.5" y="1447.8115">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="1037.5" y="1439.6357">Sign SAS token using</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="1037.5" y="1455.9873">derived key handle</text><polygon fill="#A80036" points="1370.5,1487.1953,1380.5,1491.1953,1370.5,1495.1953,1374.5,1491.1953" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="997.5" x2="1376.5" y1="1491.1953" y2="1491.1953"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1004.5" y="1486.3389">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="1022.5" y="1486.3389">Signed SAS token</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1382.5" x2="1424.5" y1="1570.6016" y2="1570.6016"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1424.5" x2="1424.5" y1="1570.6016" y2="1583.6016"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1383.5" x2="1424.5" y1="1583.6016" y2="1583.6016"/><polygon fill="#A80036" points="1393.5,1579.6016,1383.5,1583.6016,1393.5,1587.6016,1389.5,1583.6016" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1389.5" y="1541.2178">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="1407.5" y="1516.6904">Generate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="1407.5" y="1533.042">SharedAccessSignature</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="1407.5" y="1549.3936">for authenticating with IoT</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="1407.5" y="1565.7451">Hub</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1382.5" x2="1424.5" y1="1630.3047" y2="1630.3047"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1424.5" x2="1424.5" y1="1630.3047" y2="1643.3047"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1383.5" x2="1424.5" y1="1643.3047" y2="1643.3047"/><polygon fill="#A80036" points="1393.5,1639.3047,1383.5,1643.3047,1393.5,1647.3047,1389.5,1643.3047" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1389.5" y="1617.2725">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="1407.5" y="1609.0967">Create IoT Hub client with</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="1407.5" y="1625.4482">SAS token</text><polygon fill="#A80036" points="420.5,1669.6563,410.5,1673.6563,420.5,1677.6563,416.5,1673.6563" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="414.5" x2="1381.5" y1="1673.6563" y2="1673.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="426.5" y="1668.7998">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="444.5" y="1668.7998">Connect to IoT Hub</text><line style="stroke:#A80036;stroke-width:1.0;" x1="409.5" x2="451.5" y1="1769.4141" y2="1769.4141"/><line style="stroke:#A80036;stroke-width:1.0;" x1="451.5" x2="451.5" y1="1769.4141" y2="1782.4141"/><line style="stroke:#A80036;stroke-width:1.0;" x1="410.5" x2="451.5" y1="1782.4141" y2="1782.4141"/><polygon fill="#A80036" points="420.5,1778.4141,410.5,1782.4141,420.5,1786.4141,416.5,1782.4141" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="416.5" y="1731.8545">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="114" x="434.5" y="1699.1514">Validate SAS token</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="434.5" y="1715.5029">against SAS key that</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="434.5" y="1731.8545">was registered when the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="434.5" y="1748.2061">Edge Agent identity was</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="434.5" y="1764.5576">created by the runtime</text><polygon fill="#A80036" points="1370.5,1808.7656,1380.5,1812.7656,1370.5,1816.7656,1374.5,1812.7656" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="404.5" x2="1376.5" y1="1812.7656" y2="1812.7656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="411.5" y="1807.9092">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="429.5" y="1807.9092">OK</text><path d="M351,1841.7656 L534,1841.7656 L534,1849.7656 L524,1859.7656 L351,1859.7656 L351,1841.7656 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="1941.1016" style="stroke:#000000;stroke-width:2.0;" width="1628.5" x="351" y="1841.7656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="138" x="366" y="1856.2607">Edge Agent operation</text><polygon fill="#A80036" points="778.5,1894.8203,788.5,1898.8203,778.5,1902.8203,782.5,1898.8203" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="597.5" x2="784.5" y1="1898.8203" y2="1898.8203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="604.5" y="1885.7881">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="622.5" y="1877.6123">Create module identity for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="622.5" y="1893.9639">Edge Agent</text><polygon fill="#A80036" points="980.5,1941.5234,990.5,1945.5234,980.5,1949.5234,984.5,1945.5234" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="800.5" x2="986.5" y1="1945.5234" y2="1945.5234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="807.5" y="1932.4912">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="825.5" y="1924.3154">Get master encryption</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="825.5" y="1940.667">key</text><polygon fill="#A80036" points="811.5,1971.875,801.5,1975.875,811.5,1979.875,807.5,1975.875" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="805.5" x2="996.5" y1="1975.875" y2="1975.875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="817.5" y="1971.0186">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="835.5" y="1971.0186">Key handle</text><polygon fill="#A80036" points="980.5,2067.6328,990.5,2071.6328,980.5,2075.6328,984.5,2071.6328" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="800.5" x2="986.5" y1="2071.6328" y2="2071.6328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="807.5" y="2034.0732">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="825.5" y="2001.3701">Sign Edge Agent's name</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="825.5" y="2017.7217">+ generation ID using the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="825.5" y="2034.0732">master encryption key to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="825.5" y="2050.4248">derive Edge Agent SAS</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="825.5" y="2066.7764">keys</text><polygon fill="#A80036" points="811.5,2097.9844,801.5,2101.9844,811.5,2105.9844,807.5,2101.9844" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="805.5" x2="996.5" y1="2101.9844" y2="2101.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="817.5" y="2097.1279">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="839.5" y="2097.1279"/><line style="stroke:#A80036;stroke-width:1.0;" x1="800.5" x2="842.5" y1="2165.0391" y2="2165.0391"/><line style="stroke:#A80036;stroke-width:1.0;" x1="842.5" x2="842.5" y1="2165.0391" y2="2178.0391"/><line style="stroke:#A80036;stroke-width:1.0;" x1="801.5" x2="842.5" y1="2178.0391" y2="2178.0391"/><polygon fill="#A80036" points="811.5,2174.0391,801.5,2178.0391,811.5,2182.0391,807.5,2178.0391" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="807.5" y="2143.8311">36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="825.5" y="2127.4795">Create TLS client using</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="825.5" y="2143.8311">key handle + PEM (using</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="825.5" y="2160.1826">openssl-engine-ks)</text><polygon fill="#A80036" points="420.5,2253.4453,410.5,2257.4453,420.5,2261.4453,416.5,2257.4453" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="414.5" x2="789.5" y1="2257.4453" y2="2257.4453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="426.5" y="2228.0615">37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="444.5" y="2203.5342">Create module identity for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="444.5" y="2219.8857">Edge Agent and register</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="444.5" y="2236.2373">the derived SAS keys for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="7" x="444.5" y="2252.5889">it</text><polygon fill="#A80036" points="778.5,2283.7969,788.5,2287.7969,778.5,2291.7969,782.5,2287.7969" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="404.5" x2="784.5" y1="2287.7969" y2="2287.7969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="411.5" y="2282.9404">38</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="433.5" y="2282.9404"/><polygon fill="#A80036" points="608.5,2314.1484,598.5,2318.1484,608.5,2322.1484,604.5,2318.1484" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="602.5" x2="794.5" y1="2318.1484" y2="2318.1484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="614.5" y="2313.292">39</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="114" x="632.5" y="2313.292">Edge Agent identity</text><polygon fill="#A80036" points="1506.5,2344.5,1516.5,2348.5,1506.5,2352.5,1510.5,2348.5" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="597.5" x2="1512.5" y1="2348.5" y2="2348.5"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="604.5" y="2343.6436">40</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="622.5" y="2343.6436">Create and start</text><rect fill="#FEFECE" filter="url(#f1jxt8w6krzj03)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="84" x="1518.5" y="2326.1484"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="70" x="1525.5" y="2347.6816">EdgeAgent</text><path d="M361,2379.7578 L434,2379.7578 L434,2387.7578 L424,2397.7578 L361,2397.7578 L361,2379.7578 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="680.8438" style="stroke:#000000;stroke-width:2.0;" width="1386.5" x="361" y="2379.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="376" y="2394.2529">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="356" x="449" y="2393.1768">[for getting and renewing SAS token for identifying with IoT Hub]</text><polygon fill="#A80036" points="613.5,2432.8125,603.5,2436.8125,613.5,2440.8125,609.5,2436.8125" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="607.5" x2="1561.5" y1="2436.8125" y2="2436.8125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="619.5" y="2423.7803">41</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="637.5" y="2415.6045">Get SAS token for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="637.5" y="2431.9561">identifying with IoT Hub</text><polygon fill="#A80036" points="778.5,2495.8672,788.5,2499.8672,778.5,2503.8672,782.5,2499.8672" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="602.5" x2="784.5" y1="2499.8672" y2="2499.8672"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="609.5" y="2478.6592">42</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="627.5" y="2462.3076">Get SAS token for Edge</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="627.5" y="2478.6592">Agent to identify with IoT</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="627.5" y="2495.0107">Hub</text><polygon fill="#A80036" points="980.5,2542.5703,990.5,2546.5703,980.5,2550.5703,984.5,2546.5703" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="800.5" x2="986.5" y1="2546.5703" y2="2546.5703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="807.5" y="2533.5381">43</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="825.5" y="2525.3623">Get master encryption</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="825.5" y="2541.7139">key</text><polygon fill="#A80036" points="811.5,2572.9219,801.5,2576.9219,811.5,2580.9219,807.5,2576.9219" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="805.5" x2="996.5" y1="2576.9219" y2="2576.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="817.5" y="2572.0654">44</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="835.5" y="2572.0654">Key handle</text><polygon fill="#A80036" points="980.5,2668.6797,990.5,2672.6797,980.5,2676.6797,984.5,2672.6797" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="800.5" x2="986.5" y1="2672.6797" y2="2672.6797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="807.5" y="2635.1201">45</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="825.5" y="2602.417">Sign Edge Agent's name</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="825.5" y="2618.7686">+ generation ID using the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="825.5" y="2635.1201">master encryption key to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="825.5" y="2651.4717">derive Edge Agent SAS</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="825.5" y="2667.8232">keys</text><polygon fill="#A80036" points="811.5,2699.0313,801.5,2703.0313,811.5,2707.0313,807.5,2703.0313" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="805.5" x2="996.5" y1="2703.0313" y2="2703.0313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="817.5" y="2698.1748">46</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="839.5" y="2698.1748"/><line style="stroke:#A80036;stroke-width:1.0;" x1="800.5" x2="842.5" y1="2749.7344" y2="2749.7344"/><line style="stroke:#A80036;stroke-width:1.0;" x1="842.5" x2="842.5" y1="2749.7344" y2="2762.7344"/><line style="stroke:#A80036;stroke-width:1.0;" x1="801.5" x2="842.5" y1="2762.7344" y2="2762.7344"/><polygon fill="#A80036" points="811.5,2758.7344,801.5,2762.7344,811.5,2766.7344,807.5,2762.7344" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="807.5" y="2736.7021">47</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="825.5" y="2728.5264">Create SAS token from</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="825.5" y="2744.8779">SAS key</text><polygon fill="#A80036" points="613.5,2789.0859,603.5,2793.0859,613.5,2797.0859,609.5,2793.0859" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="607.5" x2="794.5" y1="2793.0859" y2="2793.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="619.5" y="2788.2295">48</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="637.5" y="2788.2295">SAS token</text><polygon fill="#A80036" points="1550.5,2819.4375,1560.5,2823.4375,1550.5,2827.4375,1554.5,2823.4375" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="597.5" x2="1556.5" y1="2823.4375" y2="2823.4375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="604.5" y="2818.5811">49</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="622.5" y="2818.5811">SAS token</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1562.5" x2="1604.5" y1="2870.1406" y2="2870.1406"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1604.5" x2="1604.5" y1="2870.1406" y2="2883.1406"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1563.5" x2="1604.5" y1="2883.1406" y2="2883.1406"/><polygon fill="#A80036" points="1573.5,2879.1406,1563.5,2883.1406,1573.5,2887.1406,1569.5,2883.1406" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1569.5" y="2857.1084">50</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="1587.5" y="2848.9326">Create IoT Hub client with</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="1587.5" y="2865.2842">SAS token</text><polygon fill="#A80036" points="420.5,2909.4922,410.5,2913.4922,420.5,2917.4922,416.5,2913.4922" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="414.5" x2="1561.5" y1="2913.4922" y2="2913.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="426.5" y="2908.6357">51</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="444.5" y="2908.6357">Connect to IoT Hub</text><line style="stroke:#A80036;stroke-width:1.0;" x1="409.5" x2="451.5" y1="3009.25" y2="3009.25"/><line style="stroke:#A80036;stroke-width:1.0;" x1="451.5" x2="451.5" y1="3009.25" y2="3022.25"/><line style="stroke:#A80036;stroke-width:1.0;" x1="410.5" x2="451.5" y1="3022.25" y2="3022.25"/><polygon fill="#A80036" points="420.5,3018.25,410.5,3022.25,420.5,3026.25,416.5,3022.25" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="416.5" y="2971.6904">52</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="114" x="434.5" y="2938.9873">Validate SAS token</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="434.5" y="2955.3389">against SAS key that</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="434.5" y="2971.6904">was registered when the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="434.5" y="2988.042">Edge Agent identity was</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="434.5" y="3004.3936">created by the runtime</text><polygon fill="#A80036" points="1550.5,3048.6016,1560.5,3052.6016,1550.5,3056.6016,1554.5,3052.6016" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="404.5" x2="1556.5" y1="3052.6016" y2="3052.6016"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="411.5" y="3047.7451">53</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="429.5" y="3047.7451">OK</text><polygon fill="#A80036" points="420.5,3085.9531,410.5,3089.9531,420.5,3093.9531,416.5,3089.9531" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="414.5" x2="1561.5" y1="3089.9531" y2="3089.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="426.5" y="3085.0967">54</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="444.5" y="3085.0967">Get deployment</text><polygon fill="#A80036" points="1550.5,3116.3047,1560.5,3120.3047,1550.5,3124.3047,1554.5,3120.3047" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="404.5" x2="1556.5" y1="3120.3047" y2="3120.3047"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="411.5" y="3115.4482">55</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="433.5" y="3115.4482"/><path d="M361,3135.3047 L434,3135.3047 L434,3143.3047 L424,3153.3047 L361,3153.3047 L361,3135.3047 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="529.7344" style="stroke:#000000;stroke-width:2.0;" width="1255.5" x="361" y="3135.3047"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="376" y="3149.7998">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="111" x="449" y="3148.7236">[for each module M]</text><polygon fill="#A80036" points="613.5,3188.3594,603.5,3192.3594,613.5,3196.3594,609.5,3192.3594" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="607.5" x2="1561.5" y1="3192.3594" y2="3192.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="619.5" y="3179.3271">56</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="637.5" y="3171.1514">Create identity for module</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="11" x="637.5" y="3187.5029">M</text><polygon fill="#A80036" points="778.5,3235.0625,788.5,3239.0625,778.5,3243.0625,782.5,3239.0625" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="602.5" x2="784.5" y1="3239.0625" y2="3239.0625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="609.5" y="3226.0303">57</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="627.5" y="3217.8545">Create identity for module</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="11" x="627.5" y="3234.2061">M</text><polygon fill="#A80036" points="980.5,3281.7656,990.5,3285.7656,980.5,3289.7656,984.5,3285.7656" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="800.5" x2="986.5" y1="3285.7656" y2="3285.7656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="807.5" y="3272.7334">58</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="825.5" y="3264.5576">Get master encryption</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="825.5" y="3280.9092">key</text><polygon fill="#A80036" points="811.5,3312.1172,801.5,3316.1172,811.5,3320.1172,807.5,3316.1172" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="805.5" x2="996.5" y1="3316.1172" y2="3316.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="817.5" y="3311.2607">59</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="835.5" y="3311.2607">Key handle</text><polygon fill="#A80036" points="980.5,3407.875,990.5,3411.875,980.5,3415.875,984.5,3411.875" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="800.5" x2="986.5" y1="3411.875" y2="3411.875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="807.5" y="3374.3154">60</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="825.5" y="3341.6123">Sign module M's name +</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="825.5" y="3357.9639">generation ID using the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="825.5" y="3374.3154">master encryption key to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="825.5" y="3390.667">derive module M's SAS</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="825.5" y="3407.0186">keys</text><polygon fill="#A80036" points="811.5,3438.2266,801.5,3442.2266,811.5,3446.2266,807.5,3442.2266" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="805.5" x2="996.5" y1="3442.2266" y2="3442.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="817.5" y="3437.3701">61</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="839.5" y="3437.3701"/><polygon fill="#A80036" points="420.5,3501.2813,410.5,3505.2813,420.5,3509.2813,416.5,3505.2813" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="414.5" x2="789.5" y1="3505.2813" y2="3505.2813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="426.5" y="3484.0732">62</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="444.5" y="3467.7217">Create identity for module</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="444.5" y="3484.0732">M and register the derived</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="444.5" y="3500.4248">SAS keys for it</text><polygon fill="#A80036" points="778.5,3531.6328,788.5,3535.6328,778.5,3539.6328,782.5,3535.6328" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="404.5" x2="784.5" y1="3535.6328" y2="3535.6328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="411.5" y="3530.7764">63</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="433.5" y="3530.7764"/><polygon fill="#A80036" points="613.5,3561.9844,603.5,3565.9844,613.5,3569.9844,609.5,3565.9844" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="607.5" x2="794.5" y1="3565.9844" y2="3565.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="619.5" y="3561.1279">64</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="641.5" y="3561.1279"/><polygon fill="#A80036" points="1550.5,3592.3359,1560.5,3596.3359,1550.5,3600.3359,1554.5,3596.3359" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="597.5" x2="1556.5" y1="3596.3359" y2="3596.3359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="604.5" y="3591.4795">65</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="626.5" y="3591.4795"/><polygon fill="#A80036" points="613.5,3622.6875,603.5,3626.6875,613.5,3630.6875,609.5,3626.6875" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="607.5" x2="1561.5" y1="3626.6875" y2="3626.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="619.5" y="3621.8311">66</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="74" x="637.5" y="3621.8311">Start module</text><polygon fill="#A80036" points="1550.5,3653.0391,1560.5,3657.0391,1550.5,3661.0391,1554.5,3657.0391" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="597.5" x2="1556.5" y1="3657.0391" y2="3657.0391"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="604.5" y="3652.1826">67</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="626.5" y="3652.1826"/><polygon fill="#A80036" points="1692.5,3690.3906,1702.5,3694.3906,1692.5,3698.3906,1696.5,3694.3906" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="597.5" x2="1698.5" y1="3694.3906" y2="3694.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="604.5" y="3689.5342">68</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="622.5" y="3689.5342">Start Edge Hub</text><rect fill="#FEFECE" filter="url(#f1jxt8w6krzj03)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="72" x="1704.5" y="3672.0391"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="58" x="1711.5" y="3693.5723">EdgeHub</text><polygon fill="#A80036" points="1877.5,3737,1887.5,3741,1877.5,3745,1881.5,3741" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="597.5" x2="1883.5" y1="3741" y2="3741"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="604.5" y="3736.1436">69</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="622.5" y="3736.1436">Start Custom module</text><rect fill="#FEFECE" filter="url(#f1jxt8w6krzj03)" height="49.2188" style="stroke:#A80036;stroke-width:1.5;" width="76" x="1889.5" y="3718.6484"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="62" x="1896.5" y="3740.1816">Container</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="46" x="1904.5" y="3757.791">Module</text><path d="M10,3796.8672 L181,3796.8672 L181,3804.8672 L171,3814.8672 L10,3814.8672 L10,3796.8672 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="2980.1797" style="stroke:#000000;stroke-width:2.0;" width="1944.5" x="10" y="3796.8672"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="126" x="25" y="3811.3623">Edge Hub operation</text><path d="M20,3822.2188 L93,3822.2188 L93,3830.2188 L83,3840.2188 L20,3840.2188 L20,3822.2188 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="2001.1172" style="stroke:#000000;stroke-width:2.0;" width="1780.5" x="20" y="3822.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="35" y="3836.7139">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="108" y="3835.6377">[for server cert request and renewal]</text><path d="M30,3845.5703 L30,4051.5703 L775,4051.5703 L775,3855.5703 L765,3845.5703 L30,3845.5703 " fill="#FBFB77" filter="url(#f1jxt8w6krzj03)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M765,3845.5703 L765,3855.5703 L775,3855.5703 L765,3845.5703 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="482" x="36" y="3864.0654">While it is possible to make an openssl engine (like openssl-engine-ks) for modules</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="539" x="36" y="3880.417">that performs key operations using the KS, it is not feasible to expect all modules to be using</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="580" x="36" y="3896.7686">openssl for TLS, especially Windows modules. Thus modules need to have the raw private key bytes</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="239" x="36" y="3913.1201">to be able to serve TLS with a server cert.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="40" y="3929.4717"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="537" x="36" y="3945.8232">For this reason, the private keys of module server certs are not persisted using Keys Service.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="40" y="3962.1748"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="631" x="36" y="3978.5264">Also, note that a single server cert is shared between all modules, and its lifetime is managed by the runtime.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="724" x="36" y="3994.8779">This is because the user may have module server certs rooted to public CAs, so it would cost the customer $$$ for each cert.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="655" x="36" y="4011.2295">Thus we do not want to request a new server cert when a previously requested cert is still valid, which also means</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="721" x="36" y="4027.5811">we want to dedupe the server certs across all modules that want them. Since server certs are issued for the device hostname</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="401" x="36" y="4043.9326">anyway, reusing the server cert for multiple modules is not a concern.</text><path d="M176,4067.7891 L237,4067.7891 L237,4075.7891 L227,4085.7891 L176,4085.7891 L176,4067.7891 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="1748.5469" style="stroke:#000000;stroke-width:2.0;" width="1614.5" x="176" y="4067.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="16" x="191" y="4082.2842">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="224" x="252" y="4081.208">[if server cert already exists and is valid]</text><polygon fill="#A80036" points="613.5,4104.4922,603.5,4108.4922,613.5,4112.4922,609.5,4108.4922" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="607.5" x2="1741.5" y1="4108.4922" y2="4108.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="619.5" y="4103.6357">70</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="85" x="637.5" y="4103.6357">Get server cert</text><line style="stroke:#A80036;stroke-width:1.0;" x1="602.5" x2="644.5" y1="4138.8438" y2="4138.8438"/><line style="stroke:#A80036;stroke-width:1.0;" x1="644.5" x2="644.5" y1="4138.8438" y2="4151.8438"/><line style="stroke:#A80036;stroke-width:1.0;" x1="603.5" x2="644.5" y1="4151.8438" y2="4151.8438"/><polygon fill="#A80036" points="613.5,4147.8438,603.5,4151.8438,613.5,4155.8438,609.5,4151.8438" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="609.5" y="4133.9873">71</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="627.5" y="4133.9873">Get persisted server cert</text><line style="stroke:#A80036;stroke-width:1.0;" x1="602.5" x2="644.5" y1="4182.1953" y2="4182.1953"/><line style="stroke:#A80036;stroke-width:1.0;" x1="644.5" x2="644.5" y1="4182.1953" y2="4195.1953"/><line style="stroke:#A80036;stroke-width:1.0;" x1="603.5" x2="644.5" y1="4195.1953" y2="4195.1953"/><polygon fill="#A80036" points="613.5,4191.1953,603.5,4195.1953,613.5,4199.1953,609.5,4195.1953" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="609.5" y="4177.3389">72</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="627.5" y="4177.3389">Server cert is valid</text><line style="stroke:#A80036;stroke-width:1.0;" x1="602.5" x2="644.5" y1="4241.8984" y2="4241.8984"/><line style="stroke:#A80036;stroke-width:1.0;" x1="644.5" x2="644.5" y1="4241.8984" y2="4254.8984"/><line style="stroke:#A80036;stroke-width:1.0;" x1="603.5" x2="644.5" y1="4254.8984" y2="4254.8984"/><polygon fill="#A80036" points="613.5,4250.8984,603.5,4254.8984,613.5,4258.8984,609.5,4254.8984" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="609.5" y="4228.8662">73</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="627.5" y="4220.6904">Get persisted server</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="627.5" y="4237.042">cert's private key</text><polygon fill="#A80036" points="1730.5,4297.6016,1740.5,4301.6016,1730.5,4305.6016,1734.5,4301.6016" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="597.5" x2="1736.5" y1="4301.6016" y2="4301.6016"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="604.5" y="4288.5693">74</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="622.5" y="4280.3936">Server cert and private</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="622.5" y="4296.7451">key</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="176" x2="1790.5" y1="4310.6016" y2="4310.6016"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="235" x="181" y="4322.0205">[if server cert does not exist or is expired]</text><polygon fill="#A80036" points="613.5,4343.7891,603.5,4347.7891,613.5,4351.7891,609.5,4347.7891" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="607.5" x2="1741.5" y1="4347.7891" y2="4347.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="619.5" y="4342.9326">75</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="85" x="637.5" y="4342.9326">Get server cert</text><path d="M527.5,4362.7891 L588.5,4362.7891 L588.5,4370.7891 L578.5,4380.7891 L527.5,4380.7891 L527.5,4362.7891 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="223.9453" style="stroke:#000000;stroke-width:2.0;" width="291" x="527.5" y="4362.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="16" x="542.5" y="4377.2842">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="162" x="603.5" y="4376.208">[if server cert does not exist]</text><line style="stroke:#A80036;stroke-width:1.0;" x1="602.5" x2="644.5" y1="4403.4922" y2="4403.4922"/><line style="stroke:#A80036;stroke-width:1.0;" x1="644.5" x2="644.5" y1="4403.4922" y2="4416.4922"/><line style="stroke:#A80036;stroke-width:1.0;" x1="603.5" x2="644.5" y1="4416.4922" y2="4416.4922"/><polygon fill="#A80036" points="613.5,4412.4922,603.5,4416.4922,613.5,4420.4922,609.5,4416.4922" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="609.5" y="4398.6357">76</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="627.5" y="4398.6357">Get persisted server cert</text><line style="stroke:#A80036;stroke-width:1.0;" x1="602.5" x2="644.5" y1="4446.8438" y2="4446.8438"/><line style="stroke:#A80036;stroke-width:1.0;" x1="644.5" x2="644.5" y1="4446.8438" y2="4459.8438"/><line style="stroke:#A80036;stroke-width:1.0;" x1="603.5" x2="644.5" y1="4459.8438" y2="4459.8438"/><polygon fill="#A80036" points="613.5,4455.8438,603.5,4459.8438,613.5,4463.8438,609.5,4459.8438" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="609.5" y="4441.9873">77</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="627.5" y="4441.9873">Server cert is not found</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="527.5" x2="818.5" y1="4468.8438" y2="4468.8438"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="286" x="532.5" y="4480.2627">[if server cert exists but is expired / close to expiry]</text><line style="stroke:#A80036;stroke-width:1.0;" x1="602.5" x2="644.5" y1="4506.0313" y2="4506.0313"/><line style="stroke:#A80036;stroke-width:1.0;" x1="644.5" x2="644.5" y1="4506.0313" y2="4519.0313"/><line style="stroke:#A80036;stroke-width:1.0;" x1="603.5" x2="644.5" y1="4519.0313" y2="4519.0313"/><polygon fill="#A80036" points="613.5,4515.0313,603.5,4519.0313,613.5,4523.0313,609.5,4519.0313" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="609.5" y="4501.1748">78</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="627.5" y="4501.1748">Get persisted server cert</text><line style="stroke:#A80036;stroke-width:1.0;" x1="602.5" x2="644.5" y1="4565.7344" y2="4565.7344"/><line style="stroke:#A80036;stroke-width:1.0;" x1="644.5" x2="644.5" y1="4565.7344" y2="4578.7344"/><line style="stroke:#A80036;stroke-width:1.0;" x1="603.5" x2="644.5" y1="4578.7344" y2="4578.7344"/><polygon fill="#A80036" points="613.5,4574.7344,603.5,4578.7344,613.5,4582.7344,609.5,4578.7344" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="609.5" y="4552.7021">79</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="627.5" y="4544.5264">Server cert is expired /</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="85" x="627.5" y="4560.8779">close to expiry</text><line style="stroke:#A80036;stroke-width:1.0;" x1="602.5" x2="644.5" y1="4632.4375" y2="4632.4375"/><line style="stroke:#A80036;stroke-width:1.0;" x1="644.5" x2="644.5" y1="4632.4375" y2="4645.4375"/><line style="stroke:#A80036;stroke-width:1.0;" x1="603.5" x2="644.5" y1="4645.4375" y2="4645.4375"/><polygon fill="#A80036" points="613.5,4641.4375,603.5,4645.4375,613.5,4649.4375,609.5,4645.4375" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="609.5" y="4619.4053">80</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="627.5" y="4611.2295">Create new asymmetric</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="627.5" y="4627.5811">key pair (in memory)</text><polygon fill="#A80036" points="1171.5,4688.1406,1181.5,4692.1406,1171.5,4696.1406,1175.5,4692.1406" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="602.5" x2="1177.5" y1="4692.1406" y2="4692.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="609.5" y="4679.1084">81</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="627.5" y="4670.9326">Request new module</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="627.5" y="4687.2842">server cert</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1193.5" x2="1235.5" y1="4755.1953" y2="4755.1953"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1235.5" x2="1235.5" y1="4755.1953" y2="4768.1953"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1194.5" x2="1235.5" y1="4768.1953" y2="4768.1953"/><polygon fill="#A80036" points="1204.5,4764.1953,1194.5,4768.1953,1204.5,4772.1953,1200.5,4768.1953" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1200.5" y="4733.9873">82</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="114" x="1218.5" y="4717.6357">Create CSR for new</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="1218.5" y="4733.9873">module server cert using</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="1218.5" y="4750.3389">key</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1193.5" x2="1240.5" y1="4793.5469" y2="4793.5469"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1240.5" x2="1240.5" y1="4793.5469" y2="4806.5469"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1199.5" x2="1240.5" y1="4806.5469" y2="4806.5469"/><polygon fill="#A80036" points="1209.5,4802.5469,1199.5,4806.5469,1209.5,4810.5469,1205.5,4806.5469" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1205.5" y="4788.6904">83</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="131" x="1223.5" y="4788.6904">Get module server cert</text><path d="M186,4826.5469 L247,4826.5469 L247,4834.5469 L237,4844.5469 L186,4844.5469 L186,4826.5469 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="726.625" style="stroke:#000000;stroke-width:2.0;" width="1198.5" x="186" y="4826.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="16" x="201" y="4841.042">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="230" x="262" y="4839.9658">[if module certs should be issued by EST]</text><polygon fill="#A80036" points="1013.5,4879.6016,1003.5,4883.6016,1013.5,4887.6016,1009.5,4883.6016" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1007.5" x2="1187.5" y1="4883.6016" y2="4883.6016"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1019.5" y="4870.5693">84</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="1037.5" y="4862.3936">Get current EST identity</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="1037.5" y="4878.7451">cert's private key</text><polygon fill="#A80036" points="1176.5,4909.9531,1186.5,4913.9531,1176.5,4917.9531,1180.5,4913.9531" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="997.5" x2="1182.5" y1="4913.9531" y2="4913.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1004.5" y="4909.0967">85</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="1022.5" y="4909.0967">Key handle</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1198.5" x2="1245.5" y1="4955.6563" y2="4955.6563"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1245.5" x2="1245.5" y1="4955.6563" y2="4968.6563"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1204.5" x2="1245.5" y1="4968.6563" y2="4968.6563"/><polygon fill="#A80036" points="1214.5,4964.6563,1204.5,4968.6563,1214.5,4972.6563,1210.5,4968.6563" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1210.5" y="4942.624">86</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="1228.5" y="4934.4482">Get current EST identity</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1228.5" y="4950.7998">cert</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1203.5" x2="1245.5" y1="5009.0078" y2="5009.0078"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1245.5" x2="1245.5" y1="5009.0078" y2="5022.0078"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1198.5" x2="1245.5" y1="5022.0078" y2="5022.0078"/><polygon fill="#A80036" points="1208.5,5018.0078,1198.5,5022.0078,1208.5,5026.0078,1204.5,5022.0078" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1210.5" y="5004.1514">87</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="29" x="1228.5" y="5004.1514">PEM</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1198.5" x2="1240.5" y1="5080.0625" y2="5080.0625"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1240.5" x2="1240.5" y1="5080.0625" y2="5093.0625"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1199.5" x2="1240.5" y1="5093.0625" y2="5093.0625"/><polygon fill="#A80036" points="1209.5,5089.0625,1199.5,5093.0625,1209.5,5097.0625,1205.5,5093.0625" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1205.5" y="5058.8545">88</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="1223.5" y="5042.5029">Create TLS client using</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="1223.5" y="5058.8545">key handle + PEM (using</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="1223.5" y="5075.2061">openssl-engine-ks)</text><polygon fill="#A80036" points="234.5,5168.4688,224.5,5172.4688,234.5,5176.4688,230.5,5172.4688" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="228.5" x2="1187.5" y1="5172.4688" y2="5172.4688"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="240.5" y="5143.085">89</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="258.5" y="5118.5576">Connect using TLS client</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="258.5" y="5134.9092">and send request for new</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="258.5" y="5151.2607">module server cert</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="258.5" y="5167.6123">corresponding to the CSR</text><line style="stroke:#A80036;stroke-width:1.0;" x1="223.5" x2="265.5" y1="5219.1719" y2="5219.1719"/><line style="stroke:#A80036;stroke-width:1.0;" x1="265.5" x2="265.5" y1="5219.1719" y2="5232.1719"/><line style="stroke:#A80036;stroke-width:1.0;" x1="224.5" x2="265.5" y1="5232.1719" y2="5232.1719"/><polygon fill="#A80036" points="234.5,5228.1719,224.5,5232.1719,234.5,5236.1719,230.5,5232.1719" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="230.5" y="5206.1396">90</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="248.5" y="5197.9639">Verify client cert against</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="18" x="248.5" y="5214.3154">CA</text><line style="stroke:#A80036;stroke-width:1.0;" x1="223.5" x2="265.5" y1="5262.5234" y2="5262.5234"/><line style="stroke:#A80036;stroke-width:1.0;" x1="265.5" x2="265.5" y1="5262.5234" y2="5275.5234"/><line style="stroke:#A80036;stroke-width:1.0;" x1="224.5" x2="265.5" y1="5275.5234" y2="5275.5234"/><polygon fill="#A80036" points="234.5,5271.5234,224.5,5275.5234,234.5,5279.5234,230.5,5275.5234" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="230.5" y="5257.667">91</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="57" x="248.5" y="5257.667">Sign CSR</text><polygon fill="#A80036" points="1176.5,5301.875,1186.5,5305.875,1176.5,5309.875,1180.5,5305.875" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="218.5" x2="1182.5" y1="5305.875" y2="5305.875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="225.5" y="5301.0186">92</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="243.5" y="5301.0186">Signed server cert</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="186" x2="1384.5" y1="5314.875" y2="5314.875"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="229" x="191" y="5326.2939">[if module certs should be minted locally]</text><polygon fill="#A80036" points="1013.5,5364.4141,1003.5,5368.4141,1013.5,5372.4141,1009.5,5368.4141" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1007.5" x2="1187.5" y1="5368.4141" y2="5368.4141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1019.5" y="5355.3818">93</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="1037.5" y="5347.2061">Get device CA cert's</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="1037.5" y="5363.5576">private key</text><polygon fill="#A80036" points="1176.5,5394.7656,1186.5,5398.7656,1176.5,5402.7656,1180.5,5398.7656" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="997.5" x2="1182.5" y1="5398.7656" y2="5398.7656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1004.5" y="5393.9092">94</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="1022.5" y="5393.9092">Key handle</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1198.5" x2="1245.5" y1="5424.1172" y2="5424.1172"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1245.5" x2="1245.5" y1="5424.1172" y2="5437.1172"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1204.5" x2="1245.5" y1="5437.1172" y2="5437.1172"/><polygon fill="#A80036" points="1214.5,5433.1172,1204.5,5437.1172,1214.5,5441.1172,1210.5,5437.1172" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1210.5" y="5419.2607">95</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="1228.5" y="5419.2607">Get device CA cert</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1203.5" x2="1245.5" y1="5477.4688" y2="5477.4688"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1245.5" x2="1245.5" y1="5477.4688" y2="5490.4688"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1198.5" x2="1245.5" y1="5490.4688" y2="5490.4688"/><polygon fill="#A80036" points="1208.5,5486.4688,1198.5,5490.4688,1208.5,5494.4688,1204.5,5490.4688" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1210.5" y="5472.6123">96</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="29" x="1228.5" y="5472.6123">PEM</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1198.5" x2="1240.5" y1="5532.1719" y2="5532.1719"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1240.5" x2="1240.5" y1="5532.1719" y2="5545.1719"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1199.5" x2="1240.5" y1="5545.1719" y2="5545.1719"/><polygon fill="#A80036" points="1209.5,5541.1719,1199.5,5545.1719,1209.5,5549.1719,1205.5,5545.1719" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1205.5" y="5519.1396">97</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="1223.5" y="5510.9639">Sign CSR using device</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="44" x="1223.5" y="5527.3154">CA cert</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1198.5" x2="1240.5" y1="5587.5234" y2="5587.5234"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1240.5" x2="1240.5" y1="5587.5234" y2="5600.5234"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1193.5" x2="1240.5" y1="5600.5234" y2="5600.5234"/><polygon fill="#A80036" points="1203.5,5596.5234,1193.5,5600.5234,1203.5,5604.5234,1199.5,5600.5234" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1205.5" y="5582.667">98</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="1223.5" y="5582.667">Signed server cert</text><polygon fill="#A80036" points="613.5,5621.875,603.5,5625.875,613.5,5629.875,609.5,5625.875" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="607.5" x2="1187.5" y1="5625.875" y2="5625.875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="619.5" y="5621.0186">99</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="637.5" y="5621.0186">Signed server cert</text><polygon fill="#A80036" points="1730.5,5652.2266,1740.5,5656.2266,1730.5,5660.2266,1734.5,5656.2266" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="597.5" x2="1736.5" y1="5656.2266" y2="5656.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="604.5" y="5651.3701">100</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="629.5" y="5651.3701">Signed server cert</text><line style="stroke:#A80036;stroke-width:1.0;" x1="597.5" x2="639.5" y1="5702.9297" y2="5702.9297"/><line style="stroke:#A80036;stroke-width:1.0;" x1="639.5" x2="639.5" y1="5702.9297" y2="5715.9297"/><line style="stroke:#A80036;stroke-width:1.0;" x1="598.5" x2="639.5" y1="5715.9297" y2="5715.9297"/><polygon fill="#A80036" points="608.5,5711.9297,598.5,5715.9297,608.5,5719.9297,604.5,5715.9297" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="604.5" y="5689.8975">101</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="629.5" y="5681.7217">Save key pair as server</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="629.5" y="5698.0732">cert private key</text><line style="stroke:#A80036;stroke-width:1.0;" x1="597.5" x2="639.5" y1="5795.3359" y2="5795.3359"/><line style="stroke:#A80036;stroke-width:1.0;" x1="639.5" x2="639.5" y1="5795.3359" y2="5808.3359"/><line style="stroke:#A80036;stroke-width:1.0;" x1="598.5" x2="639.5" y1="5808.3359" y2="5808.3359"/><polygon fill="#A80036" points="608.5,5804.3359,598.5,5808.3359,608.5,5812.3359,604.5,5808.3359" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="604.5" y="5765.9521">102</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="629.5" y="5741.4248">Save signed cert so that</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="629.5" y="5757.7764">it can be retrieved for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="629.5" y="5774.1279">future module server cert</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="629.5" y="5790.4795">requests</text><path d="M351,5837.3359 L517,5837.3359 L517,5845.3359 L507,5855.3359 L351,5855.3359 L351,5837.3359 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="932.7109" style="stroke:#000000;stroke-width:2.0;" width="1593.5" x="351" y="5837.3359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="121" x="366" y="5851.8311">Connect to IoT Hub</text><path d="M361,5862.6875 L434,5862.6875 L434,5870.6875 L424,5880.6875 L361,5880.6875 L361,5862.6875 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="900.3594" style="stroke:#000000;stroke-width:2.0;" width="1573.5" x="361" y="5862.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="376" y="5877.1826">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="356" x="449" y="5876.1064">[for getting and renewing SAS token for identifying with IoT Hub]</text><polygon fill="#A80036" points="613.5,5899.3906,603.5,5903.3906,613.5,5907.3906,609.5,5903.3906" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="607.5" x2="1741.5" y1="5903.3906" y2="5903.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="619.5" y="5898.5342">103</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="644.5" y="5898.5342">Get IoTHub identity</text><polygon fill="#A80036" points="778.5,5929.7422,788.5,5933.7422,778.5,5937.7422,782.5,5933.7422" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="602.5" x2="784.5" y1="5933.7422" y2="5933.7422"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="609.5" y="5928.8857">104</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="634.5" y="5928.8857">Get IoTHub identity</text><polygon fill="#A80036" points="613.5,6009.1484,603.5,6013.1484,613.5,6017.1484,609.5,6013.1484" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="607.5" x2="794.5" y1="6013.1484" y2="6013.1484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="619.5" y="5983.7646">105</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="644.5" y="5959.2373">Identity info (IoTHub +</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="94" x="644.5" y="5975.5889">device identity +</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="644.5" y="5991.9404">generation ID +</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="644.5" y="6008.292">credentials type)</text><polygon fill="#A80036" points="1730.5,6088.5547,1740.5,6092.5547,1730.5,6096.5547,1734.5,6092.5547" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="597.5" x2="1736.5" y1="6092.5547" y2="6092.5547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="604.5" y="6063.1709">106</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="629.5" y="6038.6436">Identity info (IoTHub +</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="94" x="629.5" y="6054.9951">device identity +</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="629.5" y="6071.3467">generation ID +</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="629.5" y="6087.6982">credentials type)</text><polygon fill="#A80036" points="613.5,6135.2578,603.5,6139.2578,613.5,6143.2578,609.5,6139.2578" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="607.5" x2="1741.5" y1="6139.2578" y2="6139.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="619.5" y="6126.2256">107</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="644.5" y="6118.0498">Get SAS token for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="644.5" y="6134.4014">identifying with IoT Hub</text><polygon fill="#A80036" points="778.5,6198.3125,788.5,6202.3125,778.5,6206.3125,782.5,6202.3125" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="602.5" x2="784.5" y1="6202.3125" y2="6202.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="609.5" y="6181.1045">108</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="634.5" y="6164.7529">Get SAS token for Edge</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="131" x="634.5" y="6181.1045">Hub to identify with IoT</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="634.5" y="6197.4561">Hub</text><polygon fill="#A80036" points="980.5,6245.0156,990.5,6249.0156,980.5,6253.0156,984.5,6249.0156" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="800.5" x2="986.5" y1="6249.0156" y2="6249.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="807.5" y="6235.9834">109</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="832.5" y="6227.8076">Get master encryption</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="832.5" y="6244.1592">key</text><polygon fill="#A80036" points="811.5,6275.3672,801.5,6279.3672,811.5,6283.3672,807.5,6279.3672" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="805.5" x2="996.5" y1="6279.3672" y2="6279.3672"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="817.5" y="6274.5107">110</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="842.5" y="6274.5107">Key handle</text><polygon fill="#A80036" points="980.5,6371.125,990.5,6375.125,980.5,6379.125,984.5,6375.125" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="800.5" x2="986.5" y1="6375.125" y2="6375.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="807.5" y="6337.5654">111</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="832.5" y="6304.8623">Sign Edge Hub's name +</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="832.5" y="6321.2139">generation ID using the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="832.5" y="6337.5654">master encryption key to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="832.5" y="6353.917">derive Edge Hub SAS</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="832.5" y="6370.2686">keys</text><polygon fill="#A80036" points="811.5,6401.4766,801.5,6405.4766,811.5,6409.4766,807.5,6405.4766" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="805.5" x2="996.5" y1="6405.4766" y2="6405.4766"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="817.5" y="6400.6201">112</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="846.5" y="6400.6201"/><line style="stroke:#A80036;stroke-width:1.0;" x1="800.5" x2="842.5" y1="6452.1797" y2="6452.1797"/><line style="stroke:#A80036;stroke-width:1.0;" x1="842.5" x2="842.5" y1="6452.1797" y2="6465.1797"/><line style="stroke:#A80036;stroke-width:1.0;" x1="801.5" x2="842.5" y1="6465.1797" y2="6465.1797"/><polygon fill="#A80036" points="811.5,6461.1797,801.5,6465.1797,811.5,6469.1797,807.5,6465.1797" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="807.5" y="6439.1475">113</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="832.5" y="6430.9717">Create SAS token from</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="832.5" y="6447.3232">SAS key</text><polygon fill="#A80036" points="613.5,6491.5313,603.5,6495.5313,613.5,6499.5313,609.5,6495.5313" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="607.5" x2="794.5" y1="6495.5313" y2="6495.5313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="619.5" y="6490.6748">114</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="644.5" y="6490.6748">SAS token</text><polygon fill="#A80036" points="1730.5,6521.8828,1740.5,6525.8828,1730.5,6529.8828,1734.5,6525.8828" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="597.5" x2="1736.5" y1="6525.8828" y2="6525.8828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="604.5" y="6521.0264">115</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="629.5" y="6521.0264">SAS token</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1742.5" x2="1784.5" y1="6572.5859" y2="6572.5859"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1784.5" x2="1784.5" y1="6572.5859" y2="6585.5859"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1743.5" x2="1784.5" y1="6585.5859" y2="6585.5859"/><polygon fill="#A80036" points="1753.5,6581.5859,1743.5,6585.5859,1753.5,6589.5859,1749.5,6585.5859" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="1749.5" y="6559.5537">116</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="1774.5" y="6551.3779">Create IoT Hub client with</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="1774.5" y="6567.7295">SAS token</text><polygon fill="#A80036" points="420.5,6611.9375,410.5,6615.9375,420.5,6619.9375,416.5,6615.9375" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="414.5" x2="1741.5" y1="6615.9375" y2="6615.9375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="426.5" y="6611.0811">117</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="451.5" y="6611.0811">Connect to IoT Hub</text><line style="stroke:#A80036;stroke-width:1.0;" x1="409.5" x2="451.5" y1="6711.6953" y2="6711.6953"/><line style="stroke:#A80036;stroke-width:1.0;" x1="451.5" x2="451.5" y1="6711.6953" y2="6724.6953"/><line style="stroke:#A80036;stroke-width:1.0;" x1="410.5" x2="451.5" y1="6724.6953" y2="6724.6953"/><polygon fill="#A80036" points="420.5,6720.6953,410.5,6724.6953,420.5,6728.6953,416.5,6724.6953" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="416.5" y="6674.1357">118</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="114" x="441.5" y="6641.4326">Validate SAS token</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="441.5" y="6657.7842">against SAS key that</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="441.5" y="6674.1357">was registered when the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="441.5" y="6690.4873">Edge Hub identity was</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="441.5" y="6706.8389">created by the runtime</text><polygon fill="#A80036" points="1730.5,6751.0469,1740.5,6755.0469,1730.5,6759.0469,1734.5,6755.0469" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="404.5" x2="1736.5" y1="6755.0469" y2="6755.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="411.5" y="6750.1904">119</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="436.5" y="6750.1904">OK</text><!--MD5=[7da4d419690c7a20a9e369625ac8e0cd]
@startuml

title Runtime Operation
skinparam maxMessageSize 150

participant "EST" as est
participant "IoT Hub" as hub

box Device #LightBlue
	participant "Module Runtime" as mr
	participant "Identity Service" as is
	participant "Keys Service" as ks
	participant "Certificates Service" as cs
	participant "Host Process\nModule" as hlm
	participant "EdgeAgent" as ea
	participant "EdgeHub" as eh
	participant "Container\nModule" as cm
end box


autonumber

group Host-level modules provisioning
	is -> is: Read host-level module names from configuration 
	loop for creating each host-level module M
		is -> ks ++: Create/Get master identity symmetric key
		return Key handle
		is -> ks++: Create module derived key object for module M (based on master identity key handle)
		return
		is -> ks ++: Derive and Sign module M's SAS key using name + generation ID (with derived key handle)
		return
		is -> is ++: Get current device identity cert and key handle
		is -> ks ++: Get current device identity cert's private key
		return Key handle
		is -> cs ++: Get current device identity cert
		return PEM
		return
		is -> is: Create TLS client using key handle + PEM (using openssl-engine-ks)
		is -> hub ++: Create identity for module M and register the derived SAS keys for it
		note over is
			If IoTHub call ever fails with bad credential, IS requests provisioning (with reprovision=true)
		end note
		return
	end
end

group Host-level modules process operations
	loop for host-level module M to create SAS token for authenticating with IoT Hub
		hlm -> is ++: Get identity for host module M to identify with IoT Hub
		is -> ks ++: Get master identity key handle
		return Key handle
		is -> ks ++: Create module derived key object for module M (based on master identity key handle)
		return
		return Module identity with derived key handle
		hlm -> hlm: Generate SAS token
		hlm -> ks++: Sign SAS token using derived key handle
		return Signed SAS token
		hlm -> hlm: Generate SharedAccessSignature for authenticating with IoT Hub
		hlm -> hlm: Create IoT Hub client with SAS token
		hlm -> hub++: Connect to IoT Hub
		hub -> hub: Validate SAS token against SAS key that was registered when the Edge Agent identity was created by the runtime
		return OK
	end
end

group Edge Agent operation
	mr -> is ++: Create module identity for Edge Agent
	is -> ks ++: Get master encryption key
	return Key handle
	is -> ks ++: Sign Edge Agent's name + generation ID using the master encryption key to derive Edge Agent SAS keys
	return
	is -> is: Create TLS client using key handle + PEM (using openssl-engine-ks)
	is -> hub ++: Create module identity for Edge Agent and register the derived SAS keys for it
	return
	return Edge Agent identity

	mr -> ea **: Create and start

	loop for getting and renewing SAS token for identifying with IoT Hub
		ea -> mr ++: Get SAS token for identifying with IoT Hub
		mr -> is ++: Get SAS token for Edge Agent to identify with IoT Hub
		is -> ks ++: Get master encryption key
		return Key handle
		is -> ks ++: Sign Edge Agent's name + generation ID using the master encryption key to derive Edge Agent SAS keys
		return
		is -> is: Create SAS token from SAS key
		return SAS token
		return SAS token
		ea -> ea: Create IoT Hub client with SAS token
		ea -> hub ++: Connect to IoT Hub
		hub -> hub: Validate SAS token against SAS key that was registered when the Edge Agent identity was created by the runtime
		return OK
	end

	ea -> hub ++: Get deployment
	return

	loop for each module M
		ea -> mr ++: Create identity for module M
		mr -> is ++: Create identity for module M
		is -> ks ++: Get master encryption key
		return Key handle
		is -> ks ++: Sign module M's name + generation ID using the master encryption key to derive module M's SAS keys
		return
		is -> hub ++: Create identity for module M and register the derived SAS keys for it
		return
		return
		return

		ea -> mr ++: Start module
		return
	end

	mr -> eh **: Start Edge Hub
	mr -> cm **: Start Custom module
end

group Edge Hub operation
	loop for server cert request and renewal
		note over hub
			While it is possible to make an openssl engine (like openssl-engine-ks) for modules
			that performs key operations using the KS, it is not feasible to expect all modules to be using
			openssl for TLS, especially Windows modules. Thus modules need to have the raw private key bytes
			to be able to serve TLS with a server cert.

			For this reason, the private keys of module server certs are not persisted using Keys Service.

			Also, note that a single server cert is shared between all modules, and its lifetime is managed by the runtime.
			This is because the user may have module server certs rooted to public CAs, so it would cost the customer $$$ for each cert.
			Thus we do not want to request a new server cert when a previously requested cert is still valid, which also means
			we want to dedupe the server certs across all modules that want them. Since server certs are issued for the device hostname
			anyway, reusing the server cert for multiple modules is not a concern.
		end note

		alt if server cert already exists and is valid
			eh -> mr ++: Get server cert
			mr -> mr: Get persisted server cert
			mr -> mr: Server cert is valid
			mr -> mr: Get persisted server cert's private key
			return Server cert and private key

		else if server cert does not exist or is expired
			eh -> mr ++: Get server cert
			alt if server cert does not exist
				mr -> mr : Get persisted server cert
				mr -> mr: Server cert is not found
			else if server cert exists but is expired / close to expiry
				mr -> mr : Get persisted server cert
				mr -> mr: Server cert is expired / close to expiry
			end

			mr -> mr: Create new asymmetric key pair (in memory)
			mr -> cs ++: Request new module server cert
			cs -> cs: Create CSR for new module server cert using key
			cs -> cs ++: Get module server cert

			alt if module certs should be issued by EST
				cs -> ks ++: Get current EST identity cert's private key
				return Key handle
				cs -> cs ++: Get current EST identity cert
				return PEM
				cs -> cs: Create TLS client using key handle + PEM (using openssl-engine-ks)
				cs -> est ++: Connect using TLS client and send request for new module server cert corresponding to the CSR
				est -> est: Verify client cert against CA
				est -> est: Sign CSR
				return Signed server cert

			else if module certs should be minted locally
				cs -> ks ++: Get device CA cert's private key
				return Key handle
				cs -> cs ++: Get device CA cert
				return PEM
				cs -> cs: Sign CSR using device CA cert
			end

			return Signed server cert
			return Signed server cert
			return Signed server cert
			mr -> mr: Save key pair as server cert private key
			mr -> mr: Save signed cert so that it can be retrieved for future module server cert requests
		end
	end

	group Connect to IoT Hub
		loop for getting and renewing SAS token for identifying with IoT Hub
			eh -> mr ++: Get IoTHub identity
			mr -> is ++: Get IoTHub identity
			return Identity info (IoTHub + device identity + generation ID + credentials type)
			return Identity info (IoTHub + device identity + generation ID + credentials type)

			eh -> mr ++: Get SAS token for identifying with IoT Hub
			mr -> is ++: Get SAS token for Edge Hub to identify with IoT Hub
			is -> ks ++: Get master encryption key
			return Key handle
			is -> ks ++: Sign Edge Hub's name + generation ID using the master encryption key to derive Edge Hub SAS keys
			return
			is -> is: Create SAS token from SAS key
			return SAS token
			return SAS token
			eh -> eh: Create IoT Hub client with SAS token
			eh -> hub ++: Connect to IoT Hub
			hub -> hub: Validate SAS token against SAS key that was registered when the Edge Hub identity was created by the runtime
			return OK
		end
	end
end

@enduml

PlantUML version 1.2020.22(Sun Dec 06 01:36:27 PST 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>