<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="6343px" preserveAspectRatio="none" style="width:2004px;height:6343px;" version="1.1" viewBox="0 0 2004 6343" width="2004px" zoomAndPan="magnify"><defs><filter height="300%" id="f15q5gbkyq2rc9" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="151" x="923.5" y="26.6992">Runtime Operation</text><rect fill="#ADD8E6" height="6293.1719" style="stroke: #A80036; stroke-width: 1.0;" width="1440" x="539" y="39.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="42" x="1236.5" y="51.1543">Device</text><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="128.9375" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="217.5" y="4737.9688"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="68.4688" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="400.5" y="894.875"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="132.4063" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="400.5" y="1436.7969"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="400.5" y="1977.4219"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="132.4063" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="400.5" y="2590.2188"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="400.5" y="2758.8594"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="400.5" y="3138.8438"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="132.4063" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="400.5" y="6106.0469"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="353.5156" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="599.5" y="2150"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="369.75" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="599.5" y="2856.7969"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="599.5" y="3255.7813"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="186.4063" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="599.5" y="3714.9844"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="1259.625" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="599.5" y="3945.5156"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="179.1094" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="599.5" y="5442.25"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="353.5156" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="599.5" y="5665.8281"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="187.6406" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="795.5" y="567.8281"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="264.5781" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="795.5" y="1085.5156"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="383.9844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="795.5" y="1651.9063"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="264.5781" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="795.5" y="2209.7031"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="296.0469" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="795.5" y="2901.2656"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="74.9375" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="795.5" y="5471.4844"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="264.5781" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="795.5" y="5725.5313"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="999.5" y="277.7813"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="999.5" y="381.9531"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="999.5" y="486.125"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="999.5" y="617.2969"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="999.5" y="1114.75"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="999.5" y="1234.1563"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="999.5" y="1681.1406"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="999.5" y="1800.5469"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="999.5" y="2238.9375"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="999.5" y="2358.3438"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="999.5" y="2930.5"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="999.5" y="3049.9063"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="999.5" y="4461.3906"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="999.5" y="4926.2656"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="999.5" y="5754.7656"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="999.5" y="5874.1719"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1185.5" y="691"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="898.1563" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1185.5" y="4277.75"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="751.9844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1190.5" y="4387.6875"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="40.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1195.5" y="4543.0938"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="40.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1195.5" y="4992.7344"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="851.2031" style="stroke: #000000; stroke-width: 2.0;" width="932" x="352" y="127.1406"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="747.2656" style="stroke: #000000; stroke-width: 2.0;" width="912" x="362" y="224.0781"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="591.8594" style="stroke: #000000; stroke-width: 2.0;" width="1230.5" x="352" y="992.3438"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="560.625" style="stroke: #000000; stroke-width: 2.0;" width="1210.5" x="362" y="1016.5781"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="1809.0313" style="stroke: #000000; stroke-width: 2.0;" width="1633" x="352" y="1598.2031"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="634.3281" style="stroke: #000000; stroke-width: 2.0;" width="1390.5" x="362" y="2096.2969"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="489.9219" style="stroke: #000000; stroke-width: 2.0;" width="1260" x="362" y="2803.0938"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="2839.2188" style="stroke: #000000; stroke-width: 2.0;" width="1947.5" x="12" y="3421.2344"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="1920.0781" style="stroke: #000000; stroke-width: 2.0;" width="1783" x="22" y="3445.4688"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="1682.0313" style="stroke: #000000; stroke-width: 2.0;" width="1615" x="180" y="3676.5156"/><rect fill="#FFFFFF" height="1449.1563" style="stroke: none; stroke-width: 1.0;" width="1615" x="180" y="3909.3906"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="216.2969" style="stroke: #000000; stroke-width: 2.0;" width="293" x="533" y="3960.5156"/><rect fill="#FFFFFF" height="114.5938" style="stroke: none; stroke-width: 1.0;" width="293" x="533" y="4062.2188"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="697.75" style="stroke: #000000; stroke-width: 2.0;" width="1197.5" x="190" y="4407.6875"/><rect fill="#FFFFFF" height="230.5313" style="stroke: none; stroke-width: 1.0;" width="1197.5" x="190" y="4874.9063"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="873.9063" style="stroke: #000000; stroke-width: 2.0;" width="1597.5" x="352" y="5379.5469"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="842.6719" style="stroke: #000000; stroke-width: 2.0;" width="1577.5" x="362" y="5403.7813"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="222" x2="222" y1="110.1406" y2="6277.4531"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="405" x2="405" y1="110.1406" y2="6277.4531"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="604" x2="604" y1="110.1406" y2="6277.4531"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="800.5" x2="800.5" y1="110.1406" y2="6277.4531"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1004.5" x2="1004.5" y1="110.1406" y2="6277.4531"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1190" x2="1190" y1="110.1406" y2="6277.4531"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1387.5" x2="1387.5" y1="110.1406" y2="6277.4531"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1567" x2="1567" y1="2076.5938" y2="6277.4531"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1747" x2="1747" y1="3332.7188" y2="6277.4531"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1934" x2="1934" y1="3386.3281" y2="6277.4531"/><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="41" x="200" y="74.7344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="27" x="207" y="94.7227">EST</text><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="41" x="200" y="6276.4531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="27" x="207" y="6296.4414">EST</text><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="63" x="372" y="74.7344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="49" x="379" y="94.7227">IoT Hub</text><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="63" x="372" y="6276.4531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="49" x="379" y="6296.4414">IoT Hub</text><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="119" x="543" y="74.7344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="105" x="550" y="94.7227">Module Runtime</text><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="119" x="543" y="6276.4531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="105" x="550" y="6296.4414">Module Runtime</text><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="114" x="741.5" y="74.7344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="100" x="748.5" y="94.7227">Identity Service</text><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="114" x="741.5" y="6276.4531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="100" x="748.5" y="6296.4414">Identity Service</text><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="96" x="954.5" y="74.7344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="961.5" y="94.7227">Keys Service</text><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="96" x="954.5" y="6276.4531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="961.5" y="6296.4414">Keys Service</text><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="143" x="1117" y="74.7344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="129" x="1124" y="94.7227">Certificates Service</text><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="143" x="1117" y="6276.4531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="129" x="1124" y="6296.4414">Certificates Service</text><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="46.8125" style="stroke: #A80036; stroke-width: 1.5;" width="102" x="1334.5" y="58.3281"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="88" x="1341.5" y="78.3164">Host Process</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="47" x="1362" y="94.7227">Module</text><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="46.8125" style="stroke: #A80036; stroke-width: 1.5;" width="102" x="1334.5" y="6276.4531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="88" x="1341.5" y="6296.4414">Host Process</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="47" x="1362" y="6312.8477">Module</text><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="85" x="1523" y="6276.4531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="71" x="1530" y="6296.4414">EdgeAgent</text><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="71" x="1710" y="6276.4531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="57" x="1717" y="6296.4414">EdgeHub</text><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="46.8125" style="stroke: #A80036; stroke-width: 1.5;" width="77" x="1894" y="6276.4531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="63" x="1901" y="6296.4414">Container</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="47" x="1909" y="6312.8477">Module</text><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="128.9375" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="217.5" y="4737.9688"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="68.4688" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="400.5" y="894.875"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="132.4063" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="400.5" y="1436.7969"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="400.5" y="1977.4219"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="132.4063" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="400.5" y="2590.2188"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="400.5" y="2758.8594"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="400.5" y="3138.8438"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="132.4063" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="400.5" y="6106.0469"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="353.5156" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="599.5" y="2150"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="369.75" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="599.5" y="2856.7969"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="599.5" y="3255.7813"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="186.4063" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="599.5" y="3714.9844"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="1259.625" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="599.5" y="3945.5156"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="179.1094" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="599.5" y="5442.25"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="353.5156" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="599.5" y="5665.8281"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="187.6406" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="795.5" y="567.8281"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="264.5781" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="795.5" y="1085.5156"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="383.9844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="795.5" y="1651.9063"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="264.5781" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="795.5" y="2209.7031"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="296.0469" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="795.5" y="2901.2656"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="74.9375" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="795.5" y="5471.4844"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="264.5781" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="795.5" y="5725.5313"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="999.5" y="277.7813"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="999.5" y="381.9531"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="999.5" y="486.125"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="999.5" y="617.2969"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="999.5" y="1114.75"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="999.5" y="1234.1563"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="999.5" y="1681.1406"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="999.5" y="1800.5469"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="999.5" y="2238.9375"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="999.5" y="2358.3438"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="999.5" y="2930.5"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="999.5" y="3049.9063"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="999.5" y="4461.3906"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="999.5" y="4926.2656"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="999.5" y="5754.7656"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="999.5" y="5874.1719"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1185.5" y="691"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="898.1563" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1185.5" y="4277.75"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="751.9844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1190.5" y="4387.6875"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="40.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1195.5" y="4543.0938"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="40.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1195.5" y="4992.7344"/><path d="M352,127.1406 L603,127.1406 L603,134.1406 L593,144.1406 L352,144.1406 L352,127.1406 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="851.2031" style="stroke: #000000; stroke-width: 2.0;" width="932" x="352" y="127.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="206" x="367" y="140.2012">Host-level modules provisioning</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="800.5" x2="842.5" y1="196.0781" y2="196.0781"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="842.5" x2="842.5" y1="196.0781" y2="209.0781"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="801.5" x2="842.5" y1="209.0781" y2="209.0781"/><polygon fill="#A80036" points="811.5,205.0781,801.5,209.0781,811.5,213.0781,807.5,209.0781" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="807.5" y="175.6699">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="818.5" y="160.4355">Read host-level module</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="818.5" y="175.6699">names from</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="818.5" y="190.9043">configuration</text><path d="M362,224.0781 L435,224.0781 L435,231.0781 L425,241.0781 L362,241.0781 L362,224.0781 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="747.2656" style="stroke: #000000; stroke-width: 2.0;" width="912" x="362" y="224.0781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="377" y="237.1387">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="222" x="450" y="236.2832">[for creating each host-level module M]</text><polygon fill="#A80036" points="987.5,273.7813,997.5,277.7813,987.5,281.7813,991.5,277.7813" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="800.5" x2="993.5" y1="277.7813" y2="277.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="807.5" y="264.9902">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="818.5" y="257.373">Create/Get master identity</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="818.5" y="272.6074">symmetric key</text><polygon fill="#A80036" points="811.5,303.0156,801.5,307.0156,811.5,311.0156,807.5,307.0156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="805.5" x2="1003.5" y1="307.0156" y2="307.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="817.5" y="301.8418">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="828.5" y="301.8418">Key handle</text><polygon fill="#A80036" points="987.5,377.9531,997.5,381.9531,987.5,385.9531,991.5,381.9531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="800.5" x2="993.5" y1="381.9531" y2="381.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="807.5" y="353.9277">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="818.5" y="331.0762">Create module derived</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="818.5" y="346.3105">key object for module M (</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="818.5" y="361.5449">based on master identity</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="67" x="818.5" y="376.7793">key handle)</text><polygon fill="#A80036" points="811.5,407.1875,801.5,411.1875,811.5,415.1875,807.5,411.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="805.5" x2="1003.5" y1="411.1875" y2="411.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="817.5" y="406.0137">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="831.5" y="406.0137"/><polygon fill="#A80036" points="987.5,482.125,997.5,486.125,987.5,490.125,991.5,486.125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="800.5" x2="993.5" y1="486.125" y2="486.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="807.5" y="458.0996">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="818.5" y="435.248">Derive and Sign module</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="818.5" y="450.4824">M's SAS key using name</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="818.5" y="465.7168">+ generation ID (with</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="818.5" y="480.9512">derived key handle)</text><polygon fill="#A80036" points="811.5,511.3594,801.5,515.3594,811.5,519.3594,807.5,515.3594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="805.5" x2="1003.5" y1="515.3594" y2="515.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="817.5" y="510.1855">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="831.5" y="510.1855"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="800.5" x2="847.5" y1="554.8281" y2="554.8281"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="847.5" x2="847.5" y1="554.8281" y2="567.8281"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="806.5" x2="847.5" y1="567.8281" y2="567.8281"/><polygon fill="#A80036" points="816.5,563.8281,806.5,567.8281,816.5,571.8281,812.5,567.8281" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="812.5" y="542.0371">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="823.5" y="534.4199">Get current device identity</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="823.5" y="549.6543">cert and key handle</text><polygon fill="#A80036" points="987.5,613.2969,997.5,617.2969,987.5,621.2969,991.5,617.2969" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="805.5" x2="993.5" y1="617.2969" y2="617.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="812.5" y="604.5059">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="823.5" y="596.8887">Get current device identity</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="823.5" y="612.123">cert's private key</text><polygon fill="#A80036" points="816.5,642.5313,806.5,646.5313,816.5,650.5313,812.5,646.5313" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="810.5" x2="1003.5" y1="646.5313" y2="646.5313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="822.5" y="641.3574">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="840.5" y="641.3574">Key handle</text><polygon fill="#A80036" points="1173.5,687,1183.5,691,1173.5,695,1177.5,691" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="805.5" x2="1179.5" y1="691" y2="691"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="812.5" y="678.209">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="830.5" y="670.5918">Get current device identity</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="830.5" y="685.8262">cert</text><polygon fill="#A80036" points="816.5,716.2344,806.5,720.2344,816.5,724.2344,812.5,720.2344" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="810.5" x2="1189.5" y1="720.2344" y2="720.2344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="822.5" y="715.0605">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="25" x="840.5" y="715.0605">PEM</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="805.5" x2="847.5" y1="754.4688" y2="754.4688"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="847.5" x2="847.5" y1="754.4688" y2="767.4688"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="800.5" x2="847.5" y1="767.4688" y2="767.4688"/><polygon fill="#A80036" points="810.5,763.4688,800.5,767.4688,810.5,771.4688,806.5,767.4688" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="812.5" y="749.2949">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="833.5" y="749.2949"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="800.5" x2="842.5" y1="822.1719" y2="822.1719"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="842.5" x2="842.5" y1="822.1719" y2="835.1719"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="801.5" x2="842.5" y1="835.1719" y2="835.1719"/><polygon fill="#A80036" points="811.5,831.1719,801.5,835.1719,811.5,839.1719,807.5,835.1719" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="807.5" y="801.7637">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="825.5" y="786.5293">Create TLS client using</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="825.5" y="801.7637">key handle + PEM (using</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="825.5" y="816.998">openssl-engine-ks)</text><polygon fill="#A80036" points="421.5,890.875,411.5,894.875,421.5,898.875,417.5,894.875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="415.5" x2="799.5" y1="894.875" y2="894.875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="427.5" y="874.4668">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="445.5" y="859.2324">Create identity for module</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="445.5" y="874.4668">M and register the derived</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="86" x="445.5" y="889.7012">SAS keys for it</text><path d="M525,907.875 L525,932.875 L1072,932.875 L1072,917.875 L1062,907.875 L525,907.875 " fill="#FBFB77" filter="url(#f15q5gbkyq2rc9)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1062,907.875 L1062,917.875 L1072,917.875 L1062,907.875 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="526" x="531" y="924.9355">If IoTHub call ever fails with bad credential, IS requests provisioning (with reprovision=true)</text><polygon fill="#A80036" points="788.5,959.3438,798.5,963.3438,788.5,967.3438,792.5,963.3438" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="405.5" x2="794.5" y1="963.3438" y2="963.3438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="412.5" y="958.1699">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="433.5" y="958.1699"/><path d="M352,992.3438 L647,992.3438 L647,999.3438 L637,1009.3438 L352,1009.3438 L352,992.3438 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="591.8594" style="stroke: #000000; stroke-width: 2.0;" width="1230.5" x="352" y="992.3438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="250" x="367" y="1005.4043">Host-level modules process operations</text><path d="M362,1016.5781 L435,1016.5781 L435,1023.5781 L425,1033.5781 L362,1033.5781 L362,1016.5781 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="560.625" style="stroke: #000000; stroke-width: 2.0;" width="1210.5" x="362" y="1016.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="377" y="1029.6387">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="362" x="450" y="1028.7832">[for getting and renewing SAS token for identifying with IoT Hub]</text><polygon fill="#A80036" points="816.5,1081.5156,806.5,1085.5156,816.5,1089.5156,812.5,1085.5156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="810.5" x2="1386.5" y1="1085.5156" y2="1085.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="822.5" y="1065.1074">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="840.5" y="1049.873">Get SAS token for Edge</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="840.5" y="1065.1074">Agent to identify with IoT</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="840.5" y="1080.3418">Hub</text><polygon fill="#A80036" points="987.5,1110.75,997.5,1114.75,987.5,1118.75,991.5,1114.75" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="805.5" x2="993.5" y1="1114.75" y2="1114.75"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="812.5" y="1109.5762">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="830.5" y="1109.5762">Get master encryption key</text><polygon fill="#A80036" points="816.5,1139.9844,806.5,1143.9844,816.5,1147.9844,812.5,1143.9844" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="810.5" x2="1003.5" y1="1143.9844" y2="1143.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="822.5" y="1138.8105">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="840.5" y="1138.8105">Key handle</text><polygon fill="#A80036" points="987.5,1230.1563,997.5,1234.1563,987.5,1238.1563,991.5,1234.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="805.5" x2="993.5" y1="1234.1563" y2="1234.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="812.5" y="1198.5137">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="830.5" y="1168.0449">Sign Edge Agent's name</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="830.5" y="1183.2793">+ generation ID using the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="830.5" y="1198.5137">master encryption key to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="830.5" y="1213.748">derive Edge Agent SAS</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="830.5" y="1228.9824">keys</text><polygon fill="#A80036" points="816.5,1259.3906,806.5,1263.3906,816.5,1267.3906,812.5,1263.3906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="810.5" x2="1003.5" y1="1263.3906" y2="1263.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="822.5" y="1258.2168">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="843.5" y="1258.2168"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="805.5" x2="847.5" y1="1307.8594" y2="1307.8594"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="847.5" x2="847.5" y1="1307.8594" y2="1320.8594"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="806.5" x2="847.5" y1="1320.8594" y2="1320.8594"/><polygon fill="#A80036" points="816.5,1316.8594,806.5,1320.8594,816.5,1324.8594,812.5,1320.8594" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="812.5" y="1295.0684">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="830.5" y="1287.4512">Create SAS token from</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="830.5" y="1302.6855">SAS key</text><polygon fill="#A80036" points="1375.5,1346.0938,1385.5,1350.0938,1375.5,1354.0938,1379.5,1350.0938" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="800.5" x2="1381.5" y1="1350.0938" y2="1350.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="807.5" y="1344.9199">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="825.5" y="1344.9199">SAS token</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1387.5" x2="1429.5" y1="1394.5625" y2="1394.5625"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1429.5" x2="1429.5" y1="1394.5625" y2="1407.5625"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1388.5" x2="1429.5" y1="1407.5625" y2="1407.5625"/><polygon fill="#A80036" points="1398.5,1403.5625,1388.5,1407.5625,1398.5,1411.5625,1394.5,1407.5625" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1394.5" y="1381.7715">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="1412.5" y="1374.1543">Create IoT Hub client with</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="1412.5" y="1389.3887">SAS token</text><polygon fill="#A80036" points="421.5,1432.7969,411.5,1436.7969,421.5,1440.7969,417.5,1436.7969" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="415.5" x2="1386.5" y1="1436.7969" y2="1436.7969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="427.5" y="1431.623">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="445.5" y="1431.623">Connect to IoT Hub</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="410.5" x2="452.5" y1="1526.9688" y2="1526.9688"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="452.5" x2="452.5" y1="1526.9688" y2="1539.9688"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="411.5" x2="452.5" y1="1539.9688" y2="1539.9688"/><polygon fill="#A80036" points="421.5,1535.9688,411.5,1539.9688,421.5,1543.9688,417.5,1539.9688" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="417.5" y="1491.3262">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="435.5" y="1460.8574">Validate SAS token</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="435.5" y="1476.0918">against SAS key that was</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="435.5" y="1491.3262">registered when the Edge</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="435.5" y="1506.5605">Agent identity was</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="435.5" y="1521.7949">created by the runtime</text><polygon fill="#A80036" points="1375.5,1565.2031,1385.5,1569.2031,1375.5,1573.2031,1379.5,1569.2031" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="405.5" x2="1381.5" y1="1569.2031" y2="1569.2031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="412.5" y="1564.0293">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="17" x="430.5" y="1564.0293">OK</text><path d="M352,1598.2031 L535,1598.2031 L535,1605.2031 L525,1615.2031 L352,1615.2031 L352,1598.2031 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1809.0313" style="stroke: #000000; stroke-width: 2.0;" width="1633" x="352" y="1598.2031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="138" x="367" y="1611.2637">Edge Agent operation</text><polygon fill="#A80036" points="783.5,1647.9063,793.5,1651.9063,783.5,1655.9063,787.5,1651.9063" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="604.5" x2="789.5" y1="1651.9063" y2="1651.9063"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="611.5" y="1639.1152">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="629.5" y="1631.498">Create module identity for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="67" x="629.5" y="1646.7324">Edge Agent</text><polygon fill="#A80036" points="987.5,1677.1406,997.5,1681.1406,987.5,1685.1406,991.5,1681.1406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="805.5" x2="993.5" y1="1681.1406" y2="1681.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="812.5" y="1675.9668">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="830.5" y="1675.9668">Get master encryption key</text><polygon fill="#A80036" points="816.5,1706.375,806.5,1710.375,816.5,1714.375,812.5,1710.375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="810.5" x2="1003.5" y1="1710.375" y2="1710.375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="822.5" y="1705.2012">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="840.5" y="1705.2012">Key handle</text><polygon fill="#A80036" points="987.5,1796.5469,997.5,1800.5469,987.5,1804.5469,991.5,1800.5469" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="805.5" x2="993.5" y1="1800.5469" y2="1800.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="812.5" y="1764.9043">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="830.5" y="1734.4355">Sign Edge Agent's name</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="830.5" y="1749.6699">+ generation ID using the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="830.5" y="1764.9043">master encryption key to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="830.5" y="1780.1387">derive Edge Agent SAS</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="830.5" y="1795.373">keys</text><polygon fill="#A80036" points="816.5,1825.7813,806.5,1829.7813,816.5,1833.7813,812.5,1829.7813" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="810.5" x2="1003.5" y1="1829.7813" y2="1829.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="822.5" y="1824.6074">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="843.5" y="1824.6074"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="805.5" x2="847.5" y1="1889.4844" y2="1889.4844"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="847.5" x2="847.5" y1="1889.4844" y2="1902.4844"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="806.5" x2="847.5" y1="1902.4844" y2="1902.4844"/><polygon fill="#A80036" points="816.5,1898.4844,806.5,1902.4844,816.5,1906.4844,812.5,1902.4844" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="812.5" y="1869.0762">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="830.5" y="1853.8418">Create TLS client using</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="830.5" y="1869.0762">key handle + PEM (using</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="830.5" y="1884.3105">openssl-engine-ks)</text><polygon fill="#A80036" points="421.5,1973.4219,411.5,1977.4219,421.5,1981.4219,417.5,1977.4219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="415.5" x2="794.5" y1="1977.4219" y2="1977.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="427.5" y="1949.3965">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="445.5" y="1926.5449">Create module identity for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="445.5" y="1941.7793">Edge Agent and register</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="445.5" y="1957.0137">the derived SAS keys for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="7" x="445.5" y="1972.248">it</text><polygon fill="#A80036" points="783.5,2002.6563,793.5,2006.6563,783.5,2010.6563,787.5,2006.6563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="405.5" x2="789.5" y1="2006.6563" y2="2006.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="412.5" y="2001.4824">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="433.5" y="2001.4824"/><polygon fill="#A80036" points="615.5,2031.8906,605.5,2035.8906,615.5,2039.8906,611.5,2035.8906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="609.5" x2="799.5" y1="2035.8906" y2="2035.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="621.5" y="2030.7168">36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="639.5" y="2030.7168">Edge Agent identity</text><polygon fill="#A80036" points="1511,2061.125,1521,2065.125,1511,2069.125,1515,2065.125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="604.5" x2="1517" y1="2065.125" y2="2065.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="611.5" y="2059.9512">37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="629.5" y="2059.9512">Create and start</text><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="85" x="1523" y="2043.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="71" x="1530" y="2063.8789">EdgeAgent</text><path d="M362,2096.2969 L435,2096.2969 L435,2103.2969 L425,2113.2969 L362,2113.2969 L362,2096.2969 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="634.3281" style="stroke: #000000; stroke-width: 2.0;" width="1390.5" x="362" y="2096.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="377" y="2109.3574">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="362" x="450" y="2108.502">[for getting and renewing SAS token for identifying with IoT Hub]</text><polygon fill="#A80036" points="620.5,2146,610.5,2150,620.5,2154,616.5,2150" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="614.5" x2="1566.5" y1="2150" y2="2150"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="626.5" y="2137.209">38</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="644.5" y="2129.5918">Get SAS token for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="644.5" y="2144.8262">identifying with IoT Hub</text><polygon fill="#A80036" points="783.5,2205.7031,793.5,2209.7031,783.5,2213.7031,787.5,2209.7031" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="609.5" x2="789.5" y1="2209.7031" y2="2209.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="616.5" y="2189.2949">39</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="634.5" y="2174.0605">Get SAS token for Edge</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="634.5" y="2189.2949">Agent to identify with IoT</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="634.5" y="2204.5293">Hub</text><polygon fill="#A80036" points="987.5,2234.9375,997.5,2238.9375,987.5,2242.9375,991.5,2238.9375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="805.5" x2="993.5" y1="2238.9375" y2="2238.9375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="812.5" y="2233.7637">40</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="830.5" y="2233.7637">Get master encryption key</text><polygon fill="#A80036" points="816.5,2264.1719,806.5,2268.1719,816.5,2272.1719,812.5,2268.1719" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="810.5" x2="1003.5" y1="2268.1719" y2="2268.1719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="822.5" y="2262.998">41</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="840.5" y="2262.998">Key handle</text><polygon fill="#A80036" points="987.5,2354.3438,997.5,2358.3438,987.5,2362.3438,991.5,2358.3438" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="805.5" x2="993.5" y1="2358.3438" y2="2358.3438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="812.5" y="2322.7012">42</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="830.5" y="2292.2324">Sign Edge Agent's name</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="830.5" y="2307.4668">+ generation ID using the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="830.5" y="2322.7012">master encryption key to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="830.5" y="2337.9355">derive Edge Agent SAS</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="830.5" y="2353.1699">keys</text><polygon fill="#A80036" points="816.5,2383.5781,806.5,2387.5781,816.5,2391.5781,812.5,2387.5781" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="810.5" x2="1003.5" y1="2387.5781" y2="2387.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="822.5" y="2382.4043">43</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="843.5" y="2382.4043"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="805.5" x2="847.5" y1="2432.0469" y2="2432.0469"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="847.5" x2="847.5" y1="2432.0469" y2="2445.0469"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="806.5" x2="847.5" y1="2445.0469" y2="2445.0469"/><polygon fill="#A80036" points="816.5,2441.0469,806.5,2445.0469,816.5,2449.0469,812.5,2445.0469" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="812.5" y="2419.2559">44</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="830.5" y="2411.6387">Create SAS token from</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="830.5" y="2426.873">SAS key</text><polygon fill="#A80036" points="620.5,2470.2813,610.5,2474.2813,620.5,2478.2813,616.5,2474.2813" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="614.5" x2="799.5" y1="2474.2813" y2="2474.2813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="626.5" y="2469.1074">45</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="644.5" y="2469.1074">SAS token</text><polygon fill="#A80036" points="1555.5,2499.5156,1565.5,2503.5156,1555.5,2507.5156,1559.5,2503.5156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="604.5" x2="1561.5" y1="2503.5156" y2="2503.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="611.5" y="2498.3418">46</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="629.5" y="2498.3418">SAS token</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1567.5" x2="1609.5" y1="2547.9844" y2="2547.9844"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1609.5" x2="1609.5" y1="2547.9844" y2="2560.9844"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1568.5" x2="1609.5" y1="2560.9844" y2="2560.9844"/><polygon fill="#A80036" points="1578.5,2556.9844,1568.5,2560.9844,1578.5,2564.9844,1574.5,2560.9844" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1574.5" y="2535.1934">47</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="1592.5" y="2527.5762">Create IoT Hub client with</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="1592.5" y="2542.8105">SAS token</text><polygon fill="#A80036" points="421.5,2586.2188,411.5,2590.2188,421.5,2594.2188,417.5,2590.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="415.5" x2="1566.5" y1="2590.2188" y2="2590.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="427.5" y="2585.0449">48</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="445.5" y="2585.0449">Connect to IoT Hub</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="410.5" x2="452.5" y1="2680.3906" y2="2680.3906"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="452.5" x2="452.5" y1="2680.3906" y2="2693.3906"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="411.5" x2="452.5" y1="2693.3906" y2="2693.3906"/><polygon fill="#A80036" points="421.5,2689.3906,411.5,2693.3906,421.5,2697.3906,417.5,2693.3906" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="417.5" y="2644.748">49</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="435.5" y="2614.2793">Validate SAS token</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="435.5" y="2629.5137">against SAS key that was</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="435.5" y="2644.748">registered when the Edge</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="435.5" y="2659.9824">Agent identity was</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="435.5" y="2675.2168">created by the runtime</text><polygon fill="#A80036" points="1555.5,2718.625,1565.5,2722.625,1555.5,2726.625,1559.5,2722.625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="405.5" x2="1561.5" y1="2722.625" y2="2722.625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="412.5" y="2717.4512">50</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="17" x="430.5" y="2717.4512">OK</text><polygon fill="#A80036" points="421.5,2754.8594,411.5,2758.8594,421.5,2762.8594,417.5,2758.8594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="415.5" x2="1566.5" y1="2758.8594" y2="2758.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="427.5" y="2753.6855">51</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="445.5" y="2753.6855">Get deployment</text><polygon fill="#A80036" points="1555.5,2784.0938,1565.5,2788.0938,1555.5,2792.0938,1559.5,2788.0938" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="405.5" x2="1561.5" y1="2788.0938" y2="2788.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="412.5" y="2782.9199">52</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="433.5" y="2782.9199"/><path d="M362,2803.0938 L435,2803.0938 L435,2810.0938 L425,2820.0938 L362,2820.0938 L362,2803.0938 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="489.9219" style="stroke: #000000; stroke-width: 2.0;" width="1260" x="362" y="2803.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="377" y="2816.1543">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="112" x="450" y="2815.2988">[for each module M]</text><polygon fill="#A80036" points="620.5,2852.7969,610.5,2856.7969,620.5,2860.7969,616.5,2856.7969" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="614.5" x2="1566.5" y1="2856.7969" y2="2856.7969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="626.5" y="2844.0059">53</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="644.5" y="2836.3887">Create identity for module</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="11" x="644.5" y="2851.623">M</text><polygon fill="#A80036" points="783.5,2897.2656,793.5,2901.2656,783.5,2905.2656,787.5,2901.2656" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="609.5" x2="789.5" y1="2901.2656" y2="2901.2656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="616.5" y="2888.4746">54</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="634.5" y="2880.8574">Create identity for module</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="11" x="634.5" y="2896.0918">M</text><polygon fill="#A80036" points="987.5,2926.5,997.5,2930.5,987.5,2934.5,991.5,2930.5" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="805.5" x2="993.5" y1="2930.5" y2="2930.5"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="812.5" y="2925.3262">55</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="830.5" y="2925.3262">Get master encryption key</text><polygon fill="#A80036" points="816.5,2955.7344,806.5,2959.7344,816.5,2963.7344,812.5,2959.7344" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="810.5" x2="1003.5" y1="2959.7344" y2="2959.7344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="822.5" y="2954.5605">56</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="840.5" y="2954.5605">Key handle</text><polygon fill="#A80036" points="987.5,3045.9063,997.5,3049.9063,987.5,3053.9063,991.5,3049.9063" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="805.5" x2="993.5" y1="3049.9063" y2="3049.9063"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="812.5" y="3014.2637">57</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="830.5" y="2983.7949">Sign module M's name +</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="830.5" y="2999.0293">generation ID using the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="830.5" y="3014.2637">master encryption key to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="830.5" y="3029.498">derive module M's SAS</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="830.5" y="3044.7324">keys</text><polygon fill="#A80036" points="816.5,3075.1406,806.5,3079.1406,816.5,3083.1406,812.5,3079.1406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="810.5" x2="1003.5" y1="3079.1406" y2="3079.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="822.5" y="3073.9668">58</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="843.5" y="3073.9668"/><polygon fill="#A80036" points="421.5,3134.8438,411.5,3138.8438,421.5,3142.8438,417.5,3138.8438" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="415.5" x2="794.5" y1="3138.8438" y2="3138.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="427.5" y="3118.4355">59</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="445.5" y="3103.2012">Create identity for module</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="445.5" y="3118.4355">M and register the derived</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="86" x="445.5" y="3133.6699">SAS keys for it</text><polygon fill="#A80036" points="783.5,3164.0781,793.5,3168.0781,783.5,3172.0781,787.5,3168.0781" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="405.5" x2="789.5" y1="3168.0781" y2="3168.0781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="412.5" y="3162.9043">60</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="433.5" y="3162.9043"/><polygon fill="#A80036" points="620.5,3193.3125,610.5,3197.3125,620.5,3201.3125,616.5,3197.3125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="614.5" x2="799.5" y1="3197.3125" y2="3197.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="626.5" y="3192.1387">61</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="647.5" y="3192.1387"/><polygon fill="#A80036" points="1555.5,3222.5469,1565.5,3226.5469,1555.5,3230.5469,1559.5,3226.5469" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="604.5" x2="1561.5" y1="3226.5469" y2="3226.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="611.5" y="3221.373">62</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="632.5" y="3221.373"/><polygon fill="#A80036" points="620.5,3251.7813,610.5,3255.7813,620.5,3259.7813,616.5,3255.7813" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="614.5" x2="1566.5" y1="3255.7813" y2="3255.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="626.5" y="3250.6074">63</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="75" x="644.5" y="3250.6074">Start module</text><polygon fill="#A80036" points="1555.5,3281.0156,1565.5,3285.0156,1555.5,3289.0156,1559.5,3285.0156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="604.5" x2="1561.5" y1="3285.0156" y2="3285.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="611.5" y="3279.8418">64</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="632.5" y="3279.8418"/><polygon fill="#A80036" points="1698,3317.25,1708,3321.25,1698,3325.25,1702,3321.25" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="604.5" x2="1704" y1="3321.25" y2="3321.25"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="611.5" y="3316.0762">65</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="629.5" y="3316.0762">Start Edge Hub</text><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="71" x="1710" y="3300.0156"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="57" x="1717" y="3320.0039">EdgeHub</text><polygon fill="#A80036" points="1882,3362.6563,1892,3366.6563,1882,3370.6563,1886,3366.6563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="604.5" x2="1888" y1="3366.6563" y2="3366.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="611.5" y="3361.4824">66</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="629.5" y="3361.4824">Start Custom module</text><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="46.8125" style="stroke: #A80036; stroke-width: 1.5;" width="77" x="1894" y="3345.4219"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="63" x="1901" y="3365.4102">Container</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="47" x="1909" y="3381.8164">Module</text><path d="M12,3421.2344 L183,3421.2344 L183,3428.2344 L173,3438.2344 L12,3438.2344 L12,3421.2344 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2839.2188" style="stroke: #000000; stroke-width: 2.0;" width="1947.5" x="12" y="3421.2344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="126" x="27" y="3434.2949">Edge Hub operation</text><path d="M22,3445.4688 L95,3445.4688 L95,3452.4688 L85,3462.4688 L22,3462.4688 L22,3445.4688 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1920.0781" style="stroke: #000000; stroke-width: 2.0;" width="1783" x="22" y="3445.4688"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="37" y="3458.5293">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="208" x="110" y="3457.6738">[for server cert request and renewal]</text><path d="M32,3467.7031 L32,3659.7031 L774,3659.7031 L774,3477.7031 L764,3467.7031 L32,3467.7031 " fill="#FBFB77" filter="url(#f15q5gbkyq2rc9)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M764,3467.7031 L764,3477.7031 L774,3477.7031 L764,3467.7031 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="485" x="38" y="3484.7637">While it is possible to make an openssl engine (like openssl-engine-ks) for modules</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="537" x="38" y="3499.998">that performs key operations using the KS, it is not feasible to expect all modules to be using</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="583" x="38" y="3515.2324">openssl for TLS, especially Windows modules. Thus modules need to have the raw private key bytes</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="38" y="3530.4668">to be able to serve TLS with a server cert.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="41" y="3545.7012"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="531" x="38" y="3560.9355">For this reason, the private keys of module server certs are not persisted using Keys Service.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="41" y="3576.1699"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="622" x="38" y="3591.4043">Also, note that a single server cert is shared between all modules, and its lifetime is managed by the runtime.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="721" x="38" y="3606.6387">This is because the user may have module server certs rooted to public CAs, so it would cost the customer $$$ for each cert.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="653" x="38" y="3621.873">Thus we do not want to request a new server cert when a previously requested cert is still valid, which also means</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="718" x="38" y="3637.1074">we want to dedupe the server certs across all modules that want them. Since server certs are issued for the device hostname</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="397" x="38" y="3652.3418">anyway, reusing the server cert for multiple modules is not a concern.</text><path d="M180,3676.5156 L243,3676.5156 L243,3683.5156 L233,3693.5156 L180,3693.5156 L180,3676.5156 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1682.0313" style="stroke: #000000; stroke-width: 2.0;" width="1615" x="180" y="3676.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="195" y="3689.5762">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="227" x="258" y="3688.7207">[if server cert already exists and is valid]</text><polygon fill="#A80036" points="620.5,3710.9844,610.5,3714.9844,620.5,3718.9844,616.5,3714.9844" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="614.5" x2="1746.5" y1="3714.9844" y2="3714.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="626.5" y="3709.8105">67</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="644.5" y="3709.8105">Get server cert</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="609.5" x2="651.5" y1="3744.2188" y2="3744.2188"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="651.5" x2="651.5" y1="3744.2188" y2="3757.2188"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="610.5" x2="651.5" y1="3757.2188" y2="3757.2188"/><polygon fill="#A80036" points="620.5,3753.2188,610.5,3757.2188,620.5,3761.2188,616.5,3757.2188" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="616.5" y="3739.0449">68</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="634.5" y="3739.0449">Get persisted server cert</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="609.5" x2="651.5" y1="3786.4531" y2="3786.4531"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="651.5" x2="651.5" y1="3786.4531" y2="3799.4531"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="610.5" x2="651.5" y1="3799.4531" y2="3799.4531"/><polygon fill="#A80036" points="620.5,3795.4531,610.5,3799.4531,620.5,3803.4531,616.5,3799.4531" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="616.5" y="3781.2793">69</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="634.5" y="3781.2793">Server cert is valid</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="609.5" x2="651.5" y1="3843.9219" y2="3843.9219"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="651.5" x2="651.5" y1="3843.9219" y2="3856.9219"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="610.5" x2="651.5" y1="3856.9219" y2="3856.9219"/><polygon fill="#A80036" points="620.5,3852.9219,610.5,3856.9219,620.5,3860.9219,616.5,3856.9219" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="616.5" y="3831.1309">70</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="634.5" y="3823.5137">Get persisted server cert'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="634.5" y="3838.748">s private key</text><polygon fill="#A80036" points="1735.5,3897.3906,1745.5,3901.3906,1735.5,3905.3906,1739.5,3901.3906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="604.5" x2="1741.5" y1="3901.3906" y2="3901.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="611.5" y="3888.5996">71</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="629.5" y="3880.9824">Server cert and private</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="20" x="629.5" y="3896.2168">key</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="180" x2="1795" y1="3910.3906" y2="3910.3906"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="235" x="185" y="3920.5957">[if server cert does not exist or is expired]</text><polygon fill="#A80036" points="620.5,3941.5156,610.5,3945.5156,620.5,3949.5156,616.5,3945.5156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="614.5" x2="1746.5" y1="3945.5156" y2="3945.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="626.5" y="3940.3418">72</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="644.5" y="3940.3418">Get server cert</text><path d="M533,3960.5156 L596,3960.5156 L596,3967.5156 L586,3977.5156 L533,3977.5156 L533,3960.5156 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="216.2969" style="stroke: #000000; stroke-width: 2.0;" width="293" x="533" y="3960.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="548" y="3973.5762">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="163" x="611" y="3972.7207">[if server cert does not exist]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="609.5" x2="651.5" y1="3998.9844" y2="3998.9844"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="651.5" x2="651.5" y1="3998.9844" y2="4011.9844"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="610.5" x2="651.5" y1="4011.9844" y2="4011.9844"/><polygon fill="#A80036" points="620.5,4007.9844,610.5,4011.9844,620.5,4015.9844,616.5,4011.9844" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="616.5" y="3993.8105">73</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="634.5" y="3993.8105">Get persisted server cert</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="609.5" x2="651.5" y1="4041.2188" y2="4041.2188"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="651.5" x2="651.5" y1="4041.2188" y2="4054.2188"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="610.5" x2="651.5" y1="4054.2188" y2="4054.2188"/><polygon fill="#A80036" points="620.5,4050.2188,610.5,4054.2188,620.5,4058.2188,616.5,4054.2188" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="616.5" y="4036.0449">74</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="634.5" y="4036.0449">Server cert is not found</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="533" x2="826" y1="4063.2188" y2="4063.2188"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="288" x="538" y="4073.4238">[if server cert exists but is expired / close to expiry]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="609.5" x2="651.5" y1="4098.3438" y2="4098.3438"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="651.5" x2="651.5" y1="4098.3438" y2="4111.3438"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="610.5" x2="651.5" y1="4111.3438" y2="4111.3438"/><polygon fill="#A80036" points="620.5,4107.3438,610.5,4111.3438,620.5,4115.3438,616.5,4111.3438" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="616.5" y="4093.1699">75</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="634.5" y="4093.1699">Get persisted server cert</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="609.5" x2="651.5" y1="4155.8125" y2="4155.8125"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="651.5" x2="651.5" y1="4155.8125" y2="4168.8125"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="610.5" x2="651.5" y1="4168.8125" y2="4168.8125"/><polygon fill="#A80036" points="620.5,4164.8125,610.5,4168.8125,620.5,4172.8125,616.5,4168.8125" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="616.5" y="4143.0215">76</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="634.5" y="4135.4043">Server cert is expired /</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="634.5" y="4150.6387">close to expiry</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="609.5" x2="651.5" y1="4220.2813" y2="4220.2813"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="651.5" x2="651.5" y1="4220.2813" y2="4233.2813"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="610.5" x2="651.5" y1="4233.2813" y2="4233.2813"/><polygon fill="#A80036" points="620.5,4229.2813,610.5,4233.2813,620.5,4237.2813,616.5,4233.2813" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="616.5" y="4207.4902">77</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="634.5" y="4199.873">Create new asymmetric</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="634.5" y="4215.1074">key pair (in memory)</text><polygon fill="#A80036" points="1173.5,4273.75,1183.5,4277.75,1173.5,4281.75,1177.5,4277.75" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="609.5" x2="1179.5" y1="4277.75" y2="4277.75"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="616.5" y="4264.959">78</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="634.5" y="4257.3418">Request new module</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="634.5" y="4272.5762">server cert</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1195.5" x2="1237.5" y1="4337.4531" y2="4337.4531"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1237.5" x2="1237.5" y1="4337.4531" y2="4350.4531"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1196.5" x2="1237.5" y1="4350.4531" y2="4350.4531"/><polygon fill="#A80036" points="1206.5,4346.4531,1196.5,4350.4531,1206.5,4354.4531,1202.5,4350.4531" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1202.5" y="4317.0449">79</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="1220.5" y="4301.8105">Create CSR for new</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="1220.5" y="4317.0449">module server cert using</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="20" x="1220.5" y="4332.2793">key</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1195.5" x2="1242.5" y1="4374.6875" y2="4374.6875"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1242.5" x2="1242.5" y1="4374.6875" y2="4387.6875"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1201.5" x2="1242.5" y1="4387.6875" y2="4387.6875"/><polygon fill="#A80036" points="1211.5,4383.6875,1201.5,4387.6875,1211.5,4391.6875,1207.5,4387.6875" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1207.5" y="4369.5137">80</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="1225.5" y="4369.5137">Get module server cert</text><path d="M190,4407.6875 L253,4407.6875 L253,4414.6875 L243,4424.6875 L190,4424.6875 L190,4407.6875 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="697.75" style="stroke: #000000; stroke-width: 2.0;" width="1197.5" x="190" y="4407.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="205" y="4420.748">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="228" x="268" y="4419.8926">[if module certs should be issued by EST]</text><polygon fill="#A80036" points="1020.5,4457.3906,1010.5,4461.3906,1020.5,4465.3906,1016.5,4461.3906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1014.5" x2="1189.5" y1="4461.3906" y2="4461.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1026.5" y="4448.5996">81</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="1044.5" y="4440.9824">Get current EST identity</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="1044.5" y="4456.2168">cert's private key</text><polygon fill="#A80036" points="1178.5,4486.625,1188.5,4490.625,1178.5,4494.625,1182.5,4490.625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1004.5" x2="1184.5" y1="4490.625" y2="4490.625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1011.5" y="4485.4512">82</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="1029.5" y="4485.4512">Key handle</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1200.5" x2="1247.5" y1="4530.0938" y2="4530.0938"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1247.5" x2="1247.5" y1="4530.0938" y2="4543.0938"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1206.5" x2="1247.5" y1="4543.0938" y2="4543.0938"/><polygon fill="#A80036" points="1216.5,4539.0938,1206.5,4543.0938,1216.5,4547.0938,1212.5,4543.0938" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1212.5" y="4517.3027">83</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="1230.5" y="4509.6855">Get current EST identity</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1230.5" y="4524.9199">cert</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1205.5" x2="1247.5" y1="4582.3281" y2="4582.3281"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1247.5" x2="1247.5" y1="4582.3281" y2="4595.3281"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1200.5" x2="1247.5" y1="4595.3281" y2="4595.3281"/><polygon fill="#A80036" points="1210.5,4591.3281,1200.5,4595.3281,1210.5,4599.3281,1206.5,4595.3281" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1212.5" y="4577.1543">84</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="25" x="1230.5" y="4577.1543">PEM</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1200.5" x2="1242.5" y1="4650.0313" y2="4650.0313"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1242.5" x2="1242.5" y1="4650.0313" y2="4663.0313"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1201.5" x2="1242.5" y1="4663.0313" y2="4663.0313"/><polygon fill="#A80036" points="1211.5,4659.0313,1201.5,4663.0313,1211.5,4667.0313,1207.5,4663.0313" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1207.5" y="4629.623">85</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="1225.5" y="4614.3887">Create TLS client using</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="1225.5" y="4629.623">key handle + PEM (using</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="1225.5" y="4644.8574">openssl-engine-ks)</text><polygon fill="#A80036" points="238.5,4733.9688,228.5,4737.9688,238.5,4741.9688,234.5,4737.9688" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="232.5" x2="1189.5" y1="4737.9688" y2="4737.9688"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="244.5" y="4709.9434">86</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="262.5" y="4687.0918">Connect using TLS client</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="262.5" y="4702.3262">and send request for new</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="262.5" y="4717.5605">module server cert</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="262.5" y="4732.7949">corresponding to the CSR</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="227.5" x2="269.5" y1="4782.4375" y2="4782.4375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="269.5" x2="269.5" y1="4782.4375" y2="4795.4375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="228.5" x2="269.5" y1="4795.4375" y2="4795.4375"/><polygon fill="#A80036" points="238.5,4791.4375,228.5,4795.4375,238.5,4799.4375,234.5,4795.4375" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="234.5" y="4769.6465">87</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="252.5" y="4762.0293">Verify client cert against</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="252.5" y="4777.2637">CA</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="227.5" x2="269.5" y1="4824.6719" y2="4824.6719"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="269.5" x2="269.5" y1="4824.6719" y2="4837.6719"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="228.5" x2="269.5" y1="4837.6719" y2="4837.6719"/><polygon fill="#A80036" points="238.5,4833.6719,228.5,4837.6719,238.5,4841.6719,234.5,4837.6719" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="234.5" y="4819.498">88</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="55" x="252.5" y="4819.498">Sign CSR</text><polygon fill="#A80036" points="1178.5,4862.9063,1188.5,4866.9063,1178.5,4870.9063,1182.5,4866.9063" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="222.5" x2="1184.5" y1="4866.9063" y2="4866.9063"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="229.5" y="4861.7324">89</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="247.5" y="4861.7324">Signed server cert</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="190" x2="1387.5" y1="4875.9063" y2="4875.9063"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="230" x="195" y="4886.1113">[if module certs should be minted locally]</text><polygon fill="#A80036" points="1020.5,4922.2656,1010.5,4926.2656,1020.5,4930.2656,1016.5,4926.2656" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1014.5" x2="1189.5" y1="4926.2656" y2="4926.2656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1026.5" y="4913.4746">90</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="115" x="1044.5" y="4905.8574">Get device CA cert's</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="1044.5" y="4921.0918">private key</text><polygon fill="#A80036" points="1178.5,4951.5,1188.5,4955.5,1178.5,4959.5,1182.5,4955.5" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1004.5" x2="1184.5" y1="4955.5" y2="4955.5"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1011.5" y="4950.3262">91</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="1029.5" y="4950.3262">Key handle</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1200.5" x2="1247.5" y1="4979.7344" y2="4979.7344"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1247.5" x2="1247.5" y1="4979.7344" y2="4992.7344"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1206.5" x2="1247.5" y1="4992.7344" y2="4992.7344"/><polygon fill="#A80036" points="1216.5,4988.7344,1206.5,4992.7344,1216.5,4996.7344,1212.5,4992.7344" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1212.5" y="4974.5605">92</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="1230.5" y="4974.5605">Get device CA cert</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1205.5" x2="1247.5" y1="5031.9688" y2="5031.9688"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1247.5" x2="1247.5" y1="5031.9688" y2="5044.9688"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1200.5" x2="1247.5" y1="5044.9688" y2="5044.9688"/><polygon fill="#A80036" points="1210.5,5040.9688,1200.5,5044.9688,1210.5,5048.9688,1206.5,5044.9688" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1212.5" y="5026.7949">93</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="25" x="1230.5" y="5026.7949">PEM</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1200.5" x2="1242.5" y1="5084.4375" y2="5084.4375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1242.5" x2="1242.5" y1="5084.4375" y2="5097.4375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1201.5" x2="1242.5" y1="5097.4375" y2="5097.4375"/><polygon fill="#A80036" points="1211.5,5093.4375,1201.5,5097.4375,1211.5,5101.4375,1207.5,5097.4375" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1207.5" y="5071.6465">94</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="1225.5" y="5064.0293">Sign CSR using device CA</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1225.5" y="5079.2637">cert</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1200.5" x2="1242.5" y1="5138.6719" y2="5138.6719"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1242.5" x2="1242.5" y1="5138.6719" y2="5151.6719"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1195.5" x2="1242.5" y1="5151.6719" y2="5151.6719"/><polygon fill="#A80036" points="1205.5,5147.6719,1195.5,5151.6719,1205.5,5155.6719,1201.5,5151.6719" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1207.5" y="5133.498">95</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="1225.5" y="5133.498">Signed server cert</text><polygon fill="#A80036" points="620.5,5171.9063,610.5,5175.9063,620.5,5179.9063,616.5,5175.9063" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="614.5" x2="1189.5" y1="5175.9063" y2="5175.9063"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="626.5" y="5170.7324">96</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="644.5" y="5170.7324">Signed server cert</text><polygon fill="#A80036" points="1735.5,5201.1406,1745.5,5205.1406,1735.5,5209.1406,1739.5,5205.1406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="604.5" x2="1741.5" y1="5205.1406" y2="5205.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="611.5" y="5199.9668">97</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="629.5" y="5199.9668">Signed server cert</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="604.5" x2="646.5" y1="5249.6094" y2="5249.6094"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="646.5" x2="646.5" y1="5249.6094" y2="5262.6094"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="605.5" x2="646.5" y1="5262.6094" y2="5262.6094"/><polygon fill="#A80036" points="615.5,5258.6094,605.5,5262.6094,615.5,5266.6094,611.5,5262.6094" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="611.5" y="5236.8184">98</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="629.5" y="5229.2012">Save key pair as server</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="629.5" y="5244.4355">cert private key</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="604.5" x2="646.5" y1="5337.5469" y2="5337.5469"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="646.5" x2="646.5" y1="5337.5469" y2="5350.5469"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="605.5" x2="646.5" y1="5350.5469" y2="5350.5469"/><polygon fill="#A80036" points="615.5,5346.5469,605.5,5350.5469,615.5,5354.5469,611.5,5350.5469" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="611.5" y="5309.5215">99</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="629.5" y="5286.6699">Save signed cert so that it</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="629.5" y="5301.9043">can be retrieved for future</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="629.5" y="5317.1387">module server cert</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="51" x="629.5" y="5332.373">requests</text><path d="M352,5379.5469 L522,5379.5469 L522,5386.5469 L512,5396.5469 L352,5396.5469 L352,5379.5469 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="873.9063" style="stroke: #000000; stroke-width: 2.0;" width="1597.5" x="352" y="5379.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="367" y="5392.6074">Connect to IoT Hub</text><path d="M362,5403.7813 L435,5403.7813 L435,5410.7813 L425,5420.7813 L362,5420.7813 L362,5403.7813 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="842.6719" style="stroke: #000000; stroke-width: 2.0;" width="1577.5" x="362" y="5403.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="377" y="5416.8418">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="362" x="450" y="5415.9863">[for getting and renewing SAS token for identifying with IoT Hub]</text><polygon fill="#A80036" points="620.5,5438.25,610.5,5442.25,620.5,5446.25,616.5,5442.25" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="614.5" x2="1746.5" y1="5442.25" y2="5442.25"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="626.5" y="5437.0762">100</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="651.5" y="5437.0762">Get IoTHub identity</text><polygon fill="#A80036" points="783.5,5467.4844,793.5,5471.4844,783.5,5475.4844,787.5,5471.4844" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="609.5" x2="789.5" y1="5471.4844" y2="5471.4844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="616.5" y="5466.3105">101</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="641.5" y="5466.3105">Get IoTHub identity</text><polygon fill="#A80036" points="620.5,5542.4219,610.5,5546.4219,620.5,5550.4219,616.5,5546.4219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="614.5" x2="799.5" y1="5546.4219" y2="5546.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="626.5" y="5518.3965">102</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="651.5" y="5495.5449">Identity info (IoTHub +</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="94" x="651.5" y="5510.7793">device identity +</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="651.5" y="5526.0137">generation ID +</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="651.5" y="5541.248">credentials type)</text><polygon fill="#A80036" points="1735.5,5617.3594,1745.5,5621.3594,1735.5,5625.3594,1739.5,5621.3594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="604.5" x2="1741.5" y1="5621.3594" y2="5621.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="611.5" y="5593.334">103</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="636.5" y="5570.4824">Identity info (IoTHub +</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="94" x="636.5" y="5585.7168">device identity +</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="636.5" y="5600.9512">generation ID +</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="636.5" y="5616.1855">credentials type)</text><polygon fill="#A80036" points="620.5,5661.8281,610.5,5665.8281,620.5,5669.8281,616.5,5665.8281" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="614.5" x2="1746.5" y1="5665.8281" y2="5665.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="626.5" y="5653.0371">104</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="651.5" y="5645.4199">Get SAS token for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="651.5" y="5660.6543">identifying with IoT Hub</text><polygon fill="#A80036" points="783.5,5721.5313,793.5,5725.5313,783.5,5729.5313,787.5,5725.5313" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="609.5" x2="789.5" y1="5725.5313" y2="5725.5313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="616.5" y="5705.123">105</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="641.5" y="5689.8887">Get SAS token for Edge</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="641.5" y="5705.123">Hub to identify with IoT</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="641.5" y="5720.3574">Hub</text><polygon fill="#A80036" points="987.5,5750.7656,997.5,5754.7656,987.5,5758.7656,991.5,5754.7656" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="805.5" x2="993.5" y1="5754.7656" y2="5754.7656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="812.5" y="5749.5918">106</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="837.5" y="5749.5918">Get master encryption key</text><polygon fill="#A80036" points="816.5,5780,806.5,5784,816.5,5788,812.5,5784" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="810.5" x2="1003.5" y1="5784" y2="5784"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="822.5" y="5778.8262">107</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="847.5" y="5778.8262">Key handle</text><polygon fill="#A80036" points="987.5,5870.1719,997.5,5874.1719,987.5,5878.1719,991.5,5874.1719" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="805.5" x2="993.5" y1="5874.1719" y2="5874.1719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="812.5" y="5838.5293">108</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="837.5" y="5808.0605">Sign Edge Hub's name +</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="837.5" y="5823.2949">generation ID using the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="837.5" y="5838.5293">master encryption key to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="837.5" y="5853.7637">derive Edge Hub SAS</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="837.5" y="5868.998">keys</text><polygon fill="#A80036" points="816.5,5899.4063,806.5,5903.4063,816.5,5907.4063,812.5,5903.4063" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="810.5" x2="1003.5" y1="5903.4063" y2="5903.4063"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="822.5" y="5898.2324">109</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="850.5" y="5898.2324"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="805.5" x2="847.5" y1="5947.875" y2="5947.875"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="847.5" x2="847.5" y1="5947.875" y2="5960.875"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="806.5" x2="847.5" y1="5960.875" y2="5960.875"/><polygon fill="#A80036" points="816.5,5956.875,806.5,5960.875,816.5,5964.875,812.5,5960.875" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="812.5" y="5935.084">110</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="837.5" y="5927.4668">Create SAS token from</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="837.5" y="5942.7012">SAS key</text><polygon fill="#A80036" points="620.5,5986.1094,610.5,5990.1094,620.5,5994.1094,616.5,5990.1094" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="614.5" x2="799.5" y1="5990.1094" y2="5990.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="626.5" y="5984.9355">111</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="651.5" y="5984.9355">SAS token</text><polygon fill="#A80036" points="1735.5,6015.3438,1745.5,6019.3438,1735.5,6023.3438,1739.5,6019.3438" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="604.5" x2="1741.5" y1="6019.3438" y2="6019.3438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="611.5" y="6014.1699">112</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="636.5" y="6014.1699">SAS token</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1747.5" x2="1789.5" y1="6063.8125" y2="6063.8125"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1789.5" x2="1789.5" y1="6063.8125" y2="6076.8125"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1748.5" x2="1789.5" y1="6076.8125" y2="6076.8125"/><polygon fill="#A80036" points="1758.5,6072.8125,1748.5,6076.8125,1758.5,6080.8125,1754.5,6076.8125" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="1754.5" y="6051.0215">113</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="1779.5" y="6043.4043">Create IoT Hub client with</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="1779.5" y="6058.6387">SAS token</text><polygon fill="#A80036" points="421.5,6102.0469,411.5,6106.0469,421.5,6110.0469,417.5,6106.0469" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="415.5" x2="1746.5" y1="6106.0469" y2="6106.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="427.5" y="6100.873">114</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="452.5" y="6100.873">Connect to IoT Hub</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="410.5" x2="452.5" y1="6196.2188" y2="6196.2188"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="452.5" x2="452.5" y1="6196.2188" y2="6209.2188"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="411.5" x2="452.5" y1="6209.2188" y2="6209.2188"/><polygon fill="#A80036" points="421.5,6205.2188,411.5,6209.2188,421.5,6213.2188,417.5,6209.2188" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="417.5" y="6160.5762">115</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="442.5" y="6130.1074">Validate SAS token</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="442.5" y="6145.3418">against SAS key that was</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="442.5" y="6160.5762">registered when the Edge</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="442.5" y="6175.8105">Hub identity was created</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="81" x="442.5" y="6191.0449">by the runtime</text><polygon fill="#A80036" points="1735.5,6234.4531,1745.5,6238.4531,1735.5,6242.4531,1739.5,6238.4531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="405.5" x2="1741.5" y1="6238.4531" y2="6238.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="412.5" y="6233.2793">116</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="17" x="437.5" y="6233.2793">OK</text><!--MD5=[c301a159521665060ae5774730d5807e]
@startuml

title Runtime Operation
skinparam maxMessageSize 150

participant "EST" as est
participant "IoT Hub" as hub

box Device #LightBlue
	participant "Module Runtime" as mr
	participant "Identity Service" as is
	participant "Keys Service" as ks
	participant "Certificates Service" as cs
	participant "Host Process\nModule" as hlm
	participant "EdgeAgent" as ea
	participant "EdgeHub" as eh
	participant "Container\nModule" as cm
end box


autonumber

group Host-level modules provisioning
	is -> is: Read host-level module names from configuration 
	loop for creating each host-level module M
		is -> ks ++: Create/Get master identity symmetric key
		return Key handle
		is -> ks++: Create module derived key object for module M (based on master identity key handle)
		return
		is -> ks ++: Derive and Sign module M's SAS key using name + generation ID (with derived key handle)
		return
		is -> is ++: Get current device identity cert and key handle
		is -> ks ++: Get current device identity cert's private key
		return Key handle
		is -> cs ++: Get current device identity cert
		return PEM
		return
		is -> is: Create TLS client using key handle + PEM (using openssl-engine-ks)
		is -> hub ++: Create identity for module M and register the derived SAS keys for it
		note over is
			If IoTHub call ever fails with bad credential, IS requests provisioning (with reprovision=true)
		end note
		return
	end
end

group Host-level modules process operations
	loop for getting and renewing SAS token for identifying with IoT Hub
		hlm -> is ++: Get SAS token for Edge Agent to identify with IoT Hub
		is -> ks ++: Get master encryption key
		return Key handle
		is -> ks ++: Sign Edge Agent's name + generation ID using the master encryption key to derive Edge Agent SAS keys
		return
		is -> is: Create SAS token from SAS key
		return SAS token
		hlm -> hlm: Create IoT Hub client with SAS token
		hlm -> hub ++: Connect to IoT Hub
		hub -> hub: Validate SAS token against SAS key that was registered when the Edge Agent identity was created by the runtime
		return OK
	end
end

group Edge Agent operation
	mr -> is ++: Create module identity for Edge Agent
	is -> ks ++: Get master encryption key
	return Key handle
	is -> ks ++: Sign Edge Agent's name + generation ID using the master encryption key to derive Edge Agent SAS keys
	return
	is -> is: Create TLS client using key handle + PEM (using openssl-engine-ks)
	is -> hub ++: Create module identity for Edge Agent and register the derived SAS keys for it
	return
	return Edge Agent identity

	mr -> ea **: Create and start

	loop for getting and renewing SAS token for identifying with IoT Hub
		ea -> mr ++: Get SAS token for identifying with IoT Hub
		mr -> is ++: Get SAS token for Edge Agent to identify with IoT Hub
		is -> ks ++: Get master encryption key
		return Key handle
		is -> ks ++: Sign Edge Agent's name + generation ID using the master encryption key to derive Edge Agent SAS keys
		return
		is -> is: Create SAS token from SAS key
		return SAS token
		return SAS token
		ea -> ea: Create IoT Hub client with SAS token
		ea -> hub ++: Connect to IoT Hub
		hub -> hub: Validate SAS token against SAS key that was registered when the Edge Agent identity was created by the runtime
		return OK
	end

	ea -> hub ++: Get deployment
	return

	loop for each module M
		ea -> mr ++: Create identity for module M
		mr -> is ++: Create identity for module M
		is -> ks ++: Get master encryption key
		return Key handle
		is -> ks ++: Sign module M's name + generation ID using the master encryption key to derive module M's SAS keys
		return
		is -> hub ++: Create identity for module M and register the derived SAS keys for it
		return
		return
		return

		ea -> mr ++: Start module
		return
	end

	mr -> eh **: Start Edge Hub
	mr -> cm **: Start Custom module
end

group Edge Hub operation
	loop for server cert request and renewal
		note over hub
			While it is possible to make an openssl engine (like openssl-engine-ks) for modules
			that performs key operations using the KS, it is not feasible to expect all modules to be using
			openssl for TLS, especially Windows modules. Thus modules need to have the raw private key bytes
			to be able to serve TLS with a server cert.

			For this reason, the private keys of module server certs are not persisted using Keys Service.

			Also, note that a single server cert is shared between all modules, and its lifetime is managed by the runtime.
			This is because the user may have module server certs rooted to public CAs, so it would cost the customer $$$ for each cert.
			Thus we do not want to request a new server cert when a previously requested cert is still valid, which also means
			we want to dedupe the server certs across all modules that want them. Since server certs are issued for the device hostname
			anyway, reusing the server cert for multiple modules is not a concern.
		end note

		alt if server cert already exists and is valid
			eh -> mr ++: Get server cert
			mr -> mr: Get persisted server cert
			mr -> mr: Server cert is valid
			mr -> mr: Get persisted server cert's private key
			return Server cert and private key

		else if server cert does not exist or is expired
			eh -> mr ++: Get server cert
			alt if server cert does not exist
				mr -> mr : Get persisted server cert
				mr -> mr: Server cert is not found
			else if server cert exists but is expired / close to expiry
				mr -> mr : Get persisted server cert
				mr -> mr: Server cert is expired / close to expiry
			end

			mr -> mr: Create new asymmetric key pair (in memory)
			mr -> cs ++: Request new module server cert
			cs -> cs: Create CSR for new module server cert using key
			cs -> cs ++: Get module server cert

			alt if module certs should be issued by EST
				cs -> ks ++: Get current EST identity cert's private key
				return Key handle
				cs -> cs ++: Get current EST identity cert
				return PEM
				cs -> cs: Create TLS client using key handle + PEM (using openssl-engine-ks)
				cs -> est ++: Connect using TLS client and send request for new module server cert corresponding to the CSR
				est -> est: Verify client cert against CA
				est -> est: Sign CSR
				return Signed server cert

			else if module certs should be minted locally
				cs -> ks ++: Get device CA cert's private key
				return Key handle
				cs -> cs ++: Get device CA cert
				return PEM
				cs -> cs: Sign CSR using device CA cert
			end

			return Signed server cert
			return Signed server cert
			return Signed server cert
			mr -> mr: Save key pair as server cert private key
			mr -> mr: Save signed cert so that it can be retrieved for future module server cert requests
		end
	end

	group Connect to IoT Hub
		loop for getting and renewing SAS token for identifying with IoT Hub
			eh -> mr ++: Get IoTHub identity
			mr -> is ++: Get IoTHub identity
			return Identity info (IoTHub + device identity + generation ID + credentials type)
			return Identity info (IoTHub + device identity + generation ID + credentials type)

			eh -> mr ++: Get SAS token for identifying with IoT Hub
			mr -> is ++: Get SAS token for Edge Hub to identify with IoT Hub
			is -> ks ++: Get master encryption key
			return Key handle
			is -> ks ++: Sign Edge Hub's name + generation ID using the master encryption key to derive Edge Hub SAS keys
			return
			is -> is: Create SAS token from SAS key
			return SAS token
			return SAS token
			eh -> eh: Create IoT Hub client with SAS token
			eh -> hub ++: Connect to IoT Hub
			hub -> hub: Validate SAS token against SAS key that was registered when the Edge Hub identity was created by the runtime
			return OK
		end
	end
end

@enduml

PlantUML version 1.2020.17(Sat Sep 19 05:30:11 PDT 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>