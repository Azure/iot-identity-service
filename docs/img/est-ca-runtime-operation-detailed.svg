<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="6699px" preserveAspectRatio="none" style="width:2047px;height:6699px;" version="1.1" viewBox="0 0 2047 6699" width="2047px" zoomAndPan="magnify"><defs><filter height="300%" id="f15q5gbkyq2rc9" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="164" x="942.75" y="27.4023">Runtime Operation</text><rect fill="#ADD8E6" height="6649.1348" style="stroke: #A80036; stroke-width: 1.0;" width="1465" x="565.5" y="39.1992"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="45" x="1273.5" y="51.7676">Device</text><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="129.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="281.5" y="5043.459"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="68.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="434.5" y="974.2871"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="148.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="434.5" y="1533.1191"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="434.5" y="2121.5039"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="148.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="434.5" y="2766.7559"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="434.5" y="2951.2402"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="434.5" y="3363.1406"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="148.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="434.5" y="6446.1836"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="369.9688" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="629.5" y="2309.8555"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="401.5898" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="629.5" y="3049.4824"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="629.5" y="3480.3828"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="202.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="629.5" y="3941.127"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="1324.1953" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="629.5" y="4187.5664"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="179.7949" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="629.5" y="5749.5566"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="369.9688" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="629.5" y="5989.2832"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="203.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="843.5" y="600.3184"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="280.7266" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="843.5" y="1165.4609"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="415.9004" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="843.5" y="1764.2246"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="280.7266" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="843.5" y="2369.7871"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="327.6582" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="843.5" y="3094.1035"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="75.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="843.5" y="5778.8672"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="280.7266" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="843.5" y="6049.2148"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1052.5" y="278.6602"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1052.5" y="383.2129"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1052.5" y="503.0762"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1052.5" y="665.25"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1052.5" y="1210.082"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1052.5" y="1329.9453"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1052.5" y="1808.8457"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1052.5" y="1928.709"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1052.5" y="2414.4082"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1052.5" y="2534.2715"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1052.5" y="3138.7246"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1052.5" y="3258.5879"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1052.5" y="4735.4219"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1052.5" y="5232.2773"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1052.5" y="6093.8359"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1052.5" y="6213.6992"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1251.5" y="739.1816"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="931.2031" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1251.5" y="4551.248"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="784.6504" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1256.5" y="4661.4902"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="40.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1261.5" y="4817.3535"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="40.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1261.5" y="5298.8984"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="930.4219" style="stroke: #000000; stroke-width: 2.0;" width="966.5" x="383.5" y="127.4863"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="826.1797" style="stroke: #000000; stroke-width: 2.0;" width="946.5" x="393.5" y="224.7285"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="624.3848" style="stroke: #000000; stroke-width: 2.0;" width="1260" x="383.5" y="1071.9082"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="593.0742" style="stroke: #000000; stroke-width: 2.0;" width="1240" x="393.5" y="1096.2188"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="1921.8652" style="stroke: #000000; stroke-width: 2.0;" width="1653" x="383.5" y="1710.293"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="682.3164" style="stroke: #000000; stroke-width: 2.0;" width="1413" x="393.5" y="2240.6133"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="522.1426" style="stroke: #000000; stroke-width: 2.0;" width="1291.5" x="393.5" y="2995.5508"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="2970.1992" style="stroke: #000000; stroke-width: 2.0;" width="1995.5" x="13" y="3646.1582"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="2002.1563" style="stroke: #000000; stroke-width: 2.0;" width="1838.5" x="23" y="3670.4688"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="1763.1191" style="stroke: #000000; stroke-width: 2.0;" width="1606.5" x="245" y="3902.5059"/><rect fill="#FFFFFF" height="1514.3242" style="stroke: none; stroke-width: 1.0;" width="1606.5" x="245" y="4151.3008"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="247.4395" style="stroke: #000000; stroke-width: 2.0;" width="299" x="559.5" y="4202.5664"/><rect fill="#FFFFFF" height="130.1973" style="stroke: none; stroke-width: 1.0;" width="299" x="559.5" y="4319.8086"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="730.3398" style="stroke: #000000; stroke-width: 2.0;" width="1205.5" x="255" y="4681.4902"/><rect fill="#FFFFFF" height="231.1289" style="stroke: none; stroke-width: 1.0;" width="1205.5" x="255" y="5180.7012"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="922.7324" style="stroke: #000000; stroke-width: 2.0;" width="1615" x="383.5" y="5686.625"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="891.4219" style="stroke: #000000; stroke-width: 2.0;" width="1595" x="393.5" y="5710.9355"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="286" x2="286" y1="110.4863" y2="6633.3574"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="439.5" x2="439.5" y1="110.4863" y2="6633.3574"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="634.5" x2="634.5" y1="110.4863" y2="6633.3574"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="848" x2="848" y1="110.4863" y2="6633.3574"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1057" x2="1057" y1="110.4863" y2="6633.3574"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1256" x2="1256" y1="110.4863" y2="6633.3574"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1455" x2="1455" y1="110.4863" y2="6633.3574"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1628" x2="1628" y1="2220.8691" y2="6633.3574"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1801.5" x2="1801.5" y1="3557.4375" y2="6633.3574"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1983.5" x2="1983.5" y1="3611.1699" y2="6633.3574"/><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="39" x="265" y="74.998"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="25" x="272" y="95.5332">EST</text><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="39" x="265" y="6632.3574"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="25" x="272" y="6652.8926">EST</text><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="68" x="403.5" y="74.998"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="54" x="410.5" y="95.5332">IoT Hub</text><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="68" x="403.5" y="6632.3574"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="54" x="410.5" y="6652.8926">IoT Hub</text><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="126" x="569.5" y="74.998"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="112" x="576.5" y="95.5332">Module Runtime</text><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="126" x="569.5" y="6632.3574"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="112" x="576.5" y="6652.8926">Module Runtime</text><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="117" x="788" y="74.998"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="103" x="795" y="95.5332">Identity Service</text><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="117" x="788" y="6632.3574"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="103" x="795" y="6652.8926">Identity Service</text><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1007" y="74.998"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="1014" y="95.5332">Keys Service</text><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1007" y="6632.3574"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="1014" y="6652.8926">Keys Service</text><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="143" x="1183" y="74.998"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="129" x="1190" y="95.5332">Certificates Service</text><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="143" x="1183" y="6632.3574"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="129" x="1190" y="6652.8926">Certificates Service</text><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="101" x="1403" y="58.5098"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="87" x="1410" y="79.0449">Host Process</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="51" x="1428" y="95.5332">Module</text><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="101" x="1403" y="6632.3574"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="87" x="1410" y="6652.8926">Host Process</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="51" x="1428" y="6669.3809">Module</text><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="89" x="1582" y="6632.3574"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="75" x="1589" y="6652.8926">EdgeAgent</text><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="76" x="1761.5" y="6632.3574"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="62" x="1768.5" y="6652.8926">EdgeHub</text><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="82" x="1940.5" y="6632.3574"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="68" x="1947.5" y="6652.8926">Container</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="51" x="1956" y="6669.3809">Module</text><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="129.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="281.5" y="5043.459"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="68.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="434.5" y="974.2871"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="148.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="434.5" y="1533.1191"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="434.5" y="2121.5039"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="148.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="434.5" y="2766.7559"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="434.5" y="2951.2402"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="434.5" y="3363.1406"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="148.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="434.5" y="6446.1836"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="369.9688" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="629.5" y="2309.8555"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="401.5898" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="629.5" y="3049.4824"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="629.5" y="3480.3828"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="202.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="629.5" y="3941.127"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="1324.1953" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="629.5" y="4187.5664"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="179.7949" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="629.5" y="5749.5566"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="369.9688" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="629.5" y="5989.2832"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="203.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="843.5" y="600.3184"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="280.7266" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="843.5" y="1165.4609"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="415.9004" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="843.5" y="1764.2246"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="280.7266" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="843.5" y="2369.7871"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="327.6582" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="843.5" y="3094.1035"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="75.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="843.5" y="5778.8672"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="280.7266" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="843.5" y="6049.2148"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1052.5" y="278.6602"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1052.5" y="383.2129"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1052.5" y="503.0762"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1052.5" y="665.25"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1052.5" y="1210.082"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1052.5" y="1329.9453"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1052.5" y="1808.8457"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1052.5" y="1928.709"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1052.5" y="2414.4082"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1052.5" y="2534.2715"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1052.5" y="3138.7246"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1052.5" y="3258.5879"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1052.5" y="4735.4219"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1052.5" y="5232.2773"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1052.5" y="6093.8359"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1052.5" y="6213.6992"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1251.5" y="739.1816"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="931.2031" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1251.5" y="4551.248"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="784.6504" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1256.5" y="4661.4902"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="40.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1261.5" y="4817.3535"/><rect fill="#FFFFFF" filter="url(#f15q5gbkyq2rc9)" height="40.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1261.5" y="5298.8984"/><path d="M383.5,127.4863 L649.5,127.4863 L649.5,134.4863 L639.5,144.4863 L383.5,144.4863 L383.5,127.4863 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="930.4219" style="stroke: #000000; stroke-width: 2.0;" width="966.5" x="383.5" y="127.4863"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="221" x="398.5" y="141.0547">Host-level modules provisioning</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="848.5" x2="890.5" y1="196.7285" y2="196.7285"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="890.5" x2="890.5" y1="196.7285" y2="209.7285"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="849.5" x2="890.5" y1="209.7285" y2="209.7285"/><polygon fill="#A80036" points="859.5,205.7285,849.5,209.7285,859.5,213.7285,855.5,209.7285" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="855.5" y="176.6758">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="868.5" y="161.3652">Read host-level module</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="75" x="868.5" y="176.6758">names from</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="85" x="868.5" y="191.9863">configuration</text><path d="M393.5,224.7285 L467.5,224.7285 L467.5,231.7285 L457.5,241.7285 L393.5,241.7285 L393.5,224.7285 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="826.1797" style="stroke: #000000; stroke-width: 2.0;" width="946.5" x="393.5" y="224.7285"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="408.5" y="238.2969">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="225" x="482.5" y="237.3633">[for creating each host-level module M]</text><polygon fill="#A80036" points="1040.5,274.6602,1050.5,278.6602,1040.5,282.6602,1044.5,278.6602" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="848.5" x2="1046.5" y1="278.6602" y2="278.6602"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="855.5" y="266.2627">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="115" x="868.5" y="258.6074">Create/Get master</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="868.5" y="273.918">identity symmetric key</text><polygon fill="#A80036" points="859.5,303.9707,849.5,307.9707,859.5,311.9707,855.5,307.9707" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="853.5" x2="1056.5" y1="307.9707" y2="307.9707"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="865.5" y="303.2285">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="878.5" y="303.2285">Key handle</text><polygon fill="#A80036" points="1040.5,379.2129,1050.5,383.2129,1040.5,387.2129,1044.5,383.2129" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="848.5" x2="1046.5" y1="383.2129" y2="383.2129"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="855.5" y="355.5049">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="868.5" y="332.5391">Create module derived</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="868.5" y="347.8496">key object for module</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="868.5" y="363.1602">M (based on master</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="868.5" y="378.4707">identity key handle)</text><polygon fill="#A80036" points="859.5,408.5234,849.5,412.5234,859.5,416.5234,855.5,412.5234" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="853.5" x2="1056.5" y1="412.5234" y2="412.5234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="865.5" y="407.7813">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="882.5" y="407.7813"/><polygon fill="#A80036" points="1040.5,499.0762,1050.5,503.0762,1040.5,507.0762,1044.5,503.0762" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="848.5" x2="1046.5" y1="503.0762" y2="503.0762"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="855.5" y="467.7129">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="868.5" y="437.0918">Derive and Sign module</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="868.5" y="452.4023">M's SAS key using</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="868.5" y="467.7129">name + generation ID (</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="868.5" y="483.0234">with derived key handle</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="868.5" y="498.334">)</text><polygon fill="#A80036" points="859.5,528.3867,849.5,532.3867,859.5,536.3867,855.5,532.3867" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="853.5" x2="1056.5" y1="532.3867" y2="532.3867"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="865.5" y="527.6445">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="882.5" y="527.6445"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="848.5" x2="895.5" y1="587.3184" y2="587.3184"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="895.5" x2="895.5" y1="587.3184" y2="600.3184"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="854.5" x2="895.5" y1="600.3184" y2="600.3184"/><polygon fill="#A80036" points="864.5,596.3184,854.5,600.3184,864.5,604.3184,860.5,600.3184" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="860.5" y="567.2656">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="114" x="873.5" y="551.9551">Get current device</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="873.5" y="567.2656">identity cert and key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="873.5" y="582.5762">handle</text><polygon fill="#A80036" points="1040.5,661.25,1050.5,665.25,1040.5,669.25,1044.5,665.25" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="853.5" x2="1046.5" y1="665.25" y2="665.25"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="860.5" y="645.1973">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="114" x="873.5" y="629.8867">Get current device</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="873.5" y="645.1973">identity cert's private</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="873.5" y="660.5078">key</text><polygon fill="#A80036" points="864.5,690.5605,854.5,694.5605,864.5,698.5605,860.5,694.5605" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="858.5" x2="1056.5" y1="694.5605" y2="694.5605"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="870.5" y="689.8184">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="892.5" y="689.8184">Key handle</text><polygon fill="#A80036" points="1239.5,735.1816,1249.5,739.1816,1239.5,743.1816,1243.5,739.1816" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="853.5" x2="1245.5" y1="739.1816" y2="739.1816"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="860.5" y="726.7842">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="114" x="882.5" y="719.1289">Get current device</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="76" x="882.5" y="734.4395">identity cert</text><polygon fill="#A80036" points="864.5,764.4922,854.5,768.4922,864.5,772.4922,860.5,768.4922" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="858.5" x2="1255.5" y1="768.4922" y2="768.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="870.5" y="763.75">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="25" x="892.5" y="763.75">PEM</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="853.5" x2="895.5" y1="802.8027" y2="802.8027"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="895.5" x2="895.5" y1="802.8027" y2="815.8027"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="848.5" x2="895.5" y1="815.8027" y2="815.8027"/><polygon fill="#A80036" points="858.5,811.8027,848.5,815.8027,858.5,819.8027,854.5,815.8027" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="860.5" y="798.0605">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="886.5" y="798.0605"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="848.5" x2="890.5" y1="886.0449" y2="886.0449"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="890.5" x2="890.5" y1="886.0449" y2="899.0449"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="849.5" x2="890.5" y1="899.0449" y2="899.0449"/><polygon fill="#A80036" points="859.5,895.0449,849.5,899.0449,859.5,903.0449,855.5,899.0449" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="855.5" y="858.3369">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="877.5" y="835.3711">Create TLS client using</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="877.5" y="850.6816">key handle + PEM (</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="877.5" y="865.9922">using openssl-engine-</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="877.5" y="881.3027">ks)</text><polygon fill="#A80036" points="455.5,970.2871,445.5,974.2871,455.5,978.2871,451.5,974.2871" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="449.5" x2="847.5" y1="974.2871" y2="974.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="461.5" y="946.5791">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="114" x="483.5" y="923.6133">Create identity for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="483.5" y="938.9238">module M and register</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="483.5" y="954.2344">the derived SAS keys</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="31" x="483.5" y="969.5449">for it</text><path d="M546,987.2871 L546,1012.2871 L1146,1012.2871 L1146,997.2871 L1136,987.2871 L546,987.2871 " fill="#FBFB77" filter="url(#f15q5gbkyq2rc9)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1136,987.2871 L1136,997.2871 L1146,997.2871 L1136,987.2871 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="579" x="552" y="1004.8555">If IoTHub call ever fails with bad credential, IS requests provisioning (with reprovision=true)</text><polygon fill="#A80036" points="836.5,1038.9082,846.5,1042.9082,836.5,1046.9082,840.5,1042.9082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="439.5" x2="842.5" y1="1042.9082" y2="1042.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="446.5" y="1038.166">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="472.5" y="1038.166"/><path d="M383.5,1071.9082 L692.5,1071.9082 L692.5,1078.9082 L682.5,1088.9082 L383.5,1088.9082 L383.5,1071.9082 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="624.3848" style="stroke: #000000; stroke-width: 2.0;" width="1260" x="383.5" y="1071.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="264" x="398.5" y="1085.4766">Host-level modules process operations</text><path d="M393.5,1096.2188 L467.5,1096.2188 L467.5,1103.2188 L457.5,1113.2188 L393.5,1113.2188 L393.5,1096.2188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="593.0742" style="stroke: #000000; stroke-width: 2.0;" width="1240" x="393.5" y="1096.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="408.5" y="1109.7871">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="370" x="482.5" y="1108.8535">[for getting and renewing SAS token for identifying with IoT Hub]</text><polygon fill="#A80036" points="864.5,1161.4609,854.5,1165.4609,864.5,1169.4609,860.5,1165.4609" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="858.5" x2="1454.5" y1="1165.4609" y2="1165.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="870.5" y="1145.4082">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="892.5" y="1130.0977">Get SAS token for Edge</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="892.5" y="1145.4082">Agent to identify with</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="892.5" y="1160.7188">IoT Hub</text><polygon fill="#A80036" points="1040.5,1206.082,1050.5,1210.082,1040.5,1214.082,1044.5,1210.082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="853.5" x2="1046.5" y1="1210.082" y2="1210.082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="860.5" y="1197.6846">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="882.5" y="1190.0293">Get master encryption</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="882.5" y="1205.3398">key</text><polygon fill="#A80036" points="864.5,1235.3926,854.5,1239.3926,864.5,1243.3926,860.5,1239.3926" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="858.5" x2="1056.5" y1="1239.3926" y2="1239.3926"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="870.5" y="1234.6504">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="892.5" y="1234.6504">Key handle</text><polygon fill="#A80036" points="1040.5,1325.9453,1050.5,1329.9453,1040.5,1333.9453,1044.5,1329.9453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="853.5" x2="1046.5" y1="1329.9453" y2="1329.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="860.5" y="1294.582">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="882.5" y="1263.9609">Sign Edge Agent's name</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="882.5" y="1279.2715">+ generation ID using</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="882.5" y="1294.582">the master encryption</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="115" x="882.5" y="1309.8926">key to derive Edge</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="882.5" y="1325.2031">Agent SAS keys</text><polygon fill="#A80036" points="864.5,1355.2559,854.5,1359.2559,864.5,1363.2559,860.5,1359.2559" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="858.5" x2="1056.5" y1="1359.2559" y2="1359.2559"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="870.5" y="1354.5137">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="896.5" y="1354.5137"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="853.5" x2="895.5" y1="1403.877" y2="1403.877"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="895.5" x2="895.5" y1="1403.877" y2="1416.877"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="854.5" x2="895.5" y1="1416.877" y2="1416.877"/><polygon fill="#A80036" points="864.5,1412.877,854.5,1416.877,864.5,1420.877,860.5,1416.877" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="860.5" y="1391.4795">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="882.5" y="1383.8242">Create SAS token from</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="882.5" y="1399.1348">SAS key</text><polygon fill="#A80036" points="1443.5,1442.1875,1453.5,1446.1875,1443.5,1450.1875,1447.5,1446.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="848.5" x2="1449.5" y1="1446.1875" y2="1446.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="855.5" y="1441.4453">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="877.5" y="1441.4453">SAS token</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1455.5" x2="1497.5" y1="1490.8086" y2="1490.8086"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1497.5" x2="1497.5" y1="1490.8086" y2="1503.8086"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1456.5" x2="1497.5" y1="1503.8086" y2="1503.8086"/><polygon fill="#A80036" points="1466.5,1499.8086,1456.5,1503.8086,1466.5,1507.8086,1462.5,1503.8086" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1462.5" y="1478.4111">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="1484.5" y="1470.7559">Create IoT Hub client</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="94" x="1484.5" y="1486.0664">with SAS token</text><polygon fill="#A80036" points="455.5,1529.1191,445.5,1533.1191,455.5,1537.1191,451.5,1533.1191" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="449.5" x2="1454.5" y1="1533.1191" y2="1533.1191"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="461.5" y="1528.377">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="483.5" y="1528.377">Connect to IoT Hub</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="444.5" x2="486.5" y1="1638.9824" y2="1638.9824"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="486.5" x2="486.5" y1="1638.9824" y2="1651.9824"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="445.5" x2="486.5" y1="1651.9824" y2="1651.9824"/><polygon fill="#A80036" points="455.5,1647.9824,445.5,1651.9824,455.5,1655.9824,451.5,1651.9824" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="451.5" y="1595.9639">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="473.5" y="1557.6875">Validate SAS token</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="473.5" y="1572.998">against SAS key that</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="473.5" y="1588.3086">was registered when</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="473.5" y="1603.6191">the Edge Agent identity</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="473.5" y="1618.9297">was created by the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="473.5" y="1634.2402">runtime</text><polygon fill="#A80036" points="1443.5,1677.293,1453.5,1681.293,1443.5,1685.293,1447.5,1681.293" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="439.5" x2="1449.5" y1="1681.293" y2="1681.293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="446.5" y="1676.5508">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="18" x="468.5" y="1676.5508">OK</text><path d="M383.5,1710.293 L576.5,1710.293 L576.5,1717.293 L566.5,1727.293 L383.5,1727.293 L383.5,1710.293 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1921.8652" style="stroke: #000000; stroke-width: 2.0;" width="1653" x="383.5" y="1710.293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="148" x="398.5" y="1723.8613">Edge Agent operation</text><polygon fill="#A80036" points="831.5,1760.2246,841.5,1764.2246,831.5,1768.2246,835.5,1764.2246" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="634.5" x2="837.5" y1="1764.2246" y2="1764.2246"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="641.5" y="1751.8271">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="663.5" y="1744.1719">Create module identity</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="663.5" y="1759.4824">for Edge Agent</text><polygon fill="#A80036" points="1040.5,1804.8457,1050.5,1808.8457,1040.5,1812.8457,1044.5,1808.8457" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="853.5" x2="1046.5" y1="1808.8457" y2="1808.8457"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="860.5" y="1796.4482">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="882.5" y="1788.793">Get master encryption</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="882.5" y="1804.1035">key</text><polygon fill="#A80036" points="864.5,1834.1563,854.5,1838.1563,864.5,1842.1563,860.5,1838.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="858.5" x2="1056.5" y1="1838.1563" y2="1838.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="870.5" y="1833.4141">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="892.5" y="1833.4141">Key handle</text><polygon fill="#A80036" points="1040.5,1924.709,1050.5,1928.709,1040.5,1932.709,1044.5,1928.709" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="853.5" x2="1046.5" y1="1928.709" y2="1928.709"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="860.5" y="1893.3457">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="882.5" y="1862.7246">Sign Edge Agent's name</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="882.5" y="1878.0352">+ generation ID using</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="882.5" y="1893.3457">the master encryption</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="115" x="882.5" y="1908.6563">key to derive Edge</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="882.5" y="1923.9668">Agent SAS keys</text><polygon fill="#A80036" points="864.5,1954.0195,854.5,1958.0195,864.5,1962.0195,860.5,1958.0195" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="858.5" x2="1056.5" y1="1958.0195" y2="1958.0195"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="870.5" y="1953.2773">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="896.5" y="1953.2773"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="853.5" x2="895.5" y1="2033.2617" y2="2033.2617"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="895.5" x2="895.5" y1="2033.2617" y2="2046.2617"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="854.5" x2="895.5" y1="2046.2617" y2="2046.2617"/><polygon fill="#A80036" points="864.5,2042.2617,854.5,2046.2617,864.5,2050.2617,860.5,2046.2617" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="860.5" y="2005.5537">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="882.5" y="1982.5879">Create TLS client using</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="882.5" y="1997.8984">key handle + PEM (</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="882.5" y="2013.209">using openssl-engine-</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="882.5" y="2028.5195">ks)</text><polygon fill="#A80036" points="455.5,2117.5039,445.5,2121.5039,455.5,2125.5039,451.5,2121.5039" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="449.5" x2="842.5" y1="2121.5039" y2="2121.5039"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="461.5" y="2093.7959">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="483.5" y="2070.8301">Create module identity</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="483.5" y="2086.1406">for Edge Agent and</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="483.5" y="2101.4512">register the derived SAS</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="64" x="483.5" y="2116.7617">keys for it</text><polygon fill="#A80036" points="831.5,2146.8145,841.5,2150.8145,831.5,2154.8145,835.5,2150.8145" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="439.5" x2="837.5" y1="2150.8145" y2="2150.8145"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="446.5" y="2146.0723">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="472.5" y="2146.0723"/><polygon fill="#A80036" points="645.5,2176.125,635.5,2180.125,645.5,2184.125,641.5,2180.125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="639.5" x2="847.5" y1="2180.125" y2="2180.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="651.5" y="2175.3828">36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="673.5" y="2175.3828">Edge Agent identity</text><polygon fill="#A80036" points="1570,2205.4355,1580,2209.4355,1570,2213.4355,1574,2209.4355" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="634.5" x2="1576" y1="2209.4355" y2="2209.4355"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="641.5" y="2204.6934">37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="663.5" y="2204.6934">Create and start</text><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="89" x="1582" y="2188.125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="75" x="1589" y="2208.6602">EdgeAgent</text><path d="M393.5,2240.6133 L467.5,2240.6133 L467.5,2247.6133 L457.5,2257.6133 L393.5,2257.6133 L393.5,2240.6133 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="682.3164" style="stroke: #000000; stroke-width: 2.0;" width="1413" x="393.5" y="2240.6133"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="408.5" y="2254.1816">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="370" x="482.5" y="2253.248">[for getting and renewing SAS token for identifying with IoT Hub]</text><polygon fill="#A80036" points="650.5,2305.8555,640.5,2309.8555,650.5,2313.8555,646.5,2309.8555" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="644.5" x2="1627.5" y1="2309.8555" y2="2309.8555"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="656.5" y="2289.8027">38</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="678.5" y="2274.4922">Get SAS token for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="678.5" y="2289.8027">identifying with IoT</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="26" x="678.5" y="2305.1133">Hub</text><polygon fill="#A80036" points="831.5,2365.7871,841.5,2369.7871,831.5,2373.7871,835.5,2369.7871" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="639.5" x2="837.5" y1="2369.7871" y2="2369.7871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="646.5" y="2349.7344">39</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="668.5" y="2334.4238">Get SAS token for Edge</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="668.5" y="2349.7344">Agent to identify with</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="668.5" y="2365.0449">IoT Hub</text><polygon fill="#A80036" points="1040.5,2410.4082,1050.5,2414.4082,1040.5,2418.4082,1044.5,2414.4082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="853.5" x2="1046.5" y1="2414.4082" y2="2414.4082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="860.5" y="2402.0107">40</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="882.5" y="2394.3555">Get master encryption</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="882.5" y="2409.666">key</text><polygon fill="#A80036" points="864.5,2439.7188,854.5,2443.7188,864.5,2447.7188,860.5,2443.7188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="858.5" x2="1056.5" y1="2443.7188" y2="2443.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="870.5" y="2438.9766">41</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="892.5" y="2438.9766">Key handle</text><polygon fill="#A80036" points="1040.5,2530.2715,1050.5,2534.2715,1040.5,2538.2715,1044.5,2534.2715" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="853.5" x2="1046.5" y1="2534.2715" y2="2534.2715"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="860.5" y="2498.9082">42</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="882.5" y="2468.2871">Sign Edge Agent's name</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="882.5" y="2483.5977">+ generation ID using</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="882.5" y="2498.9082">the master encryption</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="115" x="882.5" y="2514.2188">key to derive Edge</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="882.5" y="2529.5293">Agent SAS keys</text><polygon fill="#A80036" points="864.5,2559.582,854.5,2563.582,864.5,2567.582,860.5,2563.582" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="858.5" x2="1056.5" y1="2563.582" y2="2563.582"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="870.5" y="2558.8398">43</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="896.5" y="2558.8398"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="853.5" x2="895.5" y1="2608.2031" y2="2608.2031"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="895.5" x2="895.5" y1="2608.2031" y2="2621.2031"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="854.5" x2="895.5" y1="2621.2031" y2="2621.2031"/><polygon fill="#A80036" points="864.5,2617.2031,854.5,2621.2031,864.5,2625.2031,860.5,2621.2031" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="860.5" y="2595.8057">44</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="882.5" y="2588.1504">Create SAS token from</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="882.5" y="2603.4609">SAS key</text><polygon fill="#A80036" points="650.5,2646.5137,640.5,2650.5137,650.5,2654.5137,646.5,2650.5137" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="644.5" x2="847.5" y1="2650.5137" y2="2650.5137"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="656.5" y="2645.7715">45</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="678.5" y="2645.7715">SAS token</text><polygon fill="#A80036" points="1616.5,2675.8242,1626.5,2679.8242,1616.5,2683.8242,1620.5,2679.8242" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="634.5" x2="1622.5" y1="2679.8242" y2="2679.8242"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="641.5" y="2675.082">46</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="663.5" y="2675.082">SAS token</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1628.5" x2="1670.5" y1="2724.4453" y2="2724.4453"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1670.5" x2="1670.5" y1="2724.4453" y2="2737.4453"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1629.5" x2="1670.5" y1="2737.4453" y2="2737.4453"/><polygon fill="#A80036" points="1639.5,2733.4453,1629.5,2737.4453,1639.5,2741.4453,1635.5,2737.4453" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1635.5" y="2712.0479">47</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="1657.5" y="2704.3926">Create IoT Hub client</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="94" x="1657.5" y="2719.7031">with SAS token</text><polygon fill="#A80036" points="455.5,2762.7559,445.5,2766.7559,455.5,2770.7559,451.5,2766.7559" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="449.5" x2="1627.5" y1="2766.7559" y2="2766.7559"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="461.5" y="2762.0137">48</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="483.5" y="2762.0137">Connect to IoT Hub</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="444.5" x2="486.5" y1="2872.6191" y2="2872.6191"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="486.5" x2="486.5" y1="2872.6191" y2="2885.6191"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="445.5" x2="486.5" y1="2885.6191" y2="2885.6191"/><polygon fill="#A80036" points="455.5,2881.6191,445.5,2885.6191,455.5,2889.6191,451.5,2885.6191" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="451.5" y="2829.6006">49</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="473.5" y="2791.3242">Validate SAS token</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="473.5" y="2806.6348">against SAS key that</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="473.5" y="2821.9453">was registered when</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="473.5" y="2837.2559">the Edge Agent identity</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="473.5" y="2852.5664">was created by the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="473.5" y="2867.877">runtime</text><polygon fill="#A80036" points="1616.5,2910.9297,1626.5,2914.9297,1616.5,2918.9297,1620.5,2914.9297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="439.5" x2="1622.5" y1="2914.9297" y2="2914.9297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="446.5" y="2910.1875">50</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="18" x="468.5" y="2910.1875">OK</text><polygon fill="#A80036" points="455.5,2947.2402,445.5,2951.2402,455.5,2955.2402,451.5,2951.2402" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="449.5" x2="1627.5" y1="2951.2402" y2="2951.2402"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="461.5" y="2946.498">51</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="483.5" y="2946.498">Get deployment</text><polygon fill="#A80036" points="1616.5,2976.5508,1626.5,2980.5508,1616.5,2984.5508,1620.5,2980.5508" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="439.5" x2="1622.5" y1="2980.5508" y2="2980.5508"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="446.5" y="2975.8086">52</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="472.5" y="2975.8086"/><path d="M393.5,2995.5508 L467.5,2995.5508 L467.5,3002.5508 L457.5,3012.5508 L393.5,3012.5508 L393.5,2995.5508 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="522.1426" style="stroke: #000000; stroke-width: 2.0;" width="1291.5" x="393.5" y="2995.5508"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="408.5" y="3009.1191">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="114" x="482.5" y="3008.1855">[for each module M]</text><polygon fill="#A80036" points="650.5,3045.4824,640.5,3049.4824,650.5,3053.4824,646.5,3049.4824" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="644.5" x2="1627.5" y1="3049.4824" y2="3049.4824"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="656.5" y="3037.085">53</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="114" x="678.5" y="3029.4297">Create identity for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="678.5" y="3044.7402">module M</text><polygon fill="#A80036" points="831.5,3090.1035,841.5,3094.1035,831.5,3098.1035,835.5,3094.1035" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="639.5" x2="837.5" y1="3094.1035" y2="3094.1035"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="646.5" y="3081.7061">54</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="114" x="668.5" y="3074.0508">Create identity for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="668.5" y="3089.3613">module M</text><polygon fill="#A80036" points="1040.5,3134.7246,1050.5,3138.7246,1040.5,3142.7246,1044.5,3138.7246" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="853.5" x2="1046.5" y1="3138.7246" y2="3138.7246"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="860.5" y="3126.3271">55</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="882.5" y="3118.6719">Get master encryption</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="882.5" y="3133.9824">key</text><polygon fill="#A80036" points="864.5,3164.0352,854.5,3168.0352,864.5,3172.0352,860.5,3168.0352" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="858.5" x2="1056.5" y1="3168.0352" y2="3168.0352"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="870.5" y="3163.293">56</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="892.5" y="3163.293">Key handle</text><polygon fill="#A80036" points="1040.5,3254.5879,1050.5,3258.5879,1040.5,3262.5879,1044.5,3258.5879" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="853.5" x2="1046.5" y1="3258.5879" y2="3258.5879"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="860.5" y="3223.2246">57</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="882.5" y="3192.6035">Sign module M's name</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="882.5" y="3207.9141">+ generation ID using</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="882.5" y="3223.2246">the master encryption</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="882.5" y="3238.5352">key to derive module M'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="67" x="882.5" y="3253.8457">s SAS keys</text><polygon fill="#A80036" points="864.5,3283.8984,854.5,3287.8984,864.5,3291.8984,860.5,3287.8984" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="858.5" x2="1056.5" y1="3287.8984" y2="3287.8984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="870.5" y="3283.1563">58</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="896.5" y="3283.1563"/><polygon fill="#A80036" points="455.5,3359.1406,445.5,3363.1406,455.5,3367.1406,451.5,3363.1406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="449.5" x2="842.5" y1="3363.1406" y2="3363.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="461.5" y="3335.4326">59</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="114" x="483.5" y="3312.4668">Create identity for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="483.5" y="3327.7773">module M and register</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="483.5" y="3343.0879">the derived SAS keys</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="31" x="483.5" y="3358.3984">for it</text><polygon fill="#A80036" points="831.5,3388.4512,841.5,3392.4512,831.5,3396.4512,835.5,3392.4512" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="439.5" x2="837.5" y1="3392.4512" y2="3392.4512"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="446.5" y="3387.709">60</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="472.5" y="3387.709"/><polygon fill="#A80036" points="650.5,3417.7617,640.5,3421.7617,650.5,3425.7617,646.5,3421.7617" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="644.5" x2="847.5" y1="3421.7617" y2="3421.7617"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="656.5" y="3417.0195">61</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="682.5" y="3417.0195"/><polygon fill="#A80036" points="1616.5,3447.0723,1626.5,3451.0723,1616.5,3455.0723,1620.5,3451.0723" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="634.5" x2="1622.5" y1="3451.0723" y2="3451.0723"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="641.5" y="3446.3301">62</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="667.5" y="3446.3301"/><polygon fill="#A80036" points="650.5,3476.3828,640.5,3480.3828,650.5,3484.3828,646.5,3480.3828" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="644.5" x2="1627.5" y1="3480.3828" y2="3480.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="656.5" y="3475.6406">63</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="678.5" y="3475.6406">Start module</text><polygon fill="#A80036" points="1616.5,3505.6934,1626.5,3509.6934,1616.5,3513.6934,1620.5,3509.6934" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="634.5" x2="1622.5" y1="3509.6934" y2="3509.6934"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="641.5" y="3504.9512">64</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="667.5" y="3504.9512"/><polygon fill="#A80036" points="1749.5,3542.0039,1759.5,3546.0039,1749.5,3550.0039,1753.5,3546.0039" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="634.5" x2="1755.5" y1="3546.0039" y2="3546.0039"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="641.5" y="3541.2617">65</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="663.5" y="3541.2617">Start Edge Hub</text><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="76" x="1761.5" y="3524.6934"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="62" x="1768.5" y="3545.2285">EdgeHub</text><polygon fill="#A80036" points="1928.5,3587.4922,1938.5,3591.4922,1928.5,3595.4922,1932.5,3591.4922" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="634.5" x2="1934.5" y1="3591.4922" y2="3591.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="641.5" y="3586.75">66</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="663.5" y="3586.75">Start Custom module</text><rect fill="#FEFECE" filter="url(#f15q5gbkyq2rc9)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="82" x="1940.5" y="3570.1816"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="68" x="1947.5" y="3590.7168">Container</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="51" x="1956" y="3607.2051">Module</text><path d="M13,3646.1582 L193,3646.1582 L193,3653.1582 L183,3663.1582 L13,3663.1582 L13,3646.1582 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2970.1992" style="stroke: #000000; stroke-width: 2.0;" width="1995.5" x="13" y="3646.1582"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="135" x="28" y="3659.7266">Edge Hub operation</text><path d="M23,3670.4688 L97,3670.4688 L97,3677.4688 L87,3687.4688 L23,3687.4688 L23,3670.4688 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2002.1563" style="stroke: #000000; stroke-width: 2.0;" width="1838.5" x="23" y="3670.4688"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="38" y="3684.0371">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="205" x="112" y="3683.1035">[for server cert request and renewal]</text><path d="M33,3692.7793 L33,3885.7793 L842,3885.7793 L842,3702.7793 L832,3692.7793 L33,3692.7793 " fill="#FBFB77" filter="url(#f15q5gbkyq2rc9)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M832,3692.7793 L832,3702.7793 L842,3702.7793 L832,3692.7793 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="533" x="39" y="3710.3477">While it is possible to make an openssl engine (like openssl-engine-ks) for modules</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="590" x="39" y="3725.6582">that performs key operations using the KS, it is not feasible to expect all modules to be using</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="627" x="39" y="3740.9688">openssl for TLS, especially Windows modules. Thus modules need to have the raw private key bytes</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="39" y="3756.2793">to be able to serve TLS with a server cert.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="43" y="3771.5898"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="581" x="39" y="3786.9004">For this reason, the private keys of module server certs are not persisted using Keys Service.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="43" y="3802.2109"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="689" x="39" y="3817.5215">Also, note that a single server cert is shared between all modules, and its lifetime is managed by the runtime.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="788" x="39" y="3832.832">This is because the user may have module server certs rooted to public CAs, so it would cost the customer $$$ for each cert.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="717" x="39" y="3848.1426">Thus we do not want to request a new server cert when a previously requested cert is still valid, which also means</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="782" x="39" y="3863.4531">we want to dedupe the server certs across all modules that want them. Since server certs are issued for the device hostname</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="440" x="39" y="3878.7637">anyway, reusing the server cert for multiple modules is not a concern.</text><path d="M245,3902.5059 L307,3902.5059 L307,3909.5059 L297,3919.5059 L245,3919.5059 L245,3902.5059 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1763.1191" style="stroke: #000000; stroke-width: 2.0;" width="1606.5" x="245" y="3902.5059"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="260" y="3916.0742">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="231" x="322" y="3915.1406">[if server cert already exists and is valid]</text><polygon fill="#A80036" points="650.5,3937.127,640.5,3941.127,650.5,3945.127,646.5,3941.127" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="644.5" x2="1800.5" y1="3941.127" y2="3941.127"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="656.5" y="3936.3848">67</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="678.5" y="3936.3848">Get server cert</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="639.5" x2="681.5" y1="3985.748" y2="3985.748"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="681.5" x2="681.5" y1="3985.748" y2="3998.748"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="640.5" x2="681.5" y1="3998.748" y2="3998.748"/><polygon fill="#A80036" points="650.5,3994.748,640.5,3998.748,650.5,4002.748,646.5,3998.748" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="646.5" y="3973.3506">68</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="668.5" y="3965.6953">Get persisted server</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="668.5" y="3981.0059">cert</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="639.5" x2="681.5" y1="4028.0586" y2="4028.0586"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="681.5" x2="681.5" y1="4028.0586" y2="4041.0586"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="640.5" x2="681.5" y1="4041.0586" y2="4041.0586"/><polygon fill="#A80036" points="650.5,4037.0586,640.5,4041.0586,650.5,4045.0586,646.5,4041.0586" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="646.5" y="4023.3164">69</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="115" x="668.5" y="4023.3164">Server cert is valid</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="639.5" x2="681.5" y1="4085.6797" y2="4085.6797"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="681.5" x2="681.5" y1="4085.6797" y2="4098.6797"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="640.5" x2="681.5" y1="4098.6797" y2="4098.6797"/><polygon fill="#A80036" points="650.5,4094.6797,640.5,4098.6797,650.5,4102.6797,646.5,4098.6797" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="646.5" y="4073.2822">70</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="668.5" y="4065.627">Get persisted server</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="668.5" y="4080.9375">cert's private key</text><polygon fill="#A80036" points="1789.5,4139.3008,1799.5,4143.3008,1789.5,4147.3008,1793.5,4143.3008" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="634.5" x2="1795.5" y1="4143.3008" y2="4143.3008"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="641.5" y="4130.9033">71</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="663.5" y="4123.248">Server cert and private</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="663.5" y="4138.5586">key</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="245" x2="1851.5" y1="4152.3008" y2="4152.3008"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="238" x="250" y="4162.9355">[if server cert does not exist or is expired]</text><polygon fill="#A80036" points="650.5,4183.5664,640.5,4187.5664,650.5,4191.5664,646.5,4187.5664" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="644.5" x2="1800.5" y1="4187.5664" y2="4187.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="656.5" y="4182.8242">72</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="678.5" y="4182.8242">Get server cert</text><path d="M559.5,4202.5664 L621.5,4202.5664 L621.5,4209.5664 L611.5,4219.5664 L559.5,4219.5664 L559.5,4202.5664 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="247.4395" style="stroke: #000000; stroke-width: 2.0;" width="299" x="559.5" y="4202.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="574.5" y="4216.1348">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="163" x="636.5" y="4215.2012">[if server cert does not exist]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="639.5" x2="681.5" y1="4256.498" y2="4256.498"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="681.5" x2="681.5" y1="4256.498" y2="4269.498"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="640.5" x2="681.5" y1="4269.498" y2="4269.498"/><polygon fill="#A80036" points="650.5,4265.498,640.5,4269.498,650.5,4273.498,646.5,4269.498" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="646.5" y="4244.1006">73</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="668.5" y="4236.4453">Get persisted server</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="668.5" y="4251.7559">cert</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="639.5" x2="681.5" y1="4298.8086" y2="4298.8086"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="681.5" x2="681.5" y1="4298.8086" y2="4311.8086"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="640.5" x2="681.5" y1="4311.8086" y2="4311.8086"/><polygon fill="#A80036" points="650.5,4307.8086,640.5,4311.8086,650.5,4315.8086,646.5,4311.8086" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="646.5" y="4294.0664">74</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="668.5" y="4294.0664">Server cert is not found</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="559.5" x2="858.5" y1="4320.8086" y2="4320.8086"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="294" x="564.5" y="4331.4434">[if server cert exists but is expired / close to expiry]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="639.5" x2="681.5" y1="4371.3848" y2="4371.3848"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="681.5" x2="681.5" y1="4371.3848" y2="4384.3848"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="640.5" x2="681.5" y1="4384.3848" y2="4384.3848"/><polygon fill="#A80036" points="650.5,4380.3848,640.5,4384.3848,650.5,4388.3848,646.5,4384.3848" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="646.5" y="4358.9873">75</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="668.5" y="4351.332">Get persisted server</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="668.5" y="4366.6426">cert</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="639.5" x2="681.5" y1="4429.0059" y2="4429.0059"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="681.5" x2="681.5" y1="4429.0059" y2="4442.0059"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="640.5" x2="681.5" y1="4442.0059" y2="4442.0059"/><polygon fill="#A80036" points="650.5,4438.0059,640.5,4442.0059,650.5,4446.0059,646.5,4442.0059" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="646.5" y="4416.6084">76</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="668.5" y="4408.9531">Server cert is expired /</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="668.5" y="4424.2637">close to expiry</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="639.5" x2="681.5" y1="4493.627" y2="4493.627"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="681.5" x2="681.5" y1="4493.627" y2="4506.627"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="640.5" x2="681.5" y1="4506.627" y2="4506.627"/><polygon fill="#A80036" points="650.5,4502.627,640.5,4506.627,650.5,4510.627,646.5,4506.627" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="646.5" y="4481.2295">77</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="668.5" y="4473.5742">Create new asymmetric</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="668.5" y="4488.8848">key pair (in memory)</text><polygon fill="#A80036" points="1239.5,4547.248,1249.5,4551.248,1239.5,4555.248,1243.5,4551.248" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="639.5" x2="1245.5" y1="4551.248" y2="4551.248"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="646.5" y="4538.8506">78</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="668.5" y="4531.1953">Request new module</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="668.5" y="4546.5059">server cert</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1261.5" x2="1303.5" y1="4611.1797" y2="4611.1797"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1303.5" x2="1303.5" y1="4611.1797" y2="4624.1797"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1262.5" x2="1303.5" y1="4624.1797" y2="4624.1797"/><polygon fill="#A80036" points="1272.5,4620.1797,1262.5,4624.1797,1272.5,4628.1797,1268.5,4624.1797" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1268.5" y="4591.127">79</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="1290.5" y="4575.8164">Create CSR for new</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="1290.5" y="4591.127">module server cert</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="1290.5" y="4606.4375">using key</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1261.5" x2="1308.5" y1="4648.4902" y2="4648.4902"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1308.5" x2="1308.5" y1="4648.4902" y2="4661.4902"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1267.5" x2="1308.5" y1="4661.4902" y2="4661.4902"/><polygon fill="#A80036" points="1277.5,4657.4902,1267.5,4661.4902,1277.5,4665.4902,1273.5,4661.4902" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1273.5" y="4643.748">80</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="1295.5" y="4643.748">Get module server cert</text><path d="M255,4681.4902 L317,4681.4902 L317,4688.4902 L307,4698.4902 L255,4698.4902 L255,4681.4902 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="730.3398" style="stroke: #000000; stroke-width: 2.0;" width="1205.5" x="255" y="4681.4902"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="270" y="4695.0586">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="235" x="332" y="4694.125">[if module certs should be issued by EST]</text><polygon fill="#A80036" points="1073.5,4731.4219,1063.5,4735.4219,1073.5,4739.4219,1069.5,4735.4219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1067.5" x2="1255.5" y1="4735.4219" y2="4735.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1079.5" y="4723.0244">81</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="1101.5" y="4715.3691">Get current EST identity</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="1101.5" y="4730.6797">cert's private key</text><polygon fill="#A80036" points="1244.5,4760.7324,1254.5,4764.7324,1244.5,4768.7324,1248.5,4764.7324" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1057.5" x2="1250.5" y1="4764.7324" y2="4764.7324"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1064.5" y="4759.9902">82</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="1086.5" y="4759.9902">Key handle</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1266.5" x2="1313.5" y1="4804.3535" y2="4804.3535"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1313.5" x2="1313.5" y1="4804.3535" y2="4817.3535"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1272.5" x2="1313.5" y1="4817.3535" y2="4817.3535"/><polygon fill="#A80036" points="1282.5,4813.3535,1272.5,4817.3535,1282.5,4821.3535,1278.5,4817.3535" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1278.5" y="4791.9561">83</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="1300.5" y="4784.3008">Get current EST identity</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="1300.5" y="4799.6113">cert</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1271.5" x2="1313.5" y1="4856.6641" y2="4856.6641"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1313.5" x2="1313.5" y1="4856.6641" y2="4869.6641"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1266.5" x2="1313.5" y1="4869.6641" y2="4869.6641"/><polygon fill="#A80036" points="1276.5,4865.6641,1266.5,4869.6641,1276.5,4873.6641,1272.5,4869.6641" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1278.5" y="4851.9219">84</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="25" x="1300.5" y="4851.9219">PEM</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1266.5" x2="1308.5" y1="4939.9063" y2="4939.9063"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1308.5" x2="1308.5" y1="4939.9063" y2="4952.9063"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1267.5" x2="1308.5" y1="4952.9063" y2="4952.9063"/><polygon fill="#A80036" points="1277.5,4948.9063,1267.5,4952.9063,1277.5,4956.9063,1273.5,4952.9063" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1273.5" y="4912.1982">85</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="1295.5" y="4889.2324">Create TLS client using</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="1295.5" y="4904.543">key handle + PEM (</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="1295.5" y="4919.8535">using openssl-engine-</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="1295.5" y="4935.1641">ks)</text><polygon fill="#A80036" points="302.5,5039.459,292.5,5043.459,302.5,5047.459,298.5,5043.459" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="296.5" x2="1255.5" y1="5043.459" y2="5043.459"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="308.5" y="5008.0957">86</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="330.5" y="4977.4746">Connect using TLS</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="330.5" y="4992.7852">client and send request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="330.5" y="5008.0957">for new module server</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="330.5" y="5023.4063">cert corresponding to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="330.5" y="5038.7168">the CSR</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="291.5" x2="333.5" y1="5088.0801" y2="5088.0801"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="333.5" x2="333.5" y1="5088.0801" y2="5101.0801"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="292.5" x2="333.5" y1="5101.0801" y2="5101.0801"/><polygon fill="#A80036" points="302.5,5097.0801,292.5,5101.0801,302.5,5105.0801,298.5,5101.0801" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="298.5" y="5075.6826">87</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="103" x="320.5" y="5068.0273">Verify client cert</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="320.5" y="5083.3379">against CA</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="291.5" x2="333.5" y1="5130.3906" y2="5130.3906"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="333.5" x2="333.5" y1="5130.3906" y2="5143.3906"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="292.5" x2="333.5" y1="5143.3906" y2="5143.3906"/><polygon fill="#A80036" points="302.5,5139.3906,292.5,5143.3906,302.5,5147.3906,298.5,5143.3906" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="298.5" y="5125.6484">88</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="55" x="320.5" y="5125.6484">Sign CSR</text><polygon fill="#A80036" points="1244.5,5168.7012,1254.5,5172.7012,1244.5,5176.7012,1248.5,5172.7012" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="286.5" x2="1250.5" y1="5172.7012" y2="5172.7012"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="293.5" y="5167.959">89</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="315.5" y="5167.959">Signed server cert</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="255" x2="1460.5" y1="5181.7012" y2="5181.7012"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="237" x="260" y="5192.3359">[if module certs should be minted locally]</text><polygon fill="#A80036" points="1073.5,5228.2773,1063.5,5232.2773,1073.5,5236.2773,1069.5,5232.2773" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1067.5" x2="1255.5" y1="5232.2773" y2="5232.2773"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1079.5" y="5219.8799">90</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="1101.5" y="5212.2246">Get device CA cert's</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="69" x="1101.5" y="5227.5352">private key</text><polygon fill="#A80036" points="1244.5,5257.5879,1254.5,5261.5879,1244.5,5265.5879,1248.5,5261.5879" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1057.5" x2="1250.5" y1="5261.5879" y2="5261.5879"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1064.5" y="5256.8457">91</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="1086.5" y="5256.8457">Key handle</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1266.5" x2="1313.5" y1="5285.8984" y2="5285.8984"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1313.5" x2="1313.5" y1="5285.8984" y2="5298.8984"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1272.5" x2="1313.5" y1="5298.8984" y2="5298.8984"/><polygon fill="#A80036" points="1282.5,5294.8984,1272.5,5298.8984,1282.5,5302.8984,1278.5,5298.8984" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1278.5" y="5281.1563">92</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="115" x="1300.5" y="5281.1563">Get device CA cert</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1271.5" x2="1313.5" y1="5338.209" y2="5338.209"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1313.5" x2="1313.5" y1="5338.209" y2="5351.209"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1266.5" x2="1313.5" y1="5351.209" y2="5351.209"/><polygon fill="#A80036" points="1276.5,5347.209,1266.5,5351.209,1276.5,5355.209,1272.5,5351.209" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1278.5" y="5333.4668">93</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="25" x="1300.5" y="5333.4668">PEM</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1266.5" x2="1308.5" y1="5390.8301" y2="5390.8301"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1308.5" x2="1308.5" y1="5390.8301" y2="5403.8301"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1267.5" x2="1308.5" y1="5403.8301" y2="5403.8301"/><polygon fill="#A80036" points="1277.5,5399.8301,1267.5,5403.8301,1277.5,5407.8301,1273.5,5403.8301" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1273.5" y="5378.4326">94</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="1295.5" y="5370.7773">Sign CSR using device</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="1295.5" y="5386.0879">CA cert</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1266.5" x2="1308.5" y1="5445.1406" y2="5445.1406"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1308.5" x2="1308.5" y1="5445.1406" y2="5458.1406"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1261.5" x2="1308.5" y1="5458.1406" y2="5458.1406"/><polygon fill="#A80036" points="1271.5,5454.1406,1261.5,5458.1406,1271.5,5462.1406,1267.5,5458.1406" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1273.5" y="5440.3984">95</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="1295.5" y="5440.3984">Signed server cert</text><polygon fill="#A80036" points="650.5,5478.4512,640.5,5482.4512,650.5,5486.4512,646.5,5482.4512" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="644.5" x2="1255.5" y1="5482.4512" y2="5482.4512"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="656.5" y="5477.709">96</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="678.5" y="5477.709">Signed server cert</text><polygon fill="#A80036" points="1789.5,5507.7617,1799.5,5511.7617,1789.5,5515.7617,1793.5,5511.7617" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="634.5" x2="1795.5" y1="5511.7617" y2="5511.7617"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="641.5" y="5507.0195">97</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="663.5" y="5507.0195">Signed server cert</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="634.5" x2="676.5" y1="5556.3828" y2="5556.3828"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="676.5" x2="676.5" y1="5556.3828" y2="5569.3828"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="635.5" x2="676.5" y1="5569.3828" y2="5569.3828"/><polygon fill="#A80036" points="645.5,5565.3828,635.5,5569.3828,645.5,5573.3828,641.5,5569.3828" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="641.5" y="5543.9854">98</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="663.5" y="5536.3301">Save key pair as server</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="663.5" y="5551.6406">cert private key</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="634.5" x2="676.5" y1="5644.625" y2="5644.625"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="676.5" x2="676.5" y1="5644.625" y2="5657.625"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="635.5" x2="676.5" y1="5657.625" y2="5657.625"/><polygon fill="#A80036" points="645.5,5653.625,635.5,5657.625,645.5,5661.625,641.5,5657.625" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="641.5" y="5616.917">99</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="663.5" y="5593.9512">Save signed cert so that</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="663.5" y="5609.2617">it can be retrieved for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="131" x="663.5" y="5624.5723">future module server</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="82" x="663.5" y="5639.8828">cert requests</text><path d="M383.5,5686.625 L557.5,5686.625 L557.5,5693.625 L547.5,5703.625 L383.5,5703.625 L383.5,5686.625 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="922.7324" style="stroke: #000000; stroke-width: 2.0;" width="1615" x="383.5" y="5686.625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="129" x="398.5" y="5700.1934">Connect to IoT Hub</text><path d="M393.5,5710.9355 L467.5,5710.9355 L467.5,5717.9355 L457.5,5727.9355 L393.5,5727.9355 L393.5,5710.9355 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="891.4219" style="stroke: #000000; stroke-width: 2.0;" width="1595" x="393.5" y="5710.9355"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="408.5" y="5724.5039">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="370" x="482.5" y="5723.5703">[for getting and renewing SAS token for identifying with IoT Hub]</text><polygon fill="#A80036" points="650.5,5745.5566,640.5,5749.5566,650.5,5753.5566,646.5,5749.5566" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="644.5" x2="1800.5" y1="5749.5566" y2="5749.5566"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="27" x="656.5" y="5744.8145">100</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="687.5" y="5744.8145">Get IoTHub identity</text><polygon fill="#A80036" points="831.5,5774.8672,841.5,5778.8672,831.5,5782.8672,835.5,5778.8672" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="639.5" x2="837.5" y1="5778.8672" y2="5778.8672"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="27" x="646.5" y="5774.125">101</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="677.5" y="5774.125">Get IoTHub identity</text><polygon fill="#A80036" points="650.5,5850.1094,640.5,5854.1094,650.5,5858.1094,646.5,5854.1094" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="644.5" x2="847.5" y1="5854.1094" y2="5854.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="27" x="656.5" y="5826.4014">102</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="687.5" y="5803.4355">Identity info (IoTHub +</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="687.5" y="5818.7461">device identity +</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="687.5" y="5834.0566">generation ID +</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="687.5" y="5849.3672">credentials type)</text><polygon fill="#A80036" points="1789.5,5925.3516,1799.5,5929.3516,1789.5,5933.3516,1793.5,5929.3516" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="634.5" x2="1795.5" y1="5929.3516" y2="5929.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="27" x="641.5" y="5901.6436">103</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="672.5" y="5878.6777">Identity info (IoTHub +</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="672.5" y="5893.9883">device identity +</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="672.5" y="5909.2988">generation ID +</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="672.5" y="5924.6094">credentials type)</text><polygon fill="#A80036" points="650.5,5985.2832,640.5,5989.2832,650.5,5993.2832,646.5,5989.2832" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="644.5" x2="1800.5" y1="5989.2832" y2="5989.2832"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="27" x="656.5" y="5969.2305">104</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="687.5" y="5953.9199">Get SAS token for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="687.5" y="5969.2305">identifying with IoT</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="26" x="687.5" y="5984.541">Hub</text><polygon fill="#A80036" points="831.5,6045.2148,841.5,6049.2148,831.5,6053.2148,835.5,6049.2148" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="639.5" x2="837.5" y1="6049.2148" y2="6049.2148"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="27" x="646.5" y="6029.1621">105</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="677.5" y="6013.8516">Get SAS token for Edge</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="677.5" y="6029.1621">Hub to identify with IoT</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="26" x="677.5" y="6044.4727">Hub</text><polygon fill="#A80036" points="1040.5,6089.8359,1050.5,6093.8359,1040.5,6097.8359,1044.5,6093.8359" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="853.5" x2="1046.5" y1="6093.8359" y2="6093.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="27" x="860.5" y="6081.4385">106</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="891.5" y="6073.7832">Get master encryption</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="891.5" y="6089.0938">key</text><polygon fill="#A80036" points="864.5,6119.1465,854.5,6123.1465,864.5,6127.1465,860.5,6123.1465" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="858.5" x2="1056.5" y1="6123.1465" y2="6123.1465"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="27" x="870.5" y="6118.4043">107</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="901.5" y="6118.4043">Key handle</text><polygon fill="#A80036" points="1040.5,6209.6992,1050.5,6213.6992,1040.5,6217.6992,1044.5,6213.6992" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="853.5" x2="1046.5" y1="6213.6992" y2="6213.6992"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="27" x="860.5" y="6178.3359">108</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="891.5" y="6147.7148">Sign Edge Hub's name</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="891.5" y="6163.0254">+ generation ID using</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="891.5" y="6178.3359">the master encryption</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="891.5" y="6193.6465">key to derive Edge Hub</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="891.5" y="6208.957">SAS keys</text><polygon fill="#A80036" points="864.5,6239.0098,854.5,6243.0098,864.5,6247.0098,860.5,6243.0098" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="858.5" x2="1056.5" y1="6243.0098" y2="6243.0098"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="27" x="870.5" y="6238.2676">109</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="905.5" y="6238.2676"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="853.5" x2="895.5" y1="6287.6309" y2="6287.6309"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="895.5" x2="895.5" y1="6287.6309" y2="6300.6309"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="854.5" x2="895.5" y1="6300.6309" y2="6300.6309"/><polygon fill="#A80036" points="864.5,6296.6309,854.5,6300.6309,864.5,6304.6309,860.5,6300.6309" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="27" x="860.5" y="6275.2334">110</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="891.5" y="6267.5781">Create SAS token from</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="891.5" y="6282.8887">SAS key</text><polygon fill="#A80036" points="650.5,6325.9414,640.5,6329.9414,650.5,6333.9414,646.5,6329.9414" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="644.5" x2="847.5" y1="6329.9414" y2="6329.9414"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="27" x="656.5" y="6325.1992">111</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="687.5" y="6325.1992">SAS token</text><polygon fill="#A80036" points="1789.5,6355.252,1799.5,6359.252,1789.5,6363.252,1793.5,6359.252" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="634.5" x2="1795.5" y1="6359.252" y2="6359.252"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="27" x="641.5" y="6354.5098">112</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="672.5" y="6354.5098">SAS token</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1801.5" x2="1843.5" y1="6403.873" y2="6403.873"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1843.5" x2="1843.5" y1="6403.873" y2="6416.873"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1802.5" x2="1843.5" y1="6416.873" y2="6416.873"/><polygon fill="#A80036" points="1812.5,6412.873,1802.5,6416.873,1812.5,6420.873,1808.5,6416.873" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="27" x="1808.5" y="6391.4756">113</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="1839.5" y="6383.8203">Create IoT Hub client</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="94" x="1839.5" y="6399.1309">with SAS token</text><polygon fill="#A80036" points="455.5,6442.1836,445.5,6446.1836,455.5,6450.1836,451.5,6446.1836" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="449.5" x2="1800.5" y1="6446.1836" y2="6446.1836"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="27" x="461.5" y="6441.4414">114</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="492.5" y="6441.4414">Connect to IoT Hub</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="444.5" x2="486.5" y1="6552.0469" y2="6552.0469"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="486.5" x2="486.5" y1="6552.0469" y2="6565.0469"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="445.5" x2="486.5" y1="6565.0469" y2="6565.0469"/><polygon fill="#A80036" points="455.5,6561.0469,445.5,6565.0469,455.5,6569.0469,451.5,6565.0469" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="27" x="451.5" y="6509.0283">115</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="482.5" y="6470.752">Validate SAS token</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="482.5" y="6486.0625">against SAS key that</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="482.5" y="6501.373">was registered when</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="482.5" y="6516.6836">the Edge Hub identity</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="482.5" y="6531.9941">was created by the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="482.5" y="6547.3047">runtime</text><polygon fill="#A80036" points="1789.5,6590.3574,1799.5,6594.3574,1789.5,6598.3574,1793.5,6594.3574" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="439.5" x2="1795.5" y1="6594.3574" y2="6594.3574"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="27" x="446.5" y="6589.6152">116</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="18" x="477.5" y="6589.6152">OK</text><!--MD5=[6127fc6ad5ffa2f4a325bedda89c0b4d]
@startuml

title Runtime Operation
skinparam maxMessageSize 150

participant "EST" as est
participant "IoT Hub" as hub

box Device #LightBlue
	participant "Module Runtime" as mr
	participant "Identity Service" as is
	participant "Keys Service" as ks
	participant "Certificates Service" as cs
	participant "Host Process\nModule" as hlm
	participant "EdgeAgent" as ea
	participant "EdgeHub" as eh
	participant "Container\nModule" as cm
end box


autonumber

group Host-level modules provisioning
	is -> is: Read host-level module names from configuration 
	loop for creating each host-level module M
		is -> ks ++: Create/Get master identity symmetric key
		return Key handle
		is -> ks++: Create module derived key object for module M (based on master identity key handle)
		return
		is -> ks ++: Derive and Sign module M's SAS key using name + generation ID (with derived key handle)
		return
		is -> is ++: Get current device identity cert and key handle
		is -> ks ++: Get current device identity cert's private key
		return Key handle
		is -> cs ++: Get current device identity cert
		return PEM
		return
		is -> is: Create TLS client using key handle + PEM (using openssl-engine-ks)
		is -> hub ++: Create identity for module M and register the derived SAS keys for it
		note over is
			If IoTHub call ever fails with bad credential, IS requests provisioning (with reprovision=true)
		end note
		return
	end
end

group Host-level modules process operations
	loop for getting and renewing SAS token for identifying with IoT Hub
		hlm -> is ++: Get SAS token for Edge Agent to identify with IoT Hub
		is -> ks ++: Get master encryption key
		return Key handle
		is -> ks ++: Sign Edge Agent's name + generation ID using the master encryption key to derive Edge Agent SAS keys
		return
		is -> is: Create SAS token from SAS key
		return SAS token
		hlm -> hlm: Create IoT Hub client with SAS token
		hlm -> hub ++: Connect to IoT Hub
		hub -> hub: Validate SAS token against SAS key that was registered when the Edge Agent identity was created by the runtime
		return OK
	end
end

group Edge Agent operation
	mr -> is ++: Create module identity for Edge Agent
	is -> ks ++: Get master encryption key
	return Key handle
	is -> ks ++: Sign Edge Agent's name + generation ID using the master encryption key to derive Edge Agent SAS keys
	return
	is -> is: Create TLS client using key handle + PEM (using openssl-engine-ks)
	is -> hub ++: Create module identity for Edge Agent and register the derived SAS keys for it
	return
	return Edge Agent identity

	mr -> ea **: Create and start

	loop for getting and renewing SAS token for identifying with IoT Hub
		ea -> mr ++: Get SAS token for identifying with IoT Hub
		mr -> is ++: Get SAS token for Edge Agent to identify with IoT Hub
		is -> ks ++: Get master encryption key
		return Key handle
		is -> ks ++: Sign Edge Agent's name + generation ID using the master encryption key to derive Edge Agent SAS keys
		return
		is -> is: Create SAS token from SAS key
		return SAS token
		return SAS token
		ea -> ea: Create IoT Hub client with SAS token
		ea -> hub ++: Connect to IoT Hub
		hub -> hub: Validate SAS token against SAS key that was registered when the Edge Agent identity was created by the runtime
		return OK
	end

	ea -> hub ++: Get deployment
	return

	loop for each module M
		ea -> mr ++: Create identity for module M
		mr -> is ++: Create identity for module M
		is -> ks ++: Get master encryption key
		return Key handle
		is -> ks ++: Sign module M's name + generation ID using the master encryption key to derive module M's SAS keys
		return
		is -> hub ++: Create identity for module M and register the derived SAS keys for it
		return
		return
		return

		ea -> mr ++: Start module
		return
	end

	mr -> eh **: Start Edge Hub
	mr -> cm **: Start Custom module
end

group Edge Hub operation
	loop for server cert request and renewal
		note over hub
			While it is possible to make an openssl engine (like openssl-engine-ks) for modules
			that performs key operations using the KS, it is not feasible to expect all modules to be using
			openssl for TLS, especially Windows modules. Thus modules need to have the raw private key bytes
			to be able to serve TLS with a server cert.

			For this reason, the private keys of module server certs are not persisted using Keys Service.

			Also, note that a single server cert is shared between all modules, and its lifetime is managed by the runtime.
			This is because the user may have module server certs rooted to public CAs, so it would cost the customer $$$ for each cert.
			Thus we do not want to request a new server cert when a previously requested cert is still valid, which also means
			we want to dedupe the server certs across all modules that want them. Since server certs are issued for the device hostname
			anyway, reusing the server cert for multiple modules is not a concern.
		end note

		alt if server cert already exists and is valid
			eh -> mr ++: Get server cert
			mr -> mr: Get persisted server cert
			mr -> mr: Server cert is valid
			mr -> mr: Get persisted server cert's private key
			return Server cert and private key

		else if server cert does not exist or is expired
			eh -> mr ++: Get server cert
			alt if server cert does not exist
				mr -> mr : Get persisted server cert
				mr -> mr: Server cert is not found
			else if server cert exists but is expired / close to expiry
				mr -> mr : Get persisted server cert
				mr -> mr: Server cert is expired / close to expiry
			end

			mr -> mr: Create new asymmetric key pair (in memory)
			mr -> cs ++: Request new module server cert
			cs -> cs: Create CSR for new module server cert using key
			cs -> cs ++: Get module server cert

			alt if module certs should be issued by EST
				cs -> ks ++: Get current EST identity cert's private key
				return Key handle
				cs -> cs ++: Get current EST identity cert
				return PEM
				cs -> cs: Create TLS client using key handle + PEM (using openssl-engine-ks)
				cs -> est ++: Connect using TLS client and send request for new module server cert corresponding to the CSR
				est -> est: Verify client cert against CA
				est -> est: Sign CSR
				return Signed server cert

			else if module certs should be minted locally
				cs -> ks ++: Get device CA cert's private key
				return Key handle
				cs -> cs ++: Get device CA cert
				return PEM
				cs -> cs: Sign CSR using device CA cert
			end

			return Signed server cert
			return Signed server cert
			return Signed server cert
			mr -> mr: Save key pair as server cert private key
			mr -> mr: Save signed cert so that it can be retrieved for future module server cert requests
		end
	end

	group Connect to IoT Hub
		loop for getting and renewing SAS token for identifying with IoT Hub
			eh -> mr ++: Get IoTHub identity
			mr -> is ++: Get IoTHub identity
			return Identity info (IoTHub + device identity + generation ID + credentials type)
			return Identity info (IoTHub + device identity + generation ID + credentials type)

			eh -> mr ++: Get SAS token for identifying with IoT Hub
			mr -> is ++: Get SAS token for Edge Hub to identify with IoT Hub
			is -> ks ++: Get master encryption key
			return Key handle
			is -> ks ++: Sign Edge Hub's name + generation ID using the master encryption key to derive Edge Hub SAS keys
			return
			is -> is: Create SAS token from SAS key
			return SAS token
			return SAS token
			eh -> eh: Create IoT Hub client with SAS token
			eh -> hub ++: Connect to IoT Hub
			hub -> hub: Validate SAS token against SAS key that was registered when the Edge Hub identity was created by the runtime
			return OK
		end
	end
end

@enduml

PlantUML version 1.2020.10(Sun May 17 02:35:57 PDT 2020)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 13.0.1+9
Operating System: Mac OS X
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>