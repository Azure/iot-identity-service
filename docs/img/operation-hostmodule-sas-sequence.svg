<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="892px" preserveAspectRatio="none" style="width:778px;height:892px;background:#FFFFFF;" version="1.1" viewBox="0 0 778 892" width="778px" zoomAndPan="magnify"><defs><filter height="300%" id="f1v88lg7p95xcd" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="358" x="208" y="28.708">Host-level modules SaS authentication</text><rect fill="#ADD8E6" height="845.8438" style="stroke:#A80036;stroke-width:1.0;" width="513" x="16" y="40.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="49" x="245.5" y="53.02">Device</text><rect fill="#FFFFFF" filter="url(#f1v88lg7p95xcd)" height="221.3281" style="stroke:#A80036;stroke-width:1.0;" width="10" x="276.5" y="180.9141"/><rect fill="#FFFFFF" filter="url(#f1v88lg7p95xcd)" height="29.1328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="465.5" y="225.1797"/><rect fill="#FFFFFF" filter="url(#f1v88lg7p95xcd)" height="29.1328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="465.5" y="328.8438"/><rect fill="#FFFFFF" filter="url(#f1v88lg7p95xcd)" height="29.1328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="465.5" y="488.6406"/><rect fill="#FFFFFF" filter="url(#f1v88lg7p95xcd)" height="131.7969" style="stroke:#A80036;stroke-width:1.0;" width="10" x="566" y="691.7031"/><rect fill="#FFFFFF" filter="url(#f1v88lg7p95xcd)" height="719.1172" style="stroke:#000000;stroke-width:2.0;" width="754" x="10" y="112.3828"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="93" x2="93" y1="95.3828" y2="848.5"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="281.5" x2="281.5" y1="95.3828" y2="848.5"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="470" x2="470" y1="95.3828" y2="848.5"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="571" x2="571" y1="95.3828" y2="848.5"/><rect fill="#FEFECE" filter="url(#f1v88lg7p95xcd)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="143" x="20" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="129" x="27" y="80.0811">Your device agent</text><rect fill="#FEFECE" filter="url(#f1v88lg7p95xcd)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="143" x="20" y="847.5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="129" x="27" y="867.4951">Your device agent</text><rect fill="#FEFECE" filter="url(#f1v88lg7p95xcd)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="128" x="215.5" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="114" x="222.5" y="80.0811">Identity Service</text><rect fill="#FEFECE" filter="url(#f1v88lg7p95xcd)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="128" x="215.5" y="847.5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="114" x="222.5" y="867.4951">Identity Service</text><rect fill="#FEFECE" filter="url(#f1v88lg7p95xcd)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="105" x="416" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="423" y="80.0811">Keys Service</text><rect fill="#FEFECE" filter="url(#f1v88lg7p95xcd)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="105" x="416" y="847.5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="423" y="867.4951">Keys Service</text><rect fill="#FEFECE" filter="url(#f1v88lg7p95xcd)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="68" x="535" y="60.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="54" x="542" y="80.0811">IoT Hub</text><rect fill="#FEFECE" filter="url(#f1v88lg7p95xcd)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="68" x="535" y="847.5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="54" x="542" y="867.4951">IoT Hub</text><rect fill="#FFFFFF" filter="url(#f1v88lg7p95xcd)" height="221.3281" style="stroke:#A80036;stroke-width:1.0;" width="10" x="276.5" y="180.9141"/><rect fill="#FFFFFF" filter="url(#f1v88lg7p95xcd)" height="29.1328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="465.5" y="225.1797"/><rect fill="#FFFFFF" filter="url(#f1v88lg7p95xcd)" height="29.1328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="465.5" y="328.8438"/><rect fill="#FFFFFF" filter="url(#f1v88lg7p95xcd)" height="29.1328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="465.5" y="488.6406"/><rect fill="#FFFFFF" filter="url(#f1v88lg7p95xcd)" height="131.7969" style="stroke:#A80036;stroke-width:1.0;" width="10" x="566" y="691.7031"/><path d="M10,112.3828 L88,112.3828 L88,119.3828 L78,129.3828 L10,129.3828 L10,112.3828 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="719.1172" style="stroke:#000000;stroke-width:2.0;" width="754" x="10" y="112.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="33" x="25" y="125.4497">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="529" x="103" y="124.5933">[for host-level module M to create SAS token for authenticating with IoT Hub]</text><polygon fill="#A80036" points="264.5,176.9141,274.5,180.9141,264.5,184.9141,268.5,180.9141" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="93.5" x2="270.5" y1="180.9141" y2="180.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="100.5" y="160.7153">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="113.5" y="145.5825">Get identity for host</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="113.5" y="160.7153">module M to identify</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="113.5" y="175.8481">with IoT Hub</text><polygon fill="#A80036" points="453.5,221.1797,463.5,225.1797,453.5,229.1797,457.5,225.1797" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="286.5" x2="459.5" y1="225.1797" y2="225.1797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="293.5" y="212.5474">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="125" x="306.5" y="204.981">Get master identity</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="70" x="306.5" y="220.1138">key handle</text><polygon fill="#A80036" points="297.5,250.3125,287.5,254.3125,297.5,258.3125,293.5,254.3125" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="291.5" x2="469.5" y1="254.3125" y2="254.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="8" x="303.5" y="249.2466">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="315.5" y="249.2466">Key handle</text><polygon fill="#A80036" points="453.5,324.8438,463.5,328.8438,453.5,332.8438,457.5,328.8438" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="286.5" x2="459.5" y1="328.8438" y2="328.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="293.5" y="301.0786">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="147" x="306.5" y="278.3794">Create module derived</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="140" x="306.5" y="293.5122">key object for module</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="128" x="306.5" y="308.645">M (based on master</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127" x="306.5" y="323.7778">identity key handle)</text><polygon fill="#A80036" points="297.5,353.9766,287.5,357.9766,297.5,361.9766,293.5,357.9766" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="291.5" x2="469.5" y1="357.9766" y2="357.9766"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="303.5" y="352.9106">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="320.5" y="352.9106"/><polygon fill="#A80036" points="104.5,398.2422,94.5,402.2422,104.5,406.2422,100.5,402.2422" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="98.5" x2="280.5" y1="402.2422" y2="402.2422"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="110.5" y="389.6099">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="128" x="123.5" y="382.0435">Module identity with</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="122" x="123.5" y="397.1763">derived key handle</text><line style="stroke:#A80036;stroke-width:1.0;" x1="93.5" x2="135.5" y1="431.375" y2="431.375"/><line style="stroke:#A80036;stroke-width:1.0;" x1="135.5" x2="135.5" y1="431.375" y2="444.375"/><line style="stroke:#A80036;stroke-width:1.0;" x1="94.5" x2="135.5" y1="444.375" y2="444.375"/><polygon fill="#A80036" points="104.5,440.375,94.5,444.375,104.5,448.375,100.5,444.375" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="100.5" y="426.3091">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="113.5" y="426.3091">Generate SAS token</text><polygon fill="#A80036" points="453.5,484.6406,463.5,488.6406,453.5,492.6406,457.5,488.6406" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="93.5" x2="459.5" y1="488.6406" y2="488.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="100.5" y="476.0083">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="134" x="113.5" y="468.4419">Sign SAS token using</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="122" x="113.5" y="483.5747">derived key handle</text><polygon fill="#A80036" points="104.5,513.7734,94.5,517.7734,104.5,521.7734,100.5,517.7734" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="98.5" x2="469.5" y1="517.7734" y2="517.7734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="110.5" y="512.7075">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="112" x="123.5" y="512.7075">Signed SAS token</text><line style="stroke:#A80036;stroke-width:1.0;" x1="93.5" x2="135.5" y1="592.3047" y2="592.3047"/><line style="stroke:#A80036;stroke-width:1.0;" x1="135.5" x2="135.5" y1="592.3047" y2="605.3047"/><line style="stroke:#A80036;stroke-width:1.0;" x1="94.5" x2="135.5" y1="605.3047" y2="605.3047"/><polygon fill="#A80036" points="104.5,601.3047,94.5,605.3047,104.5,609.3047,100.5,605.3047" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="100.5" y="564.5396">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="60" x="123.5" y="541.8403">Generate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="123.5" y="556.9731">SharedAccessSignature</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="145" x="123.5" y="572.106">for authenticating with</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="48" x="123.5" y="587.2388">IoT Hub</text><line style="stroke:#A80036;stroke-width:1.0;" x1="93.5" x2="135.5" y1="649.5703" y2="649.5703"/><line style="stroke:#A80036;stroke-width:1.0;" x1="135.5" x2="135.5" y1="649.5703" y2="662.5703"/><line style="stroke:#A80036;stroke-width:1.0;" x1="94.5" x2="135.5" y1="662.5703" y2="662.5703"/><polygon fill="#A80036" points="104.5,658.5703,94.5,662.5703,104.5,666.5703,100.5,662.5703" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="100.5" y="636.938">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="133" x="122.5" y="629.3716">Create IoT Hub client</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="96" x="122.5" y="644.5044">with SAS token</text><polygon fill="#A80036" points="554,687.7031,564,691.7031,554,695.7031,558,691.7031" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="93.5" x2="560" y1="691.7031" y2="691.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="100.5" y="686.6372">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="122" x="122.5" y="686.6372">Connect to IoT Hub</text><line style="stroke:#A80036;stroke-width:1.0;" x1="576" x2="618" y1="781.3672" y2="781.3672"/><line style="stroke:#A80036;stroke-width:1.0;" x1="618" x2="618" y1="781.3672" y2="794.3672"/><line style="stroke:#A80036;stroke-width:1.0;" x1="577" x2="618" y1="794.3672" y2="794.3672"/><polygon fill="#A80036" points="587,790.3672,577,794.3672,587,798.3672,583,794.3672" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="17" x="583" y="746.0356">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121" x="604" y="715.77">Validate SAS token</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="133" x="604" y="730.9028">against SAS key that</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="134" x="604" y="746.0356">was registered when</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="103" x="604" y="761.1685">the identity was</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="148" x="604" y="776.3013">created by the runtime</text><polygon fill="#A80036" points="104.5,819.5,94.5,823.5,104.5,827.5,100.5,823.5" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="98.5" x2="570" y1="823.5" y2="823.5"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="110.5" y="818.4341">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="18" x="132.5" y="818.4341">OK</text><!--MD5=[bc58bea5044523c621da9c673bb5be24]
@startuml
title Host-level modules SaS authentication
skinparam maxMessageSize 150

box Device #LightBlue
	participant "Your device agent" as hlm
	participant "Identity Service" as is
	participant "Keys Service" as ks
end box

participant "IoT Hub" as hub

autonumber
!startsub HOSTMODULE
	loop for host-level module M to create SAS token for authenticating with IoT Hub
		hlm -> is ++: Get identity for host module M to identify with IoT Hub
		is -> ks ++: Get master identity key handle
		return Key handle
		is -> ks ++: Create module derived key object for module M (based on master identity key handle)
		return
		return Module identity with derived key handle
		hlm -> hlm: Generate SAS token
		hlm -> ks++: Sign SAS token using derived key handle
		return Signed SAS token
		hlm -> hlm: Generate SharedAccessSignature for authenticating with IoT Hub
		hlm -> hlm: Create IoT Hub client with SAS token
		hlm -> hub++: Connect to IoT Hub
		hub -> hub: Validate SAS token against SAS key that was registered when the identity was created by the runtime
		return OK
	end
!endsub
@enduml

@startuml
title Host-level modules SaS authentication
skinparam maxMessageSize 150

box Device #LightBlue
	participant "Your device agent" as hlm
	participant "Identity Service" as is
	participant "Keys Service" as ks
end box

participant "IoT Hub" as hub

autonumber
	loop for host-level module M to create SAS token for authenticating with IoT Hub
		hlm -> is ++: Get identity for host module M to identify with IoT Hub
		is -> ks ++: Get master identity key handle
		return Key handle
		is -> ks ++: Create module derived key object for module M (based on master identity key handle)
		return
		return Module identity with derived key handle
		hlm -> hlm: Generate SAS token
		hlm -> ks++: Sign SAS token using derived key handle
		return Signed SAS token
		hlm -> hlm: Generate SharedAccessSignature for authenticating with IoT Hub
		hlm -> hlm: Create IoT Hub client with SAS token
		hlm -> hub++: Connect to IoT Hub
		hub -> hub: Validate SAS token against SAS key that was registered when the identity was created by the runtime
		return OK
	end
@enduml

PlantUML version 1.2021.7beta2(Unknown compile time)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>