<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="3257px" preserveAspectRatio="none" style="width:1915px;height:3257px;" version="1.1" viewBox="0 0 1915 3257" width="1915px" zoomAndPan="magnify"><defs><filter height="300%" id="f735j1mxl357c" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="164" x="876.5" y="27.4023">Runtime Operation</text><rect fill="#ADD8E6" height="3207.2051" style="stroke: #A80036; stroke-width: 1.0;" width="1243" x="655" y="39.1992"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="45" x="1252" y="51.7676">Device</text><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="113.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="69.5" y="2449.6406"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="368.5" y="320.9707"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="102.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="368.5" y="577.4551"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="368.5" y="828.5605"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="102.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="368.5" y="1133.5332"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="368.5" y="1265.0859"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="368.5" y="1450.2598"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="102.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="368.5" y="3057.1855"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="710.5" y="417.9023"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="710.5" y="476.5234"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="129.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="710.5" y="932.6699"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="160.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="710.5" y="1348.0176"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="710.5" y="1538.1914"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="71.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="710.5" y="1891.7617"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="707.1211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="710.5" y="2007.6484"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="40.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="715.5" y="2069.2695"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="40.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="715.5" y="2168.8457"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="44.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="710.5" y="2782.3906"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="129.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="710.5" y="2856.3223"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="237.7949" style="stroke: #000000; stroke-width: 2.0;" width="732" x="317.5" y="127.4863"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="148.8633" style="stroke: #000000; stroke-width: 2.0;" width="712" x="327.5" y="209.418"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="308.416" style="stroke: #000000; stroke-width: 2.0;" width="1002" x="327.5" y="379.2813"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="988.2695" style="stroke: #000000; stroke-width: 2.0;" width="1586.5" x="317.5" y="701.6973"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="266.1055" style="stroke: #000000; stroke-width: 2.0;" width="1053.5" x="327.5" y="1309.3965"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="1470.4609" style="stroke: #000000; stroke-width: 2.0;" width="1860.5" x="13" y="1703.9668"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="1001.4922" style="stroke: #000000; stroke-width: 2.0;" width="1628.5" x="23" y="1728.2773"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="869.6289" style="stroke: #000000; stroke-width: 2.0;" width="1608.5" x="33" y="1853.1406"/><rect fill="#FFFFFF" height="751.3867" style="stroke: none; stroke-width: 1.0;" width="1608.5" x="33" y="1971.3828"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="243.8184" style="stroke: #000000; stroke-width: 2.0;" width="370.5" x="649" y="2022.6484"/><rect fill="#FFFFFF" height="141.8867" style="stroke: none; stroke-width: 1.0;" width="370.5" x="649" y="2124.5801"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="290.75" style="stroke: #000000; stroke-width: 2.0;" width="1017.5" x="43" y="2338.0879"/><rect fill="#FFFFFF" height="57.2656" style="stroke: none; stroke-width: 1.0;" width="1017.5" x="43" y="2571.5723"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="423.6582" style="stroke: #000000; stroke-width: 2.0;" width="1536" x="327.5" y="2743.7695"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="74" x2="74" y1="110.4863" y2="3191.4277"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="373.5" x2="373.5" y1="110.4863" y2="3191.4277"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="715" x2="715" y1="110.4863" y2="3191.4277"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1060" x2="1060" y1="110.4863" y2="3191.4277"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1324" x2="1324" y1="898.6152" y2="3191.4277"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1591.5" x2="1591.5" y1="1615.2461" y2="3191.4277"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1858" x2="1858" y1="1668.9785" y2="3191.4277"/><rect fill="#FEFECE" filter="url(#f735j1mxl357c)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="39" x="53" y="74.998"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="25" x="60" y="95.5332">EST</text><rect fill="#FEFECE" filter="url(#f735j1mxl357c)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="39" x="53" y="3190.4277"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="25" x="60" y="3210.9629">EST</text><rect fill="#FEFECE" filter="url(#f735j1mxl357c)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="68" x="337.5" y="74.998"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="54" x="344.5" y="95.5332">IoT Hub</text><rect fill="#FEFECE" filter="url(#f735j1mxl357c)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="68" x="337.5" y="3190.4277"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="54" x="344.5" y="3210.9629">IoT Hub</text><rect fill="#FEFECE" filter="url(#f735j1mxl357c)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="109" x="659" y="74.998"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="95" x="666" y="95.5332">Edge Runtime</text><rect fill="#FEFECE" filter="url(#f735j1mxl357c)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="109" x="659" y="3190.4277"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="95" x="666" y="3210.9629">Edge Runtime</text><rect fill="#FEFECE" filter="url(#f735j1mxl357c)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="101" x="1008" y="74.998"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="87" x="1015" y="95.5332">Host Process</text><rect fill="#FEFECE" filter="url(#f735j1mxl357c)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="101" x="1008" y="3190.4277"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="87" x="1015" y="3210.9629">Host Process</text><rect fill="#FEFECE" filter="url(#f735j1mxl357c)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="89" x="1278" y="3190.4277"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="75" x="1285" y="3210.9629">EdgeAgent</text><rect fill="#FEFECE" filter="url(#f735j1mxl357c)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="76" x="1551.5" y="3190.4277"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="62" x="1558.5" y="3210.9629">EdgeHub</text><rect fill="#FEFECE" filter="url(#f735j1mxl357c)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="67" x="1823" y="3190.4277"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="53" x="1830" y="3210.9629">Custom</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="51" x="1831" y="3227.4512">Module</text><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="113.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="69.5" y="2449.6406"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="368.5" y="320.9707"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="102.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="368.5" y="577.4551"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="368.5" y="828.5605"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="102.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="368.5" y="1133.5332"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="368.5" y="1265.0859"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="368.5" y="1450.2598"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="102.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="368.5" y="3057.1855"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="710.5" y="417.9023"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="710.5" y="476.5234"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="129.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="710.5" y="932.6699"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="160.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="710.5" y="1348.0176"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="710.5" y="1538.1914"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="71.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="710.5" y="1891.7617"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="707.1211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="710.5" y="2007.6484"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="40.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="715.5" y="2069.2695"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="40.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="715.5" y="2168.8457"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="44.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="710.5" y="2782.3906"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="129.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="710.5" y="2856.3223"/><path d="M317.5,127.4863 L494.5,127.4863 L494.5,134.4863 L484.5,144.4863 L317.5,144.4863 L317.5,127.4863 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="237.7949" style="stroke: #000000; stroke-width: 2.0;" width="732" x="317.5" y="127.4863"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="132" x="332.5" y="141.0547">Host-level modules</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="715.5" x2="757.5" y1="181.418" y2="181.418"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="757.5" x2="757.5" y1="181.418" y2="194.418"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="716.5" x2="757.5" y1="194.418" y2="194.418"/><polygon fill="#A80036" points="726.5,190.418,716.5,194.418,726.5,198.418,722.5,194.418" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="722.5" y="169.0205">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="229" x="735.5" y="161.3652">Read host-level module names from</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="85" x="735.5" y="176.6758">configuration</text><path d="M327.5,209.418 L401.5,209.418 L401.5,216.418 L391.5,226.418 L327.5,226.418 L327.5,209.418 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="148.8633" style="stroke: #000000; stroke-width: 2.0;" width="712" x="327.5" y="209.418"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="342.5" y="222.9863">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="225" x="416.5" y="222.0527">[for creating each host-level module M]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="715.5" x2="757.5" y1="263.3496" y2="263.3496"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="757.5" x2="757.5" y1="263.3496" y2="276.3496"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="716.5" x2="757.5" y1="276.3496" y2="276.3496"/><polygon fill="#A80036" points="726.5,272.3496,716.5,276.3496,726.5,280.3496,722.5,276.3496" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="722.5" y="250.9521">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="270" x="735.5" y="243.2969">Derive Edge Hub SAS keys from its name +</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="292" x="735.5" y="258.6074">generation ID using the master encryption key</text><polygon fill="#A80036" points="389.5,316.9707,379.5,320.9707,389.5,324.9707,385.5,320.9707" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383.5" x2="714.5" y1="320.9707" y2="320.9707"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="395.5" y="308.5732">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="283" x="408.5" y="300.918">Create identity for module M and register the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="408.5" y="316.2285">derived SAS keys for it</text><polygon fill="#A80036" points="703.5,346.2813,713.5,350.2813,703.5,354.2813,707.5,350.2813" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="373.5" x2="709.5" y1="350.2813" y2="350.2813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="380.5" y="345.5391">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="397.5" y="345.5391"/><path d="M327.5,379.2813 L527.5,379.2813 L527.5,386.2813 L517.5,396.2813 L327.5,396.2813 L327.5,379.2813 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="308.416" style="stroke: #000000; stroke-width: 2.0;" width="1002" x="327.5" y="379.2813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="155" x="342.5" y="392.8496">Host process operation</text><polygon fill="#A80036" points="731.5,413.9023,721.5,417.9023,731.5,421.9023,727.5,417.9023" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="725.5" x2="1059.5" y1="417.9023" y2="417.9023"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="737.5" y="413.1602">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="182" x="750.5" y="413.1602">Get identity for Host process</text><polygon fill="#A80036" points="1048.5,443.2129,1058.5,447.2129,1048.5,451.2129,1052.5,447.2129" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="715.5" x2="1054.5" y1="447.2129" y2="447.2129"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="722.5" y="442.4707">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="739.5" y="442.4707"/><polygon fill="#A80036" points="731.5,472.5234,721.5,476.5234,731.5,480.5234,727.5,476.5234" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="725.5" x2="1059.5" y1="476.5234" y2="476.5234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="737.5" y="471.7813">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="267" x="750.5" y="471.7813">Get SAS token for identifying with IoT Hub</text><polygon fill="#A80036" points="1048.5,501.834,1058.5,505.834,1048.5,509.834,1052.5,505.834" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="715.5" x2="1054.5" y1="505.834" y2="505.834"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="722.5" y="501.0918">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="739.5" y="501.0918"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1060.5" x2="1102.5" y1="535.1445" y2="535.1445"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1102.5" x2="1102.5" y1="535.1445" y2="548.1445"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1061.5" x2="1102.5" y1="548.1445" y2="548.1445"/><polygon fill="#A80036" points="1071.5,544.1445,1061.5,548.1445,1071.5,552.1445,1067.5,548.1445" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1067.5" y="530.4023">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="237" x="1080.5" y="530.4023">Create IoT Hub client using Sas token</text><polygon fill="#A80036" points="389.5,573.4551,379.5,577.4551,389.5,581.4551,385.5,577.4551" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383.5" x2="1059.5" y1="577.4551" y2="577.4551"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="395.5" y="572.7129">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="417.5" y="572.7129">Connect to Iot Hub</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="378.5" x2="420.5" y1="637.3867" y2="637.3867"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420.5" x2="420.5" y1="637.3867" y2="650.3867"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="379.5" x2="420.5" y1="650.3867" y2="650.3867"/><polygon fill="#A80036" points="389.5,646.3867,379.5,650.3867,389.5,654.3867,385.5,650.3867" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="385.5" y="617.334">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="407.5" y="602.0234">Validate SAS token against SAS key that was</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="279" x="407.5" y="617.334">registered when the Edge Agent identity was</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="407.5" y="632.6445">created by the runtime</text><polygon fill="#A80036" points="1048.5,675.6973,1058.5,679.6973,1048.5,683.6973,1052.5,679.6973" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="373.5" x2="1054.5" y1="679.6973" y2="679.6973"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="380.5" y="674.9551">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="18" x="402.5" y="674.9551">OK</text><path d="M317.5,701.6973 L510.5,701.6973 L510.5,708.6973 L500.5,718.6973 L317.5,718.6973 L317.5,701.6973 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="988.2695" style="stroke: #000000; stroke-width: 2.0;" width="1586.5" x="317.5" y="701.6973"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="148" x="332.5" y="715.2656">Edge Agent operation</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="715.5" x2="757.5" y1="770.9395" y2="770.9395"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="757.5" x2="757.5" y1="770.9395" y2="783.9395"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="716.5" x2="757.5" y1="783.9395" y2="783.9395"/><polygon fill="#A80036" points="726.5,779.9395,716.5,783.9395,726.5,787.9395,722.5,783.9395" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="722.5" y="750.8867">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="289" x="744.5" y="735.5762">Derive SAS keys for Edge Agent from its name</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="744.5" y="750.8867">+ generation ID using the master encryption</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="744.5" y="766.1973">key</text><polygon fill="#A80036" points="389.5,824.5605,379.5,828.5605,389.5,832.5605,385.5,828.5605" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383.5" x2="714.5" y1="828.5605" y2="828.5605"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="395.5" y="816.1631">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="292" x="417.5" y="808.5078">Create identity for Edge Agent and register the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="417.5" y="823.8184">derived SAS keys for it</text><polygon fill="#A80036" points="703.5,853.8711,713.5,857.8711,703.5,861.8711,707.5,857.8711" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="373.5" x2="709.5" y1="857.8711" y2="857.8711"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="380.5" y="853.1289">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="406.5" y="853.1289"/><polygon fill="#A80036" points="1266,883.1816,1276,887.1816,1266,891.1816,1270,887.1816" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="715.5" x2="1272" y1="887.1816" y2="887.1816"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="722.5" y="882.4395">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="744.5" y="882.4395">Create and start</text><rect fill="#FEFECE" filter="url(#f735j1mxl357c)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="89" x="1278" y="865.8711"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="75" x="1285" y="886.4063">EdgeAgent</text><polygon fill="#A80036" points="731.5,928.6699,721.5,932.6699,731.5,936.6699,727.5,932.6699" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="725.5" x2="1323.5" y1="932.6699" y2="932.6699"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="737.5" y="927.9277">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="267" x="759.5" y="927.9277">Get SAS token for identifying with IoT Hub</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="720.5" x2="762.5" y1="977.291" y2="977.291"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="762.5" x2="762.5" y1="977.291" y2="990.291"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="721.5" x2="762.5" y1="990.291" y2="990.291"/><polygon fill="#A80036" points="731.5,986.291,721.5,990.291,731.5,994.291,727.5,990.291" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="727.5" y="964.8936">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="281" x="749.5" y="957.2383">Derive Edge Agent SAS keys from its name +</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="292" x="749.5" y="972.5488">generation ID using the master encryption key</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="720.5" x2="762.5" y1="1019.6016" y2="1019.6016"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="762.5" x2="762.5" y1="1019.6016" y2="1032.6016"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="721.5" x2="762.5" y1="1032.6016" y2="1032.6016"/><polygon fill="#A80036" points="731.5,1028.6016,721.5,1032.6016,731.5,1036.6016,727.5,1032.6016" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="727.5" y="1014.8594">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="749.5" y="1014.8594">Create SAS token from SAS key</text><polygon fill="#A80036" points="1312.5,1057.9121,1322.5,1061.9121,1312.5,1065.9121,1316.5,1061.9121" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="715.5" x2="1318.5" y1="1061.9121" y2="1061.9121"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="722.5" y="1057.1699">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="744.5" y="1057.1699">SAS token</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1324.5" x2="1366.5" y1="1091.2227" y2="1091.2227"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1366.5" x2="1366.5" y1="1091.2227" y2="1104.2227"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1325.5" x2="1366.5" y1="1104.2227" y2="1104.2227"/><polygon fill="#A80036" points="1335.5,1100.2227,1325.5,1104.2227,1335.5,1108.2227,1331.5,1104.2227" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1331.5" y="1086.4805">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="1353.5" y="1086.4805">Create IoT Hub client with SAS token</text><polygon fill="#A80036" points="389.5,1129.5332,379.5,1133.5332,389.5,1137.5332,385.5,1133.5332" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383.5" x2="1323.5" y1="1133.5332" y2="1133.5332"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="395.5" y="1128.791">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="417.5" y="1128.791">Connect to IoT Hub</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="378.5" x2="420.5" y1="1193.4648" y2="1193.4648"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420.5" x2="420.5" y1="1193.4648" y2="1206.4648"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="379.5" x2="420.5" y1="1206.4648" y2="1206.4648"/><polygon fill="#A80036" points="389.5,1202.4648,379.5,1206.4648,389.5,1210.4648,385.5,1206.4648" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="385.5" y="1173.4121">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="407.5" y="1158.1016">Validate SAS token against SAS key that was</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="279" x="407.5" y="1173.4121">registered when the Edge Agent identity was</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="407.5" y="1188.7227">created by the runtime</text><polygon fill="#A80036" points="1312.5,1231.7754,1322.5,1235.7754,1312.5,1239.7754,1316.5,1235.7754" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="373.5" x2="1318.5" y1="1235.7754" y2="1235.7754"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="380.5" y="1231.0332">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="18" x="402.5" y="1231.0332">OK</text><polygon fill="#A80036" points="389.5,1261.0859,379.5,1265.0859,389.5,1269.0859,385.5,1265.0859" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383.5" x2="1323.5" y1="1265.0859" y2="1265.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="395.5" y="1260.3438">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="417.5" y="1260.3438">Get deployment</text><polygon fill="#A80036" points="1312.5,1290.3965,1322.5,1294.3965,1312.5,1298.3965,1316.5,1294.3965" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="373.5" x2="1318.5" y1="1294.3965" y2="1294.3965"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="380.5" y="1289.6543">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="406.5" y="1289.6543"/><path d="M327.5,1309.3965 L401.5,1309.3965 L401.5,1316.3965 L391.5,1326.3965 L327.5,1326.3965 L327.5,1309.3965 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="266.1055" style="stroke: #000000; stroke-width: 2.0;" width="1053.5" x="327.5" y="1309.3965"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="342.5" y="1322.9648">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="114" x="416.5" y="1322.0313">[for each module M]</text><polygon fill="#A80036" points="731.5,1344.0176,721.5,1348.0176,731.5,1352.0176,727.5,1348.0176" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="725.5" x2="1323.5" y1="1348.0176" y2="1348.0176"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="737.5" y="1343.2754">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="759.5" y="1343.2754">Create identity for module M</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="720.5" x2="762.5" y1="1392.6387" y2="1392.6387"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="762.5" x2="762.5" y1="1392.6387" y2="1405.6387"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="721.5" x2="762.5" y1="1405.6387" y2="1405.6387"/><polygon fill="#A80036" points="731.5,1401.6387,721.5,1405.6387,731.5,1409.6387,727.5,1405.6387" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="727.5" y="1380.2412">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="749.5" y="1372.5859">Derive module M SAS keys from its name +</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="292" x="749.5" y="1387.8965">generation ID using the master encryption key</text><polygon fill="#A80036" points="389.5,1446.2598,379.5,1450.2598,389.5,1454.2598,385.5,1450.2598" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383.5" x2="709.5" y1="1450.2598" y2="1450.2598"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="395.5" y="1437.8623">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="283" x="417.5" y="1430.207">Create identity for module M and register the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="417.5" y="1445.5176">derived SAS keys for it</text><polygon fill="#A80036" points="698.5,1475.5703,708.5,1479.5703,698.5,1483.5703,702.5,1479.5703" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="373.5" x2="704.5" y1="1479.5703" y2="1479.5703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="380.5" y="1474.8281">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="406.5" y="1474.8281"/><polygon fill="#A80036" points="1312.5,1504.8809,1322.5,1508.8809,1312.5,1512.8809,1316.5,1508.8809" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="715.5" x2="1318.5" y1="1508.8809" y2="1508.8809"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="722.5" y="1504.1387">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="748.5" y="1504.1387"/><polygon fill="#A80036" points="731.5,1534.1914,721.5,1538.1914,731.5,1542.1914,727.5,1538.1914" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="725.5" x2="1323.5" y1="1538.1914" y2="1538.1914"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="737.5" y="1533.4492">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="759.5" y="1533.4492">Start module</text><polygon fill="#A80036" points="1312.5,1563.502,1322.5,1567.502,1312.5,1571.502,1316.5,1567.502" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="715.5" x2="1318.5" y1="1567.502" y2="1567.502"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="722.5" y="1562.7598">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="748.5" y="1562.7598"/><polygon fill="#A80036" points="1539.5,1599.8125,1549.5,1603.8125,1539.5,1607.8125,1543.5,1603.8125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="715.5" x2="1545.5" y1="1603.8125" y2="1603.8125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="722.5" y="1599.0703">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="744.5" y="1599.0703">Start Edge Hub</text><rect fill="#FEFECE" filter="url(#f735j1mxl357c)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="76" x="1551.5" y="1582.502"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="62" x="1558.5" y="1603.0371">EdgeHub</text><polygon fill="#A80036" points="1811,1645.3008,1821,1649.3008,1811,1653.3008,1815,1649.3008" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="715.5" x2="1817" y1="1649.3008" y2="1649.3008"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="722.5" y="1644.5586">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="744.5" y="1644.5586">Start Custom module</text><rect fill="#FEFECE" filter="url(#f735j1mxl357c)" height="46.9766" style="stroke: #A80036; stroke-width: 1.5;" width="67" x="1823" y="1627.9902"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="53" x="1830" y="1648.5254">Custom</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="51" x="1831" y="1665.0137">Module</text><path d="M13,1703.9668 L193,1703.9668 L193,1710.9668 L183,1720.9668 L13,1720.9668 L13,1703.9668 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1470.4609" style="stroke: #000000; stroke-width: 2.0;" width="1860.5" x="13" y="1703.9668"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="135" x="28" y="1717.5352">Edge Hub operation</text><path d="M23,1728.2773 L97,1728.2773 L97,1735.2773 L87,1745.2773 L23,1745.2773 L23,1728.2773 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1001.4922" style="stroke: #000000; stroke-width: 2.0;" width="1628.5" x="23" y="1728.2773"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="38" y="1741.8457">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="205" x="112" y="1740.9121">[for server cert request and renewal]</text><path d="M309,1750.5879 L309,1836.5879 L1118,1836.5879 L1118,1760.5879 L1108,1750.5879 L309,1750.5879 " fill="#FBFB77" filter="url(#f735j1mxl357c)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1108,1750.5879 L1108,1760.5879 L1118,1760.5879 L1108,1750.5879 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="655" x="315" y="1768.1563">Note that a single server cert is shared between all modules, and its lifetime is managed by the runtime.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="788" x="315" y="1783.4668">This is because the user may have module server certs rooted to public CAs, so it would cost the customer $$$ for each cert.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="717" x="315" y="1798.7773">Thus we do not want to request a new server cert when a previously requested cert is still valid, which also means</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="782" x="315" y="1814.0879">we want to dedupe the server certs across all modules that want them. Since server certs are issued for the device hostname</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="440" x="315" y="1829.3984">anyway, reusing the server cert for multiple modules is not a concern.</text><path d="M33,1853.1406 L95,1853.1406 L95,1860.1406 L85,1870.1406 L33,1870.1406 L33,1853.1406 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="869.6289" style="stroke: #000000; stroke-width: 2.0;" width="1608.5" x="33" y="1853.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="48" y="1866.709">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="231" x="110" y="1865.7754">[if server cert already exists and is valid]</text><polygon fill="#A80036" points="731.5,1887.7617,721.5,1891.7617,731.5,1895.7617,727.5,1891.7617" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="725.5" x2="1590.5" y1="1891.7617" y2="1891.7617"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="737.5" y="1887.0195">36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="759.5" y="1887.0195">Get server cert</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="720.5" x2="762.5" y1="1921.0723" y2="1921.0723"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="762.5" x2="762.5" y1="1921.0723" y2="1934.0723"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="721.5" x2="762.5" y1="1934.0723" y2="1934.0723"/><polygon fill="#A80036" points="731.5,1930.0723,721.5,1934.0723,731.5,1938.0723,727.5,1934.0723" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="727.5" y="1916.3301">37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="282" x="749.5" y="1916.3301">Get persisted server cert PEM and private key</text><polygon fill="#A80036" points="1579.5,1959.3828,1589.5,1963.3828,1579.5,1967.3828,1583.5,1963.3828" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="715.5" x2="1585.5" y1="1963.3828" y2="1963.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="722.5" y="1958.6406">38</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="744.5" y="1958.6406">Server cert and private key</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="33" x2="1641.5" y1="1972.3828" y2="1972.3828"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="238" x="38" y="1983.0176">[if server cert does not exist or is expired]</text><polygon fill="#A80036" points="731.5,2003.6484,721.5,2007.6484,731.5,2011.6484,727.5,2007.6484" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="725.5" x2="1590.5" y1="2007.6484" y2="2007.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="737.5" y="2002.9063">39</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="759.5" y="2002.9063">Get server cert</text><path d="M649,2022.6484 L711,2022.6484 L711,2029.6484 L701,2039.6484 L649,2039.6484 L649,2022.6484 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="243.8184" style="stroke: #000000; stroke-width: 2.0;" width="370.5" x="649" y="2022.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="664" y="2036.2168">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="163" x="726" y="2035.2832">[if server cert does not exist]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="720.5" x2="767.5" y1="2056.2695" y2="2056.2695"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="767.5" x2="767.5" y1="2056.2695" y2="2069.2695"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="726.5" x2="767.5" y1="2069.2695" y2="2069.2695"/><polygon fill="#A80036" points="736.5,2065.2695,726.5,2069.2695,736.5,2073.2695,732.5,2069.2695" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="732.5" y="2051.5273">40</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="754.5" y="2051.5273">Get persisted server cert and private key</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="725.5" x2="767.5" y1="2108.5801" y2="2108.5801"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="767.5" x2="767.5" y1="2108.5801" y2="2121.5801"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="720.5" x2="767.5" y1="2121.5801" y2="2121.5801"/><polygon fill="#A80036" points="730.5,2117.5801,720.5,2121.5801,730.5,2125.5801,726.5,2121.5801" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="732.5" y="2103.8379">41</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="754.5" y="2103.8379">Err(NotFound)</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="649" x2="1019.5" y1="2125.5801" y2="2125.5801"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="294" x="654" y="2136.2148">[if server cert exists but is expired / close to expiry]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="720.5" x2="767.5" y1="2155.8457" y2="2155.8457"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="767.5" x2="767.5" y1="2155.8457" y2="2168.8457"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="726.5" x2="767.5" y1="2168.8457" y2="2168.8457"/><polygon fill="#A80036" points="736.5,2164.8457,726.5,2168.8457,736.5,2172.8457,732.5,2168.8457" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="732.5" y="2151.1035">42</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="754.5" y="2151.1035">Get persisted server cert and private key</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="725.5" x2="767.5" y1="2208.1563" y2="2208.1563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="767.5" x2="767.5" y1="2208.1563" y2="2221.1563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="720.5" x2="767.5" y1="2221.1563" y2="2221.1563"/><polygon fill="#A80036" points="730.5,2217.1563,720.5,2221.1563,730.5,2225.1563,726.5,2221.1563" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="732.5" y="2203.4141">43</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="754.5" y="2203.4141">Ok(cert)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="720.5" x2="762.5" y1="2245.4668" y2="2245.4668"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="762.5" x2="762.5" y1="2245.4668" y2="2258.4668"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="721.5" x2="762.5" y1="2258.4668" y2="2258.4668"/><polygon fill="#A80036" points="731.5,2254.4668,721.5,2258.4668,731.5,2262.4668,727.5,2258.4668" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="727.5" y="2240.7246">44</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="240" x="749.5" y="2240.7246">Server cert is expired / close to expiry</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="720.5" x2="762.5" y1="2310.0879" y2="2310.0879"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="762.5" x2="762.5" y1="2310.0879" y2="2323.0879"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="721.5" x2="762.5" y1="2323.0879" y2="2323.0879"/><polygon fill="#A80036" points="731.5,2319.0879,721.5,2323.0879,731.5,2327.0879,727.5,2323.0879" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="727.5" y="2297.6904">45</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="279" x="749.5" y="2290.0352">Create CSR for new module server cert using</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="749.5" y="2305.3457">key</text><path d="M43,2338.0879 L105,2338.0879 L105,2345.0879 L95,2355.0879 L43,2355.0879 L43,2338.0879 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="290.75" style="stroke: #000000; stroke-width: 2.0;" width="1017.5" x="43" y="2338.0879"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="58" y="2351.6563">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="235" x="120" y="2350.7227">[if module certs should be issued by EST]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="720.5" x2="762.5" y1="2376.709" y2="2376.709"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="762.5" x2="762.5" y1="2376.709" y2="2389.709"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="721.5" x2="762.5" y1="2389.709" y2="2389.709"/><polygon fill="#A80036" points="731.5,2385.709,721.5,2389.709,731.5,2393.709,727.5,2389.709" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="727.5" y="2371.9668">46</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="299" x="749.5" y="2371.9668">Create TLS client using current EST identity cert</text><polygon fill="#A80036" points="90.5,2445.6406,80.5,2449.6406,90.5,2453.6406,86.5,2449.6406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="84.5" x2="709.5" y1="2449.6406" y2="2449.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="96.5" y="2429.5879">47</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="290" x="118.5" y="2414.2773">Connect using TLS client and send request for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="282" x="118.5" y="2429.5879">new module server cert corresponding to the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="118.5" y="2444.8984">CSR</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="79.5" x2="121.5" y1="2478.9512" y2="2478.9512"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="121.5" x2="121.5" y1="2478.9512" y2="2491.9512"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="80.5" x2="121.5" y1="2491.9512" y2="2491.9512"/><polygon fill="#A80036" points="90.5,2487.9512,80.5,2491.9512,90.5,2495.9512,86.5,2491.9512" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="86.5" y="2474.209">48</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="108.5" y="2474.209">Verify client cert against EST identity CA</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="79.5" x2="121.5" y1="2521.2617" y2="2521.2617"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="121.5" x2="121.5" y1="2521.2617" y2="2534.2617"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="80.5" x2="121.5" y1="2534.2617" y2="2534.2617"/><polygon fill="#A80036" points="90.5,2530.2617,80.5,2534.2617,90.5,2538.2617,86.5,2534.2617" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="86.5" y="2516.5195">49</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="55" x="108.5" y="2516.5195">Sign CSR</text><polygon fill="#A80036" points="698.5,2559.5723,708.5,2563.5723,698.5,2567.5723,702.5,2563.5723" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="74.5" x2="704.5" y1="2563.5723" y2="2563.5723"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="81.5" y="2558.8301">50</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="103.5" y="2558.8301">Signed cert</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="43" x2="1060.5" y1="2572.5723" y2="2572.5723"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="237" x="48" y="2583.207">[if module certs should be minted locally]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="720.5" x2="762.5" y1="2607.8379" y2="2607.8379"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="762.5" x2="762.5" y1="2607.8379" y2="2620.8379"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="721.5" x2="762.5" y1="2620.8379" y2="2620.8379"/><polygon fill="#A80036" points="731.5,2616.8379,721.5,2620.8379,731.5,2624.8379,727.5,2620.8379" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="727.5" y="2603.0957">51</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="188" x="749.5" y="2603.0957">Sign CSR using device CA cert</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="720.5" x2="762.5" y1="2672.459" y2="2672.459"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="762.5" x2="762.5" y1="2672.459" y2="2685.459"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="721.5" x2="762.5" y1="2685.459" y2="2685.459"/><polygon fill="#A80036" points="731.5,2681.459,721.5,2685.459,731.5,2689.459,727.5,2685.459" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="727.5" y="2660.0615">52</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="289" x="749.5" y="2652.4063">Save signed cert and key pair so that it can be</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="298" x="749.5" y="2667.7168">retrieved for future module server cert requests</text><polygon fill="#A80036" points="1579.5,2710.7695,1589.5,2714.7695,1579.5,2718.7695,1583.5,2714.7695" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="715.5" x2="1585.5" y1="2714.7695" y2="2714.7695"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="722.5" y="2710.0273">53</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="744.5" y="2710.0273">Server cert and private key</text><path d="M327.5,2743.7695 L501.5,2743.7695 L501.5,2750.7695 L491.5,2760.7695 L327.5,2760.7695 L327.5,2743.7695 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="423.6582" style="stroke: #000000; stroke-width: 2.0;" width="1536" x="327.5" y="2743.7695"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="129" x="342.5" y="2757.3379">Connect to IoT Hub</text><polygon fill="#A80036" points="731.5,2778.3906,721.5,2782.3906,731.5,2786.3906,727.5,2782.3906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="725.5" x2="1590.5" y1="2782.3906" y2="2782.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="737.5" y="2777.6484">54</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="759.5" y="2777.6484">Get IoTHub identity</text><polygon fill="#A80036" points="1579.5,2823.0117,1589.5,2827.0117,1579.5,2831.0117,1583.5,2827.0117" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="715.5" x2="1585.5" y1="2827.0117" y2="2827.0117"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="722.5" y="2814.6143">55</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="744.5" y="2806.959">Identity info (IoTHub + device identity +</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="744.5" y="2822.2695">generation ID + credentials type)</text><polygon fill="#A80036" points="731.5,2852.3223,721.5,2856.3223,731.5,2860.3223,727.5,2856.3223" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="725.5" x2="1590.5" y1="2856.3223" y2="2856.3223"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="737.5" y="2851.5801">56</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="267" x="759.5" y="2851.5801">Get SAS token for identifying with IoT Hub</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="720.5" x2="762.5" y1="2900.9434" y2="2900.9434"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="762.5" x2="762.5" y1="2900.9434" y2="2913.9434"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="721.5" x2="762.5" y1="2913.9434" y2="2913.9434"/><polygon fill="#A80036" points="731.5,2909.9434,721.5,2913.9434,731.5,2917.9434,727.5,2913.9434" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="727.5" y="2888.5459">57</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="270" x="749.5" y="2880.8906">Derive Edge Hub SAS keys from its name +</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="292" x="749.5" y="2896.2012">generation ID using the master encryption key</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="720.5" x2="762.5" y1="2943.2539" y2="2943.2539"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="762.5" x2="762.5" y1="2943.2539" y2="2956.2539"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="721.5" x2="762.5" y1="2956.2539" y2="2956.2539"/><polygon fill="#A80036" points="731.5,2952.2539,721.5,2956.2539,731.5,2960.2539,727.5,2956.2539" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="727.5" y="2938.5117">58</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="749.5" y="2938.5117">Create SAS token from SAS key</text><polygon fill="#A80036" points="1579.5,2981.5645,1589.5,2985.5645,1579.5,2989.5645,1583.5,2985.5645" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="715.5" x2="1585.5" y1="2985.5645" y2="2985.5645"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="722.5" y="2980.8223">59</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="744.5" y="2980.8223">SAS token</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1591.5" x2="1633.5" y1="3014.875" y2="3014.875"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1633.5" x2="1633.5" y1="3014.875" y2="3027.875"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1592.5" x2="1633.5" y1="3027.875" y2="3027.875"/><polygon fill="#A80036" points="1602.5,3023.875,1592.5,3027.875,1602.5,3031.875,1598.5,3027.875" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1598.5" y="3010.1328">60</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="1620.5" y="3010.1328">Create IoT Hub client with SAS token</text><polygon fill="#A80036" points="389.5,3053.1855,379.5,3057.1855,389.5,3061.1855,385.5,3057.1855" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="383.5" x2="1590.5" y1="3057.1855" y2="3057.1855"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="395.5" y="3052.4434">61</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="417.5" y="3052.4434">Connect to IoT Hub</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="378.5" x2="420.5" y1="3117.1172" y2="3117.1172"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420.5" x2="420.5" y1="3117.1172" y2="3130.1172"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="379.5" x2="420.5" y1="3130.1172" y2="3130.1172"/><polygon fill="#A80036" points="389.5,3126.1172,379.5,3130.1172,389.5,3134.1172,385.5,3130.1172" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="385.5" y="3097.0645">62</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="407.5" y="3081.7539">Validate SAS token against SAS key that was</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="407.5" y="3097.0645">registered when the Edge Hub identity was</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="407.5" y="3112.375">created by the runtime</text><polygon fill="#A80036" points="1579.5,3155.4277,1589.5,3159.4277,1579.5,3163.4277,1583.5,3159.4277" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="373.5" x2="1585.5" y1="3159.4277" y2="3159.4277"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="380.5" y="3154.6855">63</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="18" x="402.5" y="3154.6855">OK</text><!--MD5=[d969f07463e9f5afaf964bb921600678]
@startuml

title Runtime Operation
skinparam maxMessageSize 300

participant "EST" as est
participant "IoT Hub" as hub

box Device #LightBlue
	participant "Edge Runtime" as runtime
	participant "Host Process" as hlm
	participant EdgeAgent as ea
	participant EdgeHub as eh
	participant "Custom\nModule" as cm
end box

autonumber

group Host-level modules
	runtime -> runtime: Read host-level module names from configuration 
	loop for creating each host-level module M
		runtime -> runtime: Derive Edge Hub SAS keys from its name + generation ID using the master encryption key
		runtime -> hub ++: Create identity for module M and register the derived SAS keys for it
		return
	end
end

group Host process operation
	hlm -> runtime ++: Get identity for Host process
	return
	hlm -> runtime ++: Get SAS token for identifying with IoT Hub
	return

	hlm -> hlm: Create IoT Hub client using Sas token
	hlm -> hub ++: Connect to Iot Hub
	hub -> hub: Validate SAS token against SAS key that was registered when the Edge Agent identity was created by the runtime
	return OK
end

group Edge Agent operation
	runtime -> runtime: Derive SAS keys for Edge Agent from its name + generation ID using the master encryption key
	runtime -> hub ++: Create identity for Edge Agent and register the derived SAS keys for it
	return

	runtime -> ea **: Create and start

	ea -> runtime ++: Get SAS token for identifying with IoT Hub
	runtime -> runtime: Derive Edge Agent SAS keys from its name + generation ID using the master encryption key
	runtime -> runtime: Create SAS token from SAS key
	return SAS token
	ea -> ea: Create IoT Hub client with SAS token
	ea -> hub ++: Connect to IoT Hub
	hub -> hub: Validate SAS token against SAS key that was registered when the Edge Agent identity was created by the runtime
	return OK
	ea -> hub ++: Get deployment
	return

	loop for each module M
		ea -> runtime ++: Create identity for module M
		runtime -> runtime: Derive module M SAS keys from its name + generation ID using the master encryption key
		runtime -> hub ++: Create identity for module M and register the derived SAS keys for it
		return
		return

		ea -> runtime ++: Start module
		return
	end

	runtime -> eh **: Start Edge Hub
	runtime -> cm **: Start Custom module
end

group Edge Hub operation
	loop for server cert request and renewal
		note over runtime
			Note that a single server cert is shared between all modules, and its lifetime is managed by the runtime.
			This is because the user may have module server certs rooted to public CAs, so it would cost the customer $$$ for each cert.
			Thus we do not want to request a new server cert when a previously requested cert is still valid, which also means
			we want to dedupe the server certs across all modules that want them. Since server certs are issued for the device hostname
			anyway, reusing the server cert for multiple modules is not a concern.
		end note

		alt if server cert already exists and is valid
			eh -> runtime ++: Get server cert
			runtime -> runtime: Get persisted server cert PEM and private key
			return Server cert and private key

		else if server cert does not exist or is expired
			eh -> runtime ++: Get server cert
			alt if server cert does not exist
				runtime -> runtime ++: Get persisted server cert and private key
				return Err(NotFound)
			else if server cert exists but is expired / close to expiry
				runtime -> runtime ++: Get persisted server cert and private key
				return Ok(cert)
				runtime -> runtime: Server cert is expired / close to expiry
			end

			runtime -> runtime: Create CSR for new module server cert using key

			alt if module certs should be issued by EST
				runtime -> runtime: Create TLS client using current EST identity cert
				runtime -> est ++: Connect using TLS client and send request for new module server cert corresponding to the CSR
				est -> est: Verify client cert against EST identity CA
				est -> est: Sign CSR
				return Signed cert

			else if module certs should be minted locally
				runtime -> runtime: Sign CSR using device CA cert
			end

			runtime -> runtime: Save signed cert and key pair so that it can be retrieved for future module server cert requests
			return Server cert and private key

		end
	end

	group Connect to IoT Hub
		eh -> runtime ++: Get IoTHub identity
		return Identity info (IoTHub + device identity + generation ID + credentials type)

		eh -> runtime ++: Get SAS token for identifying with IoT Hub
		runtime -> runtime: Derive Edge Hub SAS keys from its name + generation ID using the master encryption key
		runtime -> runtime: Create SAS token from SAS key
		return SAS token
		eh -> eh: Create IoT Hub client with SAS token
		eh -> hub ++: Connect to IoT Hub
		hub -> hub: Validate SAS token against SAS key that was registered when the Edge Hub identity was created by the runtime
		return OK
	end
end

@enduml

PlantUML version 1.2020.10(Sun May 17 02:35:57 PDT 2020)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 13.0.1+9
Operating System: Mac OS X
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>