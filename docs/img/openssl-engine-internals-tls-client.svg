<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1631px" preserveAspectRatio="none" style="width:1314px;height:1631px;" version="1.1" viewBox="0 0 1314 1631" width="1314px" zoomAndPan="magnify"><defs><filter height="300%" id="f1d3hlgjc2njqn" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="575" x="367.5" y="28.6992">Create a TLS client with a private key from KS and a certificate from CS</text><rect fill="#DDDDDD" height="1584" style="stroke: #A80036; stroke-width: 1.0;" width="474" x="663" y="41.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="891.5" y="53.1543">KS</text><rect fill="#FFFFFF" filter="url(#f1d3hlgjc2njqn)" height="651.1563" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="286.5" y="910.5313"/><rect fill="#FFFFFF" filter="url(#f1d3hlgjc2njqn)" height="577.6875" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="291.5" y="947.7656"/><rect fill="#FFFFFF" filter="url(#f1d3hlgjc2njqn)" height="101.9375" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="488.5" y="483.7813"/><rect fill="#FFFFFF" filter="url(#f1d3hlgjc2njqn)" height="477.75" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="488.5" y="1012.4688"/><rect fill="#FFFFFF" filter="url(#f1d3hlgjc2njqn)" height="288.1094" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="679.5" y="151.2031"/><rect fill="#FFFFFF" filter="url(#f1d3hlgjc2njqn)" height="361.8125" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="679.5" y="1099.1719"/><rect fill="#FFFFFF" filter="url(#f1d3hlgjc2njqn)" height="145.1719" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="871.5" y="222.6719"/><rect fill="#FFFFFF" filter="url(#f1d3hlgjc2njqn)" height="203.6406" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="871.5" y="1228.1094"/><rect fill="#FFFFFF" filter="url(#f1d3hlgjc2njqn)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1067.5" y="309.375"/><rect fill="#FFFFFF" filter="url(#f1d3hlgjc2njqn)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1067.5" y="1299.5781"/><rect fill="#FFFFFF" filter="url(#f1d3hlgjc2njqn)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1067.5" y="1373.2813"/><rect fill="#FFFFFF" filter="url(#f1d3hlgjc2njqn)" height="71.4688" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1156" y="646.1875"/><rect fill="#FFFFFF" filter="url(#f1d3hlgjc2njqn)" height="480.9844" style="stroke: #000000; stroke-width: 2.0;" width="1133" x="10" y="112.7344"/><rect fill="#FFFFFF" filter="url(#f1d3hlgjc2njqn)" height="175.4063" style="stroke: #000000; stroke-width: 2.0;" width="1290" x="10" y="607.7188"/><rect fill="#FFFFFF" filter="url(#f1d3hlgjc2njqn)" height="772.5625" style="stroke: #000000; stroke-width: 2.0;" width="1133" x="10" y="797.125"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="47" x2="47" y1="95.7344" y2="1586.6875"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="291.5" x2="291.5" y1="854.2109" y2="1586.6875"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="493" x2="493" y1="95.7344" y2="1586.6875"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="684" x2="684" y1="95.7344" y2="1586.6875"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="876.5" x2="876.5" y1="95.7344" y2="1586.6875"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1072" x2="1072" y1="95.7344" y2="1586.6875"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1161" x2="1161" y1="95.7344" y2="1586.6875"/><rect fill="#FEFECE" filter="url(#f1d3hlgjc2njqn)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="51" x="20" y="60.3281"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="27" y="80.3164">Client</text><rect fill="#FEFECE" filter="url(#f1d3hlgjc2njqn)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="51" x="20" y="1585.6875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="27" y="1605.6758">Client</text><rect fill="#FEFECE" filter="url(#f1d3hlgjc2njqn)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="104" x="237.5" y="1585.6875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="244.5" y="1605.6758">openssl client</text><rect fill="#FEFECE" filter="url(#f1d3hlgjc2njqn)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="185" x="399" y="60.3281"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="171" x="406" y="80.3164">aziot_keys openssl engine</text><rect fill="#FEFECE" filter="url(#f1d3hlgjc2njqn)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="185" x="399" y="1585.6875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="171" x="406" y="1605.6758">aziot_keys openssl engine</text><rect fill="#FEFECE" filter="url(#f1d3hlgjc2njqn)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="31" x="667" y="60.3281"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="17" x="674" y="80.3164">KS</text><rect fill="#FEFECE" filter="url(#f1d3hlgjc2njqn)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="31" x="667" y="1585.6875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="17" x="674" y="1605.6758">KS</text><rect fill="#FEFECE" filter="url(#f1d3hlgjc2njqn)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="96" x="826.5" y="60.3281"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="833.5" y="80.3164">libaziot-keys</text><rect fill="#FEFECE" filter="url(#f1d3hlgjc2njqn)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="96" x="826.5" y="1585.6875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="833.5" y="1605.6758">libaziot-keys</text><rect fill="#FEFECE" filter="url(#f1d3hlgjc2njqn)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="117" x="1012" y="60.3281"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="103" x="1019" y="80.3164">PKCS#11 library</text><rect fill="#FEFECE" filter="url(#f1d3hlgjc2njqn)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="117" x="1012" y="1585.6875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="103" x="1019" y="1605.6758">PKCS#11 library</text><rect fill="#FEFECE" filter="url(#f1d3hlgjc2njqn)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="32" x="1143" y="60.3281"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="18" x="1150" y="80.3164">CS</text><rect fill="#FEFECE" filter="url(#f1d3hlgjc2njqn)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="32" x="1143" y="1585.6875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="18" x="1150" y="1605.6758">CS</text><rect fill="#FFFFFF" filter="url(#f1d3hlgjc2njqn)" height="651.1563" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="286.5" y="910.5313"/><rect fill="#FFFFFF" filter="url(#f1d3hlgjc2njqn)" height="577.6875" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="291.5" y="947.7656"/><rect fill="#FFFFFF" filter="url(#f1d3hlgjc2njqn)" height="101.9375" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="488.5" y="483.7813"/><rect fill="#FFFFFF" filter="url(#f1d3hlgjc2njqn)" height="477.75" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="488.5" y="1012.4688"/><rect fill="#FFFFFF" filter="url(#f1d3hlgjc2njqn)" height="288.1094" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="679.5" y="151.2031"/><rect fill="#FFFFFF" filter="url(#f1d3hlgjc2njqn)" height="361.8125" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="679.5" y="1099.1719"/><rect fill="#FFFFFF" filter="url(#f1d3hlgjc2njqn)" height="145.1719" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="871.5" y="222.6719"/><rect fill="#FFFFFF" filter="url(#f1d3hlgjc2njqn)" height="203.6406" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="871.5" y="1228.1094"/><rect fill="#FFFFFF" filter="url(#f1d3hlgjc2njqn)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1067.5" y="309.375"/><rect fill="#FFFFFF" filter="url(#f1d3hlgjc2njqn)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1067.5" y="1299.5781"/><rect fill="#FFFFFF" filter="url(#f1d3hlgjc2njqn)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1067.5" y="1373.2813"/><rect fill="#FFFFFF" filter="url(#f1d3hlgjc2njqn)" height="71.4688" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1156" y="646.1875"/><path d="M10,112.7344 L311,112.7344 L311,119.7344 L301,129.7344 L10,129.7344 L10,112.7344 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="480.9844" style="stroke: #000000; stroke-width: 2.0;" width="1133" x="10" y="112.7344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="256" x="25" y="125.7949">Get key corresponding to key ID from KS</text><polygon fill="#A80036" points="667.5,147.2031,677.5,151.2031,667.5,155.2031,671.5,151.2031" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="47.5" x2="673.5" y1="151.2031" y2="151.2031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="54.5" y="146.0293">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="65.5" y="146.0293">get_key_handle("key_id")</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="689.5" x2="731.5" y1="180.4375" y2="180.4375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="731.5" x2="731.5" y1="180.4375" y2="193.4375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="690.5" x2="731.5" y1="193.4375" y2="193.4375"/><polygon fill="#A80036" points="700.5,189.4375,690.5,193.4375,700.5,197.4375,696.5,193.4375" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="696.5" y="175.2637">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="707.5" y="175.2637">Evaluate policies</text><polygon fill="#A80036" points="859.5,218.6719,869.5,222.6719,859.5,226.6719,863.5,222.6719" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="689.5" x2="865.5" y1="222.6719" y2="222.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="696.5" y="217.498">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="707.5" y="217.498">load_key_pair("key_id")</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="881.5" x2="923.5" y1="251.9063" y2="251.9063"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="923.5" x2="923.5" y1="251.9063" y2="264.9063"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="882.5" x2="923.5" y1="264.9063" y2="264.9063"/><polygon fill="#A80036" points="892.5,260.9063,882.5,264.9063,892.5,268.9063,888.5,264.9063" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="888.5" y="246.7324">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="899.5" y="246.7324">Convert key ID to key URI</text><polygon fill="#A80036" points="1055.5,305.375,1065.5,309.375,1055.5,313.375,1059.5,309.375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="881.5" x2="1061.5" y1="309.375" y2="309.375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="888.5" y="296.584">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="899.5" y="288.9668">C_FindObjects("key_label</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="899.5" y="304.2012">")</text><polygon fill="#A80036" points="892.5,334.6094,882.5,338.6094,892.5,342.6094,888.5,338.6094" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="886.5" x2="1071.5" y1="338.6094" y2="338.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="898.5" y="333.4355">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="909.5" y="333.4355">OBJECT_HANDLE</text><polygon fill="#A80036" points="700.5,363.8438,690.5,367.8438,700.5,371.8438,696.5,367.8438" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="694.5" x2="875.5" y1="367.8438" y2="367.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="706.5" y="362.6699">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="17" x="717.5" y="362.6699">OK</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="689.5" x2="731.5" y1="397.0781" y2="397.0781"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="731.5" x2="731.5" y1="397.0781" y2="410.0781"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="690.5" x2="731.5" y1="410.0781" y2="410.0781"/><polygon fill="#A80036" points="700.5,406.0781,690.5,410.0781,700.5,414.0781,696.5,410.0781" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="696.5" y="391.9043">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="707.5" y="391.9043">Synthesize key handle</text><polygon fill="#A80036" points="58.5,435.3125,48.5,439.3125,58.5,443.3125,54.5,439.3125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="52.5" x2="683.5" y1="439.3125" y2="439.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="64.5" y="434.1387">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="75.5" y="434.1387">OK("key handle")</text><polygon fill="#A80036" points="476.5,479.7813,486.5,483.7813,476.5,487.7813,480.5,483.7813" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="47.5" x2="482.5" y1="483.7813" y2="483.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="54.5" y="470.9902">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="72.5" y="463.373">load_private_key("key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="72.5" y="478.6074">handle")</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="498.5" x2="540.5" y1="543.4844" y2="543.4844"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="540.5" x2="540.5" y1="543.4844" y2="556.4844"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="499.5" x2="540.5" y1="556.4844" y2="556.4844"/><polygon fill="#A80036" points="509.5,552.4844,499.5,556.4844,509.5,560.4844,505.5,556.4844" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="505.5" y="523.0762">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="523.5" y="507.8418">Create new EVP_PKEY and</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="523.5" y="523.0762">attach key handle to its ex</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="29" x="523.5" y="538.3105">data.</text><polygon fill="#A80036" points="58.5,581.7188,48.5,585.7188,58.5,589.7188,54.5,585.7188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="52.5" x2="492.5" y1="585.7188" y2="585.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="64.5" y="580.5449">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="82.5" y="580.5449">openssl::EVP_PKEY</text><path d="M10,607.7188 L324,607.7188 L324,614.7188 L314,624.7188 L10,624.7188 L10,607.7188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="175.4063" style="stroke: #000000; stroke-width: 2.0;" width="1290" x="10" y="607.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="269" x="25" y="620.7793">Get cert corresponding to cert ID from CS</text><polygon fill="#A80036" points="1144,642.1875,1154,646.1875,1144,650.1875,1148,646.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="47.5" x2="1150" y1="646.1875" y2="646.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="54.5" y="641.0137">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="72.5" y="641.0137">load_cert("cert_id")</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1166" x2="1208" y1="675.4219" y2="675.4219"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1208" x2="1208" y1="675.4219" y2="688.4219"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1167" x2="1208" y1="688.4219" y2="688.4219"/><polygon fill="#A80036" points="1177,684.4219,1167,688.4219,1177,692.4219,1173,688.4219" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1173" y="670.248">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="1191" y="670.248">Evaluate policies</text><polygon fill="#A80036" points="58.5,713.6563,48.5,717.6563,58.5,721.6563,54.5,717.6563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="52.5" x2="1160" y1="717.6563" y2="717.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="64.5" y="712.4824">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="51" x="82.5" y="712.4824">OK(PEM)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="47.5" x2="89.5" y1="762.125" y2="762.125"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="89.5" x2="89.5" y1="762.125" y2="775.125"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="48.5" x2="89.5" y1="775.125" y2="775.125"/><polygon fill="#A80036" points="58.5,771.125,48.5,775.125,58.5,779.125,54.5,775.125" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="54.5" y="749.334">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="72.5" y="741.7168">Create openssl::X509</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="72.5" y="756.9512">from PEM</text><path d="M10,797.125 L204,797.125 L204,804.125 L194,814.125 L10,814.125 L10,797.125 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="772.5625" style="stroke: #000000; stroke-width: 2.0;" width="1133" x="10" y="797.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="149" x="25" y="810.1855">Create TLS connection</text><polygon fill="#A80036" points="225.5,862.0625,235.5,866.0625,225.5,870.0625,229.5,866.0625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="47.5" x2="231.5" y1="866.0625" y2="866.0625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="54.5" y="845.6543">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="72.5" y="830.4199">Create openssl client</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="72.5" y="845.6543">using openssl::EVP_PKEY</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="72.5" y="860.8887">+ openssl::X509</text><rect fill="#FEFECE" filter="url(#f1d3hlgjc2njqn)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="104" x="237.5" y="828.6563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="244.5" y="848.6445">openssl client</text><polygon fill="#A80036" points="274.5,906.5313,284.5,910.5313,274.5,914.5313,278.5,910.5313" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="47.5" x2="280.5" y1="910.5313" y2="910.5313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="54.5" y="897.7402">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="72.5" y="890.123">connect to contoso.azure</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="94" x="72.5" y="905.3574">-devices.net:443</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="296.5" x2="343.5" y1="934.7656" y2="934.7656"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="343.5" x2="343.5" y1="934.7656" y2="947.7656"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="302.5" x2="343.5" y1="947.7656" y2="947.7656"/><polygon fill="#A80036" points="312.5,943.7656,302.5,947.7656,312.5,951.7656,308.5,947.7656" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="308.5" y="929.5918">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="326.5" y="929.5918">Handshake</text><polygon fill="#A80036" points="476.5,1008.4688,486.5,1012.4688,476.5,1016.4688,480.5,1012.4688" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="301.5" x2="482.5" y1="1012.4688" y2="1012.4688"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="308.5" y="992.0605">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="326.5" y="976.8262">custom_EVP_PKEY_sign(</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="326.5" y="992.0605">openssl::ENGINE, openssl</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="326.5" y="1007.2949">::EVP_PKEY, ...)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="498.5" x2="540.5" y1="1056.9375" y2="1056.9375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="540.5" x2="540.5" y1="1056.9375" y2="1069.9375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="499.5" x2="540.5" y1="1069.9375" y2="1069.9375"/><polygon fill="#A80036" points="509.5,1065.9375,499.5,1069.9375,509.5,1073.9375,505.5,1069.9375" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="505.5" y="1044.1465">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="523.5" y="1036.5293">Extract key handle from</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="523.5" y="1051.7637">EVP_PKEY's ex data</text><polygon fill="#A80036" points="667.5,1095.1719,677.5,1099.1719,667.5,1103.1719,671.5,1099.1719" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="498.5" x2="673.5" y1="1099.1719" y2="1099.1719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="505.5" y="1093.998">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="523.5" y="1093.998">sign("key handle", ...)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="689.5" x2="731.5" y1="1128.4063" y2="1128.4063"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="731.5" x2="731.5" y1="1128.4063" y2="1141.4063"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="690.5" x2="731.5" y1="1141.4063" y2="1141.4063"/><polygon fill="#A80036" points="700.5,1137.4063,690.5,1141.4063,700.5,1145.4063,696.5,1141.4063" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="696.5" y="1123.2324">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="714.5" y="1123.2324">Evaluate policies</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="689.5" x2="731.5" y1="1185.875" y2="1185.875"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="731.5" x2="731.5" y1="1185.875" y2="1198.875"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="690.5" x2="731.5" y1="1198.875" y2="1198.875"/><polygon fill="#A80036" points="700.5,1194.875,690.5,1198.875,700.5,1202.875,696.5,1198.875" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="696.5" y="1173.084">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="714.5" y="1165.4668">Convert key handle to key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="714.5" y="1180.7012">ID</text><polygon fill="#A80036" points="859.5,1224.1094,869.5,1228.1094,859.5,1232.1094,863.5,1228.1094" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="689.5" x2="865.5" y1="1228.1094" y2="1228.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="696.5" y="1222.9355">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="94" x="714.5" y="1222.9355">sign("key ID", ...)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="881.5" x2="923.5" y1="1257.3438" y2="1257.3438"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="923.5" x2="923.5" y1="1257.3438" y2="1270.3438"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="882.5" x2="923.5" y1="1270.3438" y2="1270.3438"/><polygon fill="#A80036" points="892.5,1266.3438,882.5,1270.3438,892.5,1274.3438,888.5,1270.3438" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="888.5" y="1252.1699">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="906.5" y="1252.1699">Convert key ID to key URI</text><polygon fill="#A80036" points="1055.5,1295.5781,1065.5,1299.5781,1055.5,1303.5781,1059.5,1299.5781" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="881.5" x2="1061.5" y1="1299.5781" y2="1299.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="888.5" y="1294.4043">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="906.5" y="1294.4043">C_FindObjects("key_uri")</text><polygon fill="#A80036" points="892.5,1324.8125,882.5,1328.8125,892.5,1332.8125,888.5,1328.8125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="886.5" x2="1071.5" y1="1328.8125" y2="1328.8125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="898.5" y="1323.6387">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="916.5" y="1323.6387">OBJECT_HANDLE</text><polygon fill="#A80036" points="1055.5,1369.2813,1065.5,1373.2813,1055.5,1377.2813,1059.5,1373.2813" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="881.5" x2="1061.5" y1="1373.2813" y2="1373.2813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="888.5" y="1360.4902">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="906.5" y="1352.873">C_Sign(pkcs11::OBJECT_</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="69" x="906.5" y="1368.1074">HANDLE, ...)</text><polygon fill="#A80036" points="892.5,1398.5156,882.5,1402.5156,892.5,1406.5156,888.5,1402.5156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="886.5" x2="1071.5" y1="1402.5156" y2="1402.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="898.5" y="1397.3418">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="916.5" y="1397.3418">OK(signature)</text><polygon fill="#A80036" points="700.5,1427.75,690.5,1431.75,700.5,1435.75,696.5,1431.75" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="694.5" x2="875.5" y1="1431.75" y2="1431.75"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="706.5" y="1426.5762">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="724.5" y="1426.5762">OK(signature)</text><polygon fill="#A80036" points="509.5,1456.9844,499.5,1460.9844,509.5,1464.9844,505.5,1460.9844" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="503.5" x2="683.5" y1="1460.9844" y2="1460.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="515.5" y="1455.8105">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="533.5" y="1455.8105">OK(signature)</text><polygon fill="#A80036" points="312.5,1486.2188,302.5,1490.2188,312.5,1494.2188,308.5,1490.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="306.5" x2="492.5" y1="1490.2188" y2="1490.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="318.5" y="1485.0449">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="336.5" y="1485.0449">OK(signature)</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="301.5" x2="343.5" y1="1524.4531" y2="1524.4531"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="343.5" x2="343.5" y1="1524.4531" y2="1537.4531"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="296.5" x2="343.5" y1="1537.4531" y2="1537.4531"/><polygon fill="#A80036" points="306.5,1533.4531,296.5,1537.4531,306.5,1541.4531,302.5,1537.4531" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="308.5" y="1519.2793">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="326.5" y="1519.2793">Handshake complete</text><polygon fill="#A80036" points="58.5,1557.6875,48.5,1561.6875,58.5,1565.6875,54.5,1561.6875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="52.5" x2="290.5" y1="1561.6875" y2="1561.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="64.5" y="1556.5137">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="82.5" y="1556.5137">Connected</text><!--MD5=[47105718d3305945658207393f73a865]
@startuml

title Create a TLS client with a private key from KS and a certificate from CS
skinparam maxMessageSize 150

participant Client
participant "openssl client" as openssl
participant "aziot_keys openssl engine" as ksengine

box KS
participant KS
participant "libaziot-keys"
participant "PKCS#11 library" as pkcs11
end box

participant CS

autonumber

group Get key corresponding to key ID from KS
	Client -> KS ++: get_key_handle("key_id")
	KS -> KS: Evaluate policies
	KS -> "libaziot-keys" ++: load_key_pair("key_id")
	"libaziot-keys" -> "libaziot-keys": Convert key ID to key URI
	"libaziot-keys" -> pkcs11 ++: C_FindObjects("key_label")
	return OBJECT_HANDLE
	return OK
	KS -> KS: Synthesize key handle
	return OK("key handle")

	Client -> ksengine ++: load_private_key("key handle")
	ksengine -> ksengine: Create new EVP_PKEY and attach key handle to its ex data.
	return openssl::EVP_PKEY
end

group Get cert corresponding to cert ID from CS
	Client -> CS ++: load_cert("cert_id")
	CS -> CS: Evaluate policies
	return OK(PEM)

	Client -> Client: Create openssl::X509 from PEM
end

group Create TLS connection
	Client -> openssl **: Create openssl client using openssl::EVP_PKEY + openssl::X509
	Client -> openssl ++: connect to contoso.azure-devices.net:443

	openssl -> openssl ++: Handshake
	openssl -> ksengine ++: custom_EVP_PKEY_sign(openssl::ENGINE, openssl::EVP_PKEY, ...)
	ksengine -> ksengine: Extract key handle from EVP_PKEY's ex data
	ksengine -> KS ++: sign("key handle", ...)
	KS -> KS: Evaluate policies
	KS -> KS: Convert key handle to key ID
	KS -> "libaziot-keys" ++: sign("key ID", ...)
	"libaziot-keys" -> "libaziot-keys": Convert key ID to key URI
	"libaziot-keys" -> pkcs11 ++: C_FindObjects("key_uri")
	return OBJECT_HANDLE
	"libaziot-keys" -> pkcs11 ++: C_Sign(pkcs11::OBJECT_HANDLE, ...)
	return OK(signature)
	return OK(signature)
	return OK(signature)
	return OK(signature)
	return Handshake complete
	return Connected
end

@enduml

PlantUML version 1.2020.19(Mon Oct 12 08:10:01 PDT 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>