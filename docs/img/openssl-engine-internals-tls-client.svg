<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1946px" preserveAspectRatio="none" style="width:1621px;height:1946px;" version="1.1" viewBox="0 0 1621 1946" width="1621px" zoomAndPan="magnify"><defs><filter height="300%" id="fxqw90t0kcgz" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="575" x="520" y="26.6992">Create a TLS client with a private key from KS and a certificate from CS</text><rect fill="#DDDDDD" height="1896.0469" style="stroke: #A80036; stroke-width: 1.0;" width="667" x="638" y="39.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="963" y="51.1543">KS</text><rect fill="#DDDDDD" height="1896.0469" style="stroke: #A80036; stroke-width: 1.0;" width="289" x="1307" y="39.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1442.5" y="51.1543">CS</text><rect fill="#FFFFFF" filter="url(#fxqw90t0kcgz)" height="683.625" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="289.5" y="1188.1094"/><rect fill="#FFFFFF" filter="url(#fxqw90t0kcgz)" height="617.1563" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="294.5" y="1225.3438"/><rect fill="#FFFFFF" filter="url(#fxqw90t0kcgz)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="486.5" y="687.6563"/><rect fill="#FFFFFF" filter="url(#fxqw90t0kcgz)" height="567.6875" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="486.5" y="1274.8125"/><rect fill="#FFFFFF" filter="url(#fxqw90t0kcgz)" height="493.9844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="654.5" y="149.2031"/><rect fill="#FFFFFF" filter="url(#fxqw90t0kcgz)" height="509.2188" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="654.5" y="1304.0469"/><rect fill="#FFFFFF" filter="url(#fxqw90t0kcgz)" height="335.8125" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="846.5" y="220.6719"/><rect fill="#FFFFFF" filter="url(#fxqw90t0kcgz)" height="351.0469" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="846.5" y="1432.9844"/><rect fill="#FFFFFF" filter="url(#fxqw90t0kcgz)" height="87.7031" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1039.5" y="307.375"/><rect fill="#FFFFFF" filter="url(#fxqw90t0kcgz)" height="87.7031" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1039.5" y="439.5469"/><rect fill="#FFFFFF" filter="url(#fxqw90t0kcgz)" height="87.7031" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1039.5" y="1519.6875"/><rect fill="#FFFFFF" filter="url(#fxqw90t0kcgz)" height="102.9375" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1039.5" y="1651.8594"/><rect fill="#FFFFFF" filter="url(#fxqw90t0kcgz)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1235.5" y="336.6094"/><rect fill="#FFFFFF" filter="url(#fxqw90t0kcgz)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1235.5" y="468.7813"/><rect fill="#FFFFFF" filter="url(#fxqw90t0kcgz)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1235.5" y="1548.9219"/><rect fill="#FFFFFF" filter="url(#fxqw90t0kcgz)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1235.5" y="1696.3281"/><rect fill="#FFFFFF" filter="url(#fxqw90t0kcgz)" height="202.6406" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1324" y="792.5938"/><rect fill="#FFFFFF" filter="url(#fxqw90t0kcgz)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1520" y="879.2969"/><rect fill="#FFFFFF" filter="url(#fxqw90t0kcgz)" height="614.1563" style="stroke: #000000; stroke-width: 2.0;" width="1298" x="13" y="110.7344"/><rect fill="#FFFFFF" filter="url(#fxqw90t0kcgz)" height="321.8125" style="stroke: #000000; stroke-width: 2.0;" width="1589" x="13" y="738.8906"/><rect fill="#FFFFFF" filter="url(#fxqw90t0kcgz)" height="805.0313" style="stroke: #000000; stroke-width: 2.0;" width="1298" x="13" y="1074.7031"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="50" x2="50" y1="93.7344" y2="1896.7344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="294.5" x2="294.5" y1="1131.7891" y2="1896.7344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="491" x2="491" y1="93.7344" y2="1896.7344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="659" x2="659" y1="93.7344" y2="1896.7344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="851.5" x2="851.5" y1="93.7344" y2="1896.7344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1044" x2="1044" y1="93.7344" y2="1896.7344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1240" x2="1240" y1="93.7344" y2="1896.7344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1329" x2="1329" y1="93.7344" y2="1896.7344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1525" x2="1525" y1="93.7344" y2="1896.7344"/><rect fill="#FEFECE" filter="url(#fxqw90t0kcgz)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="51" x="23" y="58.3281"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="30" y="78.3164">Client</text><rect fill="#FEFECE" filter="url(#fxqw90t0kcgz)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="51" x="23" y="1895.7344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="30" y="1915.7227">Client</text><rect fill="#FEFECE" filter="url(#fxqw90t0kcgz)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="104" x="240.5" y="1895.7344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="247.5" y="1915.7227">openssl client</text><rect fill="#FEFECE" filter="url(#fxqw90t0kcgz)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="133" x="423" y="58.3281"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="119" x="430" y="78.3164">openssl-engine-ks</text><rect fill="#FEFECE" filter="url(#fxqw90t0kcgz)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="133" x="423" y="1895.7344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="119" x="430" y="1915.7227">openssl-engine-ks</text><rect fill="#FEFECE" filter="url(#fxqw90t0kcgz)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="31" x="642" y="58.3281"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="17" x="649" y="78.3164">KS</text><rect fill="#FEFECE" filter="url(#fxqw90t0kcgz)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="31" x="642" y="1895.7344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="17" x="649" y="1915.7227">KS</text><rect fill="#FEFECE" filter="url(#fxqw90t0kcgz)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="96" x="801.5" y="58.3281"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="808.5" y="78.3164">libaziot-keys</text><rect fill="#FEFECE" filter="url(#fxqw90t0kcgz)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="96" x="801.5" y="1895.7344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="808.5" y="1915.7227">libaziot-keys</text><rect fill="#FEFECE" filter="url(#fxqw90t0kcgz)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="165" x="960" y="58.3281"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="967" y="78.3164">openssl-engine-pkcs11</text><rect fill="#FEFECE" filter="url(#fxqw90t0kcgz)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="165" x="960" y="1895.7344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="967" y="1915.7227">openssl-engine-pkcs11</text><rect fill="#FEFECE" filter="url(#fxqw90t0kcgz)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="117" x="1180" y="58.3281"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="103" x="1187" y="78.3164">PKCS#11 library</text><rect fill="#FEFECE" filter="url(#fxqw90t0kcgz)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="117" x="1180" y="1895.7344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="103" x="1187" y="1915.7227">PKCS#11 library</text><rect fill="#FEFECE" filter="url(#fxqw90t0kcgz)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="32" x="1311" y="58.3281"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="18" x="1318" y="78.3164">CS</text><rect fill="#FEFECE" filter="url(#fxqw90t0kcgz)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="32" x="1311" y="1895.7344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="18" x="1318" y="1915.7227">CS</text><rect fill="#FEFECE" filter="url(#fxqw90t0kcgz)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="130" x="1458" y="58.3281"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="116" x="1465" y="78.3164">libiothsm-certgen</text><rect fill="#FEFECE" filter="url(#fxqw90t0kcgz)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="130" x="1458" y="1895.7344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="116" x="1465" y="1915.7227">libiothsm-certgen</text><rect fill="#FFFFFF" filter="url(#fxqw90t0kcgz)" height="683.625" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="289.5" y="1188.1094"/><rect fill="#FFFFFF" filter="url(#fxqw90t0kcgz)" height="617.1563" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="294.5" y="1225.3438"/><rect fill="#FFFFFF" filter="url(#fxqw90t0kcgz)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="486.5" y="687.6563"/><rect fill="#FFFFFF" filter="url(#fxqw90t0kcgz)" height="567.6875" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="486.5" y="1274.8125"/><rect fill="#FFFFFF" filter="url(#fxqw90t0kcgz)" height="493.9844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="654.5" y="149.2031"/><rect fill="#FFFFFF" filter="url(#fxqw90t0kcgz)" height="509.2188" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="654.5" y="1304.0469"/><rect fill="#FFFFFF" filter="url(#fxqw90t0kcgz)" height="335.8125" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="846.5" y="220.6719"/><rect fill="#FFFFFF" filter="url(#fxqw90t0kcgz)" height="351.0469" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="846.5" y="1432.9844"/><rect fill="#FFFFFF" filter="url(#fxqw90t0kcgz)" height="87.7031" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1039.5" y="307.375"/><rect fill="#FFFFFF" filter="url(#fxqw90t0kcgz)" height="87.7031" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1039.5" y="439.5469"/><rect fill="#FFFFFF" filter="url(#fxqw90t0kcgz)" height="87.7031" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1039.5" y="1519.6875"/><rect fill="#FFFFFF" filter="url(#fxqw90t0kcgz)" height="102.9375" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1039.5" y="1651.8594"/><rect fill="#FFFFFF" filter="url(#fxqw90t0kcgz)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1235.5" y="336.6094"/><rect fill="#FFFFFF" filter="url(#fxqw90t0kcgz)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1235.5" y="468.7813"/><rect fill="#FFFFFF" filter="url(#fxqw90t0kcgz)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1235.5" y="1548.9219"/><rect fill="#FFFFFF" filter="url(#fxqw90t0kcgz)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1235.5" y="1696.3281"/><rect fill="#FFFFFF" filter="url(#fxqw90t0kcgz)" height="202.6406" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1324" y="792.5938"/><rect fill="#FFFFFF" filter="url(#fxqw90t0kcgz)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1520" y="879.2969"/><path d="M13,110.7344 L314,110.7344 L314,117.7344 L304,127.7344 L13,127.7344 L13,110.7344 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="614.1563" style="stroke: #000000; stroke-width: 2.0;" width="1298" x="13" y="110.7344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="256" x="28" y="123.7949">Get key corresponding to key ID from KS</text><polygon fill="#A80036" points="642.5,145.2031,652.5,149.2031,642.5,153.2031,646.5,149.2031" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="50.5" x2="648.5" y1="149.2031" y2="149.2031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="57.5" y="144.0293">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="68.5" y="144.0293">load_key_pair("key_id")</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="664.5" x2="706.5" y1="178.4375" y2="178.4375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="706.5" x2="706.5" y1="178.4375" y2="191.4375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="665.5" x2="706.5" y1="191.4375" y2="191.4375"/><polygon fill="#A80036" points="675.5,187.4375,665.5,191.4375,675.5,195.4375,671.5,191.4375" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="671.5" y="173.2637">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="682.5" y="173.2637">Evaluate policies</text><polygon fill="#A80036" points="834.5,216.6719,844.5,220.6719,834.5,224.6719,838.5,220.6719" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="664.5" x2="840.5" y1="220.6719" y2="220.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="671.5" y="215.498">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="682.5" y="215.498">load_key_pair("key_id")</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="856.5" x2="898.5" y1="249.9063" y2="249.9063"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="898.5" x2="898.5" y1="249.9063" y2="262.9063"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="857.5" x2="898.5" y1="262.9063" y2="262.9063"/><polygon fill="#A80036" points="867.5,258.9063,857.5,262.9063,867.5,266.9063,863.5,262.9063" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="863.5" y="244.7324">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="874.5" y="244.7324">Convert key ID to key URI</text><polygon fill="#A80036" points="1027.5,303.375,1037.5,307.375,1027.5,311.375,1031.5,307.375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="856.5" x2="1033.5" y1="307.375" y2="307.375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="863.5" y="294.584">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="874.5" y="286.9668">load_public_key("key_uri"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="874.5" y="302.2012">)</text><polygon fill="#A80036" points="1223.5,332.6094,1233.5,336.6094,1223.5,340.6094,1227.5,336.6094" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1049.5" x2="1229.5" y1="336.6094" y2="336.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="1056.5" y="331.4355">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="1067.5" y="331.4355">C_FindObjects("key_uri")</text><polygon fill="#A80036" points="1060.5,361.8438,1050.5,365.8438,1060.5,369.8438,1056.5,365.8438" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1054.5" x2="1239.5" y1="365.8438" y2="365.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="1066.5" y="360.6699">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="1077.5" y="360.6699">OBJECT_HANDLE</text><polygon fill="#A80036" points="867.5,391.0781,857.5,395.0781,867.5,399.0781,863.5,395.0781" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="861.5" x2="1043.5" y1="395.0781" y2="395.0781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="873.5" y="389.9043">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="17" x="884.5" y="389.9043">OK</text><polygon fill="#A80036" points="1027.5,435.5469,1037.5,439.5469,1027.5,443.5469,1031.5,439.5469" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="856.5" x2="1033.5" y1="439.5469" y2="439.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="863.5" y="426.7559">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="874.5" y="419.1387">load_private_key("key_uri</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="874.5" y="434.373">")</text><polygon fill="#A80036" points="1223.5,464.7813,1233.5,468.7813,1223.5,472.7813,1227.5,468.7813" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1049.5" x2="1229.5" y1="468.7813" y2="468.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1056.5" y="463.6074">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="1074.5" y="463.6074">C_FindObjects("key_uri")</text><polygon fill="#A80036" points="1060.5,494.0156,1050.5,498.0156,1060.5,502.0156,1056.5,498.0156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1054.5" x2="1239.5" y1="498.0156" y2="498.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1066.5" y="492.8418">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="1084.5" y="492.8418">OBJECT_HANDLE</text><polygon fill="#A80036" points="867.5,523.25,857.5,527.25,867.5,531.25,863.5,527.25" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="861.5" x2="1043.5" y1="527.25" y2="527.25"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="873.5" y="522.0762">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="17" x="891.5" y="522.0762">OK</text><polygon fill="#A80036" points="675.5,552.4844,665.5,556.4844,675.5,560.4844,671.5,556.4844" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="669.5" x2="850.5" y1="556.4844" y2="556.4844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="681.5" y="551.3105">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="17" x="699.5" y="551.3105">OK</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="664.5" x2="706.5" y1="600.9531" y2="600.9531"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="706.5" x2="706.5" y1="600.9531" y2="613.9531"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="665.5" x2="706.5" y1="613.9531" y2="613.9531"/><polygon fill="#A80036" points="675.5,609.9531,665.5,613.9531,675.5,617.9531,671.5,613.9531" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="671.5" y="588.1621">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="689.5" y="580.5449">Synthesize key handle (</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="689.5" y="595.7793">JWT, etc)</text><polygon fill="#A80036" points="61.5,639.1875,51.5,643.1875,61.5,647.1875,57.5,643.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="55.5" x2="658.5" y1="643.1875" y2="643.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="67.5" y="638.0137">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="85.5" y="638.0137">OK("key handle")</text><polygon fill="#A80036" points="474.5,683.6563,484.5,687.6563,474.5,691.6563,478.5,687.6563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="50.5" x2="480.5" y1="687.6563" y2="687.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="57.5" y="674.8652">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="75.5" y="667.248">load_private_key("key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="75.5" y="682.4824">handle")</text><polygon fill="#A80036" points="61.5,712.8906,51.5,716.8906,61.5,720.8906,57.5,716.8906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="55.5" x2="490.5" y1="716.8906" y2="716.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="67.5" y="711.7168">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="85.5" y="711.7168">openssl::EVP_PKEY</text><path d="M13,738.8906 L327,738.8906 L327,745.8906 L317,755.8906 L13,755.8906 L13,738.8906 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="321.8125" style="stroke: #000000; stroke-width: 2.0;" width="1589" x="13" y="738.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="269" x="28" y="751.9512">Get cert corresponding to cert ID from CS</text><polygon fill="#A80036" points="1312,788.5938,1322,792.5938,1312,796.5938,1316,792.5938" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="50.5" x2="1318" y1="792.5938" y2="792.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="57.5" y="779.8027">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="75.5" y="772.1855">create_or_load_cert("key_</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="75.5" y="787.4199">id")</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1334" x2="1376" y1="821.8281" y2="821.8281"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1376" x2="1376" y1="821.8281" y2="834.8281"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1335" x2="1376" y1="834.8281" y2="834.8281"/><polygon fill="#A80036" points="1345,830.8281,1335,834.8281,1345,838.8281,1341,834.8281" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1341" y="816.6543">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="1359" y="816.6543">Evaluate policies</text><polygon fill="#A80036" points="1508,875.2969,1518,879.2969,1508,883.2969,1512,879.2969" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1334" x2="1514" y1="879.2969" y2="879.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1341" y="866.5059">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="1359" y="858.8887">create_or_load_cert("key_</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="1359" y="874.123">id")</text><polygon fill="#A80036" points="1345,904.5313,1335,908.5313,1345,912.5313,1341,908.5313" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1339" x2="1524" y1="908.5313" y2="908.5313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1351" y="903.3574">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="1369" y="903.3574">OK(openssl::X509)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1334" x2="1376" y1="953" y2="953"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1376" x2="1376" y1="953" y2="966"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1335" x2="1376" y1="966" y2="966"/><polygon fill="#A80036" points="1345,962,1335,966,1345,970,1341,966" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1341" y="940.209">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="1359" y="932.5918">Convert openssl::X509 to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="25" x="1359" y="947.8262">PEM</text><polygon fill="#A80036" points="61.5,991.2344,51.5,995.2344,61.5,999.2344,57.5,995.2344" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="55.5" x2="1328" y1="995.2344" y2="995.2344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="67.5" y="990.0605">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="51" x="85.5" y="990.0605">OK(PEM)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="50.5" x2="92.5" y1="1039.7031" y2="1039.7031"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="92.5" x2="92.5" y1="1039.7031" y2="1052.7031"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="51.5" x2="92.5" y1="1052.7031" y2="1052.7031"/><polygon fill="#A80036" points="61.5,1048.7031,51.5,1052.7031,61.5,1056.7031,57.5,1052.7031" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="57.5" y="1026.9121">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="75.5" y="1019.2949">Create openssl::X509</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="75.5" y="1034.5293">from PEM</text><path d="M13,1074.7031 L207,1074.7031 L207,1081.7031 L197,1091.7031 L13,1091.7031 L13,1074.7031 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="805.0313" style="stroke: #000000; stroke-width: 2.0;" width="1298" x="13" y="1074.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="149" x="28" y="1087.7637">Create TLS connection</text><polygon fill="#A80036" points="228.5,1139.6406,238.5,1143.6406,228.5,1147.6406,232.5,1143.6406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="50.5" x2="234.5" y1="1143.6406" y2="1143.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="57.5" y="1123.2324">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="75.5" y="1107.998">Create openssl client</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="75.5" y="1123.2324">using openssl::EVP_PKEY</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="75.5" y="1138.4668">+ openssl::X509</text><rect fill="#FEFECE" filter="url(#fxqw90t0kcgz)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="104" x="240.5" y="1106.2344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="247.5" y="1126.2227">openssl client</text><polygon fill="#A80036" points="277.5,1184.1094,287.5,1188.1094,277.5,1192.1094,281.5,1188.1094" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="50.5" x2="283.5" y1="1188.1094" y2="1188.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="57.5" y="1175.3184">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="75.5" y="1167.7012">connect to example.org:4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="14" x="75.5" y="1182.9355">43</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="299.5" x2="346.5" y1="1212.3438" y2="1212.3438"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="346.5" x2="346.5" y1="1212.3438" y2="1225.3438"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="305.5" x2="346.5" y1="1225.3438" y2="1225.3438"/><polygon fill="#A80036" points="315.5,1221.3438,305.5,1225.3438,315.5,1229.3438,311.5,1225.3438" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="311.5" y="1207.1699">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="329.5" y="1207.1699">Handshake</text><polygon fill="#A80036" points="474.5,1270.8125,484.5,1274.8125,474.5,1278.8125,478.5,1274.8125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="304.5" x2="480.5" y1="1274.8125" y2="1274.8125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="311.5" y="1262.0215">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="329.5" y="1254.4043">openssl_EVP_PKEY_sign(</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="329.5" y="1269.6387">openssl::EVP_PKEY, ...)</text><polygon fill="#A80036" points="642.5,1300.0469,652.5,1304.0469,642.5,1308.0469,646.5,1304.0469" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="496.5" x2="648.5" y1="1304.0469" y2="1304.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="503.5" y="1298.873">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="521.5" y="1298.873">sign("key handle", ...)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="664.5" x2="706.5" y1="1333.2813" y2="1333.2813"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="706.5" x2="706.5" y1="1333.2813" y2="1346.2813"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="665.5" x2="706.5" y1="1346.2813" y2="1346.2813"/><polygon fill="#A80036" points="675.5,1342.2813,665.5,1346.2813,675.5,1350.2813,671.5,1346.2813" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="671.5" y="1328.1074">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="689.5" y="1328.1074">Evaluate policies</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="664.5" x2="706.5" y1="1390.75" y2="1390.75"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="706.5" x2="706.5" y1="1390.75" y2="1403.75"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="665.5" x2="706.5" y1="1403.75" y2="1403.75"/><polygon fill="#A80036" points="675.5,1399.75,665.5,1403.75,675.5,1407.75,671.5,1403.75" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="671.5" y="1377.959">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="689.5" y="1370.3418">Convert key handle to key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="689.5" y="1385.5762">ID</text><polygon fill="#A80036" points="834.5,1428.9844,844.5,1432.9844,834.5,1436.9844,838.5,1432.9844" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="664.5" x2="840.5" y1="1432.9844" y2="1432.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="671.5" y="1427.8105">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="94" x="689.5" y="1427.8105">sign("key ID", ...)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="856.5" x2="898.5" y1="1462.2188" y2="1462.2188"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="898.5" x2="898.5" y1="1462.2188" y2="1475.2188"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="857.5" x2="898.5" y1="1475.2188" y2="1475.2188"/><polygon fill="#A80036" points="867.5,1471.2188,857.5,1475.2188,867.5,1479.2188,863.5,1475.2188" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="863.5" y="1457.0449">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="881.5" y="1457.0449">Convert key ID to key URI</text><polygon fill="#A80036" points="1027.5,1515.6875,1037.5,1519.6875,1027.5,1523.6875,1031.5,1519.6875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="856.5" x2="1033.5" y1="1519.6875" y2="1519.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="863.5" y="1506.8965">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="881.5" y="1499.2793">load_private_key("key_uri</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="881.5" y="1514.5137">")</text><polygon fill="#A80036" points="1223.5,1544.9219,1233.5,1548.9219,1223.5,1552.9219,1227.5,1548.9219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1049.5" x2="1229.5" y1="1548.9219" y2="1548.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1056.5" y="1543.748">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="1074.5" y="1543.748">C_FindObjects("key_uri")</text><polygon fill="#A80036" points="1060.5,1574.1563,1050.5,1578.1563,1060.5,1582.1563,1056.5,1578.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1054.5" x2="1239.5" y1="1578.1563" y2="1578.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1066.5" y="1572.9824">36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="1084.5" y="1572.9824">OBJECT_HANDLE</text><polygon fill="#A80036" points="867.5,1603.3906,857.5,1607.3906,867.5,1611.3906,863.5,1607.3906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="861.5" x2="1043.5" y1="1607.3906" y2="1607.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="873.5" y="1602.2168">37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="17" x="891.5" y="1602.2168">OK</text><polygon fill="#A80036" points="1027.5,1647.8594,1037.5,1651.8594,1027.5,1655.8594,1031.5,1651.8594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="856.5" x2="1033.5" y1="1651.8594" y2="1651.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="863.5" y="1639.0684">38</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="881.5" y="1631.4512">openssl::sign(openssl::</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="881.5" y="1646.6855">EVP_PKEY, ...)</text><polygon fill="#A80036" points="1223.5,1692.3281,1233.5,1696.3281,1223.5,1700.3281,1227.5,1696.3281" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1049.5" x2="1229.5" y1="1696.3281" y2="1696.3281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1056.5" y="1683.5371">39</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="1074.5" y="1675.9199">C_Sign(pkcs11::OBJECT_</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="69" x="1074.5" y="1691.1543">HANDLE, ...)</text><polygon fill="#A80036" points="1060.5,1721.5625,1050.5,1725.5625,1060.5,1729.5625,1056.5,1725.5625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1054.5" x2="1239.5" y1="1725.5625" y2="1725.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1066.5" y="1720.3887">40</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1084.5" y="1720.3887">OK(signature)</text><polygon fill="#A80036" points="867.5,1750.7969,857.5,1754.7969,867.5,1758.7969,863.5,1754.7969" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="861.5" x2="1043.5" y1="1754.7969" y2="1754.7969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="873.5" y="1749.623">41</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="891.5" y="1749.623">OK(signature)</text><polygon fill="#A80036" points="675.5,1780.0313,665.5,1784.0313,675.5,1788.0313,671.5,1784.0313" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="669.5" x2="850.5" y1="1784.0313" y2="1784.0313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="681.5" y="1778.8574">42</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="699.5" y="1778.8574">OK(signature)</text><polygon fill="#A80036" points="507.5,1809.2656,497.5,1813.2656,507.5,1817.2656,503.5,1813.2656" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="501.5" x2="658.5" y1="1813.2656" y2="1813.2656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="513.5" y="1808.0918">43</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="531.5" y="1808.0918">OK(signature)</text><polygon fill="#A80036" points="310.5,1838.5,300.5,1842.5,310.5,1846.5,306.5,1842.5" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="304.5" x2="490.5" y1="1842.5" y2="1842.5"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="316.5" y="1837.3262">44</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="334.5" y="1837.3262">OK(signature)</text><polygon fill="#A80036" points="61.5,1867.7344,51.5,1871.7344,61.5,1875.7344,57.5,1871.7344" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="55.5" x2="293.5" y1="1871.7344" y2="1871.7344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="67.5" y="1866.5605">45</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="85.5" y="1866.5605">Connected</text><!--MD5=[45f46fba92046a959b043f2de3079636]
@startuml

title Create a TLS client with a private key from KS and a certificate from CS
skinparam maxMessageSize 150

participant Client
participant "openssl client" as openssl
participant "openssl-engine-ks"

box KS
participant KS
participant "libaziot-keys"
participant "openssl-engine-pkcs11"
participant "PKCS#11 library" as pkcs11
end box

box CS
participant CS
participant "libiothsm-certgen"
end box

autonumber

group Get key corresponding to key ID from KS
	Client -> KS ++: load_key_pair("key_id")
	KS -> KS: Evaluate policies
	KS -> "libaziot-keys" ++: load_key_pair("key_id")
	"libaziot-keys" -> "libaziot-keys": Convert key ID to key URI
	"libaziot-keys" -> "openssl-engine-pkcs11" ++: load_public_key("key_uri")
	"openssl-engine-pkcs11" -> pkcs11 ++: C_FindObjects("key_uri")
	return OBJECT_HANDLE
	return OK
	"libaziot-keys" -> "openssl-engine-pkcs11" ++: load_private_key("key_uri")
	"openssl-engine-pkcs11" -> pkcs11 ++: C_FindObjects("key_uri")
	return OBJECT_HANDLE
	return OK
	return OK
	KS -> KS: Synthesize key handle (JWT, etc)
	return OK("key handle")
	Client -> "openssl-engine-ks" ++: load_private_key("key handle")
	return openssl::EVP_PKEY
end

group Get cert corresponding to cert ID from CS
	Client -> CS ++: create_or_load_cert("key_id")
	CS -> CS: Evaluate policies
	CS -> "libiothsm-certgen" ++: create_or_load_cert("key_id")
	return OK(openssl::X509)
	CS -> CS: Convert openssl::X509 to PEM
	return OK(PEM)

	Client -> Client: Create openssl::X509 from PEM
end

group Create TLS connection
	Client -> openssl **: Create openssl client using openssl::EVP_PKEY + openssl::X509
	Client -> openssl ++: connect to example.org:443

	openssl -> openssl ++: Handshake
	openssl -> "openssl-engine-ks" ++: openssl_EVP_PKEY_sign(openssl::EVP_PKEY, ...)
	"openssl-engine-ks" -> KS ++: sign("key handle", ...)
	KS -> KS: Evaluate policies
	KS -> KS: Convert key handle to key ID
	KS -> "libaziot-keys" ++: sign("key ID", ...)
	"libaziot-keys" -> "libaziot-keys": Convert key ID to key URI
	"libaziot-keys" -> "openssl-engine-pkcs11" ++: load_private_key("key_uri")
	"openssl-engine-pkcs11" -> pkcs11 ++: C_FindObjects("key_uri")
	return OBJECT_HANDLE
	return OK
	"libaziot-keys" -> "openssl-engine-pkcs11" ++: openssl::sign(openssl::EVP_PKEY, ...)
	"openssl-engine-pkcs11" -> pkcs11 ++: C_Sign(pkcs11::OBJECT_HANDLE, ...)
	return OK(signature)
	return OK(signature)
	return OK(signature)
	return OK(signature)
	return OK(signature)
	deactivate openssl
	return Connected
end

@enduml

PlantUML version 1.2020.17(Sat Sep 19 05:30:11 PDT 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>