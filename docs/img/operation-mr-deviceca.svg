<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="3801px" preserveAspectRatio="none" style="width:1397px;height:3801px;" version="1.1" viewBox="0 0 1397 3801" width="1397px" zoomAndPan="magnify"><defs><filter height="300%" id="f1vnohgqi0p9s0" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="197" x="601" y="27.4023">MR Runtime Operation</text><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="754.5586" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="47.5" y="1339.1055"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="708.627" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="47.5" y="2184.9063"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="308.7266" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="47.5" y="2954.1543"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="300.5" y="1106.4434"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="311.3477" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="300.5" y="1383.7266"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="296.0371" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="300.5" y="2229.5273"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="300.5" y="3385.4336"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="300.5" y="3595.2285"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="538.5" y="187.9297"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="538.5" y="425.7246"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="87.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="538.5" y="628.5195"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="87.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="538.5" y="892.2695"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="87.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="538.5" y="3116.3281"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="722.5" y="129.3086"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="722.5" y="367.1035"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="722.5" y="657.8301"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="722.5" y="921.5801"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="722.5" y="1485.9688"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="75.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="722.5" y="1575.2109"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="309.3477" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="722.5" y="1755.0059"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="722.5" y="2331.7695"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="75.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="722.5" y="2421.0117"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="278.7266" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="722.5" y="2585.4961"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="722.5" y="3145.6387"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="722.5" y="3474.6758"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="722.5" y="3699.7813"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="967.5" y="261.8613"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="44.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="967.5" y="499.6563"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="967.5" y="745.7617"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="967.5" y="1009.5117"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="250.1055" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="967.5" y="2983.4648"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="208.4844" style="stroke: #000000; stroke-width: 2.0;" width="977.5" x="23" y="90.6875"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="740.6504" style="stroke: #000000; stroke-width: 2.0;" width="997.5" x="13" y="313.1719"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="487.5449" style="stroke: #000000; stroke-width: 2.0;" width="977.5" x="23" y="559.2773"/><rect fill="#FFFFFF" height="263.75" style="stroke: none; stroke-width: 1.0;" width="977.5" x="23" y="783.0723"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="163.7305" style="stroke: #000000; stroke-width: 2.0;" width="1236" x="23" y="1067.8223"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="2032.3281" style="stroke: #000000; stroke-width: 2.0;" width="1256" x="13" y="1245.5527"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="831.8008" style="stroke: #000000; stroke-width: 2.0;" width="1236" x="23" y="1269.8633"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="785.8691" style="stroke: #000000; stroke-width: 2.0;" width="1236" x="23" y="2115.6641"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="355.3477" style="stroke: #000000; stroke-width: 2.0;" width="1236" x="23" y="2915.5332"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="452.2109" style="stroke: #000000; stroke-width: 2.0;" width="1115.5" x="270.5" y="3291.8809"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="195.7949" style="stroke: #000000; stroke-width: 2.0;" width="1095.5" x="280.5" y="3316.1914"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="211.1055" style="stroke: #000000; stroke-width: 2.0;" width="1095.5" x="280.5" y="3525.9863"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="52" x2="52" y1="73.6875" y2="3761.0918"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="305.5" x2="305.5" y1="73.6875" y2="3761.0918"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="543" x2="543" y1="73.6875" y2="3761.0918"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="727" x2="727" y1="73.6875" y2="3761.0918"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="972.5" x2="972.5" y1="73.6875" y2="3761.0918"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1214" x2="1214" y1="1218.8086" y2="3761.0918"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1312" x2="1312" y1="73.6875" y2="3761.0918"/><rect fill="#FEFECE" filter="url(#f1vnohgqi0p9s0)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="35" x="33" y="38.1992"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="21" x="40" y="58.7344">MR</text><rect fill="#FEFECE" filter="url(#f1vnohgqi0p9s0)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="35" x="33" y="3760.0918"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="21" x="40" y="3780.627">MR</text><rect fill="#FEFECE" filter="url(#f1vnohgqi0p9s0)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="26" x="290.5" y="38.1992"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="12" x="297.5" y="58.7344">IS</text><rect fill="#FEFECE" filter="url(#f1vnohgqi0p9s0)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="26" x="290.5" y="3760.0918"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="12" x="297.5" y="3780.627">IS</text><rect fill="#FEFECE" filter="url(#f1vnohgqi0p9s0)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="145" x="469" y="38.1992"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="131" x="476" y="58.7344">openssl-engine-ks</text><rect fill="#FEFECE" filter="url(#f1vnohgqi0p9s0)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="145" x="469" y="3760.0918"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="131" x="476" y="3780.627">openssl-engine-ks</text><rect fill="#FEFECE" filter="url(#f1vnohgqi0p9s0)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="31" x="710" y="38.1992"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="17" x="717" y="58.7344">KS</text><rect fill="#FEFECE" filter="url(#f1vnohgqi0p9s0)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="31" x="710" y="3760.0918"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="17" x="717" y="3780.627">KS</text><rect fill="#FEFECE" filter="url(#f1vnohgqi0p9s0)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="32" x="954.5" y="38.1992"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="18" x="961.5" y="58.7344">CS</text><rect fill="#FEFECE" filter="url(#f1vnohgqi0p9s0)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="32" x="954.5" y="3760.0918"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="18" x="961.5" y="3780.627">CS</text><rect fill="#FEFECE" filter="url(#f1vnohgqi0p9s0)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="65" x="1180" y="3760.0918"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="51" x="1187" y="3780.627">Module</text><rect fill="#FEFECE" filter="url(#f1vnohgqi0p9s0)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="103" x="1259" y="38.1992"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="89" x="1266" y="58.7344">Host_Module</text><rect fill="#FEFECE" filter="url(#f1vnohgqi0p9s0)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="103" x="1259" y="3760.0918"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="89" x="1266" y="3780.627">Host_Module</text><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="754.5586" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="47.5" y="1339.1055"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="708.627" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="47.5" y="2184.9063"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="308.7266" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="47.5" y="2954.1543"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="300.5" y="1106.4434"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="311.3477" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="300.5" y="1383.7266"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="296.0371" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="300.5" y="2229.5273"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="300.5" y="3385.4336"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="300.5" y="3595.2285"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="538.5" y="187.9297"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="538.5" y="425.7246"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="87.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="538.5" y="628.5195"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="87.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="538.5" y="892.2695"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="87.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="538.5" y="3116.3281"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="722.5" y="129.3086"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="722.5" y="367.1035"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="722.5" y="657.8301"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="722.5" y="921.5801"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="722.5" y="1485.9688"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="75.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="722.5" y="1575.2109"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="309.3477" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="722.5" y="1755.0059"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="722.5" y="2331.7695"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="75.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="722.5" y="2421.0117"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="278.7266" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="722.5" y="2585.4961"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="722.5" y="3145.6387"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="722.5" y="3474.6758"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="722.5" y="3699.7813"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="967.5" y="261.8613"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="44.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="967.5" y="499.6563"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="967.5" y="745.7617"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="967.5" y="1009.5117"/><rect fill="#FFFFFF" filter="url(#f1vnohgqi0p9s0)" height="250.1055" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="967.5" y="2983.4648"/><path d="M23,90.6875 L136,90.6875 L136,97.6875 L126,107.6875 L23,107.6875 L23,90.6875 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="208.4844" style="stroke: #000000; stroke-width: 2.0;" width="977.5" x="23" y="90.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="68" x="38" y="104.2559">Device CA</text><polygon fill="#A80036" points="710.5,125.3086,720.5,129.3086,710.5,133.3086,714.5,129.3086" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="52.5" x2="716.5" y1="129.3086" y2="129.3086"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="59.5" y="124.5664">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="72.5" y="124.5664">load_key_pair("device_ca")</text><polygon fill="#A80036" points="63.5,154.6191,53.5,158.6191,63.5,162.6191,59.5,158.6191" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="57.5" x2="726.5" y1="158.6191" y2="158.6191"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="69.5" y="153.877">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="82.5" y="153.877">OK("key handle")</text><polygon fill="#A80036" points="526.5,183.9297,536.5,187.9297,526.5,191.9297,530.5,187.9297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="52.5" x2="532.5" y1="187.9297" y2="187.9297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="59.5" y="183.1875">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="72.5" y="183.1875">load_private_key("key handle")</text><polygon fill="#A80036" points="63.5,213.2402,53.5,217.2402,63.5,221.2402,59.5,217.2402" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="57.5" x2="542.5" y1="217.2402" y2="217.2402"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="69.5" y="212.498">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="82.5" y="212.498">openssl::EVP_PKEY</text><polygon fill="#A80036" points="955.5,257.8613,965.5,261.8613,955.5,265.8613,959.5,261.8613" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="52.5" x2="961.5" y1="261.8613" y2="261.8613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="59.5" y="249.4639">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="72.5" y="241.8086">create_or_load_cert("device_ca"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="72.5" y="257.1191">)</text><polygon fill="#A80036" points="63.5,287.1719,53.5,291.1719,63.5,295.1719,59.5,291.1719" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="57.5" x2="971.5" y1="291.1719" y2="291.1719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="69.5" y="286.4297">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="82.5" y="286.4297">OK(cert PEM)</text><path d="M13,313.1719 L144,313.1719 L144,320.1719 L134,330.1719 L13,330.1719 L13,313.1719 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="740.6504" style="stroke: #000000; stroke-width: 2.0;" width="997.5" x="13" y="313.1719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="86" x="28" y="326.7402">Workload CA</text><polygon fill="#A80036" points="710.5,363.1035,720.5,367.1035,710.5,371.1035,714.5,367.1035" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="52.5" x2="716.5" y1="367.1035" y2="367.1035"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="59.5" y="354.7061">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="196" x="72.5" y="347.0508">create_key_pair_if_not_exists("</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="72.5" y="362.3613">workload_ca")</text><polygon fill="#A80036" points="63.5,392.4141,53.5,396.4141,63.5,400.4141,59.5,396.4141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="57.5" x2="726.5" y1="396.4141" y2="396.4141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="69.5" y="391.6719">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="82.5" y="391.6719">OK("key handle")</text><polygon fill="#A80036" points="526.5,421.7246,536.5,425.7246,526.5,429.7246,530.5,425.7246" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="52.5" x2="532.5" y1="425.7246" y2="425.7246"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="59.5" y="420.9824">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="72.5" y="420.9824">load_private_key("key handle")</text><polygon fill="#A80036" points="63.5,451.0352,53.5,455.0352,63.5,459.0352,59.5,455.0352" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="57.5" x2="542.5" y1="455.0352" y2="455.0352"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="69.5" y="450.293">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="91.5" y="450.293">openssl::EVP_PKEY</text><polygon fill="#A80036" points="955.5,495.6563,965.5,499.6563,955.5,503.6563,959.5,499.6563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="52.5" x2="961.5" y1="499.6563" y2="499.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="59.5" y="487.2588">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="81.5" y="479.6035">create_or_load_cert("workload_</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="81.5" y="494.9141">ca")</text><polygon fill="#A80036" points="63.5,540.2773,53.5,544.2773,63.5,548.2773,59.5,544.2773" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="57.5" x2="971.5" y1="544.2773" y2="544.2773"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="69.5" y="531.8799">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="91.5" y="524.2246">OK(cert PEM) or Err(NOT_</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="91.5" y="539.5352">FOUND)</text><path d="M23,559.2773 L85,559.2773 L85,566.2773 L75,576.2773 L23,576.2773 L23,559.2773 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="487.5449" style="stroke: #000000; stroke-width: 2.0;" width="977.5" x="23" y="559.2773"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="38" y="572.8457">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="95" x="100" y="571.9121">[if OK(cert PEM)]</text><polygon fill="#A80036" points="526.5,624.5195,536.5,628.5195,526.5,632.5195,530.5,628.5195" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="52.5" x2="532.5" y1="628.5195" y2="628.5195"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="59.5" y="608.4668">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="81.5" y="593.1563">openssl::X509_verify(CSR,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="81.5" y="608.4668">device_ca privkey openssl::EVP</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="81.5" y="623.7773">_PKEY)</text><polygon fill="#A80036" points="710.5,653.8301,720.5,657.8301,710.5,661.8301,714.5,657.8301" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="548.5" x2="716.5" y1="657.8301" y2="657.8301"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="555.5" y="653.0879">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="577.5" y="653.0879">sign("key handle", ...)</text><polygon fill="#A80036" points="559.5,683.1406,549.5,687.1406,559.5,691.1406,555.5,687.1406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="553.5" x2="726.5" y1="687.1406" y2="687.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="565.5" y="682.3984">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="85" x="587.5" y="682.3984">OK(signature)</text><polygon fill="#A80036" points="63.5,712.4512,53.5,716.4512,63.5,720.4512,59.5,716.4512" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="57.5" x2="542.5" y1="716.4512" y2="716.4512"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="69.5" y="711.709">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="91.5" y="711.709">OK(signed X509)</text><polygon fill="#A80036" points="955.5,741.7617,965.5,745.7617,955.5,749.7617,959.5,745.7617" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="52.5" x2="961.5" y1="745.7617" y2="745.7617"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="59.5" y="741.0195">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="200" x="81.5" y="741.0195">import("workload_ca", cert PEM)</text><polygon fill="#A80036" points="63.5,771.0723,53.5,775.0723,63.5,779.0723,59.5,775.0723" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="57.5" x2="971.5" y1="775.0723" y2="775.0723"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="69.5" y="770.3301">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="18" x="91.5" y="770.3301">OK</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="23" x2="1000.5" y1="784.0723" y2="784.0723"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="117" x="28" y="794.707">[if Err(NOT_FOUND)]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="52.5" x2="94.5" y1="834.6484" y2="834.6484"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="94.5" x2="94.5" y1="834.6484" y2="847.6484"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="53.5" x2="94.5" y1="847.6484" y2="847.6484"/><polygon fill="#A80036" points="63.5,843.6484,53.5,847.6484,63.5,851.6484,59.5,847.6484" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="59.5" y="822.251">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="81.5" y="814.5957">generate new CSR for workload</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="81.5" y="829.9063">_ca</text><polygon fill="#A80036" points="526.5,888.2695,536.5,892.2695,526.5,896.2695,530.5,892.2695" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="52.5" x2="532.5" y1="892.2695" y2="892.2695"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="59.5" y="879.8721">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="81.5" y="872.2168">openssl::X509_sign(CSR, device</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="81.5" y="887.5273">_ca privkey openssl::EVP_PKEY)</text><polygon fill="#A80036" points="710.5,917.5801,720.5,921.5801,710.5,925.5801,714.5,921.5801" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="548.5" x2="716.5" y1="921.5801" y2="921.5801"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="555.5" y="916.8379">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="577.5" y="916.8379">sign("key handle", ...)</text><polygon fill="#A80036" points="559.5,946.8906,549.5,950.8906,559.5,954.8906,555.5,950.8906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="553.5" x2="726.5" y1="950.8906" y2="950.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="565.5" y="946.1484">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="85" x="587.5" y="946.1484">OK(signature)</text><polygon fill="#A80036" points="63.5,976.2012,53.5,980.2012,63.5,984.2012,59.5,980.2012" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="57.5" x2="542.5" y1="980.2012" y2="980.2012"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="69.5" y="975.459">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="91.5" y="975.459">OK(signed X509)</text><polygon fill="#A80036" points="955.5,1005.5117,965.5,1009.5117,955.5,1013.5117,959.5,1009.5117" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="52.5" x2="961.5" y1="1009.5117" y2="1009.5117"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="59.5" y="1004.7695">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="200" x="81.5" y="1004.7695">import("workload_ca", cert PEM)</text><polygon fill="#A80036" points="63.5,1034.8223,53.5,1038.8223,63.5,1042.8223,59.5,1038.8223" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="57.5" x2="971.5" y1="1038.8223" y2="1038.8223"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="69.5" y="1034.0801">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="18" x="91.5" y="1034.0801">OK</text><path d="M23,1067.8223 L115,1067.8223 L115,1074.8223 L105,1084.8223 L23,1084.8223 L23,1067.8223 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="163.7305" style="stroke: #000000; stroke-width: 2.0;" width="1236" x="23" y="1067.8223"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="47" x="38" y="1081.3906">MR init</text><polygon fill="#A80036" points="288.5,1102.4434,298.5,1106.4434,288.5,1110.4434,292.5,1106.4434" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="52.5" x2="294.5" y1="1106.4434" y2="1106.4434"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="59.5" y="1101.7012">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="81.5" y="1101.7012">get_provisioning_info()</text><polygon fill="#A80036" points="63.5,1131.7539,53.5,1135.7539,63.5,1139.7539,59.5,1135.7539" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="57.5" x2="304.5" y1="1135.7539" y2="1135.7539"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="69.5" y="1131.0117">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="91.5" y="1131.0117">OK(provisioning info)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="52.5" x2="94.5" y1="1165.0645" y2="1165.0645"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="94.5" x2="94.5" y1="1165.0645" y2="1178.0645"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="53.5" x2="94.5" y1="1178.0645" y2="1178.0645"/><polygon fill="#A80036" points="63.5,1174.0645,53.5,1178.0645,63.5,1182.0645,59.5,1178.0645" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="59.5" y="1160.3223">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="81.5" y="1160.3223">Start modules</text><polygon fill="#A80036" points="1168,1203.375,1178,1207.375,1168,1211.375,1172,1207.375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="52.5" x2="1174" y1="1207.375" y2="1207.375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="59.5" y="1202.6328">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="85.5" y="1202.6328"/><rect fill="#FEFECE" filter="url(#f1vnohgqi0p9s0)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="65" x="1180" y="1186.0645"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="51" x="1187" y="1206.5996">Module</text><path d="M13,1245.5527 L155,1245.5527 L155,1252.5527 L145,1262.5527 L13,1262.5527 L13,1245.5527 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2032.3281" style="stroke: #000000; stroke-width: 2.0;" width="1256" x="13" y="1245.5527"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="28" y="1259.1211">Module things</text><path d="M23,1269.8633 L292,1269.8633 L292,1276.8633 L282,1286.8633 L23,1286.8633 L23,1269.8633 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="831.8008" style="stroke: #000000; stroke-width: 2.0;" width="1236" x="23" y="1269.8633"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="224" x="38" y="1283.4316">Module wants to encrypt a secret</text><polygon fill="#A80036" points="68.5,1335.1055,58.5,1339.1055,68.5,1343.1055,64.5,1339.1055" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="62.5" x2="1213.5" y1="1339.1055" y2="1339.1055"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="74.5" y="1319.0527">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="96.5" y="1303.7422">encrypt(plaintext) (e.g. encrypt(</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="96.5" y="1319.0527">b"foo"), module_id = "</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="96.5" y="1334.3633">edgeAgent", gen_id = 1000)</text><polygon fill="#A80036" points="288.5,1379.7266,298.5,1383.7266,288.5,1387.7266,292.5,1383.7266" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="57.5" x2="294.5" y1="1383.7266" y2="1383.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="64.5" y="1371.3291">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="86.5" y="1363.6738">get_encryption_key(module_id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="86.5" y="1378.9844">gen_id)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="310.5" x2="352.5" y1="1428.3477" y2="1428.3477"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="352.5" x2="352.5" y1="1428.3477" y2="1441.3477"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="311.5" x2="352.5" y1="1441.3477" y2="1441.3477"/><polygon fill="#A80036" points="321.5,1437.3477,311.5,1441.3477,321.5,1445.3477,317.5,1441.3477" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="317.5" y="1415.9502">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="339.5" y="1408.2949">Derive module ID digest (e.g. "</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="339.5" y="1423.6055">edgeAgent:1000")</text><polygon fill="#A80036" points="710.5,1481.9688,720.5,1485.9688,710.5,1489.9688,714.5,1485.9688" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="310.5" x2="716.5" y1="1485.9688" y2="1485.9688"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="317.5" y="1473.5713">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="165" x="339.5" y="1465.916">create_key_if_not_exists("</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="155" x="339.5" y="1481.2266">master_encryption_key")</text><polygon fill="#A80036" points="321.5,1511.2793,311.5,1515.2793,321.5,1519.2793,317.5,1515.2793" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="315.5" x2="726.5" y1="1515.2793" y2="1515.2793"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="327.5" y="1510.5371">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="349.5" y="1510.5371">OK("key handle")</text><polygon fill="#A80036" points="710.5,1571.2109,720.5,1575.2109,710.5,1579.2109,714.5,1575.2109" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="310.5" x2="716.5" y1="1575.2109" y2="1575.2109"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="317.5" y="1555.1582">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="339.5" y="1539.8477">create_derived_key("master</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="339.5" y="1555.1582">encryption key handle", module</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="339.5" y="1570.4688">ID digest)</text><polygon fill="#A80036" points="321.5,1646.4531,311.5,1650.4531,321.5,1654.4531,317.5,1650.4531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="315.5" x2="726.5" y1="1650.4531" y2="1650.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="327.5" y="1622.7451">36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="349.5" y="1599.7793">OK(module encryption key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="349.5" y="1615.0898">handle) (e.g. token({ base: "</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="349.5" y="1630.4004">master encryption key handle",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="349.5" y="1645.7109">digest: "edgeAgent:1000" }))</text><polygon fill="#A80036" points="68.5,1691.0742,58.5,1695.0742,68.5,1699.0742,64.5,1695.0742" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="62.5" x2="304.5" y1="1695.0742" y2="1695.0742"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="74.5" y="1682.6768">37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="96.5" y="1675.0215">OK(module encryption key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="96.5" y="1690.332">handle)</text><polygon fill="#A80036" points="710.5,1751.0059,720.5,1755.0059,710.5,1759.0059,714.5,1755.0059" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="57.5" x2="716.5" y1="1755.0059" y2="1755.0059"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="64.5" y="1734.9531">38</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="86.5" y="1719.6426">encrypt(module encryption key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="196" x="86.5" y="1734.9531">handle, plaintext) (e.g. encrypt(</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="86.5" y="1750.2637">token(...), b"foo"))</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="732.5" x2="774.5" y1="1830.248" y2="1830.248"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="774.5" x2="774.5" y1="1830.248" y2="1843.248"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="733.5" x2="774.5" y1="1843.248" y2="1843.248"/><polygon fill="#A80036" points="743.5,1839.248,733.5,1843.248,743.5,1847.248,739.5,1843.248" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="739.5" y="1802.54">39</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="165" x="761.5" y="1779.5742">Get master encryption key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="179" x="761.5" y="1794.8848">handle and module id digest</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="186" x="761.5" y="1810.1953">out of module encryption key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="761.5" y="1825.5059">handle</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="732.5" x2="774.5" y1="1933.8008" y2="1933.8008"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="774.5" x2="774.5" y1="1933.8008" y2="1946.8008"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="733.5" x2="774.5" y1="1946.8008" y2="1946.8008"/><polygon fill="#A80036" points="743.5,1942.8008,733.5,1946.8008,743.5,1950.8008,739.5,1946.8008" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="739.5" y="1898.4375">40</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="761.5" y="1867.8164">module_encryption_key = sign(</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="761.5" y="1883.127">master encryption key handle,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="177" x="761.5" y="1898.4375">module id digest) (i.e. sign("</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="761.5" y="1913.748">master_encryption_key", "</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="761.5" y="1929.0586">edgeAgent:1000"))</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="732.5" x2="774.5" y1="2022.043" y2="2022.043"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="774.5" x2="774.5" y1="2022.043" y2="2035.043"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="733.5" x2="774.5" y1="2035.043" y2="2035.043"/><polygon fill="#A80036" points="743.5,2031.043,733.5,2035.043,743.5,2039.043,739.5,2035.043" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="739.5" y="1994.335">41</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="179" x="761.5" y="1971.3691">encrypt(module_encryption_</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="761.5" y="1986.6797">key, plaintext) (i.e. encrypt(</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="761.5" y="2001.9902">module_encryption_key, b"foo"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="761.5" y="2017.3008">))</text><polygon fill="#A80036" points="68.5,2060.3535,58.5,2064.3535,68.5,2068.3535,64.5,2064.3535" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="62.5" x2="726.5" y1="2064.3535" y2="2064.3535"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="74.5" y="2059.6113">42</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="96.5" y="2059.6113">OK(ciphertext)</text><polygon fill="#A80036" points="1202.5,2089.6641,1212.5,2093.6641,1202.5,2097.6641,1206.5,2093.6641" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="52.5" x2="1208.5" y1="2093.6641" y2="2093.6641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="59.5" y="2088.9219">43</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="81.5" y="2088.9219">OK(ciphertext)</text><path d="M23,2115.6641 L387,2115.6641 L387,2122.6641 L377,2132.6641 L23,2132.6641 L23,2115.6641 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="785.8691" style="stroke: #000000; stroke-width: 2.0;" width="1236" x="23" y="2115.6641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="319" x="38" y="2129.2324">Module wants to sign (HMAC-SHA256) a digest</text><polygon fill="#A80036" points="68.5,2180.9063,58.5,2184.9063,68.5,2188.9063,64.5,2184.9063" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="62.5" x2="1213.5" y1="2184.9063" y2="2184.9063"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="74.5" y="2164.8535">44</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="187" x="96.5" y="2149.543">sign(digest) (e.g. sign(b"foo"),</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="96.5" y="2164.8535">module_id = "edgeAgent", gen_</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="96.5" y="2180.1641">id = 1000, key_id = "primary")</text><polygon fill="#A80036" points="288.5,2225.5273,298.5,2229.5273,288.5,2233.5273,292.5,2229.5273" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="57.5" x2="294.5" y1="2229.5273" y2="2229.5273"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="64.5" y="2217.1299">45</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="178" x="86.5" y="2209.4746">get_identity_key(module_id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="86.5" y="2224.7852">gen_id, key_id)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="310.5" x2="352.5" y1="2274.1484" y2="2274.1484"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="352.5" x2="352.5" y1="2274.1484" y2="2287.1484"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="311.5" x2="352.5" y1="2287.1484" y2="2287.1484"/><polygon fill="#A80036" points="321.5,2283.1484,311.5,2287.1484,321.5,2291.1484,317.5,2287.1484" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="317.5" y="2261.751">46</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="339.5" y="2254.0957">Derive module ID digest (e.g. "</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="339.5" y="2269.4063">edgeAgent:1000:primary")</text><polygon fill="#A80036" points="710.5,2327.7695,720.5,2331.7695,710.5,2335.7695,714.5,2331.7695" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="310.5" x2="716.5" y1="2331.7695" y2="2331.7695"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="317.5" y="2319.3721">47</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="165" x="339.5" y="2311.7168">create_key_if_not_exists("</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="339.5" y="2327.0273">master_identity_key")</text><polygon fill="#A80036" points="321.5,2357.0801,311.5,2361.0801,321.5,2365.0801,317.5,2361.0801" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="315.5" x2="726.5" y1="2361.0801" y2="2361.0801"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="327.5" y="2356.3379">48</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="349.5" y="2356.3379">OK("key handle")</text><polygon fill="#A80036" points="710.5,2417.0117,720.5,2421.0117,710.5,2425.0117,714.5,2421.0117" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="310.5" x2="716.5" y1="2421.0117" y2="2421.0117"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="317.5" y="2400.959">49</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="339.5" y="2385.6484">create_derived_key("master</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="339.5" y="2400.959">identity key handle", module ID</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="339.5" y="2416.2695">digest)</text><polygon fill="#A80036" points="321.5,2492.2539,311.5,2496.2539,321.5,2500.2539,317.5,2496.2539" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="315.5" x2="726.5" y1="2496.2539" y2="2496.2539"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="327.5" y="2468.5459">50</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="349.5" y="2445.5801">OK(module identity key handle)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="349.5" y="2460.8906">(e.g. token({ base: "master</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="349.5" y="2476.2012">identity key handle", digest: "</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="349.5" y="2491.5117">edgeAgent:1000:primary" }))</text><polygon fill="#A80036" points="68.5,2521.5645,58.5,2525.5645,68.5,2529.5645,64.5,2525.5645" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="62.5" x2="304.5" y1="2525.5645" y2="2525.5645"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="74.5" y="2520.8223">51</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="96.5" y="2520.8223">OK(module identity key handle)</text><polygon fill="#A80036" points="710.5,2581.4961,720.5,2585.4961,710.5,2589.4961,714.5,2585.4961" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="57.5" x2="716.5" y1="2585.4961" y2="2585.4961"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="64.5" y="2565.4434">52</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="86.5" y="2550.1328">sign(module identity key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="86.5" y="2565.4434">handle, digest) (e.g. sign(token(</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="71" x="86.5" y="2580.7539">...), b"foo"))</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="732.5" x2="774.5" y1="2645.4277" y2="2645.4277"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="774.5" x2="774.5" y1="2645.4277" y2="2658.4277"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="733.5" x2="774.5" y1="2658.4277" y2="2658.4277"/><polygon fill="#A80036" points="743.5,2654.4277,733.5,2658.4277,743.5,2662.4277,739.5,2658.4277" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="739.5" y="2625.375">53</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="761.5" y="2610.0645">Get master identity key handle</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="761.5" y="2625.375">and module id digest out of</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="761.5" y="2640.6855">module identity key handle</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="732.5" x2="774.5" y1="2748.9805" y2="2748.9805"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="774.5" x2="774.5" y1="2748.9805" y2="2761.9805"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="733.5" x2="774.5" y1="2761.9805" y2="2761.9805"/><polygon fill="#A80036" points="743.5,2757.9805,733.5,2761.9805,743.5,2765.9805,739.5,2761.9805" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="739.5" y="2713.6172">54</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="761.5" y="2682.9961">module_identity_key = sign(</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="761.5" y="2698.3066">master identity key handle,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="177" x="761.5" y="2713.6172">module id digest) (i.e. sign("</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="761.5" y="2728.9277">master_identity_key", "</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168" x="761.5" y="2744.2383">edgeAgent:1000:primary"))</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="732.5" x2="774.5" y1="2821.9121" y2="2821.9121"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="774.5" x2="774.5" y1="2821.9121" y2="2834.9121"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="733.5" x2="774.5" y1="2834.9121" y2="2834.9121"/><polygon fill="#A80036" points="743.5,2830.9121,733.5,2834.9121,743.5,2838.9121,739.5,2834.9121" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="739.5" y="2801.8594">55</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="761.5" y="2786.5488">sign(module_identity_key,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="761.5" y="2801.8594">digest) (i.e. sign(module_</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="761.5" y="2817.1699">identity_key, b"foo"))</text><polygon fill="#A80036" points="68.5,2860.2227,58.5,2864.2227,68.5,2868.2227,64.5,2864.2227" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="62.5" x2="726.5" y1="2864.2227" y2="2864.2227"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="74.5" y="2859.4805">56</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="85" x="96.5" y="2859.4805">OK(signature)</text><polygon fill="#A80036" points="1202.5,2889.5332,1212.5,2893.5332,1202.5,2897.5332,1206.5,2893.5332" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="52.5" x2="1208.5" y1="2893.5332" y2="2893.5332"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="59.5" y="2888.791">57</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="85" x="81.5" y="2888.791">OK(signature)</text><path d="M23,2915.5332 L251,2915.5332 L251,2922.5332 L241,2932.5332 L23,2932.5332 L23,2915.5332 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="355.3477" style="stroke: #000000; stroke-width: 2.0;" width="1236" x="23" y="2915.5332"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="183" x="38" y="2929.1016">Module wants a server cert</text><polygon fill="#A80036" points="68.5,2950.1543,58.5,2954.1543,68.5,2958.1543,64.5,2954.1543" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="62.5" x2="1213.5" y1="2954.1543" y2="2954.1543"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="74.5" y="2949.4121">58</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="96.5" y="2949.4121">Request server cert</text><polygon fill="#A80036" points="955.5,2979.4648,965.5,2983.4648,955.5,2987.4648,959.5,2983.4648" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="57.5" x2="961.5" y1="2983.4648" y2="2983.4648"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="64.5" y="2978.7227">59</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="86.5" y="2978.7227">Request server cert</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="977.5" x2="1019.5" y1="3043.3965" y2="3043.3965"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1019.5" x2="1019.5" y1="3043.3965" y2="3056.3965"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="978.5" x2="1019.5" y1="3056.3965" y2="3056.3965"/><polygon fill="#A80036" points="988.5,3052.3965,978.5,3056.3965,988.5,3060.3965,984.5,3056.3965" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="984.5" y="3023.3438">60</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="196" x="1006.5" y="3008.0332">generate new privkey and CSR (</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="179" x="1006.5" y="3023.3438">in memory, not via openssl-</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="69" x="1006.5" y="3038.6543">engine-ks)</text><polygon fill="#A80036" points="559.5,3112.3281,549.5,3116.3281,559.5,3120.3281,555.5,3116.3281" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="553.5" x2="966.5" y1="3116.3281" y2="3116.3281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="565.5" y="3096.2754">61</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="155" x="587.5" y="3080.9648">openssl::X509_sign(CSR,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="587.5" y="3096.2754">workload_ca privkey openssl::</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="587.5" y="3111.5859">EVP_PKEY)</text><polygon fill="#A80036" points="710.5,3141.6387,720.5,3145.6387,710.5,3149.6387,714.5,3145.6387" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="548.5" x2="716.5" y1="3145.6387" y2="3145.6387"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="555.5" y="3140.8965">62</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="577.5" y="3140.8965">sign("key handle", ...)</text><polygon fill="#A80036" points="559.5,3170.9492,549.5,3174.9492,559.5,3178.9492,555.5,3174.9492" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="553.5" x2="726.5" y1="3174.9492" y2="3174.9492"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="565.5" y="3170.207">63</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="85" x="587.5" y="3170.207">OK(signature)</text><polygon fill="#A80036" points="955.5,3200.2598,965.5,3204.2598,955.5,3208.2598,959.5,3204.2598" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="543.5" x2="961.5" y1="3204.2598" y2="3204.2598"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="550.5" y="3199.5176">64</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="572.5" y="3199.5176">OK(signed X509)</text><polygon fill="#A80036" points="68.5,3229.5703,58.5,3233.5703,68.5,3237.5703,64.5,3233.5703" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="62.5" x2="971.5" y1="3233.5703" y2="3233.5703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="74.5" y="3228.8281">65</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="96.5" y="3228.8281">OK(privkey, server cert)</text><polygon fill="#A80036" points="1202.5,3258.8809,1212.5,3262.8809,1202.5,3266.8809,1206.5,3262.8809" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="52.5" x2="1208.5" y1="3262.8809" y2="3262.8809"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="59.5" y="3258.1387">66</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="81.5" y="3258.1387">OK(privkey, server cert)</text><path d="M270.5,3291.8809 L462.5,3291.8809 L462.5,3298.8809 L452.5,3308.8809 L270.5,3308.8809 L270.5,3291.8809 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="452.2109" style="stroke: #000000; stroke-width: 2.0;" width="1115.5" x="270.5" y="3291.8809"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="147" x="285.5" y="3305.4492">Host_Module API calls</text><path d="M280.5,3316.1914 L584.5,3316.1914 L584.5,3323.1914 L574.5,3333.1914 L280.5,3333.1914 L280.5,3316.1914 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="195.7949" style="stroke: #000000; stroke-width: 2.0;" width="1095.5" x="280.5" y="3316.1914"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="259" x="295.5" y="3329.7598">Host module wants to encrypt a secret</text><polygon fill="#A80036" points="321.5,3381.4336,311.5,3385.4336,321.5,3389.4336,317.5,3385.4336" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="315.5" x2="1311.5" y1="3385.4336" y2="3385.4336"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="327.5" y="3365.3809">67</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="349.5" y="3350.0703">Similar process to MR above:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="349.5" y="3365.3809">get_encryption_key(module_id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="349.5" y="3380.6914">gen_id)</text><polygon fill="#A80036" points="1300.5,3410.7441,1310.5,3414.7441,1300.5,3418.7441,1304.5,3414.7441" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="305.5" x2="1306.5" y1="3414.7441" y2="3414.7441"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="312.5" y="3410.002">68</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="334.5" y="3410.002">OK("key handle")</text><polygon fill="#A80036" points="743.5,3470.6758,733.5,3474.6758,743.5,3478.6758,739.5,3474.6758" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="737.5" x2="1311.5" y1="3474.6758" y2="3474.6758"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="749.5" y="3454.623">69</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="771.5" y="3439.3125">Similar process to MR above:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="771.5" y="3454.623">encrypt(module encryption key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="771.5" y="3469.9336">handle, plaintext)</text><polygon fill="#A80036" points="1300.5,3499.9863,1310.5,3503.9863,1300.5,3507.9863,1304.5,3503.9863" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="727.5" x2="1306.5" y1="3503.9863" y2="3503.9863"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="734.5" y="3499.2441">70</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="756.5" y="3499.2441">OK(ciphertext)</text><path d="M280.5,3525.9863 L679.5,3525.9863 L679.5,3532.9863 L669.5,3542.9863 L280.5,3542.9863 L280.5,3525.9863 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="211.1055" style="stroke: #000000; stroke-width: 2.0;" width="1095.5" x="280.5" y="3525.9863"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="354" x="295.5" y="3539.5547">Host module wants to sign (HMAC-SHA256) a digest</text><polygon fill="#A80036" points="321.5,3591.2285,311.5,3595.2285,321.5,3599.2285,317.5,3595.2285" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="315.5" x2="1311.5" y1="3595.2285" y2="3595.2285"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="327.5" y="3575.1758">71</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="349.5" y="3559.8652">Similar process to MR above:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="178" x="349.5" y="3575.1758">get_identity_key(module_id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="349.5" y="3590.4863">gen_id, key_id)</text><polygon fill="#A80036" points="1300.5,3620.5391,1310.5,3624.5391,1300.5,3628.5391,1304.5,3624.5391" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="305.5" x2="1306.5" y1="3624.5391" y2="3624.5391"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="312.5" y="3619.7969">72</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="334.5" y="3619.7969">OK("key handle")</text><polygon fill="#A80036" points="743.5,3695.7813,733.5,3699.7813,743.5,3703.7813,739.5,3699.7813" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="737.5" x2="1311.5" y1="3699.7813" y2="3699.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="749.5" y="3672.0732">73</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="771.5" y="3649.1074">Similar process to MR above:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="771.5" y="3664.418">sign(module identity key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="771.5" y="3679.7285">handle, digest) (e.g. sign(token(</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="71" x="771.5" y="3695.0391">...), b"foo"))</text><polygon fill="#A80036" points="1300.5,3725.0918,1310.5,3729.0918,1300.5,3733.0918,1304.5,3729.0918" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="727.5" x2="1306.5" y1="3729.0918" y2="3729.0918"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="734.5" y="3724.3496">74</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="85" x="756.5" y="3724.3496">OK(signature)</text><!--MD5=[c0a12ba1bfd8107697927fc28cd58da8]
@startuml

title MR Runtime Operation
skinparam maxMessageSize 200

participant MR
participant IS
participant "openssl-engine-ks"
participant KS
participant CS
participant Module
participant Host_Module

autonumber


group Device CA
	MR -> KS ++: load_key_pair("device_ca")
	return OK("key handle")
	MR -> "openssl-engine-ks" ++: load_private_key("key handle")
	return openssl::EVP_PKEY
	MR -> CS ++: create_or_load_cert("device_ca")
	return OK(cert PEM)
end

group Workload CA
	MR -> KS ++: create_key_pair_if_not_exists("workload_ca")
	return OK("key handle")
	MR -> "openssl-engine-ks" ++: load_private_key("key handle")
	return openssl::EVP_PKEY
	MR -> CS ++: create_or_load_cert("workload_ca")
	return OK(cert PEM) or Err(NOT_FOUND)

	alt if OK(cert PEM)
		MR -> "openssl-engine-ks" ++: openssl::X509_verify(CSR, device_ca privkey openssl::EVP_PKEY)
		"openssl-engine-ks" -> KS ++: sign("key handle", ...)
		return OK(signature)
		return OK(signed X509)
		MR -> CS ++: import("workload_ca", cert PEM)
		return OK

	else if Err(NOT_FOUND)
		MR -> MR: generate new CSR for workload_ca
		MR -> "openssl-engine-ks" ++: openssl::X509_sign(CSR, device_ca privkey openssl::EVP_PKEY)
		"openssl-engine-ks" -> KS ++: sign("key handle", ...)
		return OK(signature)
		return OK(signed X509)
		MR -> CS ++: import("workload_ca", cert PEM)
		return OK
	end
end

group MR init
	MR -> IS ++: get_provisioning_info()
	return OK(provisioning info)

	MR -> MR: Start modules
	MR -> Module **
end

group Module things
	group Module wants to encrypt a secret
		Module -> MR ++: encrypt(plaintext) (e.g. encrypt(b"foo"), module_id = "edgeAgent", gen_id = 1000)
		MR -> IS ++: get_encryption_key(module_id, gen_id)
		IS -> IS: Derive module ID digest (e.g. "edgeAgent:1000")
		IS -> KS ++: create_key_if_not_exists("master_encryption_key")
		return OK("key handle")
		IS -> KS ++: create_derived_key("master encryption key handle", module ID digest)
		return OK(module encryption key handle) (e.g. token({ base: "master encryption key handle", digest: "edgeAgent:1000" }))
		return OK(module encryption key handle)
		MR -> KS ++: encrypt(module encryption key handle, plaintext) (e.g. encrypt(token(...), b"foo"))
		KS -> KS: Get master encryption key handle and module id digest out of module encryption key handle
		KS -> KS: module_encryption_key = sign(master encryption key handle, module id digest) (i.e. sign("master_encryption_key", "edgeAgent:1000"))
		KS -> KS: encrypt(module_encryption_key, plaintext) (i.e. encrypt(module_encryption_key, b"foo"))
		return OK(ciphertext)
		return OK(ciphertext)
	end

	group Module wants to sign (HMAC-SHA256) a digest
		Module -> MR ++: sign(digest) (e.g. sign(b"foo"), module_id = "edgeAgent", gen_id = 1000, key_id = "primary")
		MR -> IS ++: get_identity_key(module_id, gen_id, key_id)
		IS -> IS: Derive module ID digest (e.g. "edgeAgent:1000:primary")
		IS -> KS ++: create_key_if_not_exists("master_identity_key")
		return OK("key handle")
		IS -> KS ++: create_derived_key("master identity key handle", module ID digest)
		return OK(module identity key handle) (e.g. token({ base: "master identity key handle", digest: "edgeAgent:1000:primary" }))
		return OK(module identity key handle)
		MR -> KS ++: sign(module identity key handle, digest) (e.g. sign(token(...), b"foo"))
		KS -> KS: Get master identity key handle and module id digest out of module identity key handle
		KS -> KS: module_identity_key = sign(master identity key handle, module id digest) (i.e. sign("master_identity_key", "edgeAgent:1000:primary"))
		KS -> KS: sign(module_identity_key, digest) (i.e. sign(module_identity_key, b"foo"))
		return OK(signature)
		return OK(signature)
	end

	group Module wants a server cert
		Module -> MR ++: Request server cert
		MR -> CS ++: Request server cert
		CS -> CS: generate new privkey and CSR (in memory, not via openssl-engine-ks)
		CS -> "openssl-engine-ks" ++: openssl::X509_sign(CSR, workload_ca privkey openssl::EVP_PKEY)
		"openssl-engine-ks" -> KS ++: sign("key handle", ...)
		return OK(signature)
		return OK(signed X509)	
		return OK(privkey, server cert)
		return OK(privkey, server cert)
	end
end

group Host_Module API calls
	group Host module wants to encrypt a secret
		Host_Module -> IS ++: Similar process to MR above: get_encryption_key(module_id, gen_id)
		return OK("key handle")
		Host_Module -> KS ++: Similar process to MR above: encrypt(module encryption key handle, plaintext)
		return OK(ciphertext)
	end
	group Host module wants to sign (HMAC-SHA256) a digest
		Host_Module -> IS ++: Similar process to MR above: get_identity_key(module_id, gen_id, key_id)
		return OK("key handle")
		Host_Module -> KS ++: Similar process to MR above: sign(module identity key handle, digest) (e.g. sign(token(...), b"foo"))
		return OK(signature)
	end
end


@enduml

PlantUML version 1.2020.10(Sun May 17 02:35:57 PDT 2020)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 13.0.1+9
Operating System: Mac OS X
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>