<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1700px" preserveAspectRatio="none" style="width:1454px;height:1700px;" version="1.1" viewBox="0 0 1454 1700" width="1454px" zoomAndPan="magnify"><defs><filter height="300%" id="fffrq0z8rl8tb" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="156" x="649" y="26.6992">Device Provisioning</text><rect fill="#ADD8E6" height="1650.125" style="stroke: #A80036; stroke-width: 1.0;" width="112" x="766" y="39.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="42" x="799.5" y="51.1543">Device</text><rect fill="#FFFFFF" filter="url(#fffrq0z8rl8tb)" height="113.7031" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="151.5" y="513.1875"/><rect fill="#FFFFFF" filter="url(#fffrq0z8rl8tb)" height="113.7031" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="151.5" y="886.7656"/><rect fill="#FFFFFF" filter="url(#fffrq0z8rl8tb)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="151.5" y="1184.875"/><rect fill="#FFFFFF" filter="url(#fffrq0z8rl8tb)" height="129.9375" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="436.5" y="1495.875"/><rect fill="#FFFFFF" filter="url(#fffrq0z8rl8tb)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="721.5" y="1567.3438"/><rect fill="#FFFFFF" filter="url(#fffrq0z8rl8tb)" height="374.8125" style="stroke: #000000; stroke-width: 2.0;" width="1028" x="124" y="359.7813"/><rect fill="#FFFFFF" filter="url(#fffrq0z8rl8tb)" height="359.5781" style="stroke: #000000; stroke-width: 2.0;" width="1022" x="124" y="748.5938"/><rect fill="#FFFFFF" filter="url(#fffrq0z8rl8tb)" height="263.7656" style="stroke: #000000; stroke-width: 2.0;" width="1046" x="114" y="1122.1719"/><rect fill="#FFFFFF" filter="url(#fffrq0z8rl8tb)" height="232.5313" style="stroke: #000000; stroke-width: 2.0;" width="1026" x="124" y="1146.4063"/><rect fill="#FFFFFF" height="156.8281" style="stroke: none; stroke-width: 1.0;" width="1026" x="124" y="1222.1094"/><rect fill="#FFFFFF" filter="url(#fffrq0z8rl8tb)" height="233.875" style="stroke: #000000; stroke-width: 2.0;" width="738" x="409" y="1399.9375"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="156" x2="156" y1="93.7344" y2="1650.8125"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="441" x2="441" y1="93.7344" y2="1650.8125"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="726" x2="726" y1="93.7344" y2="1650.8125"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="822" x2="822" y1="93.7344" y2="1650.8125"/><rect fill="#FEFECE" filter="url(#fffrq0z8rl8tb)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="41" x="134" y="58.3281"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="27" x="141" y="78.3164">EST</text><rect fill="#FEFECE" filter="url(#fffrq0z8rl8tb)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="41" x="134" y="1649.8125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="27" x="141" y="1669.8008">EST</text><rect fill="#FEFECE" filter="url(#fffrq0z8rl8tb)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="41" x="419" y="58.3281"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="27" x="426" y="78.3164">DPS</text><rect fill="#FEFECE" filter="url(#fffrq0z8rl8tb)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="41" x="419" y="1649.8125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="27" x="426" y="1669.8008">DPS</text><rect fill="#FEFECE" filter="url(#fffrq0z8rl8tb)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="63" x="693" y="58.3281"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="49" x="700" y="78.3164">IoT Hub</text><rect fill="#FEFECE" filter="url(#fffrq0z8rl8tb)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="63" x="693" y="1649.8125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="49" x="700" y="1669.8008">IoT Hub</text><rect fill="#FEFECE" filter="url(#fffrq0z8rl8tb)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="100" x="770" y="58.3281"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="86" x="777" y="78.3164">Edge runtime</text><rect fill="#FEFECE" filter="url(#fffrq0z8rl8tb)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="100" x="770" y="1649.8125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="86" x="777" y="1669.8008">Edge runtime</text><rect fill="#FFFFFF" filter="url(#fffrq0z8rl8tb)" height="113.7031" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="151.5" y="513.1875"/><rect fill="#FFFFFF" filter="url(#fffrq0z8rl8tb)" height="113.7031" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="151.5" y="886.7656"/><rect fill="#FFFFFF" filter="url(#fffrq0z8rl8tb)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="151.5" y="1184.875"/><rect fill="#FFFFFF" filter="url(#fffrq0z8rl8tb)" height="129.9375" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="436.5" y="1495.875"/><rect fill="#FFFFFF" filter="url(#fffrq0z8rl8tb)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="721.5" y="1567.3438"/><path d="M8,108.7344 L8,285.7344 L1442,285.7344 L1442,118.7344 L1432,108.7344 L8,108.7344 " fill="#FBFB77" filter="url(#fffrq0z8rl8tb)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1432,108.7344 L1432,118.7344 L1442,118.7344 L1432,108.7344 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="307" x="14" y="125.7949">These are the kinds of certs involved in the EST flow:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="17" y="141.0293"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="1413" x="14" y="156.2637">1. The EST identity cert. This is the cert that the device uses for TLS client auth to authenticate itself with the EST endpoint. The device rotates this periodically via the EST enrolment workflow, using the current EST identity cert for TLS client auth.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="17" y="171.498"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="363" x="14" y="186.7324">2. The boostrap identity cert. This is the initial EST identity cert.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="17" y="201.9668"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="842" x="14" y="217.2012">3. The device CA cert. The device requests this cert from the EST endpoint if it needs it for minting any other certs locally (see the next two points).</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="17" y="232.4355"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="1242" x="14" y="247.6699">4. The device identity cert. Depending on the user's choice, the device either gets this cert from the EST endpoint (after the initial enrolment that granted it an EST identity cert), or it mints it locally via the device CA cert.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="17" y="262.9043"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="1224" x="14" y="278.1387">5. Module certs. Depending on the user's choice, the device either gets these certs from the EST endpoint (after the initial enrolment that granted it an EST identity cert), or it mints them locally via the device CA cert.</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="822" x2="864" y1="331.7813" y2="331.7813"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="864" x2="864" y1="331.7813" y2="344.7813"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="823" x2="864" y1="344.7813" y2="344.7813"/><polygon fill="#A80036" points="833,340.7813,823,344.7813,833,348.7813,829,344.7813" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="829" y="318.9902">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="840" y="311.373">At first, the bootstrap ID cert is used as the EST</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="67" x="840" y="326.6074">identity cert</text><path d="M124,359.7813 L197,359.7813 L197,366.7813 L187,376.7813 L124,376.7813 L124,359.7813 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="374.8125" style="stroke: #000000; stroke-width: 2.0;" width="1028" x="124" y="359.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="139" y="372.8418">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="250" x="212" y="371.9863">[for creating and renewing EST identity cert]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="822" x2="864" y1="398.25" y2="398.25"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="864" x2="864" y1="398.25" y2="411.25"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="823" x2="864" y1="411.25" y2="411.25"/><polygon fill="#A80036" points="833,407.25,823,411.25,833,415.25,829,411.25" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="829" y="393.0762">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="275" x="840" y="393.0762">Create TLS client using current EST identity cert</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="822" x2="864" y1="440.4844" y2="440.4844"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="864" x2="864" y1="440.4844" y2="453.4844"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="823" x2="864" y1="453.4844" y2="453.4844"/><polygon fill="#A80036" points="833,449.4844,823,453.4844,833,457.4844,829,453.4844" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="829" y="435.3105">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="300" x="840" y="435.3105">Generate new key and CSR for new EST identity cert</text><polygon fill="#A80036" points="172.5,509.1875,162.5,513.1875,172.5,517.1875,168.5,513.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="166.5" x2="821" y1="513.1875" y2="513.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="178.5" y="492.7793">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="248" x="189.5" y="477.5449">Connect using TLS client and perform EST</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="189.5" y="492.7793">enrolment to get a new EST identity cert</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="189.5" y="508.0137">corresponding to the CSR</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="161.5" x2="203.5" y1="542.4219" y2="542.4219"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="203.5" x2="203.5" y1="542.4219" y2="555.4219"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="162.5" x2="203.5" y1="555.4219" y2="555.4219"/><polygon fill="#A80036" points="172.5,551.4219,162.5,555.4219,172.5,559.4219,168.5,555.4219" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="168.5" y="537.248">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="157" x="179.5" y="537.248">Verify client cert against CA</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="161.5" x2="203.5" y1="584.6563" y2="584.6563"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="203.5" x2="203.5" y1="584.6563" y2="597.6563"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="162.5" x2="203.5" y1="597.6563" y2="597.6563"/><polygon fill="#A80036" points="172.5,593.6563,162.5,597.6563,172.5,601.6563,168.5,597.6563" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="168.5" y="579.4824">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="55" x="179.5" y="579.4824">Sign CSR</text><polygon fill="#A80036" points="810,622.8906,820,626.8906,810,630.8906,814,626.8906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="156.5" x2="816" y1="626.8906" y2="626.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="163.5" y="621.7168">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="67" x="174.5" y="621.7168">Signed cert</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="822" x2="864" y1="671.3594" y2="671.3594"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="864" x2="864" y1="671.3594" y2="684.3594"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="823" x2="864" y1="684.3594" y2="684.3594"/><polygon fill="#A80036" points="833,680.3594,823,684.3594,833,688.3594,829,684.3594" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="829" y="658.5684">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="297" x="840" y="650.9512">Set signed cert to be the EST identity cert for future</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="51" x="840" y="666.1855">requests</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="822" x2="864" y1="713.5938" y2="713.5938"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="864" x2="864" y1="713.5938" y2="726.5938"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="823" x2="864" y1="726.5938" y2="726.5938"/><polygon fill="#A80036" points="833,722.5938,823,726.5938,833,730.5938,829,726.5938" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="829" y="708.4199">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="263" x="840" y="708.4199">Wait for the EST identity cert to be near expiry</text><path d="M124,748.5938 L197,748.5938 L197,755.5938 L187,765.5938 L124,765.5938 L124,748.5938 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="359.5781" style="stroke: #000000; stroke-width: 2.0;" width="1022" x="124" y="748.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="139" y="761.6543">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="303" x="212" y="760.7988">[for creating and renewing device CA cert (if needed)]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="822" x2="864" y1="787.0625" y2="787.0625"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="864" x2="864" y1="787.0625" y2="800.0625"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="823" x2="864" y1="800.0625" y2="800.0625"/><polygon fill="#A80036" points="833,796.0625,823,800.0625,833,804.0625,829,800.0625" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="829" y="781.8887">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="275" x="847" y="781.8887">Create TLS client using current EST identity cert</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="822" x2="864" y1="829.2969" y2="829.2969"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="864" x2="864" y1="829.2969" y2="842.2969"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="823" x2="864" y1="842.2969" y2="842.2969"/><polygon fill="#A80036" points="833,838.2969,823,842.2969,833,846.2969,829,842.2969" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="829" y="824.123">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="847" y="824.123">Generate new key and CSR for new device CA cert</text><polygon fill="#A80036" points="172.5,882.7656,162.5,886.7656,172.5,890.7656,168.5,886.7656" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="166.5" x2="821" y1="886.7656" y2="886.7656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="178.5" y="873.9746">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="296" x="196.5" y="866.3574">Connect using TLS client and send request for new</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="235" x="196.5" y="881.5918">device CA cert corresponding to the CSR</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="161.5" x2="203.5" y1="916" y2="916"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="203.5" x2="203.5" y1="916" y2="929"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="162.5" x2="203.5" y1="929" y2="929"/><polygon fill="#A80036" points="172.5,925,162.5,929,172.5,933,168.5,929" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="168.5" y="910.8262">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="243" x="186.5" y="910.8262">Verify client cert against device identity CA</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="161.5" x2="203.5" y1="958.2344" y2="958.2344"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="203.5" x2="203.5" y1="958.2344" y2="971.2344"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="162.5" x2="203.5" y1="971.2344" y2="971.2344"/><polygon fill="#A80036" points="172.5,967.2344,162.5,971.2344,172.5,975.2344,168.5,971.2344" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="168.5" y="953.0605">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="55" x="186.5" y="953.0605">Sign CSR</text><polygon fill="#A80036" points="810,996.4688,820,1000.4688,810,1004.4688,814,1000.4688" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="156.5" x2="816" y1="1000.4688" y2="1000.4688"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="163.5" y="995.2949">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="67" x="181.5" y="995.2949">Signed cert</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="822" x2="864" y1="1044.9375" y2="1044.9375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="864" x2="864" y1="1044.9375" y2="1057.9375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="823" x2="864" y1="1057.9375" y2="1057.9375"/><polygon fill="#A80036" points="833,1053.9375,823,1057.9375,833,1061.9375,829,1057.9375" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="829" y="1032.1465">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="847" y="1024.5293">Set signed cert to be the device CA cert for future</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="51" x="847" y="1039.7637">requests</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="822" x2="864" y1="1087.1719" y2="1087.1719"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="864" x2="864" y1="1087.1719" y2="1100.1719"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="823" x2="864" y1="1100.1719" y2="1100.1719"/><polygon fill="#A80036" points="833,1096.1719,823,1100.1719,833,1104.1719,829,1100.1719" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="829" y="1081.998">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="847" y="1081.998">Wait for the device CA cert to be near expiry</text><path d="M114,1122.1719 L187,1122.1719 L187,1129.1719 L177,1139.1719 L114,1139.1719 L114,1122.1719 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="263.7656" style="stroke: #000000; stroke-width: 2.0;" width="1046" x="114" y="1122.1719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="129" y="1135.2324">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="266" x="202" y="1134.377">[for creating and renewing device identity cert]</text><path d="M124,1146.4063 L187,1146.4063 L187,1153.4063 L177,1163.4063 L124,1163.4063 L124,1146.4063 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="232.5313" style="stroke: #000000; stroke-width: 2.0;" width="1026" x="124" y="1146.4063"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="139" y="1159.4668">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="335" x="202" y="1158.6113">[if user configured device identity to be obtained from EST]</text><polygon fill="#A80036" points="172.5,1180.875,162.5,1184.875,172.5,1188.875,168.5,1184.875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="166.5" x2="821" y1="1184.875" y2="1184.875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="178.5" y="1179.7012">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="252" x="196.5" y="1179.7012">Similar process as for device CA cert above</text><polygon fill="#A80036" points="810,1210.1094,820,1214.1094,810,1218.1094,814,1214.1094" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="156.5" x2="816" y1="1214.1094" y2="1214.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="163.5" y="1208.9355">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="67" x="181.5" y="1208.9355">Signed cert</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="124" x2="1150" y1="1223.1094" y2="1223.1094"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="308" x="129" y="1233.3145">[if user configured device identity to be minted locally]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="822" x2="864" y1="1273.4688" y2="1273.4688"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="864" x2="864" y1="1273.4688" y2="1286.4688"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="823" x2="864" y1="1286.4688" y2="1286.4688"/><polygon fill="#A80036" points="833,1282.4688,823,1286.4688,833,1290.4688,829,1286.4688" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="829" y="1260.6777">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="288" x="847" y="1253.0605">Generate new key and CSR for new device identity</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="847" y="1268.2949">cert</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="822" x2="864" y1="1315.7031" y2="1315.7031"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="864" x2="864" y1="1315.7031" y2="1328.7031"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="823" x2="864" y1="1328.7031" y2="1328.7031"/><polygon fill="#A80036" points="833,1324.7031,823,1328.7031,833,1332.7031,829,1328.7031" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="829" y="1310.5293">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="847" y="1310.5293">Sign CSR using device CA cert</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="822" x2="864" y1="1357.9375" y2="1357.9375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="864" x2="864" y1="1357.9375" y2="1370.9375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="823" x2="864" y1="1370.9375" y2="1370.9375"/><polygon fill="#A80036" points="833,1366.9375,823,1370.9375,833,1374.9375,829,1370.9375" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="829" y="1352.7637">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="847" y="1352.7637">Wait for the device identity cert to be near expiry</text><path d="M409,1399.9375 L482,1399.9375 L482,1406.9375 L472,1416.9375 L409,1416.9375 L409,1399.9375 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="233.875" style="stroke: #000000; stroke-width: 2.0;" width="738" x="409" y="1399.9375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="424" y="1412.998">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="497" y="1412.1426">[for (re-)provisioning]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="822" x2="864" y1="1438.4063" y2="1438.4063"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="864" x2="864" y1="1438.4063" y2="1451.4063"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="823" x2="864" y1="1451.4063" y2="1451.4063"/><polygon fill="#A80036" points="833,1447.4063,823,1451.4063,833,1455.4063,829,1451.4063" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="829" y="1433.2324">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="288" x="847" y="1433.2324">Create TLS client using current device identity cert</text><polygon fill="#A80036" points="457.5,1491.875,447.5,1495.875,457.5,1499.875,453.5,1495.875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="451.5" x2="821" y1="1495.875" y2="1495.875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="463.5" y="1483.084">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="481.5" y="1475.4668">Connect using TLS client and send provisioning</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="44" x="481.5" y="1490.7012">request</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="446.5" x2="488.5" y1="1525.1094" y2="1525.1094"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="488.5" x2="488.5" y1="1525.1094" y2="1538.1094"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="447.5" x2="488.5" y1="1538.1094" y2="1538.1094"/><polygon fill="#A80036" points="457.5,1534.1094,447.5,1538.1094,457.5,1542.1094,453.5,1538.1094" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="453.5" y="1519.9355">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="243" x="471.5" y="1519.9355">Verify client cert against device identity CA</text><polygon fill="#A80036" points="709.5,1563.3438,719.5,1567.3438,709.5,1571.3438,713.5,1567.3438" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="446.5" x2="715.5" y1="1567.3438" y2="1567.3438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="453.5" y="1562.1699">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="471.5" y="1562.1699">Register device</text><polygon fill="#A80036" points="457.5,1592.5781,447.5,1596.5781,457.5,1600.5781,453.5,1596.5781" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="451.5" x2="725.5" y1="1596.5781" y2="1596.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="463.5" y="1591.4043">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="484.5" y="1591.4043"/><polygon fill="#A80036" points="810,1621.8125,820,1625.8125,810,1629.8125,814,1625.8125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="441.5" x2="816" y1="1625.8125" y2="1625.8125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="448.5" y="1620.6387">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="466.5" y="1620.6387">Provisioning info (IoT Hub + device identity)</text><!--MD5=[5ccbd613b66790c2a9f7e6965cb871e6]
@startuml

title Device Provisioning
skinparam maxMessageSize 300

participant "EST" as est
participant "DPS" as dps
participant "IoT Hub" as hub

box Device #LightBlue
	participant "Edge runtime" as runtime
end box

autonumber

note over hub
These are the kinds of certs involved in the EST flow:

1. The EST identity cert. This is the cert that the device uses for TLS client auth to authenticate itself with the EST endpoint. The device rotates this periodically via the EST enrolment workflow, using the current EST identity cert for TLS client auth.

2. The boostrap identity cert. This is the initial EST identity cert.

3. The device CA cert. The device requests this cert from the EST endpoint if it needs it for minting any other certs locally (see the next two points).

4. The device identity cert. Depending on the user's choice, the device either gets this cert from the EST endpoint (after the initial enrolment that granted it an EST identity cert), or it mints it locally via the device CA cert.

5. Module certs. Depending on the user's choice, the device either gets these certs from the EST endpoint (after the initial enrolment that granted it an EST identity cert), or it mints them locally via the device CA cert.
end note

runtime -> runtime: At first, the bootstrap ID cert is used as the EST identity cert

loop for creating and renewing EST identity cert
	runtime -> runtime: Create TLS client using current EST identity cert
	runtime -> runtime: Generate new key and CSR for new EST identity cert
	runtime -> est ++: Connect using TLS client and perform EST enrolment to get a new EST identity cert corresponding to the CSR
	est -> est: Verify client cert against CA
	est -> est: Sign CSR
	return Signed cert
	runtime -> runtime: Set signed cert to be the EST identity cert for future requests
	runtime -> runtime: Wait for the EST identity cert to be near expiry
end

loop for creating and renewing device CA cert (if needed)
	runtime -> runtime: Create TLS client using current EST identity cert
	runtime -> runtime: Generate new key and CSR for new device CA cert
	runtime -> est ++: Connect using TLS client and send request for new device CA cert corresponding to the CSR
	est -> est: Verify client cert against device identity CA
	est -> est: Sign CSR
	return Signed cert
	runtime -> runtime: Set signed cert to be the device CA cert for future requests
	runtime -> runtime: Wait for the device CA cert to be near expiry
end

loop for creating and renewing device identity cert
	alt if user configured device identity to be obtained from EST
		runtime -> est ++: Similar process as for device CA cert above
		return Signed cert

	else if user configured device identity to be minted locally
		runtime -> runtime: Generate new key and CSR for new device identity cert
		runtime -> runtime: Sign CSR using device CA cert
		runtime -> runtime: Wait for the device identity cert to be near expiry

	end
end

loop for (re-)provisioning
	runtime -> runtime: Create TLS client using current device identity cert

	runtime -> dps ++: Connect using TLS client and send provisioning request
	dps -> dps: Verify client cert against device identity CA
	dps -> hub ++: Register device
	return
	return Provisioning info (IoT Hub + device identity)
end

@enduml

PlantUML version 1.2020.09(Sun May 10 03:51:06 PDT 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 11.0.7+10-suse-1.3-x8664
Operating System: Linux
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>