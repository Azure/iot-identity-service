<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1944px" preserveAspectRatio="none" style="width:1447px;height:1944px;" version="1.1" viewBox="0 0 1447 1944" width="1447px" zoomAndPan="magnify"><defs><filter height="300%" id="f1e2o4c2zqpi3o" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#ADD8E6" height="1929.7188" style="stroke: #A80036; stroke-width: 1.0;" width="705.5" x="725" y="4"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="42" x="1056.75" y="16.0605">Device</text><rect fill="#FFFFFF" filter="url(#f1e2o4c2zqpi3o)" height="368.9844" style="stroke: #000000; stroke-width: 2.0;" width="549.5" x="13" y="92.0469"/><rect fill="#FFFFFF" filter="url(#f1e2o4c2zqpi3o)" height="135.4063" style="stroke: #000000; stroke-width: 2.0;" width="673" x="140" y="475.0313"/><rect fill="#FFFFFF" filter="url(#f1e2o4c2zqpi3o)" height="1237.4688" style="stroke: #000000; stroke-width: 2.0;" width="1296.5" x="140" y="624.4375"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="188" x2="188" y1="75.0469" y2="1878.9063"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="269" x2="269" y1="75.0469" y2="1878.9063"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="400.5" x2="400.5" y1="75.0469" y2="1878.9063"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="474.5" x2="474.5" y1="75.0469" y2="1878.9063"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="529.5" x2="529.5" y1="75.0469" y2="1878.9063"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="766" x2="766" y1="75.0469" y2="1878.9063"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="994.5" x2="994.5" y1="1113.3594" y2="1878.9063"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1165" x2="1165" y1="1320.4063" y2="1878.9063"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1391.5" x2="1391.5" y1="1374.0156" y2="1878.9063"/><rect fill="#FEFECE" filter="url(#f1e2o4c2zqpi3o)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="72" x="150" y="39.6406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="58" x="157" y="59.6289">Operator</text><rect fill="#FEFECE" filter="url(#f1e2o4c2zqpi3o)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="72" x="150" y="1877.9063"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="58" x="157" y="1897.8945">Operator</text><rect fill="#FEFECE" filter="url(#f1e2o4c2zqpi3o)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="63" x="236" y="39.6406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="49" x="243" y="59.6289">IoT Hub</text><rect fill="#FEFECE" filter="url(#f1e2o4c2zqpi3o)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="63" x="236" y="1877.9063"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="49" x="243" y="1897.8945">IoT Hub</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="77" x="359.5" y="71.6289">Edge device</text><ellipse cx="401" cy="42.6406" fill="#FEFECE" filter="url(#f1e2o4c2zqpi3o)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="389" x2="413" y1="56.6406" y2="56.6406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="77" x="359.5" y="1890.8945">Edge device</text><ellipse cx="401" cy="1910.3125" fill="#FEFECE" filter="url(#f1e2o4c2zqpi3o)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="389" x2="413" y1="1924.3125" y2="1924.3125"/><rect fill="#FEFECE" filter="url(#f1e2o4c2zqpi3o)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="41" x="452.5" y="39.6406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="27" x="459.5" y="59.6289">DPS</text><rect fill="#FEFECE" filter="url(#f1e2o4c2zqpi3o)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="41" x="452.5" y="1877.9063"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="27" x="459.5" y="1897.8945">DPS</text><rect fill="#FEFECE" filter="url(#f1e2o4c2zqpi3o)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="41" x="507.5" y="39.6406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="27" x="514.5" y="59.6289">EST</text><rect fill="#FEFECE" filter="url(#f1e2o4c2zqpi3o)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="41" x="507.5" y="1877.9063"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="27" x="514.5" y="1897.8945">EST</text><rect fill="#FEFECE" filter="url(#f1e2o4c2zqpi3o)" height="46.8125" style="stroke: #A80036; stroke-width: 1.5;" width="70" x="729" y="23.2344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="56" x="736" y="43.2227">IoT Edge</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="51" x="738.5" y="59.6289">runtime</text><rect fill="#FEFECE" filter="url(#f1e2o4c2zqpi3o)" height="46.8125" style="stroke: #A80036; stroke-width: 1.5;" width="70" x="729" y="1877.9063"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="56" x="736" y="1897.8945">IoT Edge</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="51" x="738.5" y="1914.3008">runtime</text><rect fill="#FEFECE" filter="url(#f1e2o4c2zqpi3o)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="85" x="950.5" y="1877.9063"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="71" x="957.5" y="1897.8945">EdgeAgent</text><rect fill="#FEFECE" filter="url(#f1e2o4c2zqpi3o)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="71" x="1128" y="1877.9063"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="57" x="1135" y="1897.8945">EdgeHub</text><rect fill="#FEFECE" filter="url(#f1e2o4c2zqpi3o)" height="46.8125" style="stroke: #A80036; stroke-width: 1.5;" width="66" x="1356.5" y="1877.9063"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="52" x="1363.5" y="1897.8945">Custom</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="47" x="1366" y="1914.3008">Module</text><path d="M13,92.0469 L137,92.0469 L137,99.0469 L127,109.0469 L13,109.0469 L13,92.0469 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="368.9844" style="stroke: #000000; stroke-width: 2.0;" width="549.5" x="13" y="92.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="79" x="28" y="105.1074">Initial Setup</text><polygon fill="#A80036" points="518,141.75,528,145.75,518,149.75,522,145.75" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="188" x2="524" y1="145.75" y2="145.75"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="195" y="132.959">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="206" y="125.3418">Register CA signing Cert (CA1)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="131" x="206" y="140.5762">for signing certificates</text><polygon fill="#A80036" points="518,186.2188,528,190.2188,518,194.2188,522,190.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="188" x2="524" y1="190.2188" y2="190.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="195" y="177.4277">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="206" y="169.8105">Register Identity CA Cert (CA2)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="206" y="185.0449">for signing identity certificates</text><path d="M23,203.2188 L23,243.2188 L349,243.2188 L349,213.2188 L339,203.2188 L23,203.2188 " fill="#FBFB77" filter="url(#f1e2o4c2zqpi3o)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M339,203.2188 L339,213.2188 L349,213.2188 L339,203.2188 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="188" x="29" y="220.2793">CA1 and CA2 should be different</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="305" x="29" y="235.5137">because device does have the CA cert signed by CA1</text><polygon fill="#A80036" points="518,315.625,528,319.625,518,323.625,522,319.625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="188" x2="524" y1="319.625" y2="319.625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="195" y="291.5996">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="186" x="206" y="268.748">Register EST authentication cert</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="33" x="206" y="283.9824">ESTC</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="206" y="299.2168">(Used to authenticate against the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="206" y="314.4512">EST server)</text><polygon fill="#A80036" points="463,360.0938,473,364.0938,463,368.0938,467,364.0938" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="188" x2="469" y1="364.0938" y2="364.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="195" y="351.3027">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="206" y="343.6855">Create group enrollment with</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="206" y="358.9199">Identity CA Certificate (CA2)</text><polygon fill="#A80036" points="389,404.5625,399,408.5625,389,412.5625,393,408.5625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="188" x2="395" y1="408.5625" y2="408.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="195" y="395.7715">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170" x="206" y="388.1543">Install DIdC on the device (file</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="94" x="206" y="403.3887">system or HSM)</text><polygon fill="#A80036" points="389,449.0313,399,453.0313,389,457.0313,393,453.0313" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="188" x2="395" y1="453.0313" y2="453.0313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="195" y="440.2402">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="206" y="432.623">Install ESTC on the device (file</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="94" x="206" y="447.8574">system or HSM)</text><path d="M140,475.0313 L386,475.0313 L386,482.0313 L376,492.0313 L140,492.0313 L140,475.0313 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="135.4063" style="stroke: #000000; stroke-width: 2.0;" width="673" x="140" y="475.0313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="201" x="155" y="488.0918">Device setup and configuration</text><polygon fill="#A80036" points="754,524.7344,764,528.7344,754,532.7344,758,528.7344" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="188" x2="760" y1="528.7344" y2="528.7344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="195" y="515.9434">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="206" y="508.3262">Configure device to sign</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="206" y="523.5605">certificates using EST server</text><polygon fill="#A80036" points="754,569.2031,764,573.2031,754,577.2031,758,573.2031" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="188" x2="760" y1="573.2031" y2="573.2031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="195" y="560.4121">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="206" y="552.7949">Configure device for DPS</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="206" y="568.0293">provisioning</text><polygon fill="#A80036" points="754,598.4375,764,602.4375,754,606.4375,758,602.4375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="188" x2="760" y1="602.4375" y2="602.4375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="195" y="597.2637">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="206" y="597.2637">Configure EdgeAgent</text><path d="M140,624.4375 L280,624.4375 L280,631.4375 L270,641.4375 L140,641.4375 L140,624.4375 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1237.4688" style="stroke: #000000; stroke-width: 2.0;" width="1296.5" x="140" y="624.4375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="95" x="155" y="637.498">Device running</text><polygon fill="#A80036" points="754,658.9063,764,662.9063,754,666.9063,758,662.9063" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="188" x2="760" y1="662.9063" y2="662.9063"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="195" y="657.7324">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="213" y="657.7324">Start IoT Edge runtime</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="766" x2="808" y1="707.375" y2="707.375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="808" x2="808" y1="707.375" y2="720.375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="767" x2="808" y1="720.375" y2="720.375"/><polygon fill="#A80036" points="777,716.375,767,720.375,777,724.375,773,720.375" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="773" y="694.584">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="791" y="686.9668">Generate CSR to get idenitity cert (</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="33" x="791" y="702.2012">DIdC)</text><polygon fill="#A80036" points="541,745.6094,531,749.6094,541,753.6094,537,749.6094" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="535" x2="765" y1="749.6094" y2="749.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="547" y="744.4355">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="115" x="565" y="744.4355">CSR for identity cert</text><polygon fill="#A80036" points="754,774.8438,764,778.8438,754,782.8438,758,778.8438" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="530" x2="760" y1="778.8438" y2="778.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="537" y="773.6699">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="555" y="773.6699">Identity cert DIdC signed with CA2</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="766" x2="808" y1="823.3125" y2="823.3125"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="808" x2="808" y1="823.3125" y2="836.3125"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="767" x2="808" y1="836.3125" y2="836.3125"/><polygon fill="#A80036" points="777,832.3125,767,836.3125,777,840.3125,773,836.3125" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="773" y="810.5215">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="177" x="791" y="802.9043">Generate CSR to get device CA</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="67" x="791" y="818.1387">cert (DCAC)</text><polygon fill="#A80036" points="541,861.5469,531,865.5469,541,869.5469,537,865.5469" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="535" x2="765" y1="865.5469" y2="865.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="547" y="860.373">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="565" y="860.373">CSR for CA cert</text><polygon fill="#A80036" points="754,906.0156,764,910.0156,754,914.0156,758,910.0156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="530" x2="760" y1="910.0156" y2="910.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="537" y="897.2246">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="555" y="889.6074">Device CA Cert DCAC signed with</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="555" y="904.8418">CA1</text><polygon fill="#A80036" points="486,950.4844,476,954.4844,486,958.4844,482,954.4844" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="480" x2="765" y1="954.4844" y2="954.4844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="492" y="941.6934">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="94" x="510" y="934.0762">Provision device</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="55" x="510" y="949.3105">with DIdC</text><polygon fill="#A80036" points="280.5,994.9531,270.5,998.9531,280.5,1002.9531,276.5,998.9531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="274.5" x2="474" y1="998.9531" y2="998.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="286.5" y="986.1621">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="304.5" y="978.5449">Create device with</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="131" x="304.5" y="993.7793">thumbprint based auth</text><polygon fill="#A80036" points="463,1024.1875,473,1028.1875,463,1032.1875,467,1028.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="269.5" x2="469" y1="1028.1875" y2="1028.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="276.5" y="1023.0137">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="294.5" y="1023.0137">Device info</text><polygon fill="#A80036" points="754,1068.6563,764,1072.6563,754,1076.6563,758,1072.6563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="475" x2="760" y1="1072.6563" y2="1072.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="482" y="1059.8652">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="500" y="1052.248">Provisioning info</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="500" y="1067.4824">(IoTHub + deviceId)</text><polygon fill="#A80036" points="938.5,1097.8906,948.5,1101.8906,938.5,1105.8906,942.5,1101.8906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="766" x2="944.5" y1="1101.8906" y2="1101.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="773" y="1096.7168">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="791" y="1096.7168">Create and start</text><rect fill="#FEFECE" filter="url(#f1e2o4c2zqpi3o)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="85" x="950.5" y="1080.6563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="71" x="957.5" y="1100.6445">EdgeAgent</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="995" x2="1037" y1="1147.2969" y2="1147.2969"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1037" x2="1037" y1="1147.2969" y2="1160.2969"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="996" x2="1037" y1="1160.2969" y2="1160.2969"/><polygon fill="#A80036" points="1006,1156.2969,996,1160.2969,1006,1164.2969,1002,1160.2969" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1002" y="1142.123">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="1020" y="1142.123">Process deployment</text><polygon fill="#A80036" points="777,1216,767,1220,777,1224,773,1220" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="771" x2="994" y1="1220" y2="1220"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="783" y="1199.5918">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="801" y="1184.3574">Update credentials for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="801" y="1199.5918">EdgeAgent and EdgeHub with</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="801" y="1214.8262">SAS auth</text><polygon fill="#A80036" points="280.5,1275.7031,270.5,1279.7031,280.5,1283.7031,276.5,1279.7031" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="274.5" x2="765" y1="1279.7031" y2="1279.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="286.5" y="1259.2949">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="304.5" y="1244.0605">Update credentials for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="304.5" y="1259.2949">EdgeAgent and EdgeHub with</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="304.5" y="1274.5293">SAS auth</text><polygon fill="#A80036" points="1116,1304.9375,1126,1308.9375,1116,1312.9375,1120,1308.9375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="995" x2="1122" y1="1308.9375" y2="1308.9375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1002" y="1303.7637">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="1020" y="1303.7637">Create and start</text><rect fill="#FEFECE" filter="url(#f1e2o4c2zqpi3o)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="71" x="1128" y="1287.7031"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="57" x="1135" y="1307.6914">EdgeHub</text><polygon fill="#A80036" points="1344.5,1350.3438,1354.5,1354.3438,1344.5,1358.3438,1348.5,1354.3438" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="995" x2="1350.5" y1="1354.3438" y2="1354.3438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1002" y="1349.1699">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="1020" y="1349.1699">Create and start</text><rect fill="#FEFECE" filter="url(#f1e2o4c2zqpi3o)" height="46.8125" style="stroke: #A80036; stroke-width: 1.5;" width="66" x="1356.5" y="1333.1094"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="52" x="1363.5" y="1353.0977">Custom</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="47" x="1366" y="1369.5039">Module</text><polygon fill="#A80036" points="777,1412.1563,767,1416.1563,777,1420.1563,773,1416.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="771" x2="1164.5" y1="1416.1563" y2="1416.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="783" y="1410.9824">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="801" y="1410.9824">Get server cert</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="766" x2="808" y1="1445.3906" y2="1445.3906"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="808" x2="808" y1="1445.3906" y2="1458.3906"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="767" x2="808" y1="1458.3906" y2="1458.3906"/><polygon fill="#A80036" points="777,1454.3906,767,1458.3906,777,1462.3906,773,1458.3906" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="773" y="1440.2168">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="182" x="791" y="1440.2168">Generate server cert from DCAC</text><polygon fill="#A80036" points="1153.5,1483.625,1163.5,1487.625,1153.5,1491.625,1157.5,1487.625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="766" x2="1159.5" y1="1487.625" y2="1487.625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="773" y="1482.4512">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="791" y="1482.4512">Server cert</text><polygon fill="#A80036" points="777,1512.8594,767,1516.8594,777,1520.8594,773,1516.8594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="771" x2="1390.5" y1="1516.8594" y2="1516.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="783" y="1511.6855">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="801" y="1511.6855">Get local identity</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="766" x2="808" y1="1546.0938" y2="1546.0938"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="808" x2="808" y1="1546.0938" y2="1559.0938"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="767" x2="808" y1="1559.0938" y2="1559.0938"/><polygon fill="#A80036" points="777,1555.0938,767,1559.0938,777,1563.0938,773,1559.0938" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="773" y="1540.9199">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="178" x="791" y="1540.9199">Generate client cert from DCAC</text><polygon fill="#A80036" points="1379.5,1584.3281,1389.5,1588.3281,1379.5,1592.3281,1383.5,1588.3281" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="766" x2="1385.5" y1="1588.3281" y2="1588.3281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="773" y="1583.1543">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="791" y="1583.1543">Module local identity</text><polygon fill="#A80036" points="1176.5,1613.5625,1166.5,1617.5625,1176.5,1621.5625,1172.5,1617.5625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1170.5" x2="1390.5" y1="1617.5625" y2="1617.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1182.5" y="1612.3887">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="1200.5" y="1612.3887">Connect using mutual TLS auth</text><polygon fill="#A80036" points="1176.5,1658.0313,1166.5,1662.0313,1176.5,1666.0313,1172.5,1662.0313" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1170.5" x2="1390.5" y1="1662.0313" y2="1662.0313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1182.5" y="1649.2402">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="1200.5" y="1641.623">Pub/sub to MQTT Broker using</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="1200.5" y="1656.8574">custom topics</text><polygon fill="#A80036" points="777,1687.2656,767,1691.2656,777,1695.2656,773,1691.2656" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="771" x2="1164.5" y1="1691.2656" y2="1691.2656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="783" y="1686.0918">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="801" y="1686.0918">Get IoTHub identity</text><polygon fill="#A80036" points="1153.5,1731.7344,1163.5,1735.7344,1153.5,1739.7344,1157.5,1735.7344" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="766" x2="1159.5" y1="1735.7344" y2="1735.7344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="773" y="1722.9434">36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="791" y="1715.3262">Identity info (IoTHub + deviceId +</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="187" x="791" y="1730.5605">generation Id + credentials type)</text><polygon fill="#A80036" points="777,1760.9688,767,1764.9688,777,1768.9688,773,1764.9688" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="771" x2="1164.5" y1="1764.9688" y2="1764.9688"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="783" y="1759.7949">37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="801" y="1759.7949">Sign token</text><polygon fill="#A80036" points="1153.5,1805.4375,1163.5,1809.4375,1153.5,1813.4375,1157.5,1809.4375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="766" x2="1159.5" y1="1809.4375" y2="1809.4375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="773" y="1796.6465">38</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="791" y="1789.0293">Token signed with EdgeHub's</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="791" y="1804.2637">SAS Key</text><polygon fill="#A80036" points="280.5,1849.9063,270.5,1853.9063,280.5,1857.9063,276.5,1853.9063" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="274.5" x2="1164.5" y1="1853.9063" y2="1853.9063"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="286.5" y="1841.1152">39</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="304.5" y="1833.498">Connect using token and forward</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="304.5" y="1848.7324">telemetry</text><!--MD5=[82400b5d013a09374859690b0cade018]
@startuml
skinparam maxMessageSize 200

participant "Operator" as oem
participant "IoT Hub" as ih
entity "Edge device" as device
participant "DPS" as dps
participant "EST" as est

box "Device" #LightBlue 
participant "IoT Edge\nruntime" as ie
participant "EdgeAgent" as ea
participant "EdgeHub" as eh
participant "Custom\nModule" as cm
end box 

autonumber 

group Initial Setup 
oem->est : Register CA signing Cert (CA1)\nfor signing certificates
oem->est : Register Identity CA Cert (CA2)\nfor signing identity certificates
note over oem: CA1 and CA2 should be different\nbecause device does have the CA cert signed by CA1
oem->est : Register EST authentication cert ESTC\n(Used to authenticate against the EST server)
oem->dps : Create group enrollment with Identity CA Certificate (CA2) 
oem->device : Install DIdC on the device (file system or HSM) 
oem->device : Install ESTC on the device (file system or HSM)
end 

group Device setup and configuration
oem->ie : Configure device to sign certificates using EST server
oem->ie : Configure device for DPS provisioning
oem->ie : Configure EdgeAgent
end

group Device running
oem -> ie : Start IoT Edge runtime

ie -> ie : Generate CSR to get idenitity cert (DIdC)
ie -> est : CSR for identity cert
return Identity cert DIdC signed with CA2

ie -> ie : Generate CSR to get device CA cert (DCAC)
ie -> est : CSR for CA cert
return Device CA Cert DCAC signed with CA1

ie -> dps : Provision device\nwith DIdC
dps -> ih : Create device with\nthumbprint based auth
return Device info
dps - -> ie: Provisioning info\n(IoTHub + deviceId)

ie -> ea ** : Create and start
ea -> ea : Process deployment
ea -> ie : Update credentials for\nEdgeAgent and EdgeHub with SAS auth
ie -> ih : Update credentials for\nEdgeAgent and EdgeHub with SAS auth

ea -> eh ** : Create and start
ea -> cm ** : Create and start

eh -> ie : Get server cert
ie -> ie : Generate server cert from DCAC
ie - -> eh : Server cert

cm -> ie : Get local identity
ie -> ie : Generate client cert from DCAC
ie - -> cm : Module local identity

cm -> eh : Connect using mutual TLS auth
cm -> eh : Pub/sub to MQTT Broker using custom topics

eh -> ie : Get IoTHub identity
return Identity info (IoTHub + deviceId + generation Id + credentials type)
eh -> ie : Sign token 
return Token signed with EdgeHub's SAS Key
eh -> ih : Connect using token and forward telemetry
end
@enduml

PlantUML version 1.2020.09(Sun May 10 03:51:06 PDT 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 11.0.7+10-suse-1.3-x8664
Operating System: Linux
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>