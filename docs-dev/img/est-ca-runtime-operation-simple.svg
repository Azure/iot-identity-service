<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="3188px" preserveAspectRatio="none" style="width:1804px;height:3188px;" version="1.1" viewBox="0 0 1804 3188" width="1804px" zoomAndPan="magnify"><defs><filter height="300%" id="f735j1mxl357c" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="151" x="823.75" y="26.6992">Runtime Operation</text><rect fill="#ADD8E6" height="3137.9531" style="stroke: #A80036; stroke-width: 1.0;" width="1152" x="627.5" y="39.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="42" x="1181" y="51.1543">Device</text><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="113.7031" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="70.5" y="2382.1875"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="342.5" y="304.7813"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="101.9375" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="342.5" y="560.6563"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="342.5" y="795.7656"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="101.9375" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="342.5" y="1100.0469"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="342.5" y="1231.2188"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="342.5" y="1415.8594"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="101.9375" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="342.5" y="2988.2969"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="680.5" y="401.4844"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="680.5" y="459.9531"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="128.9375" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="680.5" y="899.6406"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="160.4063" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="680.5" y="1313.9219"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="680.5" y="1503.5625"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="71.4688" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="680.5" y="1856.125"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="675" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="680.5" y="1971.7188"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="40.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="685.5" y="2033.1875"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="40.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="685.5" y="2132.5469"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="44.4688" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="680.5" y="2714.1875"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="128.9375" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="680.5" y="2787.8906"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="221.875" style="stroke: #000000; stroke-width: 2.0;" width="711.5" x="294" y="127.1406"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="148.4063" style="stroke: #000000; stroke-width: 2.0;" width="674.5" x="304" y="193.6094"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="307.5781" style="stroke: #000000; stroke-width: 2.0;" width="951.5" x="304" y="363.0156"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="970.4219" style="stroke: #000000; stroke-width: 2.0;" width="1491.5" x="294" y="684.5938"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="265.3438" style="stroke: #000000; stroke-width: 2.0;" width="1001" x="304" y="1275.4531"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="1436.2188" style="stroke: #000000; stroke-width: 2.0;" width="1742.5" x="13" y="1669.0156"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="968.4688" style="stroke: #000000; stroke-width: 2.0;" width="1530" x="23" y="1693.25"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="837.0625" style="stroke: #000000; stroke-width: 2.0;" width="1510" x="33" y="1817.6563"/><rect fill="#FFFFFF" height="719.125" style="stroke: none; stroke-width: 1.0;" width="1510" x="33" y="1935.5938"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="243.2969" style="stroke: #000000; stroke-width: 2.0;" width="342" x="621.5" y="1986.7188"/><rect fill="#FFFFFF" height="141.5938" style="stroke: none; stroke-width: 1.0;" width="342" x="621.5" y="2088.4219"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="274.7656" style="stroke: #000000; stroke-width: 2.0;" width="959.5" x="43" y="2286.25"/><rect fill="#FFFFFF" height="57.125" style="stroke: none; stroke-width: 1.0;" width="959.5" x="43" y="2503.8906"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="422.5156" style="stroke: #000000; stroke-width: 2.0;" width="1441.5" x="304" y="2675.7188"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="75" x2="75" y1="110.1406" y2="3122.2344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="347" x2="347" y1="110.1406" y2="3122.2344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="685.5" x2="685.5" y1="110.1406" y2="3122.2344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1007.5" x2="1007.5" y1="110.1406" y2="3122.2344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1250" x2="1250" y1="865.7031" y2="3122.2344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1495" x2="1495" y1="1580.5" y2="3122.2344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1740.5" x2="1740.5" y1="1634.1094" y2="3122.2344"/><rect fill="#FEFECE" filter="url(#f735j1mxl357c)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="41" x="53" y="74.7344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="27" x="60" y="94.7227">EST</text><rect fill="#FEFECE" filter="url(#f735j1mxl357c)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="41" x="53" y="3121.2344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="27" x="60" y="3141.2227">EST</text><rect fill="#FEFECE" filter="url(#f735j1mxl357c)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="63" x="314" y="74.7344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="49" x="321" y="94.7227">IoT Hub</text><rect fill="#FEFECE" filter="url(#f735j1mxl357c)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="63" x="314" y="3121.2344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="49" x="321" y="3141.2227">IoT Hub</text><rect fill="#FEFECE" filter="url(#f735j1mxl357c)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="104" x="631.5" y="74.7344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="638.5" y="94.7227">Edge Runtime</text><rect fill="#FEFECE" filter="url(#f735j1mxl357c)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="104" x="631.5" y="3121.2344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="638.5" y="3141.2227">Edge Runtime</text><rect fill="#FEFECE" filter="url(#f735j1mxl357c)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="102" x="954.5" y="74.7344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="88" x="961.5" y="94.7227">Host Process</text><rect fill="#FEFECE" filter="url(#f735j1mxl357c)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="102" x="954.5" y="3121.2344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="88" x="961.5" y="3141.2227">Host Process</text><rect fill="#FEFECE" filter="url(#f735j1mxl357c)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="85" x="1206" y="3121.2344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="71" x="1213" y="3141.2227">EdgeAgent</text><rect fill="#FEFECE" filter="url(#f735j1mxl357c)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="71" x="1458" y="3121.2344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="57" x="1465" y="3141.2227">EdgeHub</text><rect fill="#FEFECE" filter="url(#f735j1mxl357c)" height="46.8125" style="stroke: #A80036; stroke-width: 1.5;" width="66" x="1705.5" y="3121.2344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="52" x="1712.5" y="3141.2227">Custom</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="47" x="1715" y="3157.6289">Module</text><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="113.7031" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="70.5" y="2382.1875"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="342.5" y="304.7813"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="101.9375" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="342.5" y="560.6563"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="342.5" y="795.7656"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="101.9375" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="342.5" y="1100.0469"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="342.5" y="1231.2188"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="342.5" y="1415.8594"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="101.9375" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="342.5" y="2988.2969"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="680.5" y="401.4844"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="680.5" y="459.9531"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="128.9375" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="680.5" y="899.6406"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="160.4063" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="680.5" y="1313.9219"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="29.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="680.5" y="1503.5625"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="71.4688" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="680.5" y="1856.125"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="675" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="680.5" y="1971.7188"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="40.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="685.5" y="2033.1875"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="40.2344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="685.5" y="2132.5469"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="44.4688" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="680.5" y="2714.1875"/><rect fill="#FFFFFF" filter="url(#f735j1mxl357c)" height="128.9375" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="680.5" y="2787.8906"/><path d="M294,127.1406 L462,127.1406 L462,134.1406 L452,144.1406 L294,144.1406 L294,127.1406 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="221.875" style="stroke: #000000; stroke-width: 2.0;" width="711.5" x="294" y="127.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="123" x="309" y="140.2012">Host-level modules</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="685.5" x2="727.5" y1="165.6094" y2="165.6094"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="727.5" x2="727.5" y1="165.6094" y2="178.6094"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="686.5" x2="727.5" y1="178.6094" y2="178.6094"/><polygon fill="#A80036" points="696.5,174.6094,686.5,178.6094,696.5,182.6094,692.5,178.6094" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="692.5" y="160.4355">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="290" x="703.5" y="160.4355">Read host-level module names from configuration</text><path d="M304,193.6094 L377,193.6094 L377,200.6094 L367,210.6094 L304,210.6094 L304,193.6094 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="148.4063" style="stroke: #000000; stroke-width: 2.0;" width="674.5" x="304" y="193.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="319" y="206.6699">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="222" x="392" y="205.8145">[for creating each host-level module M]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="685.5" x2="727.5" y1="247.3125" y2="247.3125"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="727.5" x2="727.5" y1="247.3125" y2="260.3125"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="686.5" x2="727.5" y1="260.3125" y2="260.3125"/><polygon fill="#A80036" points="696.5,256.3125,686.5,260.3125,696.5,264.3125,692.5,260.3125" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="692.5" y="234.5215">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="249" x="703.5" y="226.9043">Derive Edge Hub SAS keys from its name +</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="263" x="703.5" y="242.1387">generation ID using the master encryption key</text><polygon fill="#A80036" points="363.5,300.7813,353.5,304.7813,363.5,308.7813,359.5,304.7813" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="357.5" x2="684.5" y1="304.7813" y2="304.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="369.5" y="291.9902">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256" x="380.5" y="284.373">Create identity for module M and register the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="380.5" y="299.6074">derived SAS keys for it</text><polygon fill="#A80036" points="673.5,330.0156,683.5,334.0156,673.5,338.0156,677.5,334.0156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="347.5" x2="679.5" y1="334.0156" y2="334.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="354.5" y="328.8418">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="368.5" y="328.8418"/><path d="M304,363.0156 L500,363.0156 L500,370.0156 L490,380.0156 L304,380.0156 L304,363.0156 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="307.5781" style="stroke: #000000; stroke-width: 2.0;" width="951.5" x="304" y="363.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="151" x="319" y="376.0762">Host process operation</text><polygon fill="#A80036" points="701.5,397.4844,691.5,401.4844,701.5,405.4844,697.5,401.4844" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="695.5" x2="1006.5" y1="401.4844" y2="401.4844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="707.5" y="396.3105">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="718.5" y="396.3105">Get identity for Host process</text><polygon fill="#A80036" points="995.5,426.7188,1005.5,430.7188,995.5,434.7188,999.5,430.7188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="685.5" x2="1001.5" y1="430.7188" y2="430.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="692.5" y="425.5449">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="706.5" y="425.5449"/><polygon fill="#A80036" points="701.5,455.9531,691.5,459.9531,701.5,463.9531,697.5,459.9531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="695.5" x2="1006.5" y1="459.9531" y2="459.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="707.5" y="454.7793">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="246" x="718.5" y="454.7793">Get SAS token for identifying with IoT Hub</text><polygon fill="#A80036" points="995.5,485.1875,1005.5,489.1875,995.5,493.1875,999.5,489.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="685.5" x2="1001.5" y1="489.1875" y2="489.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="692.5" y="484.0137">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="706.5" y="484.0137"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1007.5" x2="1049.5" y1="518.4219" y2="518.4219"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1049.5" x2="1049.5" y1="518.4219" y2="531.4219"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1008.5" x2="1049.5" y1="531.4219" y2="531.4219"/><polygon fill="#A80036" points="1018.5,527.4219,1008.5,531.4219,1018.5,535.4219,1014.5,531.4219" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="1014.5" y="513.248">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="1025.5" y="513.248">Create IoT Hub client using Sas token</text><polygon fill="#A80036" points="363.5,556.6563,353.5,560.6563,363.5,564.6563,359.5,560.6563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="357.5" x2="1006.5" y1="560.6563" y2="560.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="369.5" y="555.4824">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="387.5" y="555.4824">Connect to Iot Hub</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="352.5" x2="394.5" y1="620.3594" y2="620.3594"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="394.5" x2="394.5" y1="620.3594" y2="633.3594"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="353.5" x2="394.5" y1="633.3594" y2="633.3594"/><polygon fill="#A80036" points="363.5,629.3594,353.5,633.3594,363.5,637.3594,359.5,633.3594" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="359.5" y="599.9512">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="262" x="377.5" y="584.7168">Validate SAS token against SAS key that was</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256" x="377.5" y="599.9512">registered when the Edge Agent identity was</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="377.5" y="615.1855">created by the runtime</text><polygon fill="#A80036" points="995.5,658.5938,1005.5,662.5938,995.5,666.5938,999.5,662.5938" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="347.5" x2="1001.5" y1="662.5938" y2="662.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="354.5" y="657.4199">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="17" x="372.5" y="657.4199">OK</text><path d="M294,684.5938 L477,684.5938 L477,691.5938 L467,701.5938 L294,701.5938 L294,684.5938 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="970.4219" style="stroke: #000000; stroke-width: 2.0;" width="1491.5" x="294" y="684.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="138" x="309" y="697.6543">Edge Agent operation</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="685.5" x2="727.5" y1="738.2969" y2="738.2969"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="727.5" x2="727.5" y1="738.2969" y2="751.2969"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="686.5" x2="727.5" y1="751.2969" y2="751.2969"/><polygon fill="#A80036" points="696.5,747.2969,686.5,751.2969,696.5,755.2969,692.5,751.2969" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="692.5" y="725.5059">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="279" x="710.5" y="717.8887">Derive SAS keys for Edge Agent from its name +</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="263" x="710.5" y="733.123">generation ID using the master encryption key</text><polygon fill="#A80036" points="363.5,791.7656,353.5,795.7656,363.5,799.7656,359.5,795.7656" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="357.5" x2="684.5" y1="795.7656" y2="795.7656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="369.5" y="782.9746">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="387.5" y="775.3574">Create identity for Edge Agent and register the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="387.5" y="790.5918">derived SAS keys for it</text><polygon fill="#A80036" points="673.5,821,683.5,825,673.5,829,677.5,825" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="347.5" x2="679.5" y1="825" y2="825"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="354.5" y="819.8262">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="375.5" y="819.8262"/><polygon fill="#A80036" points="1194,850.2344,1204,854.2344,1194,858.2344,1198,854.2344" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="685.5" x2="1200" y1="854.2344" y2="854.2344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="692.5" y="849.0605">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="710.5" y="849.0605">Create and start</text><rect fill="#FEFECE" filter="url(#f735j1mxl357c)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="85" x="1206" y="833"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="71" x="1213" y="852.9883">EdgeAgent</text><polygon fill="#A80036" points="701.5,895.6406,691.5,899.6406,701.5,903.6406,697.5,899.6406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="695.5" x2="1249.5" y1="899.6406" y2="899.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="707.5" y="894.4668">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="246" x="725.5" y="894.4668">Get SAS token for identifying with IoT Hub</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="690.5" x2="732.5" y1="944.1094" y2="944.1094"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="732.5" x2="732.5" y1="944.1094" y2="957.1094"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="691.5" x2="732.5" y1="957.1094" y2="957.1094"/><polygon fill="#A80036" points="701.5,953.1094,691.5,957.1094,701.5,961.1094,697.5,957.1094" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="697.5" y="931.3184">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="715.5" y="923.7012">Derive Edge Agent SAS keys from its name +</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="263" x="715.5" y="938.9355">generation ID using the master encryption key</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="690.5" x2="732.5" y1="986.3438" y2="986.3438"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="732.5" x2="732.5" y1="986.3438" y2="999.3438"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="691.5" x2="732.5" y1="999.3438" y2="999.3438"/><polygon fill="#A80036" points="701.5,995.3438,691.5,999.3438,701.5,1003.3438,697.5,999.3438" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="697.5" y="981.1699">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="715.5" y="981.1699">Create SAS token from SAS key</text><polygon fill="#A80036" points="1238.5,1024.5781,1248.5,1028.5781,1238.5,1032.5781,1242.5,1028.5781" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="685.5" x2="1244.5" y1="1028.5781" y2="1028.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="692.5" y="1023.4043">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="710.5" y="1023.4043">SAS token</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1250.5" x2="1292.5" y1="1057.8125" y2="1057.8125"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1292.5" x2="1292.5" y1="1057.8125" y2="1070.8125"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1251.5" x2="1292.5" y1="1070.8125" y2="1070.8125"/><polygon fill="#A80036" points="1261.5,1066.8125,1251.5,1070.8125,1261.5,1074.8125,1257.5,1070.8125" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1257.5" y="1052.6387">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="213" x="1275.5" y="1052.6387">Create IoT Hub client with SAS token</text><polygon fill="#A80036" points="363.5,1096.0469,353.5,1100.0469,363.5,1104.0469,359.5,1100.0469" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="357.5" x2="1249.5" y1="1100.0469" y2="1100.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="369.5" y="1094.873">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="387.5" y="1094.873">Connect to IoT Hub</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="352.5" x2="394.5" y1="1159.75" y2="1159.75"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="394.5" x2="394.5" y1="1159.75" y2="1172.75"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="353.5" x2="394.5" y1="1172.75" y2="1172.75"/><polygon fill="#A80036" points="363.5,1168.75,353.5,1172.75,363.5,1176.75,359.5,1172.75" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="359.5" y="1139.3418">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="262" x="377.5" y="1124.1074">Validate SAS token against SAS key that was</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256" x="377.5" y="1139.3418">registered when the Edge Agent identity was</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="377.5" y="1154.5762">created by the runtime</text><polygon fill="#A80036" points="1238.5,1197.9844,1248.5,1201.9844,1238.5,1205.9844,1242.5,1201.9844" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="347.5" x2="1244.5" y1="1201.9844" y2="1201.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="354.5" y="1196.8105">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="17" x="372.5" y="1196.8105">OK</text><polygon fill="#A80036" points="363.5,1227.2188,353.5,1231.2188,363.5,1235.2188,359.5,1231.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="357.5" x2="1249.5" y1="1231.2188" y2="1231.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="369.5" y="1226.0449">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="387.5" y="1226.0449">Get deployment</text><polygon fill="#A80036" points="1238.5,1256.4531,1248.5,1260.4531,1238.5,1264.4531,1242.5,1260.4531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="347.5" x2="1244.5" y1="1260.4531" y2="1260.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="354.5" y="1255.2793">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="375.5" y="1255.2793"/><path d="M304,1275.4531 L377,1275.4531 L377,1282.4531 L367,1292.4531 L304,1292.4531 L304,1275.4531 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="265.3438" style="stroke: #000000; stroke-width: 2.0;" width="1001" x="304" y="1275.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="319" y="1288.5137">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="112" x="392" y="1287.6582">[for each module M]</text><polygon fill="#A80036" points="701.5,1309.9219,691.5,1313.9219,701.5,1317.9219,697.5,1313.9219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="695.5" x2="1249.5" y1="1313.9219" y2="1313.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="707.5" y="1308.748">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="725.5" y="1308.748">Create identity for module M</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="690.5" x2="732.5" y1="1358.3906" y2="1358.3906"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="732.5" x2="732.5" y1="1358.3906" y2="1371.3906"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="691.5" x2="732.5" y1="1371.3906" y2="1371.3906"/><polygon fill="#A80036" points="701.5,1367.3906,691.5,1371.3906,701.5,1375.3906,697.5,1371.3906" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="697.5" y="1345.5996">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="715.5" y="1337.9824">Derive module M SAS keys from its name +</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="263" x="715.5" y="1353.2168">generation ID using the master encryption key</text><polygon fill="#A80036" points="363.5,1411.8594,353.5,1415.8594,363.5,1419.8594,359.5,1415.8594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="357.5" x2="679.5" y1="1415.8594" y2="1415.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="369.5" y="1403.0684">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256" x="387.5" y="1395.4512">Create identity for module M and register the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="387.5" y="1410.6855">derived SAS keys for it</text><polygon fill="#A80036" points="668.5,1441.0938,678.5,1445.0938,668.5,1449.0938,672.5,1445.0938" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="347.5" x2="674.5" y1="1445.0938" y2="1445.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="354.5" y="1439.9199">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="375.5" y="1439.9199"/><polygon fill="#A80036" points="1238.5,1470.3281,1248.5,1474.3281,1238.5,1478.3281,1242.5,1474.3281" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="685.5" x2="1244.5" y1="1474.3281" y2="1474.3281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="692.5" y="1469.1543">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="713.5" y="1469.1543"/><polygon fill="#A80036" points="701.5,1499.5625,691.5,1503.5625,701.5,1507.5625,697.5,1503.5625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="695.5" x2="1249.5" y1="1503.5625" y2="1503.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="707.5" y="1498.3887">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="75" x="725.5" y="1498.3887">Start module</text><polygon fill="#A80036" points="1238.5,1528.7969,1248.5,1532.7969,1238.5,1536.7969,1242.5,1532.7969" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="685.5" x2="1244.5" y1="1532.7969" y2="1532.7969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="692.5" y="1527.623">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="713.5" y="1527.623"/><polygon fill="#A80036" points="1446,1565.0313,1456,1569.0313,1446,1573.0313,1450,1569.0313" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="685.5" x2="1452" y1="1569.0313" y2="1569.0313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="692.5" y="1563.8574">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="710.5" y="1563.8574">Start Edge Hub</text><rect fill="#FEFECE" filter="url(#f735j1mxl357c)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="71" x="1458" y="1547.7969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="57" x="1465" y="1567.7852">EdgeHub</text><polygon fill="#A80036" points="1693.5,1610.4375,1703.5,1614.4375,1693.5,1618.4375,1697.5,1614.4375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="685.5" x2="1699.5" y1="1614.4375" y2="1614.4375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="692.5" y="1609.2637">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="710.5" y="1609.2637">Start Custom module</text><rect fill="#FEFECE" filter="url(#f735j1mxl357c)" height="46.8125" style="stroke: #A80036; stroke-width: 1.5;" width="66" x="1705.5" y="1593.2031"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="52" x="1712.5" y="1613.1914">Custom</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="47" x="1715" y="1629.5977">Module</text><path d="M13,1669.0156 L184,1669.0156 L184,1676.0156 L174,1686.0156 L13,1686.0156 L13,1669.0156 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1436.2188" style="stroke: #000000; stroke-width: 2.0;" width="1742.5" x="13" y="1669.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="126" x="28" y="1682.0762">Edge Hub operation</text><path d="M23,1693.25 L96,1693.25 L96,1700.25 L86,1710.25 L23,1710.25 L23,1693.25 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="968.4688" style="stroke: #000000; stroke-width: 2.0;" width="1530" x="23" y="1693.25"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="38" y="1706.3105">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="208" x="111" y="1705.4551">[for server cert request and renewal]</text><path d="M312,1715.4844 L312,1801.4844 L1054,1801.4844 L1054,1725.4844 L1044,1715.4844 L312,1715.4844 " fill="#FBFB77" filter="url(#f735j1mxl357c)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1044,1715.4844 L1044,1725.4844 L1054,1725.4844 L1044,1715.4844 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="592" x="318" y="1732.5449">Note that a single server cert is shared between all modules, and its lifetime is managed by the runtime.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="721" x="318" y="1747.7793">This is because the user may have module server certs rooted to public CAs, so it would cost the customer $$$ for each cert.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="653" x="318" y="1763.0137">Thus we do not want to request a new server cert when a previously requested cert is still valid, which also means</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="718" x="318" y="1778.248">we want to dedupe the server certs across all modules that want them. Since server certs are issued for the device hostname</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="397" x="318" y="1793.4824">anyway, reusing the server cert for multiple modules is not a concern.</text><path d="M33,1817.6563 L96,1817.6563 L96,1824.6563 L86,1834.6563 L33,1834.6563 L33,1817.6563 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="837.0625" style="stroke: #000000; stroke-width: 2.0;" width="1510" x="33" y="1817.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="48" y="1830.7168">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="227" x="111" y="1829.8613">[if server cert already exists and is valid]</text><polygon fill="#A80036" points="701.5,1852.125,691.5,1856.125,701.5,1860.125,697.5,1856.125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="695.5" x2="1494.5" y1="1856.125" y2="1856.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="707.5" y="1850.9512">36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="725.5" y="1850.9512">Get server cert</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="690.5" x2="732.5" y1="1885.3594" y2="1885.3594"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="732.5" x2="732.5" y1="1885.3594" y2="1898.3594"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="691.5" x2="732.5" y1="1898.3594" y2="1898.3594"/><polygon fill="#A80036" points="701.5,1894.3594,691.5,1898.3594,701.5,1902.3594,697.5,1898.3594" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="697.5" y="1880.1855">37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="715.5" y="1880.1855">Get persisted server cert PEM and private key</text><polygon fill="#A80036" points="1483.5,1923.5938,1493.5,1927.5938,1483.5,1931.5938,1487.5,1927.5938" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="685.5" x2="1489.5" y1="1927.5938" y2="1927.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="692.5" y="1922.4199">38</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="152" x="710.5" y="1922.4199">Server cert and private key</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="33" x2="1543" y1="1936.5938" y2="1936.5938"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="235" x="38" y="1946.7988">[if server cert does not exist or is expired]</text><polygon fill="#A80036" points="701.5,1967.7188,691.5,1971.7188,701.5,1975.7188,697.5,1971.7188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="695.5" x2="1494.5" y1="1971.7188" y2="1971.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="707.5" y="1966.5449">39</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="725.5" y="1966.5449">Get server cert</text><path d="M621.5,1986.7188 L684.5,1986.7188 L684.5,1993.7188 L674.5,2003.7188 L621.5,2003.7188 L621.5,1986.7188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="243.2969" style="stroke: #000000; stroke-width: 2.0;" width="342" x="621.5" y="1986.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="636.5" y="1999.7793">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="163" x="699.5" y="1998.9238">[if server cert does not exist]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="690.5" x2="737.5" y1="2020.1875" y2="2020.1875"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="737.5" x2="737.5" y1="2020.1875" y2="2033.1875"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="696.5" x2="737.5" y1="2033.1875" y2="2033.1875"/><polygon fill="#A80036" points="706.5,2029.1875,696.5,2033.1875,706.5,2037.1875,702.5,2033.1875" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="702.5" y="2015.0137">40</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="720.5" y="2015.0137">Get persisted server cert and private key</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="695.5" x2="737.5" y1="2072.4219" y2="2072.4219"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="737.5" x2="737.5" y1="2072.4219" y2="2085.4219"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="690.5" x2="737.5" y1="2085.4219" y2="2085.4219"/><polygon fill="#A80036" points="700.5,2081.4219,690.5,2085.4219,700.5,2089.4219,696.5,2085.4219" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="702.5" y="2067.248">41</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="82" x="720.5" y="2067.248">Err(NotFound)</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="621.5" x2="963.5" y1="2089.4219" y2="2089.4219"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="288" x="626.5" y="2099.627">[if server cert exists but is expired / close to expiry]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="690.5" x2="737.5" y1="2119.5469" y2="2119.5469"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="737.5" x2="737.5" y1="2119.5469" y2="2132.5469"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="696.5" x2="737.5" y1="2132.5469" y2="2132.5469"/><polygon fill="#A80036" points="706.5,2128.5469,696.5,2132.5469,706.5,2136.5469,702.5,2132.5469" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="702.5" y="2114.373">42</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="720.5" y="2114.373">Get persisted server cert and private key</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="695.5" x2="737.5" y1="2171.7813" y2="2171.7813"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="737.5" x2="737.5" y1="2171.7813" y2="2184.7813"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="690.5" x2="737.5" y1="2184.7813" y2="2184.7813"/><polygon fill="#A80036" points="700.5,2180.7813,690.5,2184.7813,700.5,2188.7813,696.5,2184.7813" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="702.5" y="2166.6074">43</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="47" x="720.5" y="2166.6074">Ok(cert)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="690.5" x2="732.5" y1="2209.0156" y2="2209.0156"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="732.5" x2="732.5" y1="2209.0156" y2="2222.0156"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="691.5" x2="732.5" y1="2222.0156" y2="2222.0156"/><polygon fill="#A80036" points="701.5,2218.0156,691.5,2222.0156,701.5,2226.0156,697.5,2222.0156" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="697.5" y="2203.8418">44</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="715.5" y="2203.8418">Server cert is expired / close to expiry</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="690.5" x2="732.5" y1="2258.25" y2="2258.25"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="732.5" x2="732.5" y1="2258.25" y2="2271.25"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="691.5" x2="732.5" y1="2271.25" y2="2271.25"/><polygon fill="#A80036" points="701.5,2267.25,691.5,2271.25,701.5,2275.25,697.5,2271.25" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="697.5" y="2253.0762">45</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="715.5" y="2253.0762">Create CSR for new module server cert using key</text><path d="M43,2286.25 L106,2286.25 L106,2293.25 L96,2303.25 L43,2303.25 L43,2286.25 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="274.7656" style="stroke: #000000; stroke-width: 2.0;" width="959.5" x="43" y="2286.25"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="58" y="2299.3105">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="228" x="121" y="2298.4551">[if module certs should be issued by EST]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="690.5" x2="732.5" y1="2324.7188" y2="2324.7188"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="732.5" x2="732.5" y1="2324.7188" y2="2337.7188"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="691.5" x2="732.5" y1="2337.7188" y2="2337.7188"/><polygon fill="#A80036" points="701.5,2333.7188,691.5,2337.7188,701.5,2341.7188,697.5,2337.7188" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="697.5" y="2319.5449">46</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="275" x="715.5" y="2319.5449">Create TLS client using current EST identity cert</text><polygon fill="#A80036" points="91.5,2378.1875,81.5,2382.1875,91.5,2386.1875,87.5,2382.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="85.5" x2="679.5" y1="2382.1875" y2="2382.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="97.5" y="2369.3965">47</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="296" x="115.5" y="2361.7793">Connect using TLS client and send request for new</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="260" x="115.5" y="2377.0137">module server cert corresponding to the CSR</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="80.5" x2="122.5" y1="2411.4219" y2="2411.4219"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="122.5" x2="122.5" y1="2411.4219" y2="2424.4219"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="81.5" x2="122.5" y1="2424.4219" y2="2424.4219"/><polygon fill="#A80036" points="91.5,2420.4219,81.5,2424.4219,91.5,2428.4219,87.5,2424.4219" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="87.5" y="2406.248">48</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="105.5" y="2406.248">Verify client cert against EST identity CA</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="80.5" x2="122.5" y1="2453.6563" y2="2453.6563"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="122.5" x2="122.5" y1="2453.6563" y2="2466.6563"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="81.5" x2="122.5" y1="2466.6563" y2="2466.6563"/><polygon fill="#A80036" points="91.5,2462.6563,81.5,2466.6563,91.5,2470.6563,87.5,2466.6563" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="87.5" y="2448.4824">49</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="55" x="105.5" y="2448.4824">Sign CSR</text><polygon fill="#A80036" points="668.5,2491.8906,678.5,2495.8906,668.5,2499.8906,672.5,2495.8906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="75.5" x2="674.5" y1="2495.8906" y2="2495.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="82.5" y="2490.7168">50</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="67" x="100.5" y="2490.7168">Signed cert</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="43" x2="1002.5" y1="2504.8906" y2="2504.8906"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="230" x="48" y="2515.0957">[if module certs should be minted locally]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="690.5" x2="732.5" y1="2540.0156" y2="2540.0156"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="732.5" x2="732.5" y1="2540.0156" y2="2553.0156"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="691.5" x2="732.5" y1="2553.0156" y2="2553.0156"/><polygon fill="#A80036" points="701.5,2549.0156,691.5,2553.0156,701.5,2557.0156,697.5,2553.0156" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="697.5" y="2534.8418">51</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="715.5" y="2534.8418">Sign CSR using device CA cert</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="690.5" x2="732.5" y1="2604.4844" y2="2604.4844"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="732.5" x2="732.5" y1="2604.4844" y2="2617.4844"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="691.5" x2="732.5" y1="2617.4844" y2="2617.4844"/><polygon fill="#A80036" points="701.5,2613.4844,691.5,2617.4844,701.5,2621.4844,697.5,2617.4844" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="697.5" y="2591.6934">52</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="715.5" y="2584.0762">Save signed cert and key pair so that it can be</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="271" x="715.5" y="2599.3105">retrieved for future module server cert requests</text><polygon fill="#A80036" points="1483.5,2642.7188,1493.5,2646.7188,1483.5,2650.7188,1487.5,2646.7188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="685.5" x2="1489.5" y1="2646.7188" y2="2646.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="692.5" y="2641.5449">53</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="152" x="710.5" y="2641.5449">Server cert and private key</text><path d="M304,2675.7188 L474,2675.7188 L474,2682.7188 L464,2692.7188 L304,2692.7188 L304,2675.7188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="422.5156" style="stroke: #000000; stroke-width: 2.0;" width="1441.5" x="304" y="2675.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="319" y="2688.7793">Connect to IoT Hub</text><polygon fill="#A80036" points="701.5,2710.1875,691.5,2714.1875,701.5,2718.1875,697.5,2714.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="695.5" x2="1494.5" y1="2714.1875" y2="2714.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="707.5" y="2709.0137">54</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="725.5" y="2709.0137">Get IoTHub identity</text><polygon fill="#A80036" points="1483.5,2754.6563,1493.5,2758.6563,1483.5,2762.6563,1487.5,2758.6563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="685.5" x2="1489.5" y1="2758.6563" y2="2758.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="692.5" y="2745.8652">55</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="292" x="710.5" y="2738.248">Identity info (IoTHub + device identity + generation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="710.5" y="2753.4824">ID + credentials type)</text><polygon fill="#A80036" points="701.5,2783.8906,691.5,2787.8906,701.5,2791.8906,697.5,2787.8906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="695.5" x2="1494.5" y1="2787.8906" y2="2787.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="707.5" y="2782.7168">56</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="246" x="725.5" y="2782.7168">Get SAS token for identifying with IoT Hub</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="690.5" x2="732.5" y1="2832.3594" y2="2832.3594"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="732.5" x2="732.5" y1="2832.3594" y2="2845.3594"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="691.5" x2="732.5" y1="2845.3594" y2="2845.3594"/><polygon fill="#A80036" points="701.5,2841.3594,691.5,2845.3594,701.5,2849.3594,697.5,2845.3594" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="697.5" y="2819.5684">57</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="249" x="715.5" y="2811.9512">Derive Edge Hub SAS keys from its name +</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="263" x="715.5" y="2827.1855">generation ID using the master encryption key</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="690.5" x2="732.5" y1="2874.5938" y2="2874.5938"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="732.5" x2="732.5" y1="2874.5938" y2="2887.5938"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="691.5" x2="732.5" y1="2887.5938" y2="2887.5938"/><polygon fill="#A80036" points="701.5,2883.5938,691.5,2887.5938,701.5,2891.5938,697.5,2887.5938" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="697.5" y="2869.4199">58</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="715.5" y="2869.4199">Create SAS token from SAS key</text><polygon fill="#A80036" points="1483.5,2912.8281,1493.5,2916.8281,1483.5,2920.8281,1487.5,2916.8281" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="685.5" x2="1489.5" y1="2916.8281" y2="2916.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="692.5" y="2911.6543">59</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="710.5" y="2911.6543">SAS token</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1495.5" x2="1537.5" y1="2946.0625" y2="2946.0625"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1537.5" x2="1537.5" y1="2946.0625" y2="2959.0625"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1496.5" x2="1537.5" y1="2959.0625" y2="2959.0625"/><polygon fill="#A80036" points="1506.5,2955.0625,1496.5,2959.0625,1506.5,2963.0625,1502.5,2959.0625" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1502.5" y="2940.8887">60</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="213" x="1520.5" y="2940.8887">Create IoT Hub client with SAS token</text><polygon fill="#A80036" points="363.5,2984.2969,353.5,2988.2969,363.5,2992.2969,359.5,2988.2969" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="357.5" x2="1494.5" y1="2988.2969" y2="2988.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="369.5" y="2983.123">61</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="387.5" y="2983.123">Connect to IoT Hub</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="352.5" x2="394.5" y1="3048" y2="3048"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="394.5" x2="394.5" y1="3048" y2="3061"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="353.5" x2="394.5" y1="3061" y2="3061"/><polygon fill="#A80036" points="363.5,3057,353.5,3061,363.5,3065,359.5,3061" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="359.5" y="3027.5918">62</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="262" x="377.5" y="3012.3574">Validate SAS token against SAS key that was</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="293" x="377.5" y="3027.5918">registered when the Edge Hub identity was created</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="81" x="377.5" y="3042.8262">by the runtime</text><polygon fill="#A80036" points="1483.5,3086.2344,1493.5,3090.2344,1483.5,3094.2344,1487.5,3090.2344" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="347.5" x2="1489.5" y1="3090.2344" y2="3090.2344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="354.5" y="3085.0605">63</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="17" x="372.5" y="3085.0605">OK</text><!--MD5=[7500c018c0c978e010efa8cc1a159022]
@startuml

title Runtime Operation
skinparam maxMessageSize 300

participant "EST" as est
participant "IoT Hub" as hub

box Device #LightBlue
	participant "Edge Runtime" as runtime
	participant "Host Process" as hlm
	participant EdgeAgent as ea
	participant EdgeHub as eh
	participant "Custom\nModule" as cm
end box

autonumber

group Host-level modules
	runtime -> runtime: Read host-level module names from configuration 
	loop for creating each host-level module M
		runtime -> runtime: Derive Edge Hub SAS keys from its name + generation ID using the master encryption key
		runtime -> hub ++: Create identity for module M and register the derived SAS keys for it
		return
	end
end

group Host process operation
	hlm -> runtime ++: Get identity for Host process
	return
	hlm -> runtime ++: Get SAS token for identifying with IoT Hub
	return

	hlm -> hlm: Create IoT Hub client using Sas token
	hlm -> hub ++: Connect to Iot Hub
	hub -> hub: Validate SAS token against SAS key that was registered when the Edge Agent identity was created by the runtime
	return OK
end

group Edge Agent operation
	runtime -> runtime: Derive SAS keys for Edge Agent from its name + generation ID using the master encryption key
	runtime -> hub ++: Create identity for Edge Agent and register the derived SAS keys for it
	return

	runtime -> ea **: Create and start

	ea -> runtime ++: Get SAS token for identifying with IoT Hub
	runtime -> runtime: Derive Edge Agent SAS keys from its name + generation ID using the master encryption key
	runtime -> runtime: Create SAS token from SAS key
	return SAS token
	ea -> ea: Create IoT Hub client with SAS token
	ea -> hub ++: Connect to IoT Hub
	hub -> hub: Validate SAS token against SAS key that was registered when the Edge Agent identity was created by the runtime
	return OK
	ea -> hub ++: Get deployment
	return

	loop for each module M
		ea -> runtime ++: Create identity for module M
		runtime -> runtime: Derive module M SAS keys from its name + generation ID using the master encryption key
		runtime -> hub ++: Create identity for module M and register the derived SAS keys for it
		return
		return

		ea -> runtime ++: Start module
		return
	end

	runtime -> eh **: Start Edge Hub
	runtime -> cm **: Start Custom module
end

group Edge Hub operation
	loop for server cert request and renewal
		note over runtime
			Note that a single server cert is shared between all modules, and its lifetime is managed by the runtime.
			This is because the user may have module server certs rooted to public CAs, so it would cost the customer $$$ for each cert.
			Thus we do not want to request a new server cert when a previously requested cert is still valid, which also means
			we want to dedupe the server certs across all modules that want them. Since server certs are issued for the device hostname
			anyway, reusing the server cert for multiple modules is not a concern.
		end note

		alt if server cert already exists and is valid
			eh -> runtime ++: Get server cert
			runtime -> runtime: Get persisted server cert PEM and private key
			return Server cert and private key

		else if server cert does not exist or is expired
			eh -> runtime ++: Get server cert
			alt if server cert does not exist
				runtime -> runtime ++: Get persisted server cert and private key
				return Err(NotFound)
			else if server cert exists but is expired / close to expiry
				runtime -> runtime ++: Get persisted server cert and private key
				return Ok(cert)
				runtime -> runtime: Server cert is expired / close to expiry
			end

			runtime -> runtime: Create CSR for new module server cert using key

			alt if module certs should be issued by EST
				runtime -> runtime: Create TLS client using current EST identity cert
				runtime -> est ++: Connect using TLS client and send request for new module server cert corresponding to the CSR
				est -> est: Verify client cert against EST identity CA
				est -> est: Sign CSR
				return Signed cert

			else if module certs should be minted locally
				runtime -> runtime: Sign CSR using device CA cert
			end

			runtime -> runtime: Save signed cert and key pair so that it can be retrieved for future module server cert requests
			return Server cert and private key

		end
	end

	group Connect to IoT Hub
		eh -> runtime ++: Get IoTHub identity
		return Identity info (IoTHub + device identity + generation ID + credentials type)

		eh -> runtime ++: Get SAS token for identifying with IoT Hub
		runtime -> runtime: Derive Edge Hub SAS keys from its name + generation ID using the master encryption key
		runtime -> runtime: Create SAS token from SAS key
		return SAS token
		eh -> eh: Create IoT Hub client with SAS token
		eh -> hub ++: Connect to IoT Hub
		hub -> hub: Validate SAS token against SAS key that was registered when the Edge Hub identity was created by the runtime
		return OK
	end
end

@enduml

PlantUML version 1.2020.17(Sat Sep 19 05:30:11 PDT 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>