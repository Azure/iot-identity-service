<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="2166px" preserveAspectRatio="none" style="width:1401px;height:2166px;" version="1.1" viewBox="0 0 1401 2166" width="1401px" zoomAndPan="magnify"><defs><filter height="300%" id="f7lwegojph4n9" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#ADD8E6" height="2151.7969" style="stroke: #A80036; stroke-width: 1.0;" width="663.5" x="702.5" y="4"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="42" x="1013.25" y="16.0605">Device</text><rect fill="#FFFFFF" filter="url(#f7lwegojph4n9)" height="382.2188" style="stroke: #000000; stroke-width: 2.0;" width="483.5" x="13" y="92.0469"/><rect fill="#FFFFFF" filter="url(#f7lwegojph4n9)" height="228.0469" style="stroke: #000000; stroke-width: 2.0;" width="650.5" x="140" y="488.2656"/><rect fill="#FFFFFF" filter="url(#f7lwegojph4n9)" height="1353.6719" style="stroke: #000000; stroke-width: 2.0;" width="1075.5" x="306.5" y="730.3125"/><rect fill="#FFFFFF" filter="url(#f7lwegojph4n9)" height="831.2813" style="stroke: #000000; stroke-width: 2.0;" width="885.5" x="486.5" y="754.5469"/><rect fill="#FFFFFF" filter="url(#f7lwegojph4n9)" height="477.1563" style="stroke: #000000; stroke-width: 2.0;" width="867" x="316.5" y="1599.8281"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="188" x2="188" y1="75.0469" y2="889.9531"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="188" x2="188" y1="889.9531" y2="930.8438"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="188" x2="188" y1="930.8438" y2="1504.0469"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="188" x2="188" y1="1504.0469" y2="1544.9375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="188" x2="188" y1="1544.9375" y2="1544.9375"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="188" x2="188" y1="1544.9375" y2="1585.8281"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="188" x2="188" y1="1585.8281" y2="2100.9844"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="359.5" x2="359.5" y1="75.0469" y2="889.9531"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="359.5" x2="359.5" y1="889.9531" y2="930.8438"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="359.5" x2="359.5" y1="930.8438" y2="1504.0469"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="359.5" x2="359.5" y1="1504.0469" y2="1544.9375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="359.5" x2="359.5" y1="1544.9375" y2="1544.9375"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="359.5" x2="359.5" y1="1544.9375" y2="1585.8281"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="359.5" x2="359.5" y1="1585.8281" y2="2100.9844"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="444.5" x2="444.5" y1="75.0469" y2="889.9531"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="444.5" x2="444.5" y1="889.9531" y2="930.8438"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="444.5" x2="444.5" y1="930.8438" y2="1504.0469"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="444.5" x2="444.5" y1="1504.0469" y2="1544.9375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="444.5" x2="444.5" y1="1544.9375" y2="1544.9375"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="444.5" x2="444.5" y1="1544.9375" y2="1585.8281"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="444.5" x2="444.5" y1="1585.8281" y2="2100.9844"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="574.5" x2="574.5" y1="75.0469" y2="889.9531"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="574.5" x2="574.5" y1="889.9531" y2="930.8438"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="574.5" x2="574.5" y1="930.8438" y2="1504.0469"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="574.5" x2="574.5" y1="1504.0469" y2="1544.9375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="574.5" x2="574.5" y1="1544.9375" y2="1544.9375"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="574.5" x2="574.5" y1="1544.9375" y2="1585.8281"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="574.5" x2="574.5" y1="1585.8281" y2="2100.9844"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="743.5" x2="743.5" y1="75.0469" y2="889.9531"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="743.5" x2="743.5" y1="889.9531" y2="930.8438"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="743.5" x2="743.5" y1="930.8438" y2="1504.0469"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="743.5" x2="743.5" y1="1504.0469" y2="1544.9375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="743.5" x2="743.5" y1="1544.9375" y2="1544.9375"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="743.5" x2="743.5" y1="1544.9375" y2="1585.8281"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="743.5" x2="743.5" y1="1585.8281" y2="2100.9844"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="924" x2="924" y1="75.0469" y2="889.9531"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="924" x2="924" y1="889.9531" y2="930.8438"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="924" x2="924" y1="930.8438" y2="1504.0469"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="924" x2="924" y1="1504.0469" y2="1544.9375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="924" x2="924" y1="1544.9375" y2="1544.9375"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="924" x2="924" y1="1544.9375" y2="1585.8281"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="924" x2="924" y1="1585.8281" y2="2100.9844"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1135.5" x2="1135.5" y1="1050.25" y2="1504.0469"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="1135.5" x2="1135.5" y1="1504.0469" y2="1544.9375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1135.5" x2="1135.5" y1="1544.9375" y2="1544.9375"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="1135.5" x2="1135.5" y1="1544.9375" y2="1585.8281"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1135.5" x2="1135.5" y1="1585.8281" y2="2100.9844"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1327" x2="1327" y1="1103.8594" y2="1504.0469"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="1327" x2="1327" y1="1504.0469" y2="1544.9375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1327" x2="1327" y1="1544.9375" y2="1544.9375"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 1.0,4.0;" x1="1327" x2="1327" y1="1544.9375" y2="1585.8281"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1327" x2="1327" y1="1585.8281" y2="2100.9844"/><rect fill="#FEFECE" filter="url(#f7lwegojph4n9)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="72" x="150" y="39.6406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="58" x="157" y="59.6289">Operator</text><rect fill="#FEFECE" filter="url(#f7lwegojph4n9)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="72" x="150" y="2099.9844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="58" x="157" y="2119.9727">Operator</text><rect fill="#FEFECE" filter="url(#f7lwegojph4n9)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="63" x="326.5" y="39.6406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="49" x="333.5" y="59.6289">IoT Hub</text><rect fill="#FEFECE" filter="url(#f7lwegojph4n9)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="63" x="326.5" y="2099.9844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="49" x="333.5" y="2119.9727">IoT Hub</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="77" x="403.5" y="71.6289">Edge device</text><ellipse cx="445" cy="42.6406" fill="#FEFECE" filter="url(#f7lwegojph4n9)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="433" x2="457" y1="56.6406" y2="56.6406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="77" x="403.5" y="2112.9727">Edge device</text><ellipse cx="445" cy="2132.3906" fill="#FEFECE" filter="url(#f7lwegojph4n9)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="433" x2="457" y1="2146.3906" y2="2146.3906"/><rect fill="#FEFECE" filter="url(#f7lwegojph4n9)" height="46.8125" style="stroke: #A80036; stroke-width: 1.5;" width="152" x="496.5" y="23.2344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="53" x="546" y="43.2227">External</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="138" x="503.5" y="59.6289">Provisioning endpoint</text><rect fill="#FEFECE" filter="url(#f7lwegojph4n9)" height="46.8125" style="stroke: #A80036; stroke-width: 1.5;" width="152" x="496.5" y="2099.9844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="53" x="546" y="2119.9727">External</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="138" x="503.5" y="2136.3789">Provisioning endpoint</text><rect fill="#FEFECE" filter="url(#f7lwegojph4n9)" height="46.8125" style="stroke: #A80036; stroke-width: 1.5;" width="70" x="706.5" y="23.2344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="56" x="713.5" y="43.2227">IoT Edge</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="51" x="716" y="59.6289">runtime</text><rect fill="#FEFECE" filter="url(#f7lwegojph4n9)" height="46.8125" style="stroke: #A80036; stroke-width: 1.5;" width="70" x="706.5" y="2099.9844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="56" x="713.5" y="2119.9727">IoT Edge</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="51" x="716" y="2136.3789">runtime</text><rect fill="#FEFECE" filter="url(#f7lwegojph4n9)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="85" x="880" y="39.6406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="71" x="887" y="59.6289">EdgeAgent</text><rect fill="#FEFECE" filter="url(#f7lwegojph4n9)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="85" x="880" y="2099.9844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="71" x="887" y="2119.9727">EdgeAgent</text><rect fill="#FEFECE" filter="url(#f7lwegojph4n9)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="71" x="1098.5" y="2099.9844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="57" x="1105.5" y="2119.9727">EdgeHub</text><rect fill="#FEFECE" filter="url(#f7lwegojph4n9)" height="46.8125" style="stroke: #A80036; stroke-width: 1.5;" width="66" x="1292" y="2099.9844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="52" x="1299" y="2119.9727">Custom</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="47" x="1301.5" y="2136.3789">Module</text><path d="M13,92.0469 L137,92.0469 L137,99.0469 L127,109.0469 L13,109.0469 L13,92.0469 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="382.2188" style="stroke: #000000; stroke-width: 2.0;" width="483.5" x="13" y="92.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="79" x="28" y="105.1074">Initial Setup</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="188" x2="230" y1="206.6875" y2="206.6875"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="230" x2="230" y1="206.6875" y2="219.6875"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="189" x2="230" y1="219.6875" y2="219.6875"/><polygon fill="#A80036" points="199,215.6875,189,219.6875,199,223.6875,195,219.6875" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="195" y="163.4277">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="206" y="125.3418">Generate device CA cert (</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="206" y="140.5762">DCAC) (self signed, or</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="57" x="206" y="155.8105">signed by</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="206" y="171.0449">a topology CA Certificate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="206" y="186.2793">(CA1) for gateway</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="206" y="201.5137">scenarios)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="188" x2="230" y1="279.3906" y2="279.3906"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="230" x2="230" y1="279.3906" y2="292.3906"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="189" x2="230" y1="292.3906" y2="292.3906"/><polygon fill="#A80036" points="199,288.3906,189,292.3906,199,296.3906,195,292.3906" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="195" y="258.9824">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="206" y="243.748">Generate device identity</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="206" y="258.9824">cert (DIdC) signed by</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="206" y="274.2168">Identity CA Cert (CA2).</text><path d="M23,305.3906 L23,345.3906 L349,345.3906 L349,315.3906 L339,305.3906 L23,305.3906 " fill="#FBFB77" filter="url(#f7lwegojph4n9)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M339,305.3906 L339,315.3906 L349,315.3906 L339,305.3906 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="188" x="29" y="322.4512">CA1 and CA2 should be different</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="305" x="29" y="337.6855">because device does have the CA cert signed by CA1</text><polygon fill="#A80036" points="348,402.5625,358,406.5625,348,410.5625,352,406.5625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="188" x2="354" y1="406.5625" y2="406.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="195" y="386.1543">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="206" y="370.9199">Configure identity CA</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="206" y="386.1543">Certificate (CA2) for CA</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="206" y="401.3887">based auth</text><polygon fill="#A80036" points="433,462.2656,443,466.2656,433,470.2656,437,466.2656" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="188" x2="439" y1="466.2656" y2="466.2656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="195" y="445.8574">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="206" y="430.623">Install DCAC and DIdC on</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="206" y="445.8574">the device (file system or</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="34" x="206" y="461.0918">HSM)</text><path d="M140,488.2656 L386,488.2656 L386,495.2656 L376,505.2656 L140,505.2656 L140,488.2656 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="228.0469" style="stroke: #000000; stroke-width: 2.0;" width="650.5" x="140" y="488.2656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="201" x="155" y="501.3262">Device setup and configuration</text><polygon fill="#A80036" points="731.5,598.9063,741.5,602.9063,731.5,606.9063,735.5,602.9063" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="188" x2="737.5" y1="602.9063" y2="602.9063"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="195" y="559.6465">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="206" y="521.5605">Configure device CA (</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="206" y="536.7949">DCAC) in config.yaml (</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="206" y="552.0293">PKCS#11 URI or file path)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="206" y="567.2637">and provisioning in</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="206" y="582.498">External Provisioning</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="37" x="206" y="597.7324">mode.</text><polygon fill="#A80036" points="731.5,704.3125,741.5,708.3125,731.5,712.3125,735.5,708.3125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="188" x2="737.5" y1="708.3125" y2="708.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="195" y="665.0527">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="206" y="626.9668">Configure deployment for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="206" y="642.2012">device using local mode</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="206" y="657.4355">configuration for EA, EH</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="206" y="672.6699">and other modules.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="206" y="687.9043">Configure EH Bridge to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="206" y="703.1387">send telemetry upstream.</text><path d="M306.5,730.3125 L446.5,730.3125 L446.5,737.3125 L436.5,747.3125 L306.5,747.3125 L306.5,730.3125 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1353.6719" style="stroke: #000000; stroke-width: 2.0;" width="1075.5" x="306.5" y="730.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="95" x="321.5" y="743.373">Device running</text><path d="M486.5,754.5469 L620.5,754.5469 L620.5,761.5469 L610.5,771.5469 L486.5,771.5469 L486.5,754.5469 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="831.2813" style="stroke: #000000; stroke-width: 2.0;" width="885.5" x="486.5" y="754.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="89" x="501.5" y="767.6074">Device Offline</text><polygon fill="#A80036" points="731.5,789.0156,741.5,793.0156,731.5,797.0156,735.5,793.0156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="574.5" x2="737.5" y1="793.0156" y2="793.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="581.5" y="787.8418">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="592.5" y="787.8418">Start IoT Edge runtime</text><polygon fill="#A80036" points="585.5,848.7188,575.5,852.7188,585.5,856.7188,581.5,852.7188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="579.5" x2="742.5" y1="852.7188" y2="852.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="591.5" y="832.3105">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="94" x="602.5" y="817.0762">Provision device</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="602.5" y="832.3105">(external provisioning</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="57" x="602.5" y="847.5449">endpoint)</text><polygon fill="#FF0000" points="731.5,877.9531,741.5,881.9531,731.5,885.9531,735.5,881.9531" style="stroke: #FF0000; stroke-width: 1.0;"/><line style="stroke: #FF0000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="574.5" x2="737.5" y1="881.9531" y2="881.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="581.5" y="876.7793">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="38" x="592.5" y="876.7793">Failure</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="232" x="641.5" y="914.1582">Provisioning attempts continue till success</text><polygon fill="#A80036" points="912.5,963.3125,922.5,967.3125,912.5,971.3125,916.5,967.3125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="743.5" x2="918.5" y1="967.3125" y2="967.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="750.5" y="954.5215">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="768.5" y="946.9043">Create with local</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="768.5" y="962.1387">configuration and start</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="924.5" x2="966.5" y1="996.5469" y2="996.5469"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="966.5" x2="966.5" y1="996.5469" y2="1009.5469"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="925.5" x2="966.5" y1="1009.5469" y2="1009.5469"/><polygon fill="#A80036" points="935.5,1005.5469,925.5,1009.5469,935.5,1013.5469,931.5,1009.5469" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="931.5" y="991.373">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="949.5" y="991.373">Process deployment</text><polygon fill="#A80036" points="1086.5,1050.0156,1096.5,1054.0156,1086.5,1058.0156,1090.5,1054.0156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="924.5" x2="1092.5" y1="1054.0156" y2="1054.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="931.5" y="1041.2246">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="949.5" y="1033.6074">Create with local</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="949.5" y="1048.8418">configuration and start</text><rect fill="#FEFECE" filter="url(#f7lwegojph4n9)" height="30.4063" style="stroke: #A80036; stroke-width: 1.5;" width="71" x="1098.5" y="1017.5469"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="57" x="1105.5" y="1037.5352">EdgeHub</text><polygon fill="#A80036" points="1280,1080.1875,1290,1084.1875,1280,1088.1875,1284,1084.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="924.5" x2="1286" y1="1084.1875" y2="1084.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="931.5" y="1079.0137">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="949.5" y="1079.0137">Create and start</text><rect fill="#FEFECE" filter="url(#f7lwegojph4n9)" height="46.8125" style="stroke: #A80036; stroke-width: 1.5;" width="66" x="1292" y="1062.9531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="52" x="1299" y="1082.9414">Custom</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="47" x="1301.5" y="1099.3477">Module</text><polygon fill="#A80036" points="754.5,1142,744.5,1146,754.5,1150,750.5,1146" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="748.5" x2="1135" y1="1146" y2="1146"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="760.5" y="1140.8262">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="778.5" y="1140.8262">Get server cert</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="743.5" x2="785.5" y1="1190.4688" y2="1190.4688"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="785.5" x2="785.5" y1="1190.4688" y2="1203.4688"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="744.5" x2="785.5" y1="1203.4688" y2="1203.4688"/><polygon fill="#A80036" points="754.5,1199.4688,744.5,1203.4688,754.5,1207.4688,750.5,1203.4688" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="750.5" y="1177.6777">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="768.5" y="1170.0605">Generate server cert from</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="33" x="768.5" y="1185.2949">DCAC</text><polygon fill="#A80036" points="1124,1228.7031,1134,1232.7031,1124,1236.7031,1128,1232.7031" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="743.5" x2="1130" y1="1232.7031" y2="1232.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="750.5" y="1227.5293">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="768.5" y="1227.5293">Server cert</text><polygon fill="#A80036" points="754.5,1257.9375,744.5,1261.9375,754.5,1265.9375,750.5,1261.9375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="748.5" x2="1326" y1="1261.9375" y2="1261.9375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="760.5" y="1256.7637">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="778.5" y="1256.7637">Get local identity</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="743.5" x2="785.5" y1="1306.4063" y2="1306.4063"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="785.5" x2="785.5" y1="1306.4063" y2="1319.4063"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="744.5" x2="785.5" y1="1319.4063" y2="1319.4063"/><polygon fill="#A80036" points="754.5,1315.4063,744.5,1319.4063,754.5,1323.4063,750.5,1319.4063" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="750.5" y="1293.6152">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="768.5" y="1285.998">Generate client cert from</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="33" x="768.5" y="1301.2324">DCAC</text><polygon fill="#A80036" points="1315,1344.6406,1325,1348.6406,1315,1352.6406,1319,1348.6406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="743.5" x2="1321" y1="1348.6406" y2="1348.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="750.5" y="1343.4668">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="768.5" y="1343.4668">Module local identity</text><polygon fill="#A80036" points="1147,1389.1094,1137,1393.1094,1147,1397.1094,1143,1393.1094" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1141" x2="1326" y1="1393.1094" y2="1393.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1153" y="1380.3184">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="1171" y="1372.7012">Connect using mutual</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="1171" y="1387.9355">TLS auth</text><polygon fill="#A80036" points="1147,1433.5781,1137,1437.5781,1147,1441.5781,1143,1437.5781" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1141" x2="1326" y1="1437.5781" y2="1437.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1153" y="1424.7871">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="1171" y="1417.1699">Pub/sub to MQTT Broker</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="1171" y="1432.4043">using custom topics</text><polygon fill="#A80036" points="754.5,1462.8125,744.5,1466.8125,754.5,1470.8125,750.5,1466.8125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="748.5" x2="1135" y1="1466.8125" y2="1466.8125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="760.5" y="1461.6387">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="778.5" y="1461.6387">Get IoTHub identity</text><polygon fill="#FF0000" points="1124,1492.0469,1134,1496.0469,1124,1500.0469,1128,1496.0469" style="stroke: #FF0000; stroke-width: 1.0;"/><line style="stroke: #FF0000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="743.5" x2="1130" y1="1496.0469" y2="1496.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="750.5" y="1490.873">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="38" x="768.5" y="1490.873">Failure</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="308" x="603.5" y="1528.252">EdgeHub continues to ask for IoTHub identity periodically</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="315" x="600" y="1569.1426">App operation continues. EdgeHub stores telemetry locally</text><path d="M316.5,1599.8281 L478.5,1599.8281 L478.5,1606.8281 L468.5,1616.8281 L316.5,1616.8281 L316.5,1599.8281 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="477.1563" style="stroke: #000000; stroke-width: 2.0;" width="867" x="316.5" y="1599.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="117" x="331.5" y="1612.8887">Device goes online</text><polygon fill="#A80036" points="585.5,1664.7656,575.5,1668.7656,585.5,1672.7656,581.5,1668.7656" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="579.5" x2="742.5" y1="1668.7656" y2="1668.7656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="591.5" y="1648.3574">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="94" x="609.5" y="1633.123">Provision device</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="609.5" y="1648.3574">(external provisioning</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="57" x="609.5" y="1663.5918">endpoint)</text><polygon fill="#A80036" points="371,1709.2344,361,1713.2344,371,1717.2344,367,1713.2344" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="365" x2="573.5" y1="1713.2344" y2="1713.2344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="377" y="1700.4434">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="395" y="1692.8262">Create device with</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="395" y="1708.0605">CA based auth</text><polygon fill="#A80036" points="562.5,1738.4688,572.5,1742.4688,562.5,1746.4688,566.5,1742.4688" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="360" x2="568.5" y1="1742.4688" y2="1742.4688"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="367" y="1737.2949">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="385" y="1737.2949">Device info</text><polygon fill="#A80036" points="731.5,1798.1719,741.5,1802.1719,731.5,1806.1719,735.5,1802.1719" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="574.5" x2="737.5" y1="1802.1719" y2="1802.1719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="581.5" y="1781.7637">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="599.5" y="1766.5293">Provisioning info</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="599.5" y="1781.7637">(IoTHub + deviceId +</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="33" x="599.5" y="1796.998">DIdC)</text><polygon fill="#A80036" points="371,1857.875,361,1861.875,371,1865.875,367,1861.875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="365" x2="742.5" y1="1861.875" y2="1861.875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="377" y="1841.4668">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="395" y="1826.2324">Update credentials for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="395" y="1841.4668">EdgeAgent and EdgeHub</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="81" x="395" y="1856.7012">with SAS auth</text><polygon fill="#A80036" points="754.5,1887.1094,744.5,1891.1094,754.5,1895.1094,750.5,1891.1094" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="748.5" x2="1135" y1="1891.1094" y2="1891.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="760.5" y="1885.9355">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="778.5" y="1885.9355">Get IoTHub identity</text><polygon fill="#A80036" points="1124,1946.8125,1134,1950.8125,1124,1954.8125,1128,1950.8125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="743.5" x2="1130" y1="1950.8125" y2="1950.8125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="750.5" y="1930.4043">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="768.5" y="1915.1699">Identity info (IoTHub +</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="768.5" y="1930.4043">deviceId + generation Id +</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="768.5" y="1945.6387">credentials type)</text><polygon fill="#A80036" points="754.5,1976.0469,744.5,1980.0469,754.5,1984.0469,750.5,1980.0469" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="748.5" x2="1135" y1="1980.0469" y2="1980.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="760.5" y="1974.873">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="778.5" y="1974.873">Sign token</text><polygon fill="#A80036" points="1124,2020.5156,1134,2024.5156,1124,2028.5156,1128,2024.5156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="743.5" x2="1130" y1="2024.5156" y2="2024.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="750.5" y="2011.7246">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="768.5" y="2004.1074">Token signed with</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="768.5" y="2019.3418">EdgeHub's SAS Key</text><polygon fill="#A80036" points="371,2064.9844,361,2068.9844,371,2072.9844,367,2068.9844" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="365" x2="1135" y1="2068.9844" y2="2068.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="377" y="2056.1934">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="395" y="2048.5762">Connect using token and</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="102" x="395" y="2063.8105">forward telemetry</text><!--MD5=[c88317abf033275ab97728cc9dbf18d7]
@startuml
skinparam maxMessageSize 150

participant "Operator" as oem
participant "IoT Hub" as ih
entity "Edge device" as device
participant "External\nProvisioning endpoint" as ae

box "Device" #LightBlue 
participant "IoT Edge\nruntime" as ie
participant "EdgeAgent" as ea
participant "EdgeHub" as eh
participant "Custom\nModule" as cm
end box 

autonumber 
group Initial Setup 
oem->oem : Generate device CA cert (DCAC) (self signed, or signed by\na topology CA Certificate (CA1) for gateway scenarios)
oem->oem : Generate device identity cert (DIdC) signed by\nIdentity CA Cert (CA2).
note over oem: CA1 and CA2 should be different\nbecause device does have the CA cert signed by CA1
oem->ih : Configure identity CA Certificate (CA2) for CA based auth 
oem->device : Install DCAC and DIdC on the device (file system or HSM) 
end 

group Device setup and configuration
oem->ie : Configure device CA (DCAC) in config.yaml (PKCS#11 URI or file path)\nand provisioning in External Provisioning mode. 
oem->ie : Configure deployment for device using local mode configuration for EA, EH and other modules.\nConfigure EH Bridge to send telemetry upstream.
end 

group Device running
group Device Offline

ae -> ie : Start IoT Edge runtime

ie -> ae : Provision device\n(external provisioning endpoint)
ae -[#red]-> ie : Failure
... Provisioning attempts continue till success ... 

ie -> ea ** : Create with local configuration and start
ea -> ea : Process deployment

ea -> eh ** : Create with local configuration and start
ea -> cm ** : Create and start

eh -> ie : Get server cert
ie -> ie : Generate server cert from DCAC
ie - -> eh: Server cert

cm -> ie : Get local identity
ie -> ie : Generate client cert from DCAC
ie - -> cm: Module local identity

cm -> eh : Connect using mutual TLS auth
cm -> eh : Pub/sub to MQTT Broker using custom topics

eh -> ie : Get IoTHub identity
ie -[#red]-> eh : Failure
... EdgeHub continues to ask for IoTHub identity periodically ... 

... App operation continues. EdgeHub stores telemetry locally ... 
end 

group Device goes online
ie -> ae : Provision device\n(external provisioning endpoint)
ae -> ih : Create device with\nCA based auth
return Device info
ae - -> ie: Provisioning info\n(IoTHub + deviceId + DIdC)

ie -> ih : Update credentials for\nEdgeAgent and EdgeHub with SAS auth

eh -> ie : Get IoTHub identity
return Identity info (IoTHub + deviceId + generation Id + credentials type)
eh -> ie : Sign token 
return Token signed with EdgeHub's SAS Key
eh -> ih : Connect using token and forward telemetry
end
end
@enduml

PlantUML version 1.2020.17(Sat Sep 19 05:30:11 PDT 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>